
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배송 관리 MVP</title>
    
    <!-- [AdSense] Main Script (1회 로드) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4652108502419331" crossorigin="anonymous"></script>
    
    <!-- PWA Setup (iOS & Android) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="배송마스터">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="./icon.svg">
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered: ', registration.scope))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>

    <!-- 필수 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <!-- SortableJS (드래그 앤 드롭) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- 지도 (Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 폰트 & 스타일 설정 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    },
                    colors: {
                        slate: { 850: '#1e293b' }, // Custom dark
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        marquee: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-font-smoothing: antialiased; overscroll-behavior-y: none; overflow-y: auto; }
        html { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        input, button, select, textarea { font-size: 16px !important; } /* iOS Zoom 방지 */
        
        .animate-marquee { animation: marquee 15s linear infinite; white-space: nowrap; }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* Scrollbar Hide Utility */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .map-container { height: 60vh; min-height: 400px; width: 100%; border-radius: 1rem; z-index: 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .custom-marker { text-align: center; }
        .marker-pin {
            width: 36px; height: 36px; border-radius: 50% 50% 50% 0; background: #4f46e5; position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -18px 0 0 -18px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        .marker-pin::after {
            content: ''; width: 24px; height: 24px; margin: 4px 0 0 4px; background: #fff; position: absolute; border-radius: 50%;
        }
        .marker-text {
            position: absolute; width: 36px; font-size: 14px; font-weight: 800; text-align: center; top: 6px; left: 0; z-index: 10; color: #4f46e5;
            transform: rotate(45deg); /* 핀이 회전되어 있으므로 텍스트 보정 필요할 수 있음 -> 기존 로직 확인 필요 */
        }
        /* 스크롤바 커스텀 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* [User Custom Design] Delivery Card */
        .delivery-card { 
           position: relative; 
           background: #ffffff; 
           border-radius: 16px; 
           border: 1px solid #e5e7eb; 
           margin: 12px; 
           overflow: hidden; 
           transition: all 0.2s;
         } 
         
         .delivery-card.current { 
           border-color: #4f46e5; 
           background: #eef2ff; 
         } 
         
         .status-bar { 
           height: 4px; 
           background: #4f46e5; 
         } 
         
         .order-badge { 
           position: absolute; 
           top: 8px; 
           left: 8px; 
           width: 32px; 
           height: 32px; 
           background: #4f46e5; 
           color: #ffffff; 
           border-radius: 50%; 
           font-size: 13px; 
           font-weight: 800; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           z-index: 10;
         } 
         
         .card-body { 
           padding: 16px; 
           padding-top: 24px; 
           display: flex; 
           flex-direction: column; 
           gap: 12px; 
         } 
         
         .current-label { 
           font-size: 12px; 
           font-weight: 800; 
           color: #4338ca; 
         } 
         
         .phone-btn { 
           display: block; 
           background: #4f46e5; 
           color: #ffffff; 
           text-align: center; 
          padding: 14px; 
           border-radius: 14px; 
           font-size: 22px; 
           font-weight: 800; 
           text-decoration: none; 
         } 
         
         .address { 
           font-size: 14px; 
           font-weight: 600; 
           color: #1f2937; 
           line-height: 1.4;
         } 
         
         .time { 
           font-size: 12px; 
           color: #475569; 
         } 
         
         .complete-btn { 
           margin-top: 4px; 
           padding: 14px; 
           font-size: 15px; 
           font-weight: 800; 
           border: none; 
           border-radius: 14px; 
           background: #22c55e; 
           color: #ffffff; 
           cursor: pointer;
         }
         
         .map-btn {
            margin-top: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: 700;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: #f8fafc;
            color: #475569;
            width: 100%;
            cursor: pointer;
         }
 
         .time-pill {
            align-self: flex-start;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            background: #e0e7ff;
            color: #4338ca;
         }
 
         /* Status Variants */
         .delivery-card.completed {
             background: #f8fafc;
             border-color: #e2e8f0;
             opacity: 0.6;
         }
         .delivery-card.canceled {
             border-color: #fecaca;
             background: #fff;
         }
         .delivery-card.postponed {
             border-color: #fb923c;
             background: #fff7ed;
         }
        
        /* Left status strip */
        .left-strip {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #4f46e5;
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
        }
        .delivery-card.current .left-strip { background: #4f46e5; }
        .delivery-card.completed .left-strip { background: #22c55e; }
        .delivery-card.canceled .left-strip { background: #ef4444; }
        .delivery-card.postponed .left-strip { background: #fb923c; }
    </style>
</head>
<body class="bg-[#F4F5F7] text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-700">

    <!-- [Safety] Global Error Handler & Loading Watchdog -->
    <script>
        // 1. Global Error Handler (Must be non-module, non-babel to catch early errors)
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global Error:', msg, error);
            var root = document.getElementById('root');
            if (root && (root.innerHTML.trim() === '' || root.innerHTML.includes('로딩 중'))) {
                root.innerHTML = '<div style="padding:20px;text-align:center;color:red;margin-top:50px;font-family:sans-serif;"><h1>⚠️ 앱 실행 중 오류 발생</h1><p style="color:#666;margin:10px 0;">'+msg+'</p><button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;background:#333;color:white;border:none;border-radius:5px;cursor:pointer;">새로고침</button></div>';
            }
            return false;
        };

        // 2. Loading Watchdog (Check if React mounted within 3 seconds)
        setTimeout(function() {
            var root = document.getElementById('root');
            if (!root || root.innerHTML.trim() === '') {
                var msg = document.createElement('div');
                msg.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:white;color:#333;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:20px;text-align:center;font-family:sans-serif;";
                msg.innerHTML = '<h1 style="font-size:24px;margin-bottom:10px;">⚠️ 앱 로딩 실패</h1><p style="color:#666;margin-bottom:20px;">3초 이상 화면이 나오지 않으면 아래 내용을 확인해주세요.</p><ul style="text-align:left;display:inline-block;margin:0 0 20px 0;font-size:14px;color:#333;line-height:1.6;"><li>브라우저 버전이 너무 낮지 않은지 확인 (iOS 12 이하는 작동하지 않을 수 있음)</li><li>인터넷 연결 상태 확인 (라이브러리 로딩 실패)</li><li>자바스크립트 설정 확인</li></ul><div style="display:flex;gap:10px;"><button onclick="location.reload()" style="padding:10px 20px;background:#333;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">새로고침</button><button onclick="localStorage.clear();location.reload()" style="padding:10px 20px;background:#eee;color:#333;border:none;border-radius:8px;font-size:16px;cursor:pointer;">데이터 초기화</button></div>';
                document.body.appendChild(msg);
            }
        }, 3000);
    </script>

    <div id="root"></div>

    <script type="text/babel">
        // [설정] Config & Constants
        const Config = {
            MAP_KEY: "MVP_DEMO_KEY",
            SUPABASE_URL: "https://yzgsyyolhsxvavcmussi.supabase.co",
            SUPABASE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6Z3N5eW9saHN4dmF2Y211c3NpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzY1MjgsImV4cCI6MjA4NTM1MjUyOH0.g6DiBPEfnO5SIsC9iBAzgSurNR3pPF403-JiRUfIS88",
            FIXED_START: {
                address: "경기도 김포시 양촌읍 학운산단5로가길 22",
                lat: 37.619, lng: 126.634
            },
            FIXED_END: {
                address: "김포한강8로 15",
                lat: 37.643, lng: 126.626
            },
            // 스토리지 키
            STORAGE_KEYS: {
                DELIVERIES: 'mvp_deliveries',
                SETTINGS: 'mvp_settings'
            },
            // 예약 시스템 설정
            RESERVATION: {
                MIN_DAYS: 3,
                MAX_DAYS: 30,
                START_HOUR: 9,
                END_HOUR: 20
            },
            // 설치 서비스 설정
            INSTALL: {
                START_HOUR: 9,
                END_HOUR: 18,
                WEEKDAYS_ONLY: true
            },
            // 배송 메모 설정
            MEMO: {
                MIN_LENGTH: 10,
                MAX_LENGTH: 200
            },
            // [Safety] 데이터 보호 설정
            PROTECTED_DATES: ['2026-02-12', '2025-02-12']
        };

        // [유틸리티] Safe Storage Manager
        const StorageManager = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    if (item === null || item === "undefined") return defaultValue;
                    return JSON.parse(item);
                } catch (e) {
                    console.warn(`[Storage] Failed to parse ${key}, using default.`, e);
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error(`[Storage] Failed to save ${key}`, e);
                    alert("브라우저 저장 공간이 부족합니다. 일부 데이터를 정리해주세요.");
                }
            },
            remove: (key) => {
                localStorage.removeItem(key);
            },
            clearAll: () => {
                localStorage.clear();
                console.log("[Storage] All data cleared.");
            },
            cleanupEphemeral: async () => {
                let removedCount = 0;
                try {
                    if (localStorage.getItem('mvp_validation_report')) {
                        localStorage.removeItem('mvp_validation_report');
                        removedCount++;
                    }
                } catch (e) { /* ignore */ }
                // Optional minor keys cleanup (safe to reconfigure later)
                try {
                    if (localStorage.getItem('mvp_notice')) {
                        localStorage.removeItem('mvp_notice');
                        removedCount++;
                    }
                } catch (e) { /* ignore */ }
                // Clear runtime caches (Service Worker Cache API)
                try {
                    if ('caches' in window) {
                        const keys = await caches.keys();
                        for (const k of keys) {
                            await caches.delete(k);
                            removedCount++;
                        }
                    }
                } catch (e) { /* ignore */ }
                return removedCount;
            },
            ensurePersistent: async () => {
                if (!('storage' in navigator) || !navigator.storage.persist) {
                    alert('브라우저가 영구 저장 권한 요청을 지원하지 않습니다.');
                    return false;
                }
                try {
                    const already = await navigator.storage.persisted();
                    if (already) {
                        alert('이미 영구 저장으로 설정되어 있습니다.');
                        return true;
                    }
                    const ok = await navigator.storage.persist();
                    alert(ok ? '영구 저장 권한이 승인되었습니다.' : '영구 저장 권한을 얻지 못했습니다.');
                    return ok;
                } catch (e) {
                    alert('영구 저장 요청 중 오류가 발생했습니다.');
                    return false;
                }
            },
            showEstimate: async () => {
                if (!('storage' in navigator) || !navigator.storage.estimate) {
                    alert('브라우저가 저장소 사용량 조회를 지원하지 않습니다.');
                    return;
                }
                const est = await navigator.storage.estimate();
                const usage = Math.round((est.usage || 0) / (1024 * 1024));
                const quota = Math.round((est.quota || 0) / (1024 * 1024));
                alert(`저장소 사용량: ${usage}MB / 할당량: ${quota}MB`);
            },
            compactDeliveriesForCloud: (data, days) => {
                try {
                    const now = new Date();
                    const cutoff = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
                    const fmt = (d) => {
                        if (!d) return null;
                        const t = new Date(d);
                        if (isNaN(t.getTime())) return d;
                        const off = t.getTimezoneOffset() * 60000;
                        return new Date(t.getTime() - off).toISOString().split('T')[0];
                    };
                    return (data || []).filter(x => {
                        const ds = fmt(x.date);
                        const dx = new Date(ds || x.date);
                        return !isNaN(dx.getTime()) && dx >= cutoff;
                    }).map(x => ({
                        id: x.id,
                        date: x.date,
                        address: x.address,
                        phone: x.phone,
                        lat: x.lat,
                        lng: x.lng,
                        driver: x.driver,
                        completed: !!x.completed,
                        canceled: !!x.canceled,
                        cancel_type: x.cancel_type || null,
                        sequence_number: x.sequence_number || null,
                        install_fee: x.install_fee || 0,
                        yangjung: x.yangjung || 0,
                        naerim: x.naerim || 0,
                        etc_fee: x.etc_fee || 0
                    }));
                } catch (e) {
                    return data || [];
                }
            },
            exportArchive: (data, days) => {
                try {
                    const now = new Date();
                    const cutoff = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));
                    const older = (data || []).filter(x => {
                        const dx = new Date(x.date);
                        return !isNaN(dx.getTime()) && dx < cutoff;
                    });
                    const blob = new Blob([JSON.stringify(older, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
                    a.href = url;
                    a.download = `deliveries_archive_${ts}.json`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    setTimeout(() => URL.revokeObjectURL(url), 2000);
                } catch (e) {
                    alert('아카이브 내보내기 중 오류가 발생했습니다.');
                }
            },
            // 데이터별 편의 메서드
            saveDeliveries: async (data) => {
                try {
                    // [Requirement] Data must always be Supabase
                    // 1. Local Backup (Immediate UI consistency)
                    localStorage.setItem(Config.STORAGE_KEYS.DELIVERIES, JSON.stringify(data));
                    
                    // 2. Cloud Sync (Critical)
                    // Ensure connection
                    if (!CloudManager.isConnected) {
                         CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
                    }
                    
                    if (CloudManager.isConnected && CloudManager.client) {
                        const settings = StorageManager.get(Config.STORAGE_KEYS.SETTINGS) || {};
                        const enabled = !!settings.cloud_compact_enabled;
                        const days = settings.cloud_compact_days || 60;
                        const payload = enabled ? StorageManager.compactDeliveriesForCloud(data, days) : data;
                        await CloudManager.push(payload);
                        console.log("[AutoSync] Synced to cloud");
                    } else {
                        console.warn("[AutoSync] Cloud not connected - attempting reconnect");
                        CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
                        if (CloudManager.isConnected) {
                            const settings = StorageManager.get(Config.STORAGE_KEYS.SETTINGS) || {};
                            const enabled = !!settings.cloud_compact_enabled;
                            const days = settings.cloud_compact_days || 60;
                            const payload = enabled ? StorageManager.compactDeliveriesForCloud(data, days) : data;
                            await CloudManager.push(payload);
                        }
                    }
                    
                    return true;
                } catch (e) {
                    console.error("[Storage] Failed to save deliveries", e);
                    return false;
                }
            },
            loadDeliveries: () => {
                try {
                    const item = localStorage.getItem(Config.STORAGE_KEYS.DELIVERIES);
                    return item ? JSON.parse(item) : [];
                } catch (e) {
                    return [];
                }
            },
            // [New] 서버에서 데이터 동기화 (초기 로딩용)
            syncFromServer: async () => {
                try {
                    const res = await fetch('/api/load');
                    if (res.ok) {
                        const data = await res.json();
                        if (Array.isArray(data)) { // 빈 배열이어도 서버 데이터가 우선일 수 있음
                            console.log("[Server] Data loaded from server:", data.length);
                            localStorage.setItem(Config.STORAGE_KEYS.DELIVERIES, JSON.stringify(data));
                            return data;
                        }
                    }
                } catch (e) {
                    console.warn("[Server] Load failed", e);
                }
                return null;
            },
            // [New] 공지사항 저장
            saveNotice: (text) => {
                localStorage.setItem('mvp_notice', text || '');
                // [Auto-Sync] 연결되어 있으면 자동으로 서버에 푸시
                if (CloudManager.isConnected && CloudManager.client) {
                    CloudManager.pushNotice(text).then(() => {
                        console.log("[AutoSync] Notice synced");
                    }).catch(e => console.warn("[AutoSync] Notice sync failed", e));
                }
            },
            loadNotice: () => {
                return localStorage.getItem('mvp_notice') || '';
            }
        };

        // [클라우드] Cloud Manager (Supabase)
        const CloudManager = {
            client: null,
            isConnected: false,
            init: (url, key) => {
                if (!url || !key || url.includes("YOUR_")) return false;
                
                // [Auto-Fix] 프로토콜(https://) 누락 시 자동 추가
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }

                try {
                    CloudManager.client = window.supabase.createClient(url, key);
                    CloudManager.isConnected = true;
                    return true;
                } catch (e) {
                    console.error("Supabase init failed", e);
                    CloudManager.isConnected = false;
                    return false;
                }
            },
            // 전체 데이터 업로드 (덮어쓰기) - MVP 단순화
            async push(deliveries) {
                if (!CloudManager.client) throw new Error("서버가 연결되지 않았습니다.");
                
                // 테이블: delivery_sync (id: 'master', data: jsonb)
                const { data, error } = await CloudManager.client
                    .from('delivery_sync')
                    .upsert({ id: 'master', data: deliveries, updated_at: new Date().toISOString() })
                    .select();
                
                if (error) throw error;
                return true;
            },
            // 공지사항 업로드
            async pushNotice(text) {
                if (!CloudManager.client) return;
                const { error } = await CloudManager.client
                    .from('delivery_sync')
                    .upsert({ id: 'notice', data: { text }, updated_at: new Date().toISOString() });
                if (error) console.error("Notice sync failed", error);
            },
            // 전체 데이터 다운로드
            async pull() {
                if (!CloudManager.client) throw new Error("서버가 연결되지 않았습니다.");
                
                const { data, error } = await CloudManager.client
                    .from('delivery_sync')
                    .select('*')
                    .eq('id', 'master')
                    .maybeSingle(); 
                
                if (error) throw error;
                return data ? data.data : null;
            },
            // 공지사항 다운로드
            async pullNotice() {
                if (!CloudManager.client) return '';
                const { data, error } = await CloudManager.client
                    .from('delivery_sync')
                    .select('*')
                    .eq('id', 'notice')
                    .maybeSingle();
                return (data && data.data) ? data.data.text : '';
            }
        };

        // 초기화 시도
        // [Change] Config에 설정된 값으로 즉시 초기화 (사용자 요청: 무조건 사용)
        if (Config.SUPABASE_URL && !Config.SUPABASE_URL.includes("YOUR_")) {
            CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
            console.log("[Cloud] Initialized with Hardcoded Config");
        } else {
            const savedCloudConfig = StorageManager.get('mvp_supabase_config');
            if (savedCloudConfig) {
                CloudManager.init(savedCloudConfig.url, savedCloudConfig.key);
            }
        }

        const { useState, useEffect, useRef, useMemo } = React;

        // [유틸리티]
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function geocodeAddress(address, strict = false) {
            // [안전장치] 주소 유효성 검사
            if (!address || typeof address !== 'string') {
                return null;
            }

            try {
                // [개선된 지오코딩 로직]
                // 1. 기본 정제: 괄호 제거, 앞뒤 공백 제거
                let cleanAddr = address.split('(')[0].trim();
                // 콤마 등 구두점 제거로 토큰 인식 향상
                cleanAddr = cleanAddr.replace(/[,\u3001]/g, ' ');
                
                // 도로명 기반 지역 힌트
                const roadToRegion = {
                    '독정이로': '미추홀구',
                    '영종대로': '중구',
                    '영종대로278번길': '중구'
                };
                
                // 지역 프리픽스 보정 (광역시/도 표기 통일)
                const regionPrefix = (() => {
                    const a = cleanAddr;
                    if (a.includes('서울')) return '서울특별시';
                    if (a.includes('인천')) return '인천광역시';
                    if (a.includes('부산')) return '부산광역시';
                    if (a.includes('대구')) return '대구광역시';
                    if (a.includes('대전')) return '대전광역시';
                    if (a.includes('광주')) return '광주광역시';
                    if (a.includes('울산')) return '울산광역시';
                    if (a.includes('세종')) return '세종특별자치시';
                    if (a.includes('경기')) return '경기도';
                    if (a.includes('강원')) return '강원특별자치도';
                    if (a.includes('충남')) return '충청남도';
                    if (a.includes('충북')) return '충청북도';
                    if (a.includes('전남')) return '전라남도';
                    if (a.includes('전북')) return '전라북도';
                    if (a.includes('경남')) return '경상남도';
                    if (a.includes('경북')) return '경상북도';
                    if (a.includes('제주')) return '제주특별자치도';
                    return '';
                })();
                
                const KR_SUFFIX = ' 대한민국';
                const REGION_CENTERS = {
                    '인천': { lat: 37.4563, lng: 126.7052 },
                    '미추홀구': { lat: 37.444, lng: 126.687 },
                    '중구': { lat: 37.4609, lng: 126.5547 },
                    '김포시': { lat: 37.6153, lng: 126.7150 }
                };
                const REGION_VIEWBOX = {
                    incheon: { left: 126.52, top: 37.55, right: 126.80, bottom: 37.30 },
                    gimpo: { left: 126.55, top: 37.75, right: 126.85, bottom: 37.50 }
                };
                const nearRegion = (() => {
                    if (cleanAddr.includes('미추홀구')) return '미추홀구';
                    if (cleanAddr.includes('중구')) return '중구';
                    if (cleanAddr.includes('인천')) return '인천';
                    if (cleanAddr.includes('김포시') || cleanAddr.includes('김포')) return '김포시';
                    for (const road in roadToRegion) {
                        if (cleanAddr.includes(road)) return roadToRegion[road];
                    }
                    return null;
                })();
                const boxKey = (() => {
                    if (nearRegion === '미추홀구' || nearRegion === '중구' || nearRegion === '인천') return 'incheon';
                    if (nearRegion === '김포시') return 'gimpo';
                    return null;
                })();
                const isFar = (coords, centerKey, limitKm = 60) => {
                    if (!coords || !centerKey || !REGION_CENTERS[centerKey]) return false;
                    const c = REGION_CENTERS[centerKey];
                    const dist = getDistance(c.lat, c.lng, coords.lat, coords.lng);
                    return dist > limitKm;
                };
                
                // 도우미 함수: Nominatim 검색
                const search = async (query) => {
                    try {
                        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=kr&q=${encodeURIComponent(query)}`;
                        let res = await fetch(url);
                        if (res.status === 429) {
                            await new Promise(r => setTimeout(r, 1200));
                            res = await fetch(url);
                        }
                        if (!res.ok) return null;
                        const data = await res.json();
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lng = parseFloat(data[0].lon);
                            if (isNaN(lat) || isNaN(lng)) return null;
                            return { lat, lng };
                        }
                    } catch(e) { return null; }
                    return null;
                };
                const searchStruct = async (params) => {
                    try {
                        const q = new URLSearchParams({
                            format: 'json', limit: '1', countrycodes: 'kr', ...params
                        }).toString();
                        const url = `https://nominatim.openstreetmap.org/search?${q}`;
                        let res = await fetch(url);
                        if (res.status === 429) {
                            await new Promise(r => setTimeout(r, 1200));
                            res = await fetch(url);
                        }
                        if (!res.ok) return null;
                        const data = await res.json();
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lng = parseFloat(data[0].lon);
                            if (isNaN(lat) || isNaN(lng)) return null;
                            return { lat, lng };
                        }
                    } catch (e) { return null; }
                    return null;
                };
                const searchBounded = async (query, boxKey = 'incheon') => {
                    try {
                        const box = REGION_VIEWBOX[boxKey];
                        if (!box) return null;
                        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&countrycodes=kr&bounded=1&viewbox=${box.left},${box.top},${box.right},${box.bottom}&q=${encodeURIComponent(query)}`;
                        let res = await fetch(url);
                        if (res.status === 429) {
                            await new Promise(r => setTimeout(r, 1200));
                            res = await fetch(url);
                        }
                        if (!res.ok) return null;
                        const data = await res.json();
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lng = parseFloat(data[0].lon);
                            if (isNaN(lat) || isNaN(lng)) return null;
                            return { lat, lng };
                        }
                    } catch (e) { return null; }
                    return null;
                };

                // 코어 주소 우선 검색: 시/구 + 복합 도로명 + 건물번호까지만
                {
                    const coreDisplay = formatAddressDisplay(cleanAddr);
                    let pre = null;
                    if (boxKey) {
                        pre = await searchBounded(coreDisplay, boxKey);
                        if (pre) return pre;
                    }
                    if (regionPrefix) {
                        if (boxKey) {
                            pre = await searchBounded(`${regionPrefix} ${coreDisplay}`, boxKey);
                            if (pre) return pre;
                        }
                        if (pre) return pre;
                        pre = await search(`${regionPrefix} ${coreDisplay}${KR_SUFFIX}`);
                        if (pre) return pre;
                    }
                    pre = await search(coreDisplay + KR_SUFFIX);
                    if (pre) return pre;
                }

                // 전략 1: (우선) 지역 경계 제한 전체 주소 검색
                let result = null;
                if (boxKey) {
                    result = await searchBounded(cleanAddr, boxKey);
                    if (result) return result;
                }
                // 전략 1b: 전체 주소 일반 검색
                result = await search(cleanAddr + KR_SUFFIX);
                if (result) return result;

                // [New] 전략 2: 도로명 주소 파싱 (시/군/구 + 도로명 + 건물번호)
                // 정규식으로 "구/군/시", "로/길", 숫자 추출 시도
                // 예: "인천 연수구 송도과학로27번길 15" -> ["인천", "연수구", "송도과학로27번길", "15"]
                
                // 간단한 토큰 분리 방식이 더 강력할 수 있음
                const tokens = cleanAddr.split(/\s+/); // 공백으로 분리
                
                // 토큰 분석
                let siDo = "";
                let guGun = "";
                let roadParts = [];
                let buildingNum = "";

                // 역순으로 탐색하여 건물번호, 도로명 식별
                for (let i = tokens.length - 1; i >= 0; i--) {
                    const t = tokens[i];
                    // 숫자 포함 여부 확인 (건물번호) - 보통 맨 뒤 또는 맨 뒤에서 두번째
                    if (!buildingNum && /^\d+(-\d+)?$/.test(t)) {
                        buildingNum = t;
                        continue;
                    }
                    // 로/길로 끝나는지 확인 (도로명)
                    if ((t.endsWith('로') || t.endsWith('길') || /[로길]\d+번길/.test(t))) {
                        roadParts.push(t);
                        continue;
                    }
                    // 구/군/시 확인
                    if (!guGun && (t.endsWith('구') || t.endsWith('군') || (t.endsWith('시') && t.length > 2))) { // "시"는 "서울시" 등
                        guGun = t;
                        continue;
                    }
                    // 시/도 확인 (남은 것 중 맨 앞쪽일 가능성 높음)
                    if (!siDo && (t.endsWith('시') || t.endsWith('도'))) {
                        siDo = t;
                    }
                }

                // 파싱된 조합으로 재검색
                if (roadParts.length > 0) {
                    // 불필요한 꼬리 토큰 제거: 도로명(+번길) 이후 내용은 검색에서 제외
                    // 건물번호가 있으면 포함, 없으면 도로명만 사용
                    const roadFull = roadParts.slice().reverse().join(' ');
                    const coreRoad = buildingNum ? `${roadFull} ${buildingNum}` : `${roadFull}`;
                    
                    // [강화] 구조화 검색 (city/county/street)
                    if (nearRegion) {
                        const city = '인천';
                        const county = (cleanAddr.includes('미추홀구') || guGun === '미추홀구') ? '미추홀구'
                                      : (cleanAddr.includes('중구') || guGun === '중구') ? '중구' : '';
                        const params = {
                            street: coreRoad,
                            city: city,
                            country: '대한민국'
                        };
                        if (county) params.county = county;
                        result = await searchStruct(params);
                        if (result && !isFar(result, nearRegion)) return result;
                    }

                    // 조합 1: 시/도 + 구/군 + 도로명(+건물번호)
                    if (siDo && guGun) {
                        result = await search(`${siDo} ${guGun} ${coreRoad}${KR_SUFFIX}`);
                        if (result) return result;
                    }

                    // 조합 2: 구/군 + 도로명(+건물번호)
                    if (guGun) {
                        result = await search(`${guGun} ${coreRoad}${KR_SUFFIX}`);
                        if (result) return result;
                    }

                    // 조합 3: 지역 프리픽스 + 도로명(+건물번호)
                    if (regionPrefix) {
                        result = await search(`${regionPrefix} ${coreRoad}${KR_SUFFIX}`);
                        if (result) return result;
                    }
                    // 일반 검색
                    result = await search(`${coreRoad}${KR_SUFFIX}`);
                    if (result) return result;
                    
                    // [강화] 경계 제한 검색
                    if (boxKey) {
                        result = await searchBounded(coreRoad, boxKey);
                        if (result) return result;
                    }
                }

                // 전략 3: 상세주소(마지막 어절) 제거 후 검색 (기존 로직 유지)
                if (tokens.length > 2) { 
                    tokens.pop(); 
                    const lessDetail = tokens.join(' ');
                    result = await search(lessDetail + KR_SUFFIX);
                    if (result) return result;
                }

                // 전략 4: 더 넓은 범위 검색
                if (tokens.length > 2) {
                    tokens.pop();
                    const moreLessDetail = tokens.join(' ');
                    result = await search(moreLessDetail + KR_SUFFIX);
                    if (result) return result;
                    // [강화] 경계 제한 넓은 검색
                    if (boxKey) {
                        result = await searchBounded(moreLessDetail, boxKey);
                        if (result) return result;
                    }
                }
                
                // 전략 5: 지역 프리픽스 + 전체 주소 재시도
                if (regionPrefix) {
                    result = await search(`${regionPrefix} ${cleanAddr}${KR_SUFFIX}`);
                    if (result) return result;
                    if (boxKey) {
                        result = await searchBounded(`${regionPrefix} ${cleanAddr}`, boxKey);
                        if (result) return result;
                    }
                }

                if (!strict) {
                    if (cleanAddr.includes('김포시') || cleanAddr.includes('김포')) return REGION_CENTERS['김포시'];
                    if (cleanAddr.includes('인천')) return REGION_CENTERS['인천'];
                }

            } catch (e) { console.error("Geocoding failed", e); }
            return null;
        }
        
        function formatAddressDisplay(address) {
            if (!address) return '';
            const s = String(address).trim().replace(/[,\u3001]/g, ' ');
            const tokens = s.split(/\s+/);
            let siDo = '';
            let guGun = '';
            let roadParts = [];
            let buildingNum = '';
            for (let i = tokens.length - 1; i >= 0; i--) {
                const t = tokens[i];
                if (!buildingNum && /^\d+(-\d+)?$/.test(t)) { buildingNum = t; continue; }
                if ((t.endsWith('로') || t.endsWith('길') || /[로길]\d+번길/.test(t))) { roadParts.push(t); continue; }
                if (!guGun && (t.endsWith('구') || t.endsWith('군') || (t.endsWith('시') && t.length > 2))) { guGun = t; continue; }
                if (!siDo && (t.endsWith('시') || t.endsWith('도'))) { siDo = t; }
            }
            if (roadParts.length > 0) {
                const roadFull = roadParts.slice().reverse().join(' ');
                const core = `${siDo ? siDo + ' ' : ''}${guGun ? guGun + ' ' : ''}${roadFull}${buildingNum ? ' ' + buildingNum : ''}`;
                return core.trim();
            }
            return s;
        }

        function formatTimeRange(start, minutes) {
            if (!start) return '예약시간';
            const [hh, mm] = start.split(':').map(x => parseInt(x, 10));
            const total = hh * 60 + mm + (parseInt(minutes, 10) || 0);
            const eh = Math.floor(total / 60);
            const em = total % 60;
            const pad = n => (n < 10 ? '0' + n : '' + n);
            return `${start} ~ ${pad(eh)}:${pad(em)}`;
        }

        function parseCustomDate(dateStr) {
            // [안전장치] 값이 없으면 오늘 날짜 반환 (Local Time - KST Support)
            if (!dateStr) {
                const d = new Date();
                const offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().split('T')[0];
            }

            // 엑셀 날짜 객체인 경우
            if (dateStr instanceof Date) {
                const offset = dateStr.getTimezoneOffset() * 60000;
                return new Date(dateStr.getTime() - offset).toISOString().split('T')[0];
            }

            let str = String(dateStr).trim();

            // [개선] "2025. 2. 3" 또는 "2025/02/03" 등의 형식을 "2025-02-03"으로 정규화
            // 1. 년월일 한글 형식 ("2월 3일")
            const koreanMatch = str.match(/(\d+)월\s*(\d+)일/);
            if (koreanMatch) {
                const year = new Date().getFullYear();
                const month = koreanMatch[1].padStart(2, '0');
                const day = koreanMatch[2].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 2. 구분자(., /)를 -로 통일하고 공백 제거
            // 예: "2025. 02. 03" -> "2025-02-03"
            const normalized = str.replace(/[\.\/]/g, '-').replace(/\s+/g, '');
            
            // 3. YYYY-M-D 형식을 YYYY-MM-DD로 보정
            const parts = normalized.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                // 연도가 2자리인 경우 (25-02-03) 처리 (선택사항, 여기선 4자리 가정하되 필요시 추가)
                return `${year}-${month}-${day}`;
            }
            
            return normalized; 
        }

        // [알고리즘] Nearest Neighbor (출발지 -> 가장 가까운 곳 -> ... -> 도착지)
        function solveTSP(startNode, nodes, endNode) {
            let current = startNode;
            let unvisited = [...nodes];
            const path = [];

            while (unvisited.length > 0) {
                // 현재 위치에서 가장 가까운 노드 찾기
                unvisited.sort((a, b) => {
                    const distA = getDistance(current.lat, current.lng, a.lat, a.lng);
                    const distB = getDistance(current.lat, current.lng, b.lat, b.lng);
                    return distA - distB;
                });

                const next = unvisited.shift();
                path.push({
                    ...next,
                    // [수정] 거리는 항상 출발지(startNode) 기준으로 표시
                    distanceFromPrev: getDistance(startNode.lat, startNode.lng, next.lat, next.lng)
                });
                current = next;
            }

            // [추가] 마지막 도착지(집) 추가
            if (endNode) {
                path.push({
                    ...endNode,
                    distanceFromPrev: getDistance(current.lat, current.lng, endNode.lat, endNode.lng),
                    type: 'destination' // 식별용 태그
                });
            }

            return path;
        }

        // [컴포넌트] 지도
        function MapView({ locations, center, startPoint }) {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const polylineRef = useRef(null);
            const geoCacheRef = useRef({});
            const isValid = (p) => {
                if (!p || p.lat == null || p.lng == null) return false;
                const lat = Number(p.lat);
                const lng = Number(p.lng);
                return !isNaN(lat) && !isNaN(lng);
            };

            useEffect(() => {
                if (!mapRef.current) return;
                if (!mapInstance.current) {
                    mapInstance.current = L.map(mapRef.current, {
                        zoomControl: false
                    }).setView([36.5, 127.8], 7);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(mapInstance.current);
                }

                let orderCounter = 0;
                let prevLatLng = isValid(startPoint) ? [Number(startPoint.lat), Number(startPoint.lng)] : null;
                let currBearing = null;
                let destLatLng = null;
                const TURN_PENALTY = 0.4;
                const DEST_WEIGHT = 0.6;
                const routeLatLngs = [];
                // 마커 클리어
                mapInstance.current.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) mapInstance.current.removeLayer(layer);
                });

                // 1. 출발지 마커 (파랑)
                if (isValid(startPoint)) {
                    const startIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color:#2563eb; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px black;"></div>`,
                        iconSize: [20, 20]
                    });
                    const startMarker = L.marker([Number(startPoint.lat), Number(startPoint.lng)], { icon: startIcon }).addTo(mapInstance.current).bindPopup("🚩 출발지 (물류센터)");
                    startMarker.off('click');
                    startMarker.on('click', function() {
                        if (this.isPopupOpen()) this.closePopup();
                        else this.openPopup();
                    });
                    routeLatLngs.push([Number(startPoint.lat), Number(startPoint.lng)]);
                }

                // 2. 배송지 및 도착지 마커 (근접 순서 번호 부여)
                const missing = [];
                const known = [];
                locations.forEach((group) => {
                    if (group.type === 'destination') {
                        const icon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style='background-color:#10b981; color:white; border-radius:50%; width:30px; height:30px; text-align:center; line-height:30px; font-size:18px; border:2px solid white; box-shadow:1px 1px 3px rgba(0,0,0,0.5);'>🏠</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        const dlat = Number(group.lat), dlng = Number(group.lng);
                        const destMarker = L.marker([dlat, dlng], { icon }).addTo(mapInstance.current)
                            .bindPopup(`<div class="font-bold text-center p-2">🏠 도착지(집)<br/><span class="text-xs text-gray-500">${formatAddressDisplay(group.address)}</span></div>`);
                        destMarker.off('click');
                        destMarker.on('click', function() { if (this.isPopupOpen()) this.closePopup(); else this.openPopup(); });
                        if (!isNaN(dlat) && !isNaN(dlng)) destLatLng = [dlat, dlng];
                        return;
                    }
                    if (!group.lat || !group.lng || isNaN(group.lat) || isNaN(group.lng)) { missing.push(group); return; }
                    known.push(group);
                });
                while (known.length > 0) {
                    let pickIdx = 0;
                    if (prevLatLng) {
                        let best = Infinity;
                        for (let i = 0; i < known.length; i++) {
                            const nx = Number(known[i].lat), ny = Number(known[i].lng);
                            const d = getDistance(prevLatLng[0], prevLatLng[1], nx, ny);
                            let cost = d;
                            if (currBearing != null) {
                                const r = Math.PI / 180;
                                const y = Math.sin((ny - prevLatLng[1]) * r) * Math.cos(nx * r);
                                const x = Math.cos(prevLatLng[0] * r) * Math.cos(nx * r) * Math.cos((ny - prevLatLng[1]) * r) - Math.sin(prevLatLng[0] * r) * Math.sin(nx * r);
                                let b = Math.atan2(y, x) * 180 / Math.PI; if (b < 0) b += 360;
                                let diff = Math.abs(b - currBearing) % 360; if (diff > 180) diff = 360 - diff;
                                cost = d + TURN_PENALTY * (diff / 90);
                            }
                            if (destLatLng) {
                                const rem = known.length;
                                const w = rem <= 3 ? DEST_WEIGHT : DEST_WEIGHT * 0.2;
                                const dd = getDistance(nx, ny, destLatLng[0], destLatLng[1]);
                                cost += w * dd;
                            }
                            if (cost < best) { best = cost; pickIdx = i; }
                        }
                    }
                    const group = known.splice(pickIdx, 1)[0];
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style='background-color:#ef4444; color:white; border-radius:50%; width:24px; height:24px; text-align:center; line-height:24px; font-weight:bold; border:2px solid white; box-shadow:1px 1px 3px rgba(0,0,0,0.5);'>${orderCounter + 1}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    let distKm = null;
                    if (prevLatLng) {
                        const dk = getDistance(prevLatLng[0], prevLatLng[1], Number(group.lat), Number(group.lng));
                        if (Number.isFinite(dk)) distKm = dk.toFixed(1);
                    }
                    const distHtml = distKm ? `<span class="text-xs font-bold text-blue-700 bg-blue-100 px-1.5 py-0.5 rounded border border-blue-200 ml-1 whitespace-nowrap">${distKm}km</span>` : '';
                    const popupContent = `
                        <div class="p-2 min-w-[200px]">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">${orderCounter + 1}번</span>
                                <span class="font-bold text-lg text-gray-800">${group.phone || ''}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-1 flex items-center flex-wrap">📍 ${formatAddressDisplay(group.address)} ${distHtml}</div>
                            <div class="border-t pt-2">
                                <ul class="list-disc pl-4 text-sm space-y-0.5 text-gray-700">
                                    ${(group.items || []).map(i => `<li>${i.item}</li>`).join('')}
                                </ul>
                                <div class="flex gap-1 mt-2">
                                    <button onclick="window.handleAppNavigation(${group.lat}, ${group.lng}, '${(group.address || '').replace(/'/g, "\\'")}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">배송출발</button>
                                    <button onclick="window.handlePopupSequenceChange('${(group.ids || []).join(',')}')" class="flex-1 bg-sky-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">순서변경</button>
                                    <button onclick="document.querySelector('.leaflet-popup-close-button').click()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">닫기</button>
                                </div>
                            </div>
                        </div>
                    `;
                    const marker = L.marker([Number(group.lat), Number(group.lng)], { icon }).addTo(mapInstance.current).bindPopup(popupContent);
                    const current = [Number(group.lat), Number(group.lng)];
                    if (prevLatLng) L.polyline([prevLatLng, current], { color: '#2563eb', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(mapInstance.current);
                    prevLatLng = current;
                    routeLatLngs.push(current);
                    {
                        const r = Math.PI / 180, a1 = prevLatLng[0] * r, b1 = prevLatLng[1] * r, a2 = Number(group.lat) * r, b2 = Number(group.lng) * r;
                        const y = Math.sin(b2 - b1) * Math.cos(a2);
                        const x = Math.cos(a1) * Math.cos(a2) * Math.cos(b2 - b1) - Math.sin(a1) * Math.sin(a2);
                        let b = Math.atan2(y, x) * 180 / Math.PI; if (b < 0) b += 360;
                        currBearing = b;
                    }
                    orderCounter++;
                    marker.off('click'); marker.on('click', function() { if (this.isPopupOpen()) this.closePopup(); else this.openPopup(); });
                }
                // 마지막은 pending 처리 후 일괄 그리기

                if (missing.length > 0) {
                    (async () => {
                        const bounds = [];
                        if (startPoint && !isNaN(Number(startPoint.lat)) && !isNaN(Number(startPoint.lng))) {
                            bounds.push([Number(startPoint.lat), Number(startPoint.lng)]);
                        }
                        const pending = [];
                        for (const group of missing) {
                            const key = String(group.address || '').trim();
                            let c = geoCacheRef.current[key];
                            if (!c) {
                                const addr = formatAddressDisplay(group.address || '');
                                c = await geocodeAddress(addr, true) || await geocodeAddress(addr, false);
                                if (c) geoCacheRef.current[key] = c;
                            }
                            let fromFallback = false;
                            if (!c) {
                                const a = (group.address || '');
                                if (a.includes('인천')) { c = { lat: 37.4563, lng: 126.7052 }; fromFallback = true; }
                                else if (a.includes('서울')) { c = { lat: 37.5665, lng: 126.9780 }; fromFallback = true; }
                                else { c = { lat: 36.5, lng: 127.8 }; fromFallback = true; }
                            }
                            if (c) {
                                let latNum = Number(c.lat);
                                let lngNum = Number(c.lng);
                                const isFallbackCoord = (la, ln) => (
                                    (Math.abs(la - 37.4563) < 1e-6 && Math.abs(ln - 126.7052) < 1e-6) ||
                                    (Math.abs(la - 37.5665) < 1e-6 && Math.abs(ln - 126.9780) < 1e-6) ||
                                    (Math.abs(la - 36.5) < 1e-6 && Math.abs(ln - 127.8) < 1e-6)
                                );
                                if (fromFallback || isFallbackCoord(latNum, lngNum)) {
                                    const s = String(group.address || '');
                                    let h = 0; for (let i = 0; i < s.length; i++) { h = ((h * 31) + s.charCodeAt(i)) >>> 0; }
                                    const dLat = ((h % 21) - 10) * 0.0009;
                                    const dLng = ((((h >> 5) % 21) - 10) * 0.0009);
                                    latNum += dLat; lngNum += dLng;
                                }
                                pending.push({ group, lat: latNum, lng: lngNum });
                            }
                        }
                        while (pending.length > 0) {
                            let pickIdx = 0;
                            if (prevLatLng) {
                                let best = Infinity;
                                for (let i = 0; i < pending.length; i++) {
                                    const cand = pending[i];
                                    const d = getDistance(prevLatLng[0], prevLatLng[1], cand.lat, cand.lng);
                                    let cost = d;
                                    if (currBearing != null) {
                                        const r = Math.PI / 180;
                                        const y = Math.sin((cand.lng - prevLatLng[1]) * r) * Math.cos(cand.lat * r);
                                        const x = Math.cos(prevLatLng[0] * r) * Math.cos(cand.lat * r) * Math.cos((cand.lng - prevLatLng[1]) * r) - Math.sin(prevLatLng[0] * r) * Math.sin(cand.lat * r);
                                        let b = Math.atan2(y, x) * 180 / Math.PI; if (b < 0) b += 360;
                                        let diff = Math.abs(b - currBearing) % 360; if (diff > 180) diff = 360 - diff;
                                        cost = d + TURN_PENALTY * (diff / 90);
                                    }
                                    if (destLatLng) {
                                        const rem = pending.length;
                                        const w = rem <= 3 ? DEST_WEIGHT : DEST_WEIGHT * 0.2;
                                        const dd = getDistance(cand.lat, cand.lng, destLatLng[0], destLatLng[1]);
                                        cost += w * dd;
                                    }
                                    if (cost < best) { best = cost; pickIdx = i; }
                                }
                            }
                            const { group, lat, lng } = pending.splice(pickIdx, 1)[0];
                            const icon = L.divIcon({
                                className: 'custom-div-icon',
                                html: `<div style='background-color:#ef4444; color:white; border-radius:50%; width:24px; height:24px; text-align:center; line-height:24px; font-weight:bold; border:2px solid white; box-shadow:1px 1px 3px rgba(0,0,0,0.5);'>${orderCounter + 1}</div>`,
                                iconSize: [24, 24],
                                iconAnchor: [12, 12]
                            });
                            let distKm = null;
                            if (prevLatLng) {
                                const dk = getDistance(prevLatLng[0], prevLatLng[1], lat, lng);
                                if (Number.isFinite(dk)) distKm = dk.toFixed(1);
                            }
                            const distHtml = distKm ? `<span class="text-xs font-bold text-blue-700 bg-blue-100 px-1.5 py-0.5 rounded border border-blue-200 ml-1 whitespace-nowrap">${distKm}km</span>` : '';
                            const popupContent = `
                                <div class="p-2 min-w-[200px]">
                                    <div class="text-sm text-gray-600 mb-1 flex items-center flex-wrap">📍 ${formatAddressDisplay(group.address)} ${distHtml}</div>
                                    <div class="border-t pt-2">
                                        <div class="flex gap-1 mt-2">
                                            <button onclick="window.handleAppNavigation(${lat}, ${lng}, '${(group.address || '').replace(/'/g, "\\'")}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">
                                                배송출발
                                            </button>
                                            <button onclick="window.handlePopupSequenceChange('${Array.isArray(group.ids) ? group.ids.join(',') : (group.id != null ? String(group.id) : '')}')" class="flex-1 bg-sky-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">
                                                순서변경
                                            </button>
                                            <button onclick="document.querySelector('.leaflet-popup-close-button').click()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">
                                                닫기
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                            L.marker([lat, lng], { icon }).addTo(mapInstance.current).bindPopup(popupContent);
                            if (prevLatLng) {
                                L.polyline([prevLatLng, [lat, lng]], { color: '#2563eb', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(mapInstance.current);
                            }
                            {
                                const r = Math.PI / 180, a1 = (prevLatLng ? prevLatLng[0] : lat) * r, b1 = (prevLatLng ? prevLatLng[1] : lng) * r, a2 = lat * r, b2 = lng * r;
                                const y = Math.sin(b2 - b1) * Math.cos(a2);
                                const x = Math.cos(a1) * Math.cos(a2) * Math.cos(b2 - b1) - Math.sin(a1) * Math.sin(a2);
                                let b = Math.atan2(y, x) * 180 / Math.PI; if (b < 0) b += 360;
                                currBearing = b;
                            }
                            prevLatLng = [lat, lng];
                            routeLatLngs.push([lat, lng]);
                            orderCounter++;
                            bounds.push([lat, lng]);
                        }
                        // 전체 경로 초록 실선 (출발지 → 모든 배송지 → 도착지)
                        if (destLatLng) {
                            routeLatLngs.push(destLatLng);
                        }
                        if (routeLatLngs.length >= 2) {
                            L.polyline(routeLatLngs, { color: '#10b981', weight: 4, opacity: 0.85 }).addTo(mapInstance.current);
                        }
                        if (bounds.length > 0) {
                            mapInstance.current.fitBounds(bounds, { padding: [40, 40], maxZoom: 16 });
                        }
                    })();
                }

                
                // 4. 화면 맞춤 (유효 좌표가 있을 때만)
                {
                    const bounds = [];
                    if (isValid(startPoint)) bounds.push([Number(startPoint.lat), Number(startPoint.lng)]);
                    locations.forEach(l => {
                        const lat = Number(l?.lat);
                        const lng = Number(l?.lng);
                        if (!isNaN(lat) && !isNaN(lng)) bounds.push([lat, lng]);
                    });
                    if (bounds.length > 0) {
                        mapInstance.current.fitBounds(bounds, { padding: [40, 40], maxZoom: 16 });
                    }
                }

            }, [locations, center, startPoint]);

            return <div ref={mapRef} className="map-container mb-4 shadow-md bg-gray-200"></div>;
        }

        // [컴포넌트] 로그인/메인 진입 화면
        function LoginScreen({ onLogin }) {
            const [driverName, setDriverName] = useState('');

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex flex-col items-center justify-center p-6 animate-fade-in">
                    <div className="bg-white/80 backdrop-blur-xl p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center space-y-8 border border-white/50 ring-1 ring-indigo-50">
                        <div className="space-y-4">
                            <div className="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl mx-auto flex items-center justify-center shadow-lg shadow-indigo-200 mb-6 transform hover:scale-105 transition-transform duration-300">
                                <span className="text-5xl filter drop-shadow-md">🚚</span>
                            </div>
                            <div>
                                <h1 className="text-3xl font-black text-slate-900 tracking-tight mb-2">배송 마스터</h1>
                                <p className="text-slate-500 font-medium text-sm">기사님, 오늘도 안전운전 하세요!</p>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div className="relative group">
                                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <span className="text-gray-400 group-focus-within:text-indigo-500 transition-colors">👤</span>
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="이름을 입력해주세요" 
                                    className="w-full bg-slate-50 border border-slate-200 p-4 pl-11 rounded-2xl text-lg font-bold text-slate-800 placeholder:text-slate-400 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all"
                                    value={driverName}
                                    onChange={(e) => setDriverName(e.target.value)}
                                    onKeyPress={(e) => {
                                        if(e.key === 'Enter') {
                                            if (/^[가-힣]{2,10}$/.test(driverName.trim())) {
                                                onLogin('driver', driverName.trim());
                                            } else {
                                                alert("올바른 한글 이름(2~10자)을 입력해주세요.");
                                            }
                                        }
                                    }}
                                />
                            </div>

                            <button 
                                onClick={() => {
                                    if (/^[가-힣]{2,10}$/.test(driverName.trim())) {
                                        onLogin('driver', driverName.trim());
                                    } else {
                                        alert("올바른 한글 이름(2~10자)을 입력해주세요.");
                                    }
                                }}
                                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-2xl font-bold text-lg shadow-lg shadow-indigo-200 hover:shadow-indigo-300 hover:-translate-y-0.5 active:scale-95 transition-all flex items-center justify-center gap-2"
                            >
                                <span>시작하기</span>
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                            </button>

                            <div className="relative flex py-2 items-center">
                                <div className="flex-grow border-t border-slate-200"></div>
                                <span className="flex-shrink-0 mx-4 text-slate-300 text-xs font-bold uppercase tracking-wider">Admin Access</span>
                                <div className="flex-grow border-t border-slate-200"></div>
                            </div>
                            
                            <button 
                                onClick={() => {
                                    const pwd = prompt('관리자 비밀번호를 입력하세요:');
                                    if (pwd === '1234') {
                                        onLogin('admin', 'admin');
                                    } else if (pwd !== null) {
                                        alert('비밀번호가 올바르지 않습니다.');
                                    }
                                }}
                                className="w-full bg-white text-slate-500 border border-slate-200 p-3 rounded-xl font-bold text-sm hover:bg-slate-50 hover:text-slate-700 active:bg-slate-100 transition-all flex items-center justify-center gap-2"
                            >
                                <span>⚙️</span> 관리자 모드
                            </button>
                        </div>
                        
                        <div className="text-xs text-slate-400">
                            v2.1 MVP Release
                        </div>
                    </div>
                </div>
            );
        }

        // [Component] Reusable Card Component (Modernized)
        const Card = ({ title, description, actions, children, className = "", loading = false }) => {
            return (
                <div className={`bg-white rounded-2xl shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 border border-slate-100 overflow-hidden group ${className}`}>
                    {(title || actions) && (
                        <div className="px-4 py-3 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center relative">
                            <div className="w-full text-center">
                                {title && <h3 className="font-bold text-lg text-slate-800 flex items-center justify-center gap-2">{title}</h3>}
                                {description && <p className="text-sm text-slate-500 mt-1">{description}</p>}
                            </div>
                            {actions && <div className="flex gap-2 absolute right-5 top-1/2 -translate-y-1/2">{actions}</div>}
                        </div>
                    )}
                    <div className={`px-4 py-3 relative ${loading ? 'opacity-50 pointer-events-none' : ''}`}>
                        {loading && (
                            <div className="absolute inset-0 bg-white/60 backdrop-blur-[1px] z-10 flex items-center justify-center">
                                 <div className="animate-spin rounded-full h-8 w-8 border-4 border-slate-200 border-t-indigo-600"></div>
                            </div>
                        )}
                        {children}
                    </div>
                </div>
            );
        };

        function DeliveryCard({ item, order, isCurrent, onComplete }) {
            return (
                <div className={`relative rounded-2xl px-4 py-3 border transition ${item.completed ? 'opacity-60' : ''} ${isCurrent ? 'border-indigo-600 bg-indigo-50' : 'border-slate-200 bg-white'}`}>
                    <div className="absolute -top-2 -left-2 w-7 h-7 rounded-full bg-indigo-600 text-white text-xs font-bold flex items-center justify-center">
                        {order}
                    </div>
                    <div className="flex justify-between items-start">
                        <div className="flex-1 pr-2">
                            {isCurrent && (
                                <p className="text-[11px] font-bold text-indigo-600 mb-1">
                                    🚚 현재 배송 중
                                </p>
                            )}
                            <div className="font-semibold text-slate-900 text-sm leading-snug">📍 {formatAddressDisplay(item.address)}</div>
                            <div className="text-xs text-slate-500 mt-0.5">📦 {item.item}</div>
                            <div className="text-xs text-slate-500 mt-1">
                                <a href={`tel:${item.phone}`}>📞 {item.phone || '번호없음'}</a>
                            </div>
                        </div>
                        <div className="flex gap-1 shrink-0 items-center">
                            {(item.scheduled_time || item.time) && (
                                <span className="text-[10px] font-bold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded-full shrink-0">
                                    ⏰ {(item.scheduled_time || item.time)}
                                </span>
                            )}
                            {item.canceled && <span className="text-[10px] font-bold text-white bg-red-500 px-2 py-1 rounded-full shrink-0">취소됨</span>}
                            {item.completed && <span className="text-[10px] font-bold text-white bg-green-600 px-2 py-1 rounded-full shrink-0">완료</span>}
                            {!item.completed && (
                                <button onClick={() => onComplete(item.id, order)} className="px-2 py-1 text-xs font-bold rounded bg-indigo-600 text-white shadow-sm active:scale-95">
                                    완료
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // [광고] AdSense Banner Component
        const AdBanner = ({ className = "", slot, format = "auto", fullWidth = true }) => {
            useEffect(() => {
                try {
                    (window.adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.warn("AdSense push failed", e);
                }
            }, []);

            return (
                <div className={`ad-container ${className}`} style={{ minHeight: '100px', textAlign: 'center', overflow: 'hidden' }}>
                    <ins className="adsbygoogle"
                         style={{ display: 'block' }}
                         data-ad-client="ca-pub-4652108502419331"
                         data-ad-slot={slot}
                         data-ad-format={format}
                         data-full-width-responsive={fullWidth ? "true" : "false"}></ins>
                </div>
            );
        };

        // [설정 모달] Supabase Cloud Config
        function CloudSettingsModal({ isOpen, onClose, onReset }) {
            if (!isOpen) return null;
            const [url, setUrl] = useState(CloudManager.client?.supabaseUrl || '');
            const [key, setKey] = useState(CloudManager.client?.supabaseKey || '');
            const [showKey, setShowKey] = useState(false);

            const handleSave = () => {
                if (!url || !key) {
                    alert("URL과 Key를 모두 입력해주세요.");
                    return;
                }

                // [Auto-Fix] URL 보정
                let fixedUrl = url.trim();
                if (!fixedUrl.startsWith('http://') && !fixedUrl.startsWith('https://')) {
                    fixedUrl = 'https://' + fixedUrl;
                }

                const success = CloudManager.init(fixedUrl, key);
                if (success) {
                    StorageManager.set('mvp_supabase_config', { url: fixedUrl, key });
                    alert("✅ 서버 연결에 성공했습니다!");
                    onClose();
                } else {
                    alert("⚠️ 연결 실패. URL과 Key를 확인해주세요.");
                }
            };

            return (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md m-4 border border-slate-200">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">☁️ 서버(Cloud) 설정</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 font-bold text-xl">✕</button>
                        </div>
                        
                        <div className="space-y-4 mb-6">
                            <div className="bg-blue-50 p-4 rounded-xl text-sm text-blue-700 leading-relaxed">
                                <strong>🔑 키 확인 방법 (Supabase 대시보드)</strong><br/>
                                1. 프로젝트 대시보드 접속<br/>
                                2. 좌측 메뉴 최하단 <strong>톱니바퀴 아이콘 (Project Settings)</strong> 클릭<br/>
                                3. <strong>API</strong> 메뉴 선택<br/>
                                4. <strong>Project URL</strong> 및 <strong>anon / public</strong> 키 복사<br/>
                                <br/>
                                <strong>⚡ 초기 설정 (SQL Editor)</strong><br/>
                                좌측 <strong>SQL Editor</strong> 메뉴 > 아래 쿼리 붙여넣기 후 <strong>Run</strong>:<br/>
                                <code className="block bg-blue-100 p-2 mt-2 rounded font-mono text-xs select-all">
                                    create table delivery_sync (
                                      id text primary key,
                                      data jsonb,
                                      updated_at timestamptz default now()
                                    );
                                </code>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Project URL</label>
                                <div className="flex gap-2">
                                    <input type="text" className="flex-1 bg-slate-50 border p-3 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none" 
                                        placeholder="https://your-project.supabase.co" value={url} onChange={e => setUrl(e.target.value)} />
                                    <button onClick={() => { navigator.clipboard.writeText(url); alert("URL이 복사되었습니다!"); }} 
                                        className="bg-slate-100 px-3 rounded-lg hover:bg-slate-200 text-lg transition" title="URL 복사">📋</button>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Anon / Public Key</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <input type={showKey ? "text" : "password"} className="w-full bg-slate-50 border p-3 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none pr-10" 
                                            placeholder="eyJh..." value={key} onChange={e => setKey(e.target.value)} />
                                        <button onClick={() => setShowKey(!showKey)} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 z-10 p-1">
                                            {showKey ? "🙈" : "👁️"}
                                        </button>
                                    </div>
                                    <button onClick={() => { navigator.clipboard.writeText(key); alert("Key가 복사되었습니다!"); }} 
                                        className="bg-slate-100 px-3 rounded-lg hover:bg-slate-200 text-lg transition" title="Key 복사">📋</button>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => {
                                StorageManager.remove('mvp_supabase_config');
                                setUrl(''); setKey('');
                                CloudManager.client = null;
                                alert("연결이 해제되었습니다.");
                                onClose();
                            }} className="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition">연결 해제</button>
                            <button onClick={handleSave} className="flex-[2] bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">연결 저장</button>
                        </div>
                        
                        <div className="mt-4 pt-4 border-t border-slate-100">
                            <button onClick={async () => {
                                if (!CloudManager.isConnected && !CloudManager.client) {
                                    alert("먼저 서버에 연결해야 데이터를 삭제할 수 있습니다.");
                                    return;
                                }
                                if(confirm("⚠️ 정말로 서버의 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {
                                    try {
                                        await CloudManager.push([]); // 빈 배열 업로드
                                        if (onReset) onReset(); // 로컬 데이터 초기화
                                        alert("✅ 서버 데이터가 초기화되었습니다. 이제 테스트를 시작하세요.");
                                        onClose();
                                    } catch(e) {
                                        alert("❌ 초기화 실패: " + e.message);
                                    }
                                }
                            }} className="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold hover:bg-red-100 transition text-sm flex items-center justify-center gap-2">
                                🗑️ 서버 데이터 초기화 (전체 삭제)
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // [가이드 모달] 앱 사용 설명서
        function GuideModal({ isOpen, onClose }) {
            if (!isOpen) return null;
            const [tab, setTab] = useState('driver'); // driver | admin | cloud

            return (
                <div className="fixed inset-0 z-[10000] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl m-4 overflow-hidden flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">📘 사용 가이드</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 font-bold text-xl">✕</button>
                        </div>
                        
                        <div className="flex border-b">
                            <button className={`flex-1 py-3 text-sm font-bold transition ${tab === 'driver' ? 'text-indigo-900 border-b-2 border-indigo-600 bg-sky-50/50' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setTab('driver')}>🛵 기사님 가이드</button>
                            <button className={`flex-1 py-3 text-sm font-bold transition ${tab === 'admin' ? 'text-indigo-900 border-b-2 border-indigo-600 bg-sky-50/50' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setTab('admin')}>👨‍💼 관리자 가이드</button>
                            <button className={`flex-1 py-3 text-sm font-bold transition ${tab === 'cloud' ? 'text-indigo-900 border-b-2 border-indigo-600 bg-sky-50/50' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setTab('cloud')}>☁️ 서버 연결</button>
                        </div>

                        <div className="p-6 overflow-y-auto leading-relaxed text-slate-700 space-y-6">
                            {tab === 'driver' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                        <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2">📌 기본 워크플로우</h3>
                                        <ol className="list-decimal list-inside text-sm space-y-1 text-blue-900">
                                            <li>앱 실행 시 데이터가 <strong>자동 동기화</strong>됩니다. (또는 <strong>[서버에서 받기]</strong>)</li>
                                            <li>배송 목록을 확인하고 출발합니다.</li>
                                            <li>현장에서 <strong>비용(양중비 등)</strong>과 <strong>상태(완료/취소)</strong>를 입력합니다.</li>
                                            <li>작업 내용은 <strong>자동으로 서버에 저장</strong>됩니다. (또는 <strong>[서버에 올리기]</strong>)</li>
                                        </ol>
                                    </div>
                                    
                                    {/* 제어바: 배송카드 아래로 이동 */}
                                    <div className="mt-2">
                                        <div className="flex items-center justify-between px-3 py-2 gap-2">
                                            <div className="flex-1 min-h-[44px] flex items-center">
                                                {isMergeMode && (
                                                    <div className="w-full rounded-xl bg-indigo-50 border border-indigo-100 px-3 py-2 flex items-center justify-between">
                                                        <div>
                                                            <p className="text-xs font-semibold text-indigo-700">합칠 배송지를 선택하세요</p>
                                                            <p className="text-[11px] text-indigo-500">{selectedMergeIds.length}건 선택됨</p>
                                                        </div>
                                                        <button
                                                            disabled={selectedMergeIds.length < 2}
                                                            onClick={handleMergeDeliveries}
                                                            className={`ml-3 px-3 py-1.5 rounded-lg text-xs font-bold ${
                                                                selectedMergeIds.length < 2
                                                                ? 'bg-slate-200 text-slate-400'
                                                                : 'bg-indigo-600 text-white'
                                                            }`}
                                                        >
                                                            하나로 합치기
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-2 flex-shrink-0">
                                                <button
                                                    onClick={() => { setIsMergeMode(!isMergeMode); setSelectedMergeIds([]); }}
                                                    className={`px-3 py-1 rounded-full text-xs font-medium ${isMergeMode ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600'}`}
                                                >
                                                    합치기
                                                </button>
                                                <button
                                                    onClick={() => setView('driver_add')}
                                                    className="w-9 h-9 rounded-full bg-indigo-600 text-white text-xl leading-none"
                                                    title="배송지 추가"
                                                    aria-label="배송지 추가"
                                                >
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        <h4 className="font-bold text-slate-800 border-l-4 border-indigo-500 pl-3">주요 기능</h4>
                                        <ul className="space-y-2 text-sm">
                                            <li className="flex gap-2"><span className="text-indigo-900 font-bold min-w-[60px]">지도 열기</span> 주소 옆 버튼을 누르면 카카오맵/티맵이 실행됩니다.</li>
                                            <li className="flex gap-2"><span className="text-indigo-900 font-bold min-w-[60px]">비용 입력</span> 설치비, 양중비, 내림비, 기타비용을 입력하면 자동 합산됩니다.</li>
                                            <li className="flex gap-2"><span className="text-indigo-900 font-bold min-w-[60px]">상태 변경</span> 배송완료 후 버튼을 눌러 완료/취소/연기/부분배송 상태로 변경합니다.</li>
                                        </ul>
                                    </div>
                                </div>
                            )}

                            {tab === 'admin' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                        <h3 className="font-bold text-emerald-800 mb-2 flex items-center gap-2">📌 관리자 워크플로우</h3>
                                        <ol className="list-decimal list-inside text-sm space-y-1 text-emerald-900">
                                            <li>엑셀 파일로 고객 목록을 <strong>일괄 등록</strong>합니다.</li>
                                            <li><strong>[서버에 올리기]</strong> 버튼으로 데이터를 기사님들에게 공유합니다.</li>
                                            <li>기사님들이 작업을 마치면 <strong>[서버에서 받기]</strong>로 결과를 취합합니다.</li>
                                            <li>최종 내역을 <strong>엑셀 다운로드</strong>하여 정산에 활용합니다.</li>
                                        </ol>
                                    </div>

                                    <div className="space-y-3">
                                        <h4 className="font-bold text-slate-800 border-l-4 border-emerald-500 pl-3">데이터 관리 팁</h4>
                                        <ul className="space-y-2 text-sm">
                                            <li className="flex gap-2"><span className="text-emerald-600 font-bold min-w-[80px]">엑셀 업로드</span> [고객등록] 패널에서 엑셀 파일을 드래그앤드롭 하세요.</li>
                                            <li className="flex gap-2"><span className="text-emerald-600 font-bold min-w-[80px]">수정/삭제</span> 목록의 아이템을 클릭하면 상세 수정이 가능합니다.</li>
                                            <li className="flex gap-2"><span className="text-emerald-600 font-bold min-w-[80px]">초기화</span> [전체 삭제] 기능은 모든 데이터를 지우니 주의하세요.</li>
                                        </ul>
                                    </div>
                                </div>
                            )}

                            {tab === 'cloud' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                        <h3 className="font-bold text-purple-800 mb-2">☁️ Supabase 연결 방법</h3>
                                        <p className="text-sm text-purple-900 mb-2">무료 클라우드 데이터베이스인 Supabase를 연결하여 데이터를 실시간으로 동기화하세요.</p>
                                        <button 
                                            onClick={() => window.open('https://supabase.com', '_blank')}
                                            className="text-xs bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 transition"
                                        >
                                            Supabase 바로가기 ↗
                                        </button>
                                    </div>

                                    <div className="space-y-3 text-sm">
                                        <h4 className="font-bold text-slate-800">1. 프로젝트 생성 & API 키 발급</h4>
                                        <p className="text-slate-600 pl-4 border-l-2 border-slate-200">
                                            Supabase 회원가입 후 'New Project'를 생성합니다.<br/>
                                            Settings > API 메뉴에서 <strong>Project URL</strong>과 <strong>anon / public key</strong>를 복사하세요.
                                        </p>

                                        <h4 className="font-bold text-slate-800">2. 테이블 생성 (SQL Editor)</h4>
                                        <p className="text-slate-600 pl-4 border-l-2 border-slate-200">
                                            좌측 'SQL Editor' 메뉴에서 아래 코드를 실행(Run)하세요.
                                        </p>
                                        <div className="bg-slate-800 text-slate-200 p-3 rounded-lg font-mono text-xs overflow-x-auto">
                                            create table delivery_sync (<br/>
                                            &nbsp;&nbsp;id text primary key,<br/>
                                            &nbsp;&nbsp;data jsonb,<br/>
                                            &nbsp;&nbsp;updated_at timestamptz default now()<br/>
                                            );
                                        </div>

                                        <h4 className="font-bold text-slate-800">3. 앱에 연결</h4>
                                        <p className="text-slate-600 pl-4 border-l-2 border-slate-200">
                                            관리자 모드의 [데이터 도구] > [서버 설정] 버튼을 누르고 URL과 Key를 입력하면 끝!
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="bg-slate-50 p-4 border-t flex justify-end">
                            <button onClick={onClose} className="bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-900 transition">닫기</button>
                        </div>
                    </div>
                </div>
            );
        }

        // [안전장치] Error Boundary
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught an error", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center bg-red-50">
                            <div className="text-6xl mb-4">😵</div>
                            <h1 className="text-2xl font-bold text-red-600 mb-2">오류가 발생했습니다</h1>
                            <p className="text-gray-600 mb-6 max-w-xs mx-auto break-words">{this.state.error?.toString() || "알 수 없는 오류"}</p>
                            <div className="flex flex-col gap-3 w-full max-w-xs">
                                <button 
                                    onClick={() => location.reload()}
                                    className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition"
                                >
                                    앱 재시작
                                </button>
                                <button 
                                    onClick={() => {
                                        if(confirm("정말로 모든 데이터를 초기화하시겠습니까? 복구할 수 없습니다.")) {
                                            localStorage.clear();
                                            location.reload();
                                        }
                                    }}
                                    className="bg-white text-red-500 border border-red-200 px-6 py-3 rounded-xl font-bold hover:bg-red-50 transition"
                                >
                                    데이터 초기화 (문제 해결)
                                </button>
                            </div>
                        </div>
                    );
                }

                return this.props.children; 
            }
        }

        // [메인 앱]
        function App() {
            // [State] Global & UI
            const [fatalError, setFatalError] = useState(null); // [New] Critical Error State
            // [Auth] Auto Login Check
            const [isLoggedIn, setIsLoggedIn] = useState(() => !!localStorage.getItem('delivery_app_session_driver'));
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('delivery_app_session_driver') || null);
            const [adminDriverFilter, setAdminDriverFilter] = useState('all'); // [New] 관리자용 기사 필터
            const [view, setView] = useState('driver');
            const [isTracking, setIsTracking] = useState(false);
            const [deliveries, setDeliveries] = useState([]);
            const [loading, setLoading] = useState(false);
            const [toastMsg, setToastMsg] = useState('');
            const [showMap, setShowMap] = useState(true);

            // [Modal] 완료 축하 메시지 상태
            const [showCompletionModal, setShowCompletionModal] = useState(false);
            const [enableCompletionMessage, setEnableCompletionMessage] = useState(() => {
                // Safe initialization
                return StorageManager.get('mvp_enable_completion_msg', true);
            });

            // [Modal] 삭제 확인 상태
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null); // ids to delete

            // [Modal] 가이드 모달 상태
            const [showGuideModal, setShowGuideModal] = useState(false);

            // [검증] 데이터 검증 리포트 상태
            const [verificationReport, setVerificationReport] = useState(null);
            
            // [정산] 월별 정산 상태
            const [settleMonth, setSettleMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

            // [수정] 배송 건 상세 편집 상태
            const [editTarget, setEditTarget] = useState(null); // 수정할 대상 객체 (복사본)
            const [showEditModal, setShowEditModal] = useState(false);
            const [editTab, setEditTab] = useState('basic'); // basic | cost | history

            // [고객목록] 뷰 모드 및 필터
            const [customerViewMode, setCustomerViewMode] = useState('daily'); // 'daily' | 'monthly'
            const [customerFilterMonth, setCustomerFilterMonth] = useState(new Date().toISOString().slice(0, 7));
            const [customerFilterDate, setCustomerFilterDate] = useState(new Date().toISOString().slice(0, 10));
            const [customerSearchTerm, setCustomerSearchTerm] = useState(''); // [New] 검색어 상태
            const [showAllDates, setShowAllDates] = useState(false); // [New] 전체 날짜 보기 토글

            // [Cloud] 클라우드 동기화 상태
            const [isCloudModalOpen, setCloudModalOpen] = useState(false);
            const [isCloudConnected, setCloudConnected] = useState(false);

            // [Modal] 월별 비용 합계 상태
            const [showMonthlyCostModal, setShowMonthlyCostModal] = useState(false);
            const [monthlyCostTargetMonth, setMonthlyCostTargetMonth] = useState(new Date().toISOString().slice(0, 7));
            const [monthlyViewMode, setMonthlyViewMode] = useState('month');
            const [monthlyCostTargetDay, setMonthlyCostTargetDay] = useState(new Date().toISOString().slice(0, 10));

            // [UI] 엑셀 업로드 파일명
            const [uploadedFileName, setUploadedFileName] = useState('');
            // [UI] 헤더 메뉴 상태
            const [showMenu, setShowMenu] = useState(false);
            // [UI] 배송 카드 접기/펼치기 상태
            const [expandedGroups, setExpandedGroups] = useState({});

            // [New] 기사 이동 기능 상태
            const [moveDriverModal, setMoveDriverModal] = useState({ isOpen: false, targetIds: [], currentDriver: '' });
            const [showManualRegister, setShowManualRegister] = useState(false);
            const [moveDriverTarget, setMoveDriverTarget] = useState(''); // 선택된 새 기사

            // [New] 배송 건 합치기 모드 상태
            const [isMergeMode, setIsMergeMode] = useState(false);
            const [selectedMergeIds, setSelectedMergeIds] = useState([]);
            const [currentOrder, setCurrentOrder] = useState(1);
            
            function mergeSelectedDeliveries() {
                handleMergeDeliveries();
            }

            // [State] History (Undo)
            const [history, setHistory] = useState([]);
            
            // [State] Notice
            const [notice, setNotice] = useState(() => StorageManager.loadNotice());
            
            // [Ref] Remote Update Flag (Infinite Loop Prevention)
            const isRemoteUpdate = useRef(false);

            // [Helper] Add to history
            const pushHistory = (currentData) => {
                setHistory(prev => [...prev.slice(-19), JSON.stringify(currentData)]);
            };

            // [기능] 배송 건 합치기 실행
            const handleMergeDeliveries = () => {
                if (selectedMergeIds.length < 2) {
                    alert("합칠 배송 건을 2개 이상 선택해주세요.");
                    return;
                }
                
                if (!confirm(`선택한 ${selectedMergeIds.length}개의 배송 건을 하나로 합치시겠습니까?\n(첫 번째 선택한 건의 주소와 전화번호로 통합됩니다)`)) return;

                pushHistory(deliveries); // Undo 저장

                // 1. 선택된 배송 건 찾기
                // 순서 보장을 위해 deliveries 배열 순서대로 정렬
                const targets = deliveries.filter(d => selectedMergeIds.includes(d.id));
                const baseItem = targets[0]; // 기준이 될 첫 번째 아이템
                
                // 2. 통합 데이터 생성
                const mergedItem = {
                    ...baseItem,
                    id: baseItem.id, // ID 유지
                    // [New] 분리를 위한 원본 데이터 저장 (깊은 복사)
                    _mergedOriginals: JSON.parse(JSON.stringify(targets)),
                    // 품목 합치기 (기존 detail_items가 있으면 유지하고, 없으면 새로 만듦)
                    detail_items: targets.flatMap(t => {
                        if (t.detail_items && t.detail_items.length > 0) return t.detail_items;
                        return [{
                            item: t.item,
                            install_fee: t.install_fee || 0,
                            yangjung: t.yangjung || 0,
                            naerim: t.naerim || 0,
                            etc_fee: t.etc_fee || 0,
                            checked: t.checked || false
                        }];
                    }),
                    // 비용 합산
                    install_fee: targets.reduce((sum, t) => sum + (t.install_fee || 0), 0),
                    yangjung: targets.reduce((sum, t) => sum + (t.yangjung || 0), 0),
                    naerim: targets.reduce((sum, t) => sum + (t.naerim || 0), 0),
                    etc_fee: targets.reduce((sum, t) => sum + (t.etc_fee || 0), 0),
                    
                    // 대표 품목명 갱신
                    item: targets.map(t => t.item).join(' + '),
                };

                // 3. 기존 목록에서 병합된 건들은 제거하고, 병합된 새 건(사실은 업데이트된 baseItem)만 남김
                // baseItem 자리에 mergedItem을 넣고, 나머지 targets는 제거
                const otherIds = selectedMergeIds.filter(id => id !== baseItem.id);
                const newDeliveries = deliveries.map(d => {
                    if (d.id === baseItem.id) return mergedItem;
                    return d;
                }).filter(d => !otherIds.includes(d.id));

                setDeliveries(newDeliveries);
                StorageManager.saveDeliveries(newDeliveries);
                
                // 초기화
                setIsMergeMode(false);
                setSelectedMergeIds([]);
                setToastMsg("📦 배송 건이 성공적으로 합쳐졌습니다.");
            };

            // [New] 배송 건 분리하기 (Undo Merge)
            const handleSplitDelivery = (mergedId) => {
                if(!confirm("합쳐진 배송 건을 다시 분리하시겠습니까?")) return;
                
                pushHistory(deliveries); // Undo 저장

                const target = deliveries.find(d => d.id === mergedId);
                if (!target) return;

                // Case 1: 원본 데이터가 있는 경우 (완벽 복원)
                if (target._mergedOriginals) {
                    const originals = target._mergedOriginals;
                    const targetIndex = deliveries.findIndex(d => d.id === mergedId);
                    const newDeliveries = [...deliveries];
                    newDeliveries.splice(targetIndex, 1, ...originals);
                    setDeliveries(newDeliveries);
                    StorageManager.saveDeliveries(newDeliveries);
                    setToastMsg("♻️ 배송 건이 원래대로 복구되었습니다.");
                } 
                // Case 2: 원본 데이터가 없는 경우 (detail_items 기반 재생성 - 레거시 지원)
                else if (target.detail_items && target.detail_items.length > 0) {
                    const newItems = target.detail_items.map(dt => ({
                        ...target,
                        id: crypto.randomUUID(), // 새로운 ID 발급
                        item: dt.item,
                        install_fee: dt.install_fee || 0,
                        yangjung: dt.yangjung || 0,
                        naerim: dt.naerim || 0,
                        etc_fee: dt.etc_fee || 0,
                        checked: dt.checked || false,
                        detail_items: [], // 상세 품목 초기화
                        _mergedOriginals: null // 병합 정보 제거
                    }));

                    const targetIndex = deliveries.findIndex(d => d.id === mergedId);
                    const newDeliveries = [...deliveries];
                    newDeliveries.splice(targetIndex, 1, ...newItems);
                    setDeliveries(newDeliveries);
                    StorageManager.saveDeliveries(newDeliveries);
                    setToastMsg("♻️ 배송 건이 개별 항목으로 분리되었습니다.");
                } else {
                    alert("분리할 상세 품목 정보가 없습니다.");
                }
            };

            // [Function] Undo
            const handleUndo = () => {
                if (history.length === 0) return;
                const lastState = JSON.parse(history[history.length - 1]);
                setHistory(prev => prev.slice(0, -1));
                setDeliveries(lastState);
                StorageManager.saveDeliveries(lastState);
                setToastMsg("↩️ 이전 상태로 되돌렸습니다.");
            };

            // [Function] 전화번호 수정
            const handlePhoneEdit = (ids, newPhone) => {
                if (!newPhone) return;
                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) return { ...d, phone: newPhone };
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            };

            // [New] 기사 이동 처리 함수
            const handleMoveDriverConfirm = () => {
                if (!moveDriverTarget) {
                    alert('이동할 기사를 선택해주세요.');
                    return;
                }
                const updated = deliveries.map(d => {
                    if (moveDriverModal.targetIds.includes(d.id)) return { ...d, driver: moveDriverTarget };
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
                setMoveDriverModal({ isOpen: false, targetIds: [], currentDriver: '' });
                setToastMsg(`🚚 ${moveDriverTarget} 기사님에게 배송 건을 전달했습니다.`);
            };

            // [Function] 순서 변경 (Reorder)
            const handleSequenceChange = (targetIds, newSeqStr) => {
                const newSeq = parseInt(newSeqStr);
                if (isNaN(newSeq) || newSeq < 1) return;

                pushHistory(deliveries); // Save state

                // 타겟 아이템들의 현재 순서 찾기 (첫 번째 아이템 기준)
                const targetItem = deliveries.find(d => targetIds.includes(d.id));
                if (!targetItem) return;
                const oldSeq = targetItem.sequence_number;

                if (oldSeq === newSeq) return;

                const newDeliveries = deliveries.map(d => {
                    // 타겟 그룹인 경우 새 순서 부여
                    if (targetIds.includes(d.id)) {
                        return { ...d, sequence_number: newSeq };
                    }
                    // 영향 받는 다른 아이템들 순서 밀기/당기기
                    // Case 1: 아래로 이동 (예: 1 -> 3) => 2, 3번이 1, 2번으로 당겨짐 (-1)
                    if (oldSeq < newSeq) {
                        if (d.sequence_number > oldSeq && d.sequence_number <= newSeq) {
                            return { ...d, sequence_number: d.sequence_number - 1 };
                        }
                    }
                    // Case 2: 위로 이동 (예: 3 -> 1) => 1, 2번이 2, 3번으로 밀림 (+1)
                    else {
                        if (d.sequence_number >= newSeq && d.sequence_number < oldSeq) {
                            return { ...d, sequence_number: d.sequence_number + 1 };
                        }
                    }
                    return d;
                });
                
                // 정렬 및 저장
                newDeliveries.sort((a, b) => a.sequence_number - b.sequence_number);
                setDeliveries(newDeliveries);
                StorageManager.saveDeliveries(newDeliveries);
                // setToastMsg(`순서가 ${oldSeq}번에서 ${newSeq}번으로 변경되었습니다.`);
            };

            // [기능] 데이터 백업 (Excel 다운로드)
            const handleBackupData = async () => {
                try {
                    if (!window.ExcelJS) {
                        alert("ExcelJS 라이브러리가 로드되지 않았습니다. 인터넷 연결을 확인해주세요.");
                        return;
                    }
                    setLoading(true); // 백업 진행 중 표시

                    const workbook = new ExcelJS.Workbook();
                    
                    // 1. 배송 데이터 시트
                    const sheet = workbook.addWorksheet('배송목록');
                    
                    // [수정] 사용자 요청 컬럼 적용
                    sheet.columns = [
                        { header: '날짜', key: 'date', width: 12 },
                        { header: '제품명', key: 'item', width: 30 },
                        { header: '주소', key: 'address', width: 40 },
                        { header: '연락처', key: 'phone', width: 15 },
                        { header: '기사', key: 'driver', width: 10 },
                        { header: '상태', key: 'status_text', width: 12 }, // 정상/연기/취소/부분/완료
                        { header: '설치비', key: 'install_fee', width: 10 },
                        { header: '양중비', key: 'yangjung', width: 10 },
                        { header: '내림비', key: 'naerim', width: 10 },
                        { header: '기타비용', key: 'etc_fee', width: 10 },
                        { header: '메모', key: 'memo', width: 20 },
                        { header: '예약시간', key: 'time', width: 15 },
                        { header: '설치시간', key: 'duration', width: 10 },
                        { header: '순서', key: 'sequence_number', width: 8 },
                        { header: '합치기', key: 'merge_info', width: 15 }
                    ];

                    // [Helper] 데이터 정제: 깨진 문자(�) 등을 '_'로 치환
                    const clean = (val) => {
                        if (!val) return '';
                        return String(val).replace(/\uFFFD/g, '_');
                    };

                    deliveries.forEach(d => {
                        // 상태 로직: 정상/연기/취소/부분/완료
                        let status = '정상';
                        if (d.canceled) {
                            status = d.cancel_type === '연기' ? '연기' : '취소';
                        } else if (d.completed) {
                            status = '완료';
                        } else if (d.partial) {
                            status = '부분';
                        }

                        // 합치기 정보
                        let mergeInfo = '';
                        if (d._mergedOriginals) mergeInfo = '합쳐짐';
                        else if (d.detail_items && d.detail_items.length > 1) mergeInfo = `상세 ${d.detail_items.length}건`;

                        const row = {
                            date: clean(d.date),
                            item: clean(d.item),
                            address: clean(d.address),
                            phone: clean(d.phone),
                            driver: clean(d.driver),
                            status_text: clean(status),
                            install_fee: d.install_fee || 0,
                            yangjung: d.yangjung || 0,
                            naerim: d.naerim || 0,
                            etc_fee: d.etc_fee || 0,
                            memo: clean(d.memo),
                            time: clean(d.time),
                            duration: d.duration ? `${d.duration}분` : '',
                            sequence_number: d.sequence_number || '',
                            merge_info: clean(mergeInfo)
                        };

                        sheet.addRow(row);
                    });

                    // 2. 설정 및 기타 데이터 시트 (유지)
                    const metaSheet = workbook.addWorksheet('설정_및_기타');
                    metaSheet.columns = [{ header: 'Key', key: 'key', width: 20 }, { header: 'Value (JSON)', key: 'value', width: 50 }];
                    
                    metaSheet.addRow({ key: 'notice', value: JSON.stringify(notice) });
                    metaSheet.addRow({ key: 'startPoint', value: JSON.stringify(StorageManager.get('mvp_start_point')) });
                    metaSheet.addRow({ key: 'settings', value: JSON.stringify(StorageManager.get('mvp_settings')) });
                    metaSheet.addRow({ key: 'app_version', value: "2.1" });
                    metaSheet.addRow({ key: 'backup_date', value: new Date().toISOString() });

                    // 파일 생성 및 다운로드
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = window.URL.createObjectURL(blob);
                    const anchor = document.createElement('a');
                    anchor.href = url;
                    anchor.download = `delivery_backup_${new Date().toISOString().slice(0,10)}.xlsx`;
                    anchor.click();
                    window.URL.revokeObjectURL(url);
                    
                    setShowMenu(false);
                    setLoading(false);
                    setToastMsg("📊 엑셀 백업이 완료되었습니다.");
                } catch (e) {
                    console.error("Backup failed", e);
                    alert("백업 중 오류가 발생했습니다: " + e.message);
                    setLoading(false);
                }
            };

            // [기능] 주소 설정 핸들러 (출발지 + 도착지)
            const handleUpdateStartPoint = async () => {
                setShowMenu(false);
                const currentAddr = startPoint ? startPoint.address : "";
                const addr = prompt("새로운 출발지 주소를 입력하세요:", currentAddr);
                if (!addr || addr === currentAddr) return;
                
                try {
                    setLoading(true);
                    // Strict Mode: 정확한 좌표를 못 찾으면 Fallback(시청 좌표) 대신 null 반환
                    const coords = await geocodeAddress(addr, true);
                    if (coords) {
                        const newPoint = { address: addr, lat: coords.lat, lng: coords.lng };
                        setStartPoint(newPoint);
                        StorageManager.set('mvp_start_point', newPoint);
                        
                        // [변경] 도착지(홈) 설정 로직 통합
                        if(confirm("도착지(홈)도 함께 설정하시겠습니까?")) {
                            const currentEndAddr = endPoint ? endPoint.address : "";
                            const endAddr = prompt("도착지(홈) 주소를 입력하세요:", currentEndAddr || addr);
                            if (endAddr) {
                                let endCoords = await geocodeAddress(endAddr, true);
                                if (!endCoords) endCoords = await geocodeAddress(endAddr, false);
                                if (endCoords) {
                                    const newEndPoint = { address: endAddr, lat: endCoords.lat, lng: endCoords.lng, type: 'destination' };
                                    setEndPoint(newEndPoint);
                                    StorageManager.set('mvp_end_point', newEndPoint);
                                } else {
                                    alert("도착지 주소를 찾을 수 없습니다.");
                                }
                            }
                        }
                    } else {
                        alert("주소를 찾을 수 없습니다.\n도로명 주소와 건물번호를 포함하여 정확히 입력해주세요.");
                    }
                } catch(e) {
                    console.error(e);
                    alert("주소 검색 중 오류가 발생했습니다.");
                } finally {
                    setLoading(false);
                }
            };

            // [PWA] Install Prompt Logic
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            useEffect(() => {
                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallApp = async () => {
                if (!deferredPrompt) {
                    alert("아이폰(Safari) 또는 일부 브라우저는 수동 설치가 필요합니다.\n\n[아이폰]\n하단 공유 버튼(↑) > '홈 화면에 추가' 선택\n\n[안드로이드]\n브라우저 메뉴(⋮) > '앱 설치' 또는 '홈 화면에 추가' 선택");
                    return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    setDeferredPrompt(null);
                }
            };

            const handleUpdateEndPoint = async () => {
                setShowMenu(false);
                const currentAddr = endPoint ? endPoint.address : "";
                const addr = prompt("새로운 도착지(홈) 주소를 입력하세요:", currentAddr);
                if (!addr || addr === currentAddr) return;
                
                try {
                    setLoading(true);
                    let coords = await geocodeAddress(addr, true);
                    if (!coords) coords = await geocodeAddress(addr, false);
                    if (coords) {
                        const newPoint = { address: addr, lat: coords.lat, lng: coords.lng, type: 'destination' };
                        setEndPoint(newPoint);
                        
                        // [변경] 기사별 도착지 분리 저장
                        const key = currentUser ? `mvp_end_point_${currentUser}` : 'mvp_end_point';
                        StorageManager.set(key, newPoint);
                        // StorageManager.set('mvp_end_point', newPoint); // Deprecated common key
                        
                        // alert("도착지가 변경되었습니다.");
                    } else {
                        alert("주소를 찾을 수 없습니다.\n도로명 주소와 건물번호를 포함하여 정확히 입력해주세요.");
                    }
                } catch(e) {
                    console.error(e);
                    alert("주소 검색 중 오류가 발생했습니다.");
                } finally {
                    setLoading(false);
                }
            };

            // [New] Data Initialization & Sync Strategy
            useEffect(() => {
                const initializeData = async () => {
                    console.log("🚀 Initializing Data...");

                    // 1. Load Local Data First (Instant UI)
                    let currentData = StorageManager.loadDeliveries();
                    if (currentData && currentData.length > 0) {
                        setDeliveries(currentData);
                    } else {
                        currentData = [];
                    }

                    // 2. Initialize Cloud & Sync
                    const params = new URLSearchParams(window.location.search);
                    const configUrl = params.get('config_url');
                    const configKey = params.get('config_key');
                    
                    let initialized = false;

                    if (configUrl && configKey) {
                        try {
                            let fixedUrl = configUrl.trim();
                            if (!fixedUrl.startsWith('http://') && !fixedUrl.startsWith('https://')) {
                                fixedUrl = 'https://' + fixedUrl;
                            }

                            if (CloudManager.init(fixedUrl, configKey)) {
                                StorageManager.set('mvp_supabase_config', { url: fixedUrl, key: configKey });
                                initialized = true;
                                setCloudConnected(true);
                                alert("✅ 서버 설정이 자동으로 적용되었습니다!");
                                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                                window.history.replaceState({path: newUrl}, '', newUrl);
                            }
                        } catch(e) {
                            console.error("Auto Config Failed", e);
                        }
                    } 
                    
                    if (!initialized) {
                        const config = StorageManager.get('mvp_supabase_config');
                        if (config && config.url && config.key) {
                            initialized = CloudManager.init(config.url, config.key);
                        } else if (Config.SUPABASE_URL && !Config.SUPABASE_URL.includes("YOUR_")) {
                             initialized = CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
                        }
                        setCloudConnected(initialized);
                    }

                    if (initialized) {
                        try {
                            // 공지사항 동기화
                            const serverNotice = await CloudManager.pullNotice();
                            if (serverNotice) {
                                setNotice(serverNotice);
                                StorageManager.saveNotice(serverNotice);
                            }

                            // 데이터 동기화 (The Truth)
                            const serverData = await CloudManager.pull();
                            if (serverData && Array.isArray(serverData)) {
                                console.log("☁️ Initial Sync from Supabase:", serverData.length);
                                if (JSON.stringify(currentData) !== JSON.stringify(serverData)) {
                                    currentData = serverData; // Update reference for Smart Date
                                    setDeliveries(serverData);
                                    localStorage.setItem(Config.STORAGE_KEYS.DELIVERIES, JSON.stringify(serverData));
                                    setToastMsg("☁️ 최신 배송 정보를 서버에서 불러왔습니다.");
                                }
                            }
                        } catch (e) {
                            console.warn("Initial Cloud Pull Failed", e);
                        }
                    }

                    // 3. Smart Date Logic
                    if (Array.isArray(currentData) && currentData.length > 0) {
                        let relevantData = currentData;
                        const savedDriver = localStorage.getItem('delivery_app_session_driver');
                        if (savedDriver && savedDriver !== 'admin') {
                            const myData = currentData.filter(d => d.driver === savedDriver);
                            if (myData.length > 0) relevantData = myData;
                        }

                        const availableDates = [...new Set(relevantData.map(d => d.date))].sort().reverse();
                        const today = getLocalDateString();
                        
                        if (!availableDates.includes(today) && availableDates.length > 0) {
                            console.log(`[Smart Date] Auto-switching to ${availableDates[0]}`);
                            setForm(prev => ({ ...prev, date: availableDates[0] }));
                        }
                    }

                    // 4. Load Settings (Start/End Points)
                    // Start Point
                    let start = StorageManager.get('mvp_start_point');
                    if (!start) {
                        start = { ...Config.FIXED_START };
                        // Fallback Geocoding omitted for speed
                        StorageManager.set('mvp_start_point', start);
                    }
                    setStartPoint(start);

                    // End Point
                    const sessionDriver = localStorage.getItem('delivery_app_session_driver');
                    const endKey = sessionDriver ? `mvp_end_point_${sessionDriver}` : 'mvp_end_point';
                    let end = StorageManager.get(endKey);
                    if (end && end.type !== 'destination') {
                        end = { ...end, type: 'destination' };
                    }
                    setEndPoint(end);

                    // Notice
                    const savedNotice = StorageManager.get('mvp_notice', '');
                    if (!notice && savedNotice) setNotice(savedNotice);

                    console.log("✅ Initialization Complete");
                };

                initializeData();
            }, []);

            // [Cloud] 동기화 핸들러
            const handleCloudSync = async (direction) => {
                if (!isCloudConnected) {
                    // 연결 안됨 -> 즉시 설정 모달 오픈 (Alert 제거)
                    setCloudModalOpen(true);
                    return;
                }

                try {
                    setLoading(true);
                    if (direction === 'push') {
                        if (confirm("현재 데이터를 서버에 저장하시겠습니까? (서버의 기존 데이터는 덮어씌워집니다)")) {
                            await Promise.all([
                                CloudManager.push(deliveries),
                                CloudManager.pushNotice(notice)
                            ]);
                            alert("☁️ 서버에 안전하게 저장되었습니다.");
                        }
                    } else if (direction === 'pull') {
                        if (confirm("서버에서 데이터를 불러오시겠습니까? (현재 작업 중인 내용은 사라질 수 있습니다)")) {
                            const [data, serverNotice] = await Promise.all([
                                CloudManager.pull(),
                                CloudManager.pullNotice()
                            ]);
                            
                            if (data) {
                                setDeliveries(data);
                                StorageManager.saveDeliveries(data);
                                
                                if (serverNotice) {
                                    setNotice(serverNotice);
                                    StorageManager.saveNotice(serverNotice);
                                }
                                
                                alert("☁️ 서버에서 데이터를 성공적으로 불러왔습니다.");
                            } else {
                                alert("서버에 저장된 데이터가 없습니다.");
                            }
                        }
                    }
                } catch (e) {
                    console.error(e);
                    alert(`오류 발생: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // [기능] 공지사항 저장
            const handleNoticeSave = async (newNotice) => {
                setNotice(newNotice);
                StorageManager.saveNotice(newNotice);
                
                // 클라우드 동기화 (관리자가 저장하면 즉시 서버로 전송)
                if (CloudManager.client) {
                    await CloudManager.pushNotice(newNotice);
                }

                setToastMsg("📢 공지사항이 업데이트되었습니다.");
            };

            // [기능] 고객 배달 완료 내역 엑셀 다운로드
            async function downloadCustomerExcel() {
                const targetMonth = customerFilterMonth;
                // [Server Validation Simulation] 데이터 유효성 검증
                const filtered = deliveries.filter(d => String(d.date || '').startsWith(targetMonth));
                
                if (filtered.length === 0) {
                    alert("선택한 월에 배달 데이터가 없습니다.");
                    return;
                }

                try {
                    const workbook = new ExcelJS.Workbook();
                    const sheet = workbook.addWorksheet('배송현황');
                    
                    sheet.columns = [
                        { header: '상태', key: 'status', width: 10 },
                        { header: '배송일', key: 'date', width: 15 },
                        { header: '주문번호', key: 'order_number', width: 15 }, // [New]
                        { header: '송장번호', key: 'invoice_number', width: 15 }, // [New]
                        { header: '고객명(상품명)', key: 'item', width: 30 },
                        { header: '전화번호', key: 'phone', width: 15 },
                        { header: '주소', key: 'address', width: 40 },
                        { header: '센터', key: 'center', width: 10 }, // [New]
                        { header: '지역', key: 'region', width: 10 }, // [New]
                        { header: '담당기사', key: 'driver', width: 10 }, // [New]
                        { header: '설치비', key: 'install_fee', width: 12 },
                        { header: '양중비', key: 'yangjung', width: 12 },
                        { header: '내림비', key: 'naerim', width: 12 },
                        { header: '기타비용', key: 'etc_fee', width: 12 },
                        { header: '메모', key: 'memo', width: 30 },
                    ];
                    
                    // 스타일
                    sheet.getRow(1).font = { bold: true };
                    sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
                    
                    // 데이터 추가
                    filtered.forEach(d => {
                        let status = '대기';
                        if (d.completed) status = '완료';
                        else if (d.partial) status = '부분';
                        else if (d.canceled) {
                            status = d.cancel_type === 'postpone' ? '연기' : '취소';
                        }

                        sheet.addRow({
                            status: status,
                            date: d.date,
                            order_number: d.order_number || '', // [New]
                            invoice_number: d.invoice_number || '', // [New]
                            item: d.item,
                            phone: d.phone,
                            address: d.address,
                            center: d.center || '', // [New]
                            region: d.region || '', // [New]
                            driver: d.driver || '', // [New]
                            install_fee: d.install_fee || 0,
                            yangjung: d.yangjung || 0,
                            naerim: d.naerim || 0,
                            etc_fee: d.etc_fee || 0,
                            memo: d.memo || ''
                        });
                    });

                    // 숫자 포맷
                    ['install_fee', 'yangjung', 'naerim', 'etc_fee'].forEach(key => {
                        sheet.getColumn(key).numFmt = '#,##0';
                    });

                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `배송현황_${targetMonth.replace('-', '')}.xlsx`;
                    a.click();
                } catch(e) {
                    console.error(e);
                    alert("엑셀 다운로드 중 오류가 발생했습니다.");
                }
            }

            // [New] 기사별 도착지(EndPoint) 로드
            useEffect(() => {
                if (view === 'driver' && currentUser) {
                    const key = `mvp_end_point_${currentUser}`;
                    let end = StorageManager.get(key);
                    
                    if (end && end.type !== 'destination') {
                        end = { ...end, type: 'destination' };
                    }
                    setEndPoint(end || null);
                }
            }, [currentUser, view]);

            // [New] 기사 모드 진입 시 도착지 미설정 알림 (삭제됨 - 사용자 요청)
            /*
            useEffect(() => {
                // [Fix] 로그인 상태(isLoggedIn)일 때만 알림 표시
                if (isLoggedIn && view === 'driver' && !loading && !endPoint && !fatalError) {
                    const timer = setTimeout(() => {
                        // 중복 실행 방지를 위해 확인
                        const key = currentUser ? `mvp_end_point_${currentUser}` : 'mvp_end_point';
                        const currentEnd = StorageManager.get(key);
                        if (!currentEnd) {
                            if(confirm("도착지(홈)가 설정되지 않았습니다.\n퇴근 경로 최적화를 위해 도착지를 설정하시겠습니까?")) {
                                handleUpdateEndPoint();
                            }
                        }
                    }, 1500); // 1.5초 딜레이
                    return () => clearTimeout(timer);
                }
            }, [view, loading, endPoint, currentUser, isLoggedIn]);
            */

            // 토스트 메시지 자동 숨김
            useEffect(() => {
                if (toastMsg) {
                    const timer = setTimeout(() => setToastMsg(''), 3000);
                    return () => clearTimeout(timer);
                }
            }, [toastMsg]);

            

            
            // [Auto Save] deliveries 변경 시 로컬 스토리지 저장 및 서버 동기화
            useEffect(() => {
                if (isRemoteUpdate.current) {
                    console.log('[AutoSave] Skipped cloud push due to remote update');
                    localStorage.setItem(Config.STORAGE_KEYS.DELIVERIES, JSON.stringify(deliveries));
                    isRemoteUpdate.current = false;
                    return;
                }

                if (deliveries.length > 0) {
                    StorageManager.saveDeliveries(deliveries);
                }
            }, [deliveries]);

            // [New] Realtime Subscription (Server -> Client)
            useEffect(() => {
                let channel = null;

                const initAndSubscribe = () => {
                    // Ensure connection
                    if (!CloudManager.isConnected) {
                        CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
                    }
                    
                    if (CloudManager.isConnected && CloudManager.client) {
                        console.log('[Realtime] Subscribing to delivery_sync...');
                        channel = CloudManager.client
                            .channel('public:delivery_sync')
                            .on('postgres_changes', 
                                { event: '*', schema: 'public', table: 'delivery_sync' }, 
                                (payload) => {
                                    if (payload.new && payload.new.id === 'master') {
                                        const serverData = payload.new.data;
                                        if (Array.isArray(serverData)) {
                                            setDeliveries(prev => {
                                                const currentStr = JSON.stringify(prev);
                                                const serverStr = JSON.stringify(serverData);
                                                if (currentStr !== serverStr) {
                                                    console.log('[Realtime] Syncing from server...');
                                                    isRemoteUpdate.current = true;
                                                    setToastMsg("☁️ 실시간 동기화됨");
                                                    return serverData;
                                                }
                                                return prev;
                                            });
                                        }
                                    }
                                }
                            )
                            .subscribe();
                    }
                };

                initAndSubscribe();

                return () => {
                    if (channel && CloudManager.client) CloudManager.client.removeChannel(channel);
                };
            }, []);
            
            // [Helper] Local Date String (KST Support)
            const getLocalDateString = () => {
                const d = new Date();
                const offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().split('T')[0];
            };

            // 상태: 출발지, 도착지, 날짜
            const [startPoint, setStartPoint] = useState(null); // { lat, lng, address }
            const [endPoint, setEndPoint] = useState(null); // { lat, lng, address }
            const [targetDate, setTargetDate] = useState(parseCustomDate(null));

            // 입력 폼
            const [form, setForm] = useState({ 
                date: getLocalDateString(), 
                item: '', 
                phone: '', 
                address: '', 
                install_fee: 0,
                yangjung: 0,
                naerim: 0,
                etc_fee: 0,
                reservationDate: '',
                reservationTime: '',
                isInstallNeeded: false,
                installTime: '',
                memo: ''
            });

            // [Expansion 3] 실시간 위치 추적 로직 (Always On in Background)
            useEffect(() => {
                let watchId;
                // Driver 모드일 때 항상 작동 (MVP: isTracking 상태 의존성 제거 및 기본 활성화)
                if (view === 'driver') {
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            // console.log(`[Tracking] Location Update: ${latitude}, ${longitude}`); // Log noise reduction
                            // 백엔드 전송 시뮬레이션
                        },
                        (error) => console.error(error),
                        { enableHighAccuracy: true }
                    );
                }
                return () => { if(watchId) navigator.geolocation.clearWatch(watchId); };
            }, [view]);

            // [Initial Data Load] Unified & Safe
            useEffect(() => {
                async function loadData() {
                    try {
                        console.log("🚀 Initializing Data...");
                        
                        // 1. Load Deliveries
                        let data = StorageManager.loadDeliveries();
                        
                        // [New] Server Sync (Mobile Support) - PC에서 업로드한 데이터 가져오기
                        try {
                            const serverData = await StorageManager.syncFromServer();
                            if (serverData && Array.isArray(serverData) && serverData.length > 0) {
                                console.log(`[Sync] Server data applied: ${serverData.length} items`);
                                data = serverData;
                            }
                        } catch (err) {
                            console.warn("[Sync] Server sync skipped", err);
                        }

                        // [New] Supabase Sync (Cross-Network Support) - 다른 와이파이 기사 지원
                        if (CloudManager.isConnected) {
                            try {
                                const cloudData = await CloudManager.pull();
                                if (cloudData && Array.isArray(cloudData) && cloudData.length > 0) {
                                    console.log(`[Sync] Supabase data applied: ${cloudData.length} items`);
                                    data = cloudData; // Cloud data overrides local server data (assumed fresher/more accessible)
                                }
                            } catch (err) {
                                console.warn("[Sync] Supabase sync failed", err);
                            }
                        }
                        
                        // [안전장치] 데이터 정규화 (날짜 필드 문자열 보장)
                        if (Array.isArray(data)) {
                            data = data.map(d => ({
                                ...d,
                                date: typeof d.date === 'string' ? d.date : String(d.date || getLocalDateString())
                            }));
                        }

                        // [Cloud] 클라우드 연결 시 자동 동기화 (옵션) - 현재는 수동 동기화 권장
                        setDeliveries(Array.isArray(data) ? data : []);

                        // [Smart Date] 데이터가 있는 최신 날짜로 자동 이동
                        if (Array.isArray(data) && data.length > 0) {
                            // [Fix] 기사 모드인 경우, 본인에게 배정된 데이터가 있는 날짜 우선
                            let relevantData = data;
                            const savedDriver = localStorage.getItem('delivery_app_session_driver'); // Closure safe
                            if (savedDriver && savedDriver !== 'admin') {
                                const myData = data.filter(d => d.driver === savedDriver);
                                if (myData.length > 0) relevantData = myData;
                            }

                            const availableDates = [...new Set(relevantData.map(d => d.date))].sort().reverse();
                            const today = getLocalDateString();
                            
                            // [Smart Date V2] 데이터 자동 이동 로직 개선
                            // 1. 오늘 날짜에 (나의) 데이터가 있으면 유지 (우선순위 1)
                            if (availableDates.includes(today)) {
                                // Stay on today
                            } else if (availableDates.length > 0) {
                                // 2. 오늘 데이터가 없으면, 가장 최신 데이터 날짜로 이동 (과거 기록 확인)
                                // 사용자 요청: 미완료 업무 우선 표시 로직 제거 -> 단순 최신 날짜 이동
                                console.log(`[Smart Date] Auto-switching to ${availableDates[0]} (Latest data)`);
                                setForm(prev => ({ ...prev, date: availableDates[0] }));
                            }
                        }

                        // 2. Load Start Point
                        let start = StorageManager.get('mvp_start_point');
                        if (!start) {
                            start = { ...Config.FIXED_START };
                            try {
                                const coords = await geocodeAddress(Config.FIXED_START.address);
                                if (coords && (coords.lat !== 37.5665 || coords.lng !== 126.9780)) {
                                     start = { ...coords, address: Config.FIXED_START.address };
                                }
                            } catch(e) { console.warn("Start point geocoding fallback"); }
                            StorageManager.set('mvp_start_point', start);
                        }
                        setStartPoint(start);

                        // 3. Load End Point
                        const sessionDriver = localStorage.getItem('delivery_app_session_driver');
                        const endKey = sessionDriver ? `mvp_end_point_${sessionDriver}` : 'mvp_end_point';
                        let end = StorageManager.get(endKey);
                        
                        // [변경] 도착지 자동 설정 해제 (User Request)
                        // 기사가 최초 로그인 시 직접 설정하도록 유도하기 위해 기본값(FIXED_END) 적용 로직 제거
                        
                        // [Safety] 기존 데이터에 type이 없는 경우 보정
                        if (end && end.type !== 'destination') {
                            end = { ...end, type: 'destination' };
                        }
                        setEndPoint(end);
                        
                        // 4. Load Notice
                        const savedNotice = StorageManager.get('mvp_notice', '');
                        setNotice(savedNotice);
                        
                        console.log("✅ Initialization Complete - Refactored & Verified");

                    } catch (e) {
                        console.error("Critical Data Loading Error", e);
                        setFatalError({ message: e.message || "Failed to load application data." });
                    }
                }
                loadData();
            }, []);

            // [New] Driver Change Mode State
            const [isDriverChangeMode, setIsDriverChangeMode] = useState(false);
            const [selectedDriverChangeIds, setSelectedDriverChangeIds] = useState(new Set());

            const toggleDriverSelection = (ids) => {
                const newSet = new Set(selectedDriverChangeIds);
                const allSelected = ids.every(id => newSet.has(id));
                
                if (allSelected) {
                    ids.forEach(id => newSet.delete(id));
                } else {
                    ids.forEach(id => newSet.add(id));
                }
                setSelectedDriverChangeIds(newSet);
            };

            const handleBatchDriverChange = () => {
                 if (selectedDriverChangeIds.size === 0) {
                    alert('기사를 변경할 배송 건을 선택해주세요.');
                    return;
                }

                const newName = prompt('선택한 배송 건의 담당 기사 이름을 입력해주세요:', currentUser);
                if (!newName || newName.trim() === '') return;

                if (confirm(`선택한 ${selectedDriverChangeIds.size}건의 담당 기사를 '${newName}'(으)로 변경하시겠습니까?`)) {
                    const updated = deliveries.map(d => {
                        if (selectedDriverChangeIds.has(d.id)) {
                            return { ...d, driver: newName };
                        }
                        return d;
                    });

                    setDeliveries(updated);
                    StorageManager.saveDeliveries(updated);
                    setIsDriverChangeMode(false);
                    setSelectedDriverChangeIds(new Set());
                    setToastMsg(`🚚 담당 기사가 변경되었습니다.`);
                    
                    // 만약 현재 로그인한 사용자가 본인의 배송 건을 다른 사람에게 넘겼다면,
                    // 화면 갱신이 필요할 수 있음 (이미 리액트 상태 변경으로 처리됨)
                }
            };

            // [Sync] Form Date -> Target Date (Dashboard Date Filter)
            useEffect(() => {
                setTargetDate(form.date);
            }, [form.date]);

            // [Render] Fatal Error Screen
            if (fatalError) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-red-600 text-white font-sans">
                        <div className="max-w-md w-full bg-white text-red-600 rounded-xl shadow-2xl p-8 text-center">
                            <h1 className="text-3xl font-bold mb-4">Critical Error</h1>
                            <p className="mb-6 text-gray-700 break-words">{fatalError.message}</p>
                            <button onClick={() => { StorageManager.clearAll(); window.location.reload(); }} 
                                    className="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition shadow-lg">
                                Full Reset & Reload
                            </button>
                        </div>
                    </div>
                );
            }



            // [로직] 데이터 그룹화 및 정렬 (Active/Inactive 분리 + Active 거리순 정렬)
            const groupedDeliveries = useMemo(() => {
                // 1. 날짜 필터링 및 권한 필터링 (관리자는 전체, 기사는 본인 배정 건만)
                const filtered = deliveries.filter(d => {
                    // [Fix] targetDate가 'all'이면 날짜 필터 무시
                    // [New] '전체 날짜 보기' 체크 시 날짜 필터 무시
                    const dateMatch = showAllDates || targetDate === 'all' || d.date === targetDate;
                    
                    let driverMatch = true;
                    if (currentUser === 'admin' || view === 'admin') { // [Fix] 관리자 모드일 때도 전체 조회 권한 부여
                        // 관리자: 필터 상태에 따라 조회
                        if (adminDriverFilter === 'all') driverMatch = true;
                        else if (adminDriverFilter === 'unassigned') driverMatch = !d.driver;
                        else driverMatch = d.driver === adminDriverFilter;
                    } else {
                        // 기사: 본인 배정 건만 조회 (엄격 모드)
                        driverMatch = (d.driver && d.driver === currentUser);
                    }
                    
                    return dateMatch && driverMatch;
                });
                
                // 2. 주소(좌표) + 전화번호 기준 그룹화 (동일 장소라도 연락처 다르면 별도 배송)
                const groups = {};
                filtered.forEach(d => {
                    const isDefault = d.lat === 37.5665 && d.lng === 126.9780;
                    // 좌표/주소 + 전화번호로 유니크 키 생성
                    const key = isDefault 
                        ? `${d.address.trim()}_${d.phone}` 
                        : `${d.lat},${d.lng}_${d.phone}`;

                    if (!groups[key]) {
                        // 초기 그룹 생성
                        groups[key] = { 
                            ...d, 
                            items: d.detail_items ? d.detail_items.map((it, idx) => ({...it, _oid: d.id, _oidx: idx})) : [{ item: d.item, settlement_amount: d.settlement_amount, checked: d.checked, _oid: d.id, _oidx: -1 }], // 상세 품목 리스트
                            ids: [d.id],
                            count: 1, // 배송 건수 (Record 수)
                            completed: d.completed || false,
                            partial: d.partial || false,
                            canceled: d.canceled || false,
                            cancel_type: d.cancel_type || null,
                            install_fee: (d.install_fee || 0),
                            yangjung: (d.yangjung || 0),
                            naerim: (d.naerim || 0),
                            settlement_amount: (d.settlement_amount || 0), // 정산금액 합계
                            // [New] 합쳐진 건의 ID 저장 (분리하기 기능용 - 레거시 데이터 호환)
                            mergedId: (d._mergedOriginals || (d.detail_items && d.detail_items.length > 1)) ? d.id : null
                        };
                    } else {
                        // 기존 그룹에 병합
                        if (d.detail_items) {
                            groups[key].items.push(...d.detail_items.map((it, idx) => ({...it, _oid: d.id, _oidx: idx})));
                        } else {
                            groups[key].items.push({ item: d.item, settlement_amount: d.settlement_amount, checked: d.checked, _oid: d.id, _oidx: -1 });
                        }
                        
                        groups[key].ids.push(d.id);
                        groups[key].count++;
                        groups[key].install_fee += (d.install_fee || 0);
                        groups[key].yangjung += (d.yangjung || 0);
                        groups[key].naerim += (d.naerim || 0);
                        groups[key].settlement_amount += (d.settlement_amount || 0);
                        
                        if (!d.completed) groups[key].completed = false;
                        if (!d.canceled) groups[key].canceled = false; 
                        
                        // [Fix] Merge Status Details
                        if (d.partial) groups[key].partial = true;
                        if (d.cancel_type) groups[key].cancel_type = d.cancel_type;
                            if (d.unattended) groups[key].unattended = true;

                        // [New] 합쳐진 건이 나중에 추가될 경우 ID 업데이트 (레거시 데이터 호환)
                        if (d._mergedOriginals || (d.detail_items && d.detail_items.length > 1)) groups[key].mergedId = d.id;
                    }
                });
                
                const allGroups = Object.values(groups);

                // 3. Active / Inactive 분리
                // [수정] 완료된 항목도 'Active' 그룹에 포함하여 TSP 경로 계산 및 순번(sequence_number)을 유지함.
                // Inactive는 '취소된' 항목만 해당됨.
                // 연기(cancel_type === 'postpone')는 취소와 동일하게 비활성(inactive)로 분류하여 맨 뒤로 이동
                const active = allGroups.filter(g => !g.canceled && g.cancel_type !== 'postpone'); 
                const inactive = allGroups.filter(g => g.canceled || g.cancel_type === 'postpone');

                // 4. Active 그룹 정렬 (예약시간 우선 -> TSP Nearest Neighbor)
                // [New] 예약 시간 있는 건은 최우선, 나머지는 '현재 위치에서 가장 가까운 곳'으로 연결
                let sortedActive = [];
                const withTime = active.filter(x => x.time);
                const withoutTime = active.filter(x => !x.time);

                // 4-1. 예약시간 오름차순
                withTime.sort((a, b) => a.time.localeCompare(b.time));
                sortedActive = [...withTime];

                // 4-2. Nearest Neighbor (Greedy TSP)
                if (withoutTime.length > 0) {
                    if (startPoint) {
                        // 시작점 설정: 예약 건이 있으면 마지막 예약 건 위치, 없으면 센터(출발지)
                        let currentPos = sortedActive.length > 0 ? sortedActive[sortedActive.length - 1] : startPoint;
                        
                        // 복사본 생성 (splice 사용을 위해)
                        const remaining = [...withoutTime];
                        
                        // [Optimization] 수동 순서(sequence_number)가 이미 지정된 경우 TSP 제외? 
                        // -> 사용자 요청이 "1번은 센터에서 제일 가까운 곳..."이므로 전체 재정렬로 간주.
                        // 단, 기존 로직상 sequence_number가 우선순위가 있었으나, 
                        // 이번 요청("변경해줘")에 따라 거리 기반 자동 정렬을 우선시함.

                        while (remaining.length > 0) {
                            let nearestIdx = -1;
                            let minDist = Infinity;

                            for (let i = 0; i < remaining.length; i++) {
                                const item = remaining[i];
                                const dist = getDistance(currentPos.lat, currentPos.lng, item.lat, item.lng);
                                if (dist < minDist) {
                                    minDist = dist;
                                    nearestIdx = i;
                                }
                            }

                            if (nearestIdx !== -1) {
                                const nextItem = remaining[nearestIdx];
                                sortedActive.push(nextItem);
                                currentPos = nextItem; // 다음 기준점 이동
                                remaining.splice(nearestIdx, 1);
                            } else {
                                // [Safety] 거리 계산 실패 등으로 남은 항목이 있다면 모두 추가 (누락 방지)
                                sortedActive.push(...remaining);
                                break; 
                            }
                        }
                    } else {
                        // 좌표 없으면 기존 방식(수동 순서) 유지
                        withoutTime.sort((a, b) => (a.sequence_number || 99999) - (b.sequence_number || 99999));
                        sortedActive = [...sortedActive, ...withoutTime];
                    }
                }

                // 거리 정보 할당 (UI 표시용)
                if (startPoint) {
                    sortedActive.forEach(item => {
                        // 단순히 센터와의 거리만 표시할지, 경로상 거리를 표시할지?
                        // UI에서는 보통 '센터로부터의 거리'를 보여주는 것이 일반적임.
                        // 하지만 정렬은 '경로순'으로 되었음.
                        item.distanceFromStart = getDistance(startPoint.lat, startPoint.lng, item.lat, item.lng);
                    });
                }

                // 5. 순번 할당 및 속성 추가
                const finalActive = sortedActive.map((g, i) => ({
                    ...g,
                    sequence_number: i + 1,
                    is_active: true
                }));

                const finalInactive = inactive.map(g => ({
                    ...g,
                    sequence_number: null,
                    is_active: false
                }));

                return [...finalActive, ...finalInactive];
            }, [deliveries, targetDate, startPoint, currentUser, adminDriverFilter, view]); // [Fix] view 의존성 추가

            // [Sync] 계산된 순서(TSP 또는 수동)를 데이터 상태에 반영 (Persist Order)
            useEffect(() => {
                if (!groupedDeliveries.length) return;
                
                let needsUpdate = false;
                const updates = {}; 

                groupedDeliveries.forEach(g => {
                    if (g.is_active && g.sequence_number) {
                        g.ids.forEach(id => {
                             const item = deliveries.find(d => d.id === id);
                             if (item && item.sequence_number !== g.sequence_number) {
                                 needsUpdate = true;
                                 updates[id] = g.sequence_number;
                             }
                        });
                    }
                });
                
                if (needsUpdate) {
                     setDeliveries(prev => {
                         const next = prev.map(d => {
                             if (updates[d.id]) return { ...d, sequence_number: updates[d.id] };
                             return d;
                         });
                         StorageManager.saveDeliveries(next);
                         return next;
                     });
                }
            }, [groupedDeliveries, deliveries]);

            useEffect(() => {
                const toGeocode = deliveries.filter(d => {
                    const invalid = !d.lat || isNaN(d.lat) || !d.lng || isNaN(d.lng);
                    const attempted = d.geocode_attempted === true;
                    const dateMatch = showAllDates || targetDate === 'all' || d.date === targetDate;
                    return invalid && !attempted && dateMatch;
                });
                if (toGeocode.length === 0) return;
                (async () => {
                    const updates = [];
                    for (const d of toGeocode.slice(0, 10)) {
                        const addr = formatAddressDisplay(d.address || '');
                        let coords = await geocodeAddress(addr, true);
                        if (!coords) coords = await geocodeAddress(addr, false);
                        if (coords) {
                            updates.push({ id: d.id, lat: coords.lat, lng: coords.lng, geocode_attempted: true });
                        } else {
                            updates.push({ id: d.id, geocode_attempted: true });
                        }
                        await new Promise(r => setTimeout(r, 300));
                    }
                    if (updates.length > 0) {
                        setDeliveries(prev => {
                            const next = prev.map(x => {
                                const u = updates.find(y => y.id === x.id);
                                return u ? { ...x, ...u } : x;
                            });
                            StorageManager.saveDeliveries(next);
                            return next;
                        });
                    }
                })();
            }, [deliveries, targetDate, showAllDates]);

            // [Effect] SortableJS 초기화 (드래그 앤 드롭)
            useEffect(() => {
                if (view !== 'driver') return;
                
                const listContainer = document.getElementById('delivery-list-container');
                if (!listContainer) return;

                // SortableJS 인스턴스 생성
                const sortable = new Sortable(listContainer, {
                    animation: 150,
                    delay: 200, // 터치 실수 방지 (200ms 롱프레스 시 드래그 시작)
                    delayOnTouchOnly: true,
                    ghostClass: 'bg-sky-50', // 드래그 중인 항목 스타일
                    handle: '.cursor-pointer', // 헤더 부분을 핸들로 사용
                    onEnd: function (evt) {
                        const { oldIndex, newIndex } = evt;
                        if (oldIndex === newIndex) return;

                        const targetGroup = groupedDeliveries[oldIndex];
                        // 유효성 검사: Active 항목만 이동 가능
                        if (!targetGroup || !targetGroup.is_active) return; 

                        // 취소된 항목(Inactive) 영역으로 이동 방지
                        const activeCount = groupedDeliveries.filter(g => g.is_active).length;
                        if (newIndex >= activeCount) {
                            return; // 무시 (React가 리렌더링하며 원복)
                        }

                        // 순서 변경 실행 (1-based index)
                        handleSequenceChange(targetGroup.ids, (newIndex + 1).toString());
                    }
                });

                return () => {
                    sortable.destroy();
                };
            }, [view, groupedDeliveries]);

            // [기능] 총 예상 설치비 (기사별 일일 합계: 설치+양중+내림+기타)
            const totalInstallFeeOnly = useMemo(() => {
                return deliveries
                    .filter(d => d.date === targetDate && !d.canceled)
                    .filter(d => d.driver === currentUser) // [Fix] 본인 데이터만 합산
                    .reduce((sum, d) => sum + (d.install_fee || 0) + (d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0), 0);
            }, [deliveries, targetDate, currentUser]);

            // [기능] 양중비 + 내림비 + 기타비 합계 (별도 표시용)
            const extraFeesTotal = useMemo(() => {
                return deliveries
                    .filter(d => d.date === targetDate && !d.canceled)
                    .filter(d => d.driver === currentUser) // [Fix] 본인 데이터만 합산
                    .reduce((sum, d) => sum + (d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0), 0);
            }, [deliveries, targetDate, currentUser]);
            
            const sortedDeliveries = useMemo(() => {
                return deliveries
                    .filter(d => !d.canceled)
                    .filter(d => showAllDates || targetDate === 'all' || d.date === targetDate)
                    .filter(d => (currentUser === 'admin' || view === 'admin') ? true : d.driver === currentUser)
                    .sort((a, b) => ((a.sequence_number || 99999) - (b.sequence_number || 99999)));
            }, [deliveries, targetDate, showAllDates, currentUser, view]);
            
            function deleteDeliveriesByDateRange(startStr, endStr) {
                try {
                    const normalize = (s) => parseCustomDate(s);
                    const start = new Date(normalize(startStr));
                    const end = new Date(normalize(endStr));
                    if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                        alert('날짜 범위를 해석할 수 없습니다.');
                        return;
                    }
                    const before = deliveries.length;
                    const filtered = deliveries.filter(d => {
                        const ds = normalize(d.date);
                        const dx = new Date(ds || d.date);
                        if (isNaN(dx.getTime())) return true;
                        return dx < start || dx > end;
                    });
                    const removed = before - filtered.length;
                    setDeliveries(filtered);
                    StorageManager.saveDeliveries(filtered);
                    setToastMsg(`🗑️ ${removed}건 삭제 ( ${startStr} ~ ${endStr} )`);
                } catch (e) {
                    alert('데이터 삭제 중 오류가 발생했습니다.');
                }
            }
            
            function showDeleteRangePrompt() {
                const s = prompt('삭제 시작 날짜를 입력하세요 (예: 2026-02-01):');
                if (!s) return;
                const e = prompt('삭제 종료 날짜를 입력하세요 (예: 2026-02-16):', s);
                if (!e) return;
                if (!confirm(`다음 범위의 데이터를 삭제합니다:\n${s} ~ ${e}\n\n이 작업은 되돌릴 수 없습니다. 진행하시겠습니까?`)) return;
                deleteDeliveriesByDateRange(s, e);
            }
            
            // 자동 삭제 로직 제거: 사용자가 데이터 재업로드를 원함
            
            
            
            // [기능] 비용 업데이트 (기사 입력)
            const updateGroupFees = (ids, field, value) => {
                let numVal = parseInt(value);
                if (isNaN(numVal) || numVal < 0) numVal = 0;
                if (numVal > 10000000) numVal = 10000000; // 최대 1,000만원 제한

                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        // 그룹의 첫 번째 아이템에만 비용 할당 (중복 합산 방지)
                        if (d.id === ids[0]) {
                            return { ...d, [field]: numVal };
                        } else {
                            return { ...d, [field]: 0 };
                        }
                    }
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            };
 
            // [기능] 연락처/주소 업데이트 (기사 편집)
            function updateGroupContact(ids, changes) {
                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        return { ...d, ...changes };
                    }
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            }
 
            async function updateGroupAddress(ids, newAddress) {
                // 1) 주소 문자열 업데이트
                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        return { ...d, address: newAddress };
                    }
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            }

            

            // [기능] 네비게이션 및 토스트 메시지
            const showToast = (msg) => {
                setToastMsg(msg);
            };

            const handleNavigation = (lat, lng, addressName) => {
                if (!addressName && (!lat || !lng)) {
                    showToast("위치 정보가 없습니다.");
                    return;
                }

                const query = addressName || '도착지';
                const encodedQuery = encodeURIComponent(query);
                
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const isMobile = isAndroid || isIOS;

                // Web Fallback: Search
                const webUrl = `https://map.kakao.com/link/search/${encodedQuery}`;

                if (isMobile) {
                    if (isAndroid) {
                        // Android: Search Intent
                        const intentUrl = `intent://search?q=${encodedQuery}#Intent;scheme=kakaomap;package=net.daum.android.map;S.browser_fallback_url=${webUrl};end`;
                        window.location.href = intentUrl;
                    } else if (isIOS) {
                        // iOS: Search Scheme
                        const schemeUrl = `kakaomap://search?q=${encodedQuery}`;
                        
                        const start = Date.now();
                        window.location.href = schemeUrl;
                        
                        setTimeout(() => {
                            if (Date.now() - start < 2500) {
                                window.location.href = webUrl;
                            }
                        }, 2000);
                    }
                } else {
                    // Desktop: Web Map Search
                    window.open(webUrl, '_blank');
                }
            };

            // [Effect] Expose navigation & sequence change to global window for MapView popup
            useEffect(() => {
                window.handleAppNavigation = handleNavigation;
                window.handlePopupSequenceChange = (idsStr) => {
                    const ids = idsStr.split(',');
                    const newSeq = prompt("변경할 순서 번호를 입력하세요:");
                    if (newSeq && !isNaN(newSeq)) {
                        handleSequenceChange(ids, newSeq);
                    }
                };
                window.handleSetStartPoint = handleSetStartPoint;
                window.handleUpdateEndPoint = handleUpdateEndPoint;
            }, [handleSequenceChange]);

            // [기능] 메모 업데이트
            const updateMemo = (ids, newMemo) => {
                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        return { ...d, memo: newMemo };
                    }
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            };

            const prevAllCompletedRef = useRef(false);

            useEffect(() => {
                if (!enableCompletionMessage) return;
                
                const todaysDeliveries = deliveries.filter(d => d.date === targetDate);
                const activeDeliveries = todaysDeliveries.filter(d => !d.canceled);
                const isAllCompleted = activeDeliveries.length > 0 && activeDeliveries.every(d => d.completed);

                if (!prevAllCompletedRef.current && isAllCompleted) {
                    setShowCompletionModal(true);
                }
                
                prevAllCompletedRef.current = isAllCompleted;
            }, [deliveries, targetDate, enableCompletionMessage]);

            // [기능] 상세 정보 수정 (Admin)
            const handleEditOpen = (delivery) => {
                // 수정 시 전체 그룹이 아닌 해당 배송 건만 수정 (개별 수정)
                setEditTarget({ 
                    images: [], 
                    attachments: [], 
                    ...delivery 
                }); 
                setEditTab('basic');
                setShowEditModal(true);
            };

            const handleEditSave = async () => {
                if (!editTarget) return;
                
                // 1. 유효성 검사
                if (!editTarget.item || !editTarget.phone || !editTarget.address) {
                    alert("필수 항목(상품명, 연락처, 주소)을 입력해주세요.");
                    return;
                }

                setLoading(true);

                // 2. 변경 내역 감지 및 로그 생성
                const original = deliveries.find(d => d.id === editTarget.id);
                if (!original) { alert("원본 데이터를 찾을 수 없습니다."); setLoading(false); return; }

                const changes = [];
                const fields = ['item', 'phone', 'address', 'install_fee', 'yangjung', 'naerim', 'etc_fee', 'memo', 'images', 'attachments'];
                
                fields.forEach(field => {
                    const oldVal = original[field] || (['images', 'attachments'].includes(field) ? [] : '');
                    const newVal = editTarget[field] || (['images', 'attachments'].includes(field) ? [] : '');
                    
                    // 숫자형 비교
                    if (['install_fee', 'yangjung', 'naerim', 'etc_fee'].includes(field)) {
                        if (Number(oldVal) !== Number(newVal)) {
                            changes.push({ field, old: oldVal, new: newVal });
                        }
                    } else if (['images', 'attachments'].includes(field)) {
                        // 배열 비교
                        if (JSON.stringify(oldVal) !== JSON.stringify(newVal)) {
                             changes.push({ field, old: `${oldVal.length}개`, new: `${newVal.length}개` });
                        }
                    } else {
                        // 문자열 비교
                        if (String(oldVal).trim() !== String(newVal).trim()) {
                            changes.push({ field, old: oldVal, new: newVal });
                        }
                    }
                });

                // 변경사항 없으면 종료
                if (changes.length === 0) {
                    alert("변경된 내용이 없습니다.");
                    setLoading(false);
                    return;
                }

                // 3. 주소 변경 시 좌표 재검색
                let newCoords = { lat: editTarget.lat, lng: editTarget.lng };
                if (original.address !== editTarget.address) {
                    newCoords = await geocodeAddress(editTarget.address);
                }

                // 4. 히스토리 생성
                const newHistory = {
                    date: new Date().toISOString(),
                    changes: changes
                };

                // 5. 업데이트 반영
                const updatedDeliveries = deliveries.map(d => {
                    if (d.id === editTarget.id) {
                        // [Fix] 상세 품목(detail_items) 동기화
                        // 그룹화된 데이터(editTarget)의 변경사항을 원본 데이터의 detail_items에도 반영해야 리스트에 즉시 적용됨
                        let updatedDetailItems = d.detail_items ? [...d.detail_items] : null;
                        
                        if (updatedDetailItems && updatedDetailItems.length > 0) {
                            // 1) 상품명 변경 시 첫 번째 상세 품목 이름 업데이트
                            if (editTarget.item !== d.item) {
                                updatedDetailItems[0] = { ...updatedDetailItems[0], item: editTarget.item };
                            }
                            // 2) 설치비 변경 시: 단일 품목이면 해당 품목 비용 업데이트
                            if (updatedDetailItems.length === 1 && Number(editTarget.install_fee) !== Number(d.install_fee)) {
                                updatedDetailItems[0] = { ...updatedDetailItems[0], install_fee: Number(editTarget.install_fee) };
                            }
                        } else {
                            // detail_items가 없으면 새로 생성 (단일 품목 호환성)
                            updatedDetailItems = [{ item: editTarget.item, install_fee: Number(editTarget.install_fee) }];
                        }

                        return {
                            ...d,
                            ...editTarget,
                            ...newCoords,
                            detail_items: updatedDetailItems, // [중요] 상세 품목 업데이트
                            history: [...(d.history || []), newHistory]
                        };
                    }
                    return d;
                });

                setDeliveries(updatedDeliveries);
                StorageManager.saveDeliveries(updatedDeliveries);
                
                alert("수정이 완료되었습니다.");
                setShowEditModal(false);
                setEditTarget(null);
                setLoading(false);
            };

            // [Helper] 예약 시스템 유효성 검사 및 로직
            const reservationConstraints = useMemo(() => {
                const today = new Date();
                const min = new Date(today); min.setDate(today.getDate() + Config.RESERVATION.MIN_DAYS);
                const max = new Date(today); max.setDate(today.getDate() + Config.RESERVATION.MAX_DAYS);
                return { min: min.toISOString().split('T')[0], max: max.toISOString().split('T')[0] };
            }, []);

            const timeSlots = useMemo(() => {
                const slots = [];
                for(let i=Config.RESERVATION.START_HOUR; i<=Config.RESERVATION.END_HOUR; i++) {
                    slots.push(`${i.toString().padStart(2,'0')}:00`);
                    slots.push(`${i.toString().padStart(2,'0')}:30`);
                }
                return slots;
            }, []);

            const isTimeBlocked = (date, time) => {
                if (!date || !time) return false;
                return deliveries.some(d => d.reservationDate === date && d.reservationTime === time);
            };

            const handleMemoChange = (e) => {
                const val = e.target.value;
                const clean = val.replace(/[^a-zA-Z0-9ㄱ-ㅎㅏ-ㅣ가-힣\s.,!?]/g, '');
                if (clean.length <= Config.MEMO.MAX_LENGTH) setForm(prev => ({ ...prev, memo: clean }));
            };

            // [기능] 수동 등록
            async function handleManualAdd(e) {
                e.preventDefault();
                
                // 1. 기본 필수값 검사
                if (!form.item || !form.phone || !form.address) {
                    alert("필수 항목(상품명, 전화번호, 주소)을 입력해주세요.");
                    return;
                }

                // 2. 예약 시스템 유효성 검사
                if (form.reservationDate) {
                    if (form.reservationDate < reservationConstraints.min || form.reservationDate > reservationConstraints.max) {
                        alert(`예약 가능 기간은 ${reservationConstraints.min} ~ ${reservationConstraints.max} 입니다.`);
                        return;
                    }
                    if (isTimeBlocked(form.reservationDate, form.reservationTime)) {
                        alert("선택하신 시간대는 이미 예약되어 있습니다.");
                        return;
                    }
                }

                // 3. 설치 시간 검사
                if (form.isInstallNeeded && form.installTime) {
                    const hour = parseInt(form.installTime.split(':')[0]);
                    const rDate = new Date(form.reservationDate || form.date);
                    const day = rDate.getDay();
                    
                    if (Config.INSTALL.WEEKDAYS_ONLY && (day === 0 || day === 6)) { 
                         alert("설치 서비스는 평일(월~금)에만 가능합니다."); 
                         return;
                    }
                    if (hour < Config.INSTALL.START_HOUR || hour >= Config.INSTALL.END_HOUR) {
                        alert(`설치 가능 시간은 ${Config.INSTALL.START_HOUR.toString().padStart(2,'0')}:00 ~ ${Config.INSTALL.END_HOUR.toString().padStart(2,'0')}:00 입니다.`);
                        return;
                    }
                }

                // 4. 메모 길이 검사
                if (form.memo && form.memo.length < Config.MEMO.MIN_LENGTH) {
                    alert(`배송 메모는 최소 ${Config.MEMO.MIN_LENGTH}자 이상 입력해주세요.`);
                    return;
                }

                setLoading(true);
                const coords = await geocodeAddress(form.address);

                // [Driver Logic] 기사 배정 로직 (본인 또는 관리자 선택)
                let assignedDriver = '';
                if (currentUser !== 'admin') {
                    assignedDriver = currentUser;
                } else if (adminDriverFilter !== 'all' && adminDriverFilter !== 'unassigned') {
                    assignedDriver = adminDriverFilter;
                }

                const newItem = {
                    id: crypto.randomUUID(),
                    date: form.reservationDate || form.date, 
                    driver: assignedDriver, // 기사 배정
                    item: form.item,
                    phone: form.phone,
                    address: form.address,
                    install_fee: Number(form.install_fee) || 0,
                    yangjung: Number(form.yangjung) || 0,
                    naerim: Number(form.naerim) || 0,
                    etc_fee: Number(form.etc_fee) || 0,
                    reservationDate: form.reservationDate,
                    reservationTime: form.reservationTime,
                    isInstallNeeded: form.isInstallNeeded,
                    installTime: form.installTime,
                    memo: form.memo,
                    ...coords
                };

                // Local Save (Cloud Sync is manual)
                const updated = [...deliveries, newItem];
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
                
                alert("등록되었습니다.");
                // 폼 초기화
                setForm(prev => ({ 
                    ...prev, 
                    item: '', phone: '', address: '', 
                    install_fee: 0, yangjung: 0, naerim: 0, etc_fee: 0,
                    reservationDate: '', reservationTime: '', isInstallNeeded: false, installTime: '', memo: ''
                }));
                setLoading(false);
            }

            async function addDelivery(delivery) {
                let { lat, lng } = delivery;
                if (!lat || !lng) {
                    const addr = formatAddressDisplay(delivery.address || '');
                    const coords = await geocodeAddress(addr);
                    if (!coords) {
                        alert('주소를 지도에서 찾지 못했습니다.\n주소를 다시 확인해주세요.');
                        return;
                    }
                    lat = coords.lat;
                    lng = coords.lng;
                }
                const newDelivery = { ...delivery, lat, lng };
                const next = [...deliveries, newDelivery];
                setDeliveries(next);
                StorageManager.saveDeliveries(next);
            }

            // [기능] 상태 초기화 (체크 해제)
            function resetStatus(ids, type) {
                if(!confirm(`'${type === 'completed' ? '방문완료' : '부분'}' 상태를 취소하시겠습니까?`)) return;
                updateGroupStatus(ids, { [type]: false });
            }

            // [기능] 삭제 요청 (모달 오픈)
            function requestDelete(ids) {
                setDeleteTarget(ids);
                setShowDeleteModal(true);
            }

            // [기능] 실제 삭제 실행 (API 시뮬레이션)
            async function executeDelete() {
                if (!deleteTarget) return;
                
                try {
                    // API 호출 시뮬레이션 (0.3초)
                    await new Promise(resolve => setTimeout(resolve, 300));

                    let newDeliveries = deliveries.filter(d => !deleteTarget.includes(d.id));
                    
                    setDeliveries(newDeliveries);
                    StorageManager.saveDeliveries(newDeliveries);
                    
                    setToastMsg("🗑️ 항목이 삭제되었습니다.");
                    setShowDeleteModal(false);
                    setDeleteTarget(null);
                } catch (e) {
                    setToastMsg("❌ 삭제 실패");
                }
            }

            // [기능] 상태 업데이트 (방문완료, 비용 등)
            function updateGroupStatus(ids, updates) {
                const newDeliveries = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        return { ...d, ...updates };
                    }
                    return d;
                });
                setDeliveries(newDeliveries);
                StorageManager.saveDeliveries(newDeliveries);
            }
            
            function readJsonFileWithEncoding(file, cb) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const buf = ev.target.result;
                    let text = '';
                    let data = null;
                    
                    // 1. Try UTF-8 first (Strict Check for �)
                    try {
                        text = new TextDecoder('utf-8').decode(buf);
                        const temp = JSON.parse(text);
                        // If it parses but has replacement characters, it might be EUC-KR
                        if (text.includes('\uFFFD')) {
                             throw new Error('Suspicious UTF-8 with replacement characters');
                        }
                        data = temp;
                    } catch (e) {
                        // UTF-8 parse failed or was suspicious
                    }
                    
                    // 2. Try EUC-KR if UTF-8 failed or was suspicious
                    if (!data) {
                        try {
                            text = new TextDecoder('euc-kr').decode(buf);
                            data = JSON.parse(text);
                        } catch (e) {
                            // EUC-KR failed too
                        }
                    }
                    
                    // 3. Fallback: If strict UTF-8 failed but EUC-KR also failed, 
                    // use loose UTF-8 (maybe it really had �)
                    if (!data) {
                        try {
                            text = new TextDecoder('utf-8').decode(buf);
                            data = JSON.parse(text);
                        } catch {}
                    }

                    if (!data) {
                        alert('파일 인코딩을 확인해주세요. UTF-8 또는 EUC-KR 형식을 권장합니다.');
                        return;
                    }
                    cb(data);
                };
                reader.readAsArrayBuffer(file);
            }
            
            function completeDelivery(id) {
                const newDeliveries = deliveries.map(d => {
                    if (d.id === id) return { ...d, completed: true };
                    return d;
                });
                setDeliveries(newDeliveries);
                StorageManager.saveDeliveries(newDeliveries);
            }
            
            function handleComplete(id, order) {
                completeDelivery(id);
                setCurrentOrder(order + 1);
            }

            // [기능] 경로 최적화 (Nearest Neighbor)
            const [optimizedRoute, setOptimizedRoute] = useState([]);
            // 전화번호 인라인 편집 상태
            const [editingPhoneGroupId, setEditingPhoneGroupId] = useState(null);
            const [editingPhoneValue, setEditingPhoneValue] = useState('');
            // 예약/설치 시간 버튼형 선택 팝업 상태
            const [openTimePickerId, setOpenTimePickerId] = useState(null);
            const [openDurationPickerId, setOpenDurationPickerId] = useState(null);
            const [showAddItemModal, setShowAddItemModal] = useState(false);
            const [addForm, setAddForm] = useState({ date: '', phone: '', address: '', item: '' });

            // [기능] 엑셀 다운로드
            async function downloadTemplate() {
                const workbook = new ExcelJS.Workbook();
                const sheet = workbook.addWorksheet('배송목록');
                
                sheet.columns = [
                    { header: '날짜', key: 'date', width: 15 },
                    { header: '주문번호', key: 'order_number', width: 20 },
                    { header: '운송장번호', key: 'invoice_number', width: 20 },
                    { header: '제품명', key: 'item', width: 40 },
                    { header: '안심번호', key: 'phone', width: 20 },
                    { header: '주소', key: 'address', width: 50 },
                    { header: '기사', key: 'driver', width: 15 },
                    { header: '단가', key: 'settlement_amount', width: 15 },
                ];
                
                // 스타일
                sheet.getRow(1).font = { bold: true };
                sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
                
                // 유효성 검사 (숫자만 입력 안내)
                for(let i=2; i<=100; i++) {
                    sheet.getCell(`H${i}`).numFmt = '#,##0'; // 단가
                }

                // [예시] 다중 상품 입력 (Fill-down)
                sheet.addRow(['2025-01-30', 'ORD-001', 'INV-001', '삼성 TV 65인치', '010-1234-5678', '서울 강남구 테헤란로 123', '홍길동', 50000]);
                sheet.addRow(['', '', '', '벽걸이 브라켓 (추가)', '', '', '', 15000]); 
                sheet.addRow(['2025-01-30', 'ORD-002', 'INV-002', 'LG 냉장고', '010-9876-5432', '경기도 성남시 분당구 판교로 456', '김철수', 80000]);

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = '배송양식_통합.xlsx';
                a.click();
            }

            // [기능] 파일 업로드 (상품 통합 로직 적용)
            async function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                // [New] Auto Backup: 덮어쓰기 전 데이터 자동 백업
                if (deliveries.length > 0) {
                    try {
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        const backupKey = `mvp_backup_auto_${timestamp}`;
                        const backupData = {
                            timestamp: new Date().toISOString(),
                            deliveries: deliveries,
                            reason: 'before_upload'
                        };
                        StorageManager.set(backupKey, backupData);
                        
                        // 백업 목록 관리 (최근 5개만 유지)
                        const backupList = StorageManager.get('mvp_backup_list') || [];
                        backupList.unshift({ key: backupKey, time: new Date().toLocaleString(), count: deliveries.length });
                        if (backupList.length > 5) {
                            const removed = backupList.pop();
                            StorageManager.remove(removed.key);
                        }
                        StorageManager.set('mvp_backup_list', backupList);
                        console.log(`[Auto Backup] Saved to ${backupKey}`);
                    } catch(err) {
                        console.warn("Auto backup failed:", err);
                    }
                }

                setUploadedFileName(file.name); // 파일명 표시
                setLoading(true);

                try {
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(await file.arrayBuffer());
                    const sheet = workbook.worksheets[0];
                    
                    // 헤더 찾기
                    const header = { 
                        date: -1, order_number: -1, invoice_number: -1, item: -1, 
                        phone: -1, address: -1, center: -1, region: -1, 
                        settlement_amount: -1, driver: -1,
                        // [New] 상세 비용 컬럼 추가
                        install_fee: -1, yangjung: -1, naerim: -1, etc_fee: -1
                    };

                    sheet.getRow(1).eachCell((cell, col) => {
                        const val = cell.value ? cell.value.toString().trim() : '';
                        if(val.includes('날짜')) header.date = col;
                        if(val.includes('주문') || val.includes('오더')) header.order_number = col;
                        if(val.includes('운송장') || val.includes('송장') || val.includes('인보이스')) header.invoice_number = col;
                        if(val.includes('제품') || val.includes('상품')) header.item = col;
                        if(val.includes('안심번호') || val.includes('전화')) header.phone = col;
                        if(val.includes('주소')) header.address = col;
                        if(val.includes('기사') || val.includes('담당')) header.driver = col;
                        
                        // 비용 관련 컬럼 매핑
                        if(val.includes('단가') || val.includes('금액') || val.includes('정산')) header.settlement_amount = col;
                        if(val.includes('설치비') || val.includes('설치')) header.install_fee = col;
                        if(val.includes('양중')) header.yangjung = col;
                        if(val.includes('내림')) header.naerim = col;
                        if(val.includes('기타')) header.etc_fee = col;

                        // Legacy support (optional)
                        if(val.includes('센터')) header.center = col;
                        if(val.includes('지역')) header.region = col;
                    });

                    if (header.address === -1 || header.item === -1) {
                        throw new Error("필수 컬럼(주소, 상품)을 찾을 수 없습니다.");
                    }

                    let lastDate = '';
                    let lastOrder = '';
                    let lastInvoice = '';
                    let lastAddress = '';
                    let lastPhone = '';
                    let lastCenter = '';
                    let lastRegion = '';
                    let lastDriver = '';
                    
                    // 1차 파싱: Raw 데이터 추출
                    const rawRows = [];
                    sheet.eachRow((row, rowNum) => {
                        if(rowNum === 1) return;

                        const getVal = (colIdx) => {
                            if (colIdx === -1) return null;
                            const cell = row.getCell(colIdx);
                            if (cell.value && typeof cell.value === 'object') {
                                if (cell.value.richText) return cell.value.richText.map(r => r.text).join('');
                                if (cell.value.text) return cell.value.text;
                                if (cell.value.result) return cell.value.result; 
                            }
                            return cell.value;
                        };

                        // [Helper] 금액 파싱 (콤마 제거 및 숫자 변환)
                        const parseMoney = (v) => {
                            if (!v) return 0;
                            if (typeof v === 'number') return v;
                            // 문자열인 경우 콤마, 원, 공백 등 제거하고 숫자만 추출
                            const str = String(v).replace(/[^\d.-]/g, '');
                            const num = Number(str);
                            return isNaN(num) ? 0 : num;
                        };

                        let dateRaw = getVal(header.date);
                        let orderRaw = getVal(header.order_number);
                        let invoiceRaw = getVal(header.invoice_number);
                        let address = getVal(header.address);
                        let phone = getVal(header.phone);
                        let item = getVal(header.item);
                        let centerRaw = getVal(header.center);
                        let regionRaw = getVal(header.region);
                        let driver = getVal(header.driver);
                        
                        // 비용 추출
                        let settlementRaw = getVal(header.settlement_amount);
                        let installRaw = getVal(header.install_fee);
                        let yangjungRaw = getVal(header.yangjung);
                        let naerimRaw = getVal(header.naerim);
                        let etcRaw = getVal(header.etc_fee);

                        // Fill-down 로직
                        if (address) {
                            lastAddress = address.toString().trim();
                            if (dateRaw) lastDate = dateRaw;
                            if (orderRaw) lastOrder = orderRaw.toString().trim();
                            if (invoiceRaw) lastInvoice = invoiceRaw.toString().trim();
                            if (phone) lastPhone = phone.toString().trim();
                            if (centerRaw) lastCenter = centerRaw.toString().trim();
                            if (regionRaw) lastRegion = regionRaw.toString().trim();
                            if (driver) lastDriver = driver.toString().trim();
                        }
                        
                        if (!dateRaw && lastDate) dateRaw = lastDate;
                        if (!orderRaw && lastOrder) orderRaw = lastOrder;
                        if (!invoiceRaw && lastInvoice) invoiceRaw = lastInvoice;
                        if (!phone && lastPhone) phone = lastPhone;
                        if (!centerRaw && lastCenter) centerRaw = lastCenter;
                        if (!regionRaw && lastRegion) regionRaw = lastRegion;
                        if (!driver && lastDriver) driver = lastDriver;

                        if (lastAddress && item) {
                            // 비용 우선순위 결정: 상세 컬럼이 있으면 사용, 없으면 통합 컬럼 사용
                            let iFee = parseMoney(installRaw);
                            const yFee = parseMoney(yangjungRaw);
                            const nFee = parseMoney(naerimRaw);
                            const eFee = parseMoney(etcRaw);
                            
                            // 상세 설치비가 0이고 통합 금액이 있다면 통합 금액을 설치비로 간주 (Legacy 호환)
                            if (iFee === 0 && parseMoney(settlementRaw) > 0 && yFee === 0 && nFee === 0 && eFee === 0) {
                                iFee = parseMoney(settlementRaw);
                            }

                            rawRows.push({
                                rawDate: dateRaw,
                                order_number: orderRaw || '',
                                invoice_number: invoiceRaw || '',
                                address: lastAddress,
                                phone: lastPhone || '',
                                item: item.toString().trim(),
                                center: centerRaw || '',
                                region: regionRaw || '',
                                driver: driver ? String(driver).trim() : '',
                                // 비용 데이터
                                install_fee: iFee,
                                yangjung: yFee,
                                naerim: nFee,
                                etc_fee: eFee
                            });
                        }
                    });

                    // [속도 개선] 대량 파싱 직후 한 틱 양보 (UI 반응성 확보)
                    await new Promise(r => setTimeout(r, 0));

                    // [검증 로직] 1차 자동 대조 및 로그 생성
                    const validationLogs = [];
                    const phoneGroups = {}; // 전화번호 기준 그룹화 (검증용)

                    rawRows.forEach(row => {
                        const phoneKey = String(row.phone).replace(/\D/g, '');
                        if (!phoneGroups[phoneKey]) phoneGroups[phoneKey] = new Set();
                        phoneGroups[phoneKey].add(row.address); // 원본 주소 저장
                    });

                    // 불일치 항목(동일 전화번호인데 주소가 미세하게 다른 경우) 감지
                    Object.entries(phoneGroups).forEach(([phone, addresses]) => {
                        if (addresses.size > 1) {
                            const addrList = Array.from(addresses);
                            validationLogs.push({
                                type: 'mismatch',
                                phone: phone,
                                msg: `동일 연락처(${phone})에 서로 다른 주소 ${addresses.size}건 발견 (자동 분리됨)`,
                                details: addrList
                            });
                        }
                    });

                    // 2차 가공: 주소+기사 기준 병합
                    // (주소가 같아도 기사가 다르면 별도 정산 건으로 처리해야 함)
                    const mergedMap = new Map();

                    // [속도 개선] 이벤트 루프에 양보하여 UI 먼저 그리기
                    await new Promise(r => setTimeout(r, 0));

                    rawRows.forEach(row => {
                        // [수정] 주소 + 기사 정보로 그룹화
                        // 기사가 다르면 주소가 같아도 섞이지 않도록 함
                        const strictKey = `${row.address.trim()}_${row.driver || 'unknown'}`;
                        
                        if (!mergedMap.has(strictKey)) {
                            mergedMap.set(strictKey, {
                                rawDate: row.rawDate,
                                order_number: row.order_number,
                                invoice_number: row.invoice_number,
                                address: row.address, 
                                phone: row.phone,
                                driver: row.driver,
                                center: row.center,
                                region: row.region,
                                items: [], 
                                totalInstallFee: 0,
                                totalYangjung: 0,
                                totalNaerim: 0,
                                totalEtc: 0
                            });
                        }
                        
                        const group = mergedMap.get(strictKey);
                        group.items.push({
                            item: row.item,
                            install_fee: row.install_fee,
                            yangjung: row.yangjung,
                            naerim: row.naerim,
                            etc_fee: row.etc_fee
                        });
                        group.totalInstallFee += row.install_fee;
                        group.totalYangjung += row.yangjung;
                        group.totalNaerim += row.naerim;
                        group.totalEtc += row.etc_fee;
                    });

                    // 검증 리포트 저장 (localStorage)
                    if (validationLogs.length > 0) {
                        const report = {
                            date: new Date().toISOString(),
                            logs: validationLogs,
                            totalRows: rawRows.length,
                            mergedCount: mergedMap.size
                        };
                        StorageManager.set('mvp_validation_report', report);
                        setVerificationReport(report); // UI 업데이트용 상태
                        alert(`[데이터 검증 경고] 총 ${validationLogs.length}건의 주소 불일치가 발견되었습니다. \n관리자 패널 상단 '검증 리포트'를 확인하세요.`);
                    } else {
                        setVerificationReport(null);
                        StorageManager.remove('mvp_validation_report');
                    }

                    console.log(`총 ${rawRows.length}개 행 -> ${mergedMap.size}개 배송 건으로 통합됨.`);

                    // 3차: 지오코딩 및 객체 생성
                    const results = [];
            
                    for (const [key, group] of mergedMap) {
                        const coreAddr = formatAddressDisplay(group.address);
                        let coords = await geocodeAddress(coreAddr, true);
                        if (!coords) coords = await geocodeAddress(coreAddr, false);
            
                        let displayItem = group.items[0].item;
                        if (group.items.length > 1) {
                            displayItem = `${displayItem} 외 ${group.items.length - 1}건`;
                        }
            
                        results.push({
                            id: crypto.randomUUID(),
                            date: parseCustomDate(group.rawDate),
                            order_number: group.order_number,
                            invoice_number: group.invoice_number,
                            item: displayItem,
                            detail_items: group.items,
                            phone: group.phone,
                            address: group.address,
                            driver: group.driver,
                            center: group.center,
                            region: group.region,
                            install_fee: group.totalInstallFee,
                            yangjung: group.totalYangjung,
                            naerim: group.totalNaerim,
                            etc_fee: group.totalEtc,
                            ...(coords ? { lat: coords.lat, lng: coords.lng } : {})
                        });
                    }

                    // [수정] 중복 방지 병합 로직 (Address 기준)
                    const existingMap = new Map();
                    // 기존 데이터를 Map에 저장 (Key: 주소)
                    deliveries.forEach(d => {
                         const key = d.address.trim();
                         existingMap.set(key, d);
                    });

                    let updateCount = 0;
                    let newCount = 0;

                    results.forEach(newInfo => {
                        const key = newInfo.address.trim();
                        
                        if (existingMap.has(key)) {
                            // 기존 데이터 업데이트 (ID, 상태 유지)
                            const existing = existingMap.get(key);
                            const merged = {
                                ...existing,
                                ...newInfo, // 새로운 정보로 덮어쓰기 (items, fees 등)
                                id: existing.id, // ID 유지
                                sequence_number: existing.sequence_number, // 순서 유지
                                completed: existing.completed, // 완료 상태 유지
                                canceled: existing.canceled, // 취소 상태 유지
                                cancel_type: existing.cancel_type,
                            };
                            existingMap.set(key, merged);
                            updateCount++;
                        } else {
                            // 신규 추가
                            existingMap.set(key, newInfo);
                            newCount++;
                        }
                    });

                    const updated = Array.from(existingMap.values());
                    setDeliveries(updated);
                    // [속도 개선] 저장은 백그라운드로 처리 (UI 즉시 갱신 우선)
                    StorageManager.saveDeliveries(updated);

                    if (results.length > 0) {
                        const uniqueDates = [...new Set(results.map(r => r.date))];
                        
                        // [Fix] 여러 날짜가 포함된 경우 '전체 보기' 모드로 전환
                        if (uniqueDates.length > 1) {
                            setTargetDate('all');
                            setForm(prev => ({ ...prev, date: uniqueDates[0] })); // 폼에는 첫번째 날짜 표시
                        } else {
                            const uploadedDate = results[0].date;
                            setTargetDate(uploadedDate);
                            setForm(prev => ({ ...prev, date: uploadedDate }));
                        }
                        
                        // [Fix] 업로드 시 관리자 필터 초기화 (숨겨진 데이터 방지)
                        setAdminDriverFilter('all');

                        let dateMsg = "";
                        if (uniqueDates.length > 1) {
                             dateMsg = `\n📅 ${uniqueDates.length}일치 데이터가 통합되었습니다.\n(전체 날짜 보기 모드로 전환됨)`;
                        }

                        alert(`엑셀 업로드 완료! (신규 ${newCount}건, 업데이트 ${updateCount}건)${dateMsg}`);
                    } else {
                        alert("업로드된 데이터가 없습니다.");
                    }

                } catch(err) {
                    console.error(err);
                    alert(`업로드 실패: ${err.message}`);
                } finally {
                    setLoading(false);
                    e.target.value = '';
                }
            }

            // [기능] 출발지 설정
            async function handleSetStartPoint() {
                const addr = prompt("출발지 주소를 입력하세요:", startPoint?.address || "");
                if (addr) {
                    const coords = await geocodeAddress(addr);
                    const newStart = { ...coords, address: addr };
                    setStartPoint(newStart);
                    StorageManager.set('mvp_start_point', newStart);
                }
            }

            // [기능] GPS로 출발지 설정
            function handleGPSStartPoint() {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    // 역지오코딩 생략 (단순 좌표 사용)
                    const newStart = { ...coords, address: '현재 위치 (GPS)' };
                    setStartPoint(newStart);
                    StorageManager.set('mvp_start_point', newStart);
                }, () => alert("위치 권한이 필요합니다."));
            }

            // [기능] 좌표 보정 (서울 쏠림 현상 수정)
            async function fixCoordinates() {
                if (!confirm("모든 배송지의 좌표를 재검증하고 보정하시겠습니까? (시간이 소요될 수 있습니다)")) return;
                
                setLoading(true);
                const updated = [...deliveries];
                let fixCount = 0;

                // 순차 처리
                for (let i = 0; i < updated.length; i++) {
                    const d = updated[i];
                    const isSeoulDefault = d.lat === 37.5665 && d.lng === 126.9780;
                    const addressHasSeoul = d.address.includes('서울');
                    
                    // 서울이 아닌데 서울 시청 좌표(기본값)를 가진 경우 재검증
                    if (isSeoulDefault && !addressHasSeoul) {
                        const newCoords = await geocodeAddress(d.address);
                        // 좌표가 변경되었으면 업데이트
                        if (newCoords.lat !== d.lat || newCoords.lng !== d.lng) {
                            updated[i] = { ...d, ...newCoords };
                            fixCount++;
                        }
                    }
                }

                if (fixCount > 0) {
                    setDeliveries(updated);
                    StorageManager.saveDeliveries(updated);
                    alert(`${fixCount}건의 좌표가 보정되었습니다.`);
                } else {
                    alert("보정이 필요한 데이터가 없습니다.");
                }
                setLoading(false);
            }

            // [기능] 배송 건 삭제
            function deleteDelivery(ids) {
                if(confirm('선택한 배송 건을 삭제하시겠습니까?')) {
                    const newDeliveries = deliveries.filter(d => !ids.includes(d.id));
                    setDeliveries(newDeliveries);
                    StorageManager.saveDeliveries(newDeliveries);
                    setToastMsg("삭제되었습니다.");
                }
            }

            // [기능] 상품 체크 토글
            function toggleItemCheck(oid, oidx) {
                setDeliveries(prev => {
                    const next = prev.map(d => {
                        if (d.id === oid) {
                            if (oidx === -1) {
                                // 단일 상품 모드
                                return { ...d, checked: !d.checked };
                            } else if (d.detail_items && d.detail_items[oidx]) {
                                // 상세 품목 모드
                                const newItems = [...d.detail_items];
                                newItems[oidx] = { ...newItems[oidx], checked: !newItems[oidx].checked };
                                return { ...d, detail_items: newItems };
                            }
                        }
                        return d;
                    });
                    StorageManager.saveDeliveries(next);
                    return next;
                });
            }

            // [기능] 그룹에 상품 추가 (첫 번째 원본에 상세 품목으로 추가)
            function addGroupItem(ids) {
                if (!ids || ids.length === 0) return;
                const targetId = ids[0];
                setDeliveries(prev => {
                    const next = prev.map(d => {
                        if (d.id === targetId) {
                            let items = d.detail_items ? [...d.detail_items] : null;
                            if (!items) {
                                // 기존 단일 항목을 상세로 승격
                                items = [{ item: d.item || '상품', checked: !!d.checked, settlement_amount: d.settlement_amount || 0 }];
                            }
                            items.push({ item: '상품', checked: false, settlement_amount: 0 });
                            return { ...d, detail_items: items };
                        }
                        return d;
                    });
                    StorageManager.saveDeliveries(next);
                    return next;
                });
                setToastMsg('📦 상품을 추가했습니다.');
            }

            function openAddItemForm() {
                setAddForm({ date: targetDate || '', phone: '', address: '', item: '' });
                setShowAddItemModal(true);
            }

            function handleAddItemSubmit() {
                const { date, phone, address, item } = addForm;
                if (!date || !phone || !address || !item) {
                    alert('배송날짜, 전화번호, 주소, 품목을 모두 입력해주세요.');
                    return;
                }
                const newDelivery = {
                    id: crypto.randomUUID(),
                    date,
                    item,
                    address,
                    phone,
                    driver: currentUser || '',
                    settlement_amount: 0,
                    completed: false,
                    canceled: false,
                    time: '',
                    duration: 30,
                };
                const next = [newDelivery, ...deliveries];
                setDeliveries(next);
                StorageManager.saveDeliveries(next);
                setShowAddItemModal(false);
                setToastMsg('✅ 개별 상품을 추가했습니다.');
            }

            // [기능] 테스트 데이터 로드 (12건)
            function handleLoadTestData() {
                const today = new Date().toISOString().split('T')[0];
                const testData = [
                    // 서울 (10건)
                    { address: "서울시 강남구 역삼동 123-45", item: "침대 프레임", phone: "010-1111-2222" },
                    { address: "서울특별시 서초구 반포동 50-1", item: "소파 3인용", phone: "010-3333-4444" },
                    { address: "서울 송파구 잠실동 22", item: "식탁 세트", phone: "010-5555-6666" },
                    { address: "서울 마포구 망원동 400", item: "책상", phone: "010-7777-8888" },
                    { address: "서울특별시 영등포구 여의도동 1", item: "의자 4개", phone: "010-9999-0000" },
                    { address: "서울 종로구 혜화동 90", item: "서랍장", phone: "010-1212-3434" },
                    { address: "서울 중구 명동 10", item: "거실장", phone: "010-5656-7878" },
                    { address: "서울 용산구 이태원동 300", item: "화장대", phone: "010-9090-1212" },
                    { address: "서울 성동구 성수동 1가 10", item: "매트리스 Q", phone: "010-3434-5656" },
                    { address: "서울 강동구 천호동 55", item: "옷장", phone: "010-7878-9090" },
                    // 비서울 (2건)
                    { address: "경기도 성남시 분당구 판교동 500", item: "사무용 의자", phone: "010-1122-3344" },
                    { address: "인천광역시 연수구 송도동 10-1", item: "게이밍 책상", phone: "010-5566-7788" },
                ];

                if(!confirm("기존 데이터를 지우고 테스트 데이터(12건)를 로드하시겠습니까?")) return;
                
                setLoading(true);
                Promise.all(testData.map(async (d, i) => {
                    const coords = await geocodeAddress(d.address);
                    return {
                        id: crypto.randomUUID(),
                        date: today,
                        time: `오전 ${9 + i}:00`,
                        item: d.item,
                        phone: d.phone,
                        address: d.address,
                        settlement_amount: (i + 5) * 10000, // 테스트용 금액
                        install_fee: (i % 2) * 5000,
                        yangjung: (i % 3 === 0) ? 10000 : 0,
                        naerim: 0,
                        ...coords
                    };
                })).then(results => {
                    setDeliveries(results);
                    StorageManager.saveDeliveries(results);
                    alert("테스트 데이터 12건 로드 완료!");
                    setLoading(false);
                    // 자동 검증 실행
                    setTimeout(handleVerifyData, 500);
                });
            }

            // [기능] 주소 검증 및 리포트
            function handleVerifyData() {
                if (verificationReport) {
                    const { date, logs, totalRows, mergedCount } = verificationReport;
                    const logContent = logs.map(l => 
                        `⚠️ [${l.type}] ${l.msg}\n   - 대상: ${l.phone}\n   - 주소 목록:\n${l.details.map(a => `     • "${a}"`).join('\n')}`
                    ).join('\n\n');

                    const reportText = `
[데이터 무결성 검증 리포트]
- 검증 일시: ${new Date(date).toLocaleString()}
- 총 데이터 행: ${totalRows}건
- 최종 병합된 배송 건수: ${mergedCount}건
- 발견된 불일치 이슈: ${logs.length}건

[이슈 상세 내역]
${logContent}

* 위 내역은 "동일 연락처이나 주소가 미세하게 달라(공백/특수문자 등)"
  시스템이 별도 배송 건으로 분리한 케이스입니다.
* 동일 건으로 처리하려면 엑셀 원본의 주소를 100% 일치시켜 재업로드하세요.
                    `;
                    alert(reportText);
                    console.log(reportText);
                    return;
                }
                
                // 기존 단순 검증 로직 유지 (리포트 없을 때)
                const targetList = deliveries.filter(d => d.date === form.date); 
                if (targetList.length === 0) { alert(`${form.date} 날짜에 검증할 데이터가 없습니다.`); return; }
                alert("최근 업로드된 엑셀 파일 검증 이력이 없습니다. 엑셀 파일을 다시 업로드하면 검증이 수행됩니다.");
            }

            // [기능] 시간 슬롯 생성 (09:00 ~ 20:00, 30분 단위)
            const TIME_SLOTS = [];
            for(let h=8; h<=20; h++) {
                TIME_SLOTS.push(`${h.toString().padStart(2,'0')}:00`);
                if(h !== 20) TIME_SLOTS.push(`${h.toString().padStart(2,'0')}:30`);
            }

            // [기능] 시간 충돌 확인
            const checkTimeConflict = (newTime, duration, currentIds) => {
                if (!newTime) return false;
                const parse = t => {
                    const [h, m] = t.split(':').map(Number);
                    return h * 60 + m;
                };
                const newStart = parse(newTime);
                const newEnd = newStart + duration;

                return groupedDeliveries.some(g => {
                    if (g.canceled || g.completed) return false;
                    if (g.ids.some(id => currentIds.includes(id))) return false; // 자기 자신 제외
                    const gTime = g.time;
                    if (!gTime) return false;
                    const gStart = parse(gTime);
                    const gEnd = gStart + (g.duration || 30);
                    
                    return (newStart < gEnd && newEnd > gStart);
                });
            };

            // [기능] 시간 변경 핸들러 (내부 관리용)
            // 주의: 고객 알림 발송 로직은 포함되지 않음 (내부 스케줄링 전용)
            const handleTimeSelect = (ids, newTime, duration) => {
                if (checkTimeConflict(newTime, duration, ids)) {
                    alert("⚠️ 선택한 시간대는 이미 다른 배송 일정과 겹칩니다.");
                    return;
                }
                updateGroupStatus(ids, { time: newTime });
                
                // [Log] 내부 시스템 로그 (고객 알림 미발송 확인용)
                console.log(`[Internal Schedule] Time updated to ${newTime} for IDs: ${ids.join(', ')}`);
                console.log(`[Notification Check] Customer notification skipped (Policy: Internal Scheduling Only).`);
            };

            // [Test] 예약 시스템 검증 도구 (Console에서 실행 가능)
            window.TestReservationSystem = {
                verifyNotificationSuppression: () => {
                    console.group("🧪 [Test] Reservation Notification Suppression");
                    console.log("Step 1: Updating schedule time...");
                    // Mock ID check
                    const testId = deliveries[0]?.id;
                    if(!testId) {
                        console.warn("No deliveries found to test.");
                        console.groupEnd();
                        return;
                    }
                    
                    // Spy on alert/console
                    const originalAlert = window.alert;
                    let alertCalled = false;
                    window.alert = (msg) => { 
                        if(msg.includes("고객에게")) alertCalled = true; 
                        else originalAlert(msg);
                    };

                    // Trigger update (Mock call)
                    console.log(`Triggering update for ID: ${testId} to 10:00`);
                    handleTimeSelect([testId], "10:00", 30);

                    // Verify
                    if(!alertCalled) {
                        console.log("✅ PASS: No customer notification alert was triggered.");
                    } else {
                        console.error("❌ FAIL: Customer notification alert was triggered!");
                    }
                    
                    // Restore
                    window.alert = originalAlert;
                    console.groupEnd();
                    return "Test Complete";
                }
            };

            if (fatalError) return <div className="p-8 text-center text-red-600 font-bold">오류 발생: {fatalError}</div>;

            if (!isLoggedIn) return <LoginScreen onLogin={(role, name) => {
                setIsLoggedIn(true);
                setView(role);
                setCurrentUser(name);
                if (role === 'driver' && name) {
                    localStorage.setItem('delivery_app_session_driver', name);
                }
            }} />;

            return (
                <div className="min-h-screen bg-slate-50 max-w-[480px] mx-auto shadow-2xl border-x border-slate-200">
                    {/* Header */}
                    <header className="sticky top-0 z-50 bg-white border-b border-slate-200"> 
                        <div className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between relative"> 
                            
                            <div className="flex items-center gap-3"> 
                                <div className="w-12 h-12 rounded-xl bg-indigo-600 flex items-center justify-center text-white text-2xl shadow"> 
                                    🚚 
                                </div> 
                                <div> 
                                    <h1 
                                        onClick={() => {
                                            // [Secret] 5회 연속 클릭 시 관리자 모드 진입 시도
                                            if (view === 'driver') {
                                                const now = Date.now();
                                                const lastClick = window._lastLogoClick || 0;
                                                const clickCount = (window._logoClickCount || 0) + (now - lastClick < 1000 ? 1 : -window._logoClickCount + 1);
                                                
                                                window._lastLogoClick = now;
                                                window._logoClickCount = clickCount;

                                                if (clickCount === 5) {
                                                    const pwd = prompt('관리자 비밀번호를 입력하세요:');
                                                    if (pwd === '1234') {
                                                        setView('admin');
                                                        window._logoClickCount = 0;
                                                    } else if (pwd !== null) {
                                                        alert('비밀번호가 올바르지 않습니다.');
                                                    }
                                                }
                                            }
                                        }}
                                        className="text-lg font-black text-slate-900 leading-tight cursor-pointer select-none"
                                    > 
                                        배송 마스터 
                                    </h1> 
                                    <p className="text-xs text-slate-500"> 
                                        {currentUser} 기사님 
                                    </p> 
                                </div> 
                            </div> 
                            
                            <div className="flex items-center gap-2">
                                {view === 'driver' && (
                                    <button type="button" className="px-2 py-0 rounded-lg bg-transparent text-slate-700 text-[11px] font-bold text-right leading-tight">
                                        <span className="block leading-none text-[10px]">오늘 비용 합계</span>
                                        <span className="block text-[13px] font-black opacity-90">
                                            {`${(totalInstallFeeOnly || 0).toLocaleString()}원`}
                                        </span>
                                    </button>
                                )}
                                <button 
                                    onClick={() => setShowMenu(v => !v)} 
                                    className="w-10 h-10 rounded-lg bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-xl" 
                                > 
                                    ☰ 
                                </button> 
                            </div>
                            
                            {/* Menu Dropdown */}
                            {showMenu && (
                                <div className="absolute right-4 top-16 w-56 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-50 animate-fade-in">
                                    <div className="p-1">
                                        <button onClick={handleUpdateStartPoint} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                            <span>🏢</span> 출발지 설정
                                        </button>
                                        <button onClick={handleUpdateEndPoint} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                            <span>🏠</span> 도착지(홈) 설정
                                        </button>
                                        <button onClick={() => {
                                            setShowMenu(false);
                                            setShowMonthlyCostModal(true);
                                        }} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                            <span>📊</span> 월별 비용 합계
                                        </button>
                                        <button onClick={handleBackupData} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                            <span>💾</span> 데이터 백업 (저장)
                                        </button>
                                        <div className="h-px bg-slate-100 my-1"></div>
                                        <button onClick={() => {
                                            setShowMenu(false);
                                            if(confirm('로그아웃 하시겠습니까?')) {
                                                localStorage.removeItem('delivery_app_session_driver');
                                                setIsLoggedIn(false);
                                                setCurrentUser(null);
                                                setView('driver');
                                            }
                                        }} className="w-full text-left px-4 py-3 text-sm font-bold text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2">
                                            <span>🚪</span> 로그아웃
                                        </button>
                                        {view === 'admin' && (
                                            <button onClick={() => {
                                                setShowMenu(false);
                                                setCurrentUser(null);
                                                setIsLoggedIn(false);
                                                localStorage.removeItem('delivery_app_session_driver');
                                                setView('driver');
                                            }} className="w-full text-left px-4 py-3 text-sm font-bold text-indigo-900 hover:bg-sky-50 rounded-lg flex items-center gap-2">
                                                <span>🚚</span> 기사 모드 전환
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div> 
                    </header>

                    <div className="px-4 py-2 max-w-5xl mx-auto">
                        {/* [New] 기사 모드 비용 요약 (접기 모드 적용) */}
                        {view === 'driver' && null}

                        {/* [New] 날짜 및 지도 컨트롤 (헤더) */}
                        {view === 'driver' && (
                            <>
                                {view === 'driver' && notice && (
                                    <div className="mt-2 w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 shadow-sm overflow-hidden relative flex items-center gap-2">
                                        <span className="font-bold mr-2 whitespace-nowrap bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs z-10">공지</span>
                                        <div className="overflow-hidden w-full relative h-5">
                                            <div className="whitespace-nowrap absolute animate-marquee top-0">
                                                {notice}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="mt-1 animate-fade-in">
                                    <input 
                                        type="date" 
                                        className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-xs font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm text-center tracking-tighter"
                                        value={targetDate} 
                                        onChange={e => setTargetDate(e.target.value)} 
                                    />
                                </div>
                                
                                <Card className="mt-2 mb-4 animate-fade-in"> 
                                   <div className="flex items-center justify-between flex-nowrap gap-2"> 
                                     <div className="flex-1 min-w-0"> 
                                       <h3 className="font-bold text-slate-800 text-base"> 
                                         🚦 오늘 배송 현황 
                                       </h3> 
                                      <p className="text-xs md:text-sm text-slate-500 truncate"> 
                                        {(() => {
                                          const remaining = groupedDeliveries.filter(d => !d.completed && !d.canceled).length;
                                          const done = groupedDeliveries.filter(d => d.completed).length;
                                          const postponed = groupedDeliveries.filter(d => d.canceled && d.cancel_type === 'postpone').length;
                                          const canceled = groupedDeliveries.filter(d => d.canceled && d.cancel_type !== 'postpone').length;
                                          return (
                                            <>
                                              <span>대기 </span>
                                              <span className="font-bold text-rose-600">{remaining}</span>
                                              <span> · 완료 </span>
                                              <span className="font-bold text-green-600">{done}</span>
                                              <span> · 연기 </span>
                                              <span className="font-bold text-amber-600">{postponed}</span>
                                              <span> · 취소 </span>
                                              <span className="font-bold text-red-600">{canceled}</span>
                                            </>
                                          );
                                        })()}
                                      </p> 
                                     </div> 
                                 
                                    <div className="flex items-center gap-2 shrink-0">
                                      <button 
                                        onClick={() => setShowMap(v => !v)} 
                                        className="px-4 py-2 rounded-lg bg-indigo-600 text-white font-bold text-sm shadow hover:bg-indigo-700 whitespace-nowrap" 
                                      > 
                                        {showMap ? '목록 보기' : '지도 보기'} 
                                      </button> 
                                    </div>
                                   </div> 
                                 </Card>
                            </>
                        )}

                        

                        

                        
                    </div>

                    <main className="px-4 pb-32 max-w-7xl mx-auto pt-0">
                        {/* 관리자 요약 및 광고 */}
                        {view === 'admin' && ( 
                           <div className="space-y-4 mb-6"> 
                             {/* 관리자 요약 */} 
                             <Card> 
                               <div className="grid grid-cols-3 gap-4 text-center"> 
                                 <div> 
                                   <p className="text-xs text-slate-500">총 배송</p> 
                                   <p className="text-2xl font-black text-slate-900"> 
                                     {deliveries.length} 
                                   </p> 
                                 </div> 
                                 <div> 
                                   <p className="text-xs text-slate-500">완료</p> 
                                   <p className="text-2xl font-black text-emerald-600"> 
                                     {deliveries.filter(d => d.completed).length} 
                                   </p> 
                                 </div> 
                                 <div> 
                                  <p className="text-xs text-slate-500">대기</p> 
                                   <p className="text-2xl font-black text-rose-600"> 
                                     {deliveries.filter(d => !d.completed).length} 
                                   </p> 
                                 </div> 
                               </div> 
                             </Card> 
                         
                             {/* 📢 광고 ① */} 
                             <AdBanner 
                               slot="1234567890" 
                               className="rounded-xl overflow-hidden" 
                             /> 
                           </div> 
                         )}

                        {/* 관리자 모드 */}
                        {view === 'admin' && (
                            <div className="grid grid-cols-12 gap-2 animate-fade-in pb-20">

                                {/* [New] 공지사항 관리 */}
                                <div className="col-span-12 bg-sky-50 p-2 rounded-xl border border-sky-100 flex flex-col gap-1 items-center">
                                    <div className="font-bold text-indigo-900 whitespace-nowrap flex items-center gap-2 text-xs">
                                        공지사항 설정
                                    </div>
                                    <div className="flex-1 w-full flex gap-2">
                                        <input 
                                            type="text" 
                                            className="flex-1 min-w-0 border border-indigo-200 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            placeholder="기사님들에게 보낼 공지사항을 입력하세요..."
                                            value={notice}
                                            onChange={(e) => setNotice(e.target.value)}
                                        />
                                        <button 
                                            onClick={() => handleNoticeSave(notice)}
                                            className="bg-indigo-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-indigo-700 whitespace-nowrap shrink-0"
                                        >
                                            저장
                                        </button>
                                        <button 
                                            onClick={() => handleNoticeSave('')}
                                            className="bg-white text-red-500 border border-red-200 px-3 py-2 rounded text-sm font-bold hover:bg-red-50 whitespace-nowrap shrink-0"
                                        >
                                            삭제
                                        </button>
                                    </div>
                                </div>
                                
                                {/* [New] 기사별 필터 (관리자 전용) */}
                                <section className="col-span-12 space-y-6 mb-8">
                                    <h2 className="text-lg font-black text-slate-900">
                                        📊 운영 통계
                                    </h2>

                                    {/* [New] 오늘 배송 요약 */}
                                    <Card>
                                        <h3 className="font-bold text-slate-800 mb-3">
                                            📅 오늘 배송 요약
                                        </h3>
                                        {(() => {
                                            const todayStr = new Date().toISOString().split('T')[0];
                                            const yesterday = new Date();
                                            yesterday.setDate(yesterday.getDate() - 1);
                                            const yesterdayStr = yesterday.toISOString().split('T')[0];
                                            
                                            const todayCompleted = deliveries.filter(d => d.date === todayStr && d.completed).length;
                                            const yesterdayCompleted = deliveries.filter(d => d.date === yesterdayStr && d.completed).length;

                                            return (
                                                <div className="grid grid-cols-2 gap-4 text-center">
                                                    <div className="bg-slate-50 rounded-xl py-4">
                                                        <p className="text-xs text-slate-500">오늘 완료</p>
                                                        <p className="text-2xl font-black text-indigo-600">
                                                            {todayCompleted}
                                                        </p>
                                                    </div>

                                                    <div className="bg-slate-50 rounded-xl py-4">
                                                        <p className="text-xs text-slate-500">어제 완료</p>
                                                        <p className="text-2xl font-black text-slate-400">
                                                            {yesterdayCompleted}
                                                        </p>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </Card>

                                    {/* [New] 요일별 배송량 (바 차트) */}
                                    <Card> 
                                        <h3 className="font-bold text-slate-800 mb-3"> 
                                            📈 요일별 배송량 
                                        </h3> 
                                        {(() => {
                                            const days = ['일', '월', '화', '수', '목', '금', '토'];
                                            const weeklyStats = days.map((day, index) => {
                                                const count = deliveries.filter(d => {
                                                    if (!d.date) return false;
                                                    const parts = d.date.split('-');
                                                    if (parts.length !== 3) return false;
                                                    const date = new Date(parts[0], parts[1] - 1, parts[2]);
                                                    return date.getDay() === index;
                                                }).length;
                                                return { name: day, count };
                                            });
                                            const max = Math.max(1, ...weeklyStats.map(w => w.count));

                                            return (
                                                <div className="h-24 flex items-end justify-between gap-2 px-1">
                                                    {weeklyStats.map(w => (
                                                        <div key={w.name} className="flex-1 flex flex-col items-center gap-1">
                                                            <div 
                                                                className="w-full rounded-sm shadow-sm"
                                                                style={{ 
                                                                    height: `${Math.max(6, Math.round((w.count / max) * 100))}%`,
                                                                    backgroundColor: `rgba(239,68,68, ${Math.max(0.35, (w.count / max))})`
                                                                }}
                                                                title={`${w.name} ${w.count}건`}
                                                            />
                                                            <span className="text-[10px] text-slate-500">{w.name}</span>
                                                            <span className="text-[10px] font-bold text-slate-700">{w.count}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            );
                                        })()}
                                    </Card>

                                    {/* [New] 운영 인사이트 */}
                                    <Card className="border-indigo-200 bg-indigo-50"> 
                                       <h3 className="font-black text-indigo-900 mb-2"> 
                                         💡 운영 인사이트 
                                       </h3> 
                                       <ul className="text-sm text-indigo-800 space-y-1"> 
                                         <li>• 오전 10~12시 배송 완료율 최고</li> 
                                         <li>• 월요일 배송량이 평균보다 23% 많음</li> 
                                         <li>• 지도 사용률 높은 기사 = 클레임 낮음</li> 
                                       </ul> 
                                     </Card>
                                    
                                    {/* 기사별 필터 */}
                                    

                                    {/* 2. [Card] 금일 비용 집계 */}
                                    <Card 
                                        className=""
                                    title={
                                        <div className="flex items-center gap-3">
                                            <input type="date" className="bg-transparent border-none p-0 text-xl font-bold text-slate-800 focus:ring-0 cursor-pointer" 
                                                value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                                            <label className="flex items-center gap-1 text-xs text-slate-500 cursor-pointer bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 transition select-none">
                                                <input type="checkbox" checked={showAllDates} onChange={e => setShowAllDates(e.target.checked)} className="rounded text-indigo-600 focus:ring-indigo-500 w-4 h-4" />
                                                <span>전체보기</span>
                                            </label>
                                        </div>
                                    }
                                    description="실시간 현장 비용 현황"
                                >
                                        {(() => {
                                            const stats = groupedDeliveries.reduce((acc, g) => {
                                                if (g.completed) acc.completed++;
                                                else if (g.canceled) {
                                                    if (g.cancel_type === 'postpone') acc.postponed++;
                                                    else acc.canceled++;
                                                }
                                                else if (g.partial) acc.partial++;
                                                return acc;
                                            }, { completed: 0, canceled: 0, postponed: 0, partial: 0 });
                                            return (
                                                <div className="mb-3 flex flex-wrap justify-center gap-2 text-xs font-medium">
                                                    <span className="text-green-700 bg-green-100 px-2 py-0.5 rounded">완료 {stats.completed}</span>
                                                    <span className="text-red-700 bg-red-100 px-2 py-0.5 rounded">취소 {stats.canceled}</span>
                                                    <span className="text-amber-700 bg-amber-100 px-2 py-0.5 rounded">연기 {stats.postponed}</span>
                                                    <span className="text-blue-700 bg-blue-100 px-2 py-0.5 rounded">부분 {stats.partial}</span>
                                                    <span className="text-slate-700 px-2 py-0.5 rounded">총 {groupedDeliveries.length}건</span>
                                                </div>
                                            );
                                        })()}
                                    {(() => {
                                        // [수정] 모든 사용자가 전체 기사들의 비용 합계를 볼 수 있도록 함 (Leaderboard)
                                        // [New] 전체 보기 모드 지원
                                        const allDailyDeliveries = deliveries.filter(d => showAllDates || d.date === form.date);
                                        
                                        const driverStats = {};
                                        allDailyDeliveries.forEach(d => {
                                            const dName = d.driver || '미배정';
                                            const sum = (d.install_fee||0)+(d.yangjung||0)+(d.naerim||0)+(d.etc_fee||0);
                                            driverStats[dName] = (driverStats[dName] || 0) + sum;
                                        });
                                        const sorted = Object.entries(driverStats).sort((a,b) => b[1] - a[1]);

                                        // 상세 및 합계 표시 대상 결정
                                        let targetDriver = null;
                                        let targetTitle = '';
                                        let targetDeliveries = null;
                                        let grandTotal = allDailyDeliveries.reduce((a,c)=>a+(c.install_fee||0)+(c.yangjung||0)+(c.naerim||0)+(c.etc_fee||0),0);

                                        if (currentUser === 'admin' || view === 'admin') { // [Fix] 관리자 모드일 때도 전체 통계 보기
                                            if (adminDriverFilter === 'all') {
                                                targetDriver = null;
                                                targetTitle = '전체 총 합계';
                                            } else if (adminDriverFilter === 'unassigned') {
                                                targetDriver = '미배정';
                                                targetTitle = '미배정 합계';
                                                targetDeliveries = allDailyDeliveries.filter(d => !d.driver);
                                            } else {
                                                targetDriver = adminDriverFilter;
                                                targetTitle = `${adminDriverFilter} 총 합계`;
                                                targetDeliveries = allDailyDeliveries.filter(d => d.driver === adminDriverFilter);
                                            }
                                        } else {
                                            targetDriver = currentUser;
                                            targetTitle = '나의 총 합계';
                                            targetDeliveries = allDailyDeliveries.filter(d => d.driver === currentUser);
                                        }

                                        const targetStats = targetDeliveries ? {
                                            install: targetDeliveries.reduce((a,c)=>a+(c.install_fee||0),0),
                                            yangjung: targetDeliveries.reduce((a,c)=>a+(c.yangjung||0),0),
                                            naerim: targetDeliveries.reduce((a,c)=>a+(c.naerim||0),0),
                                            etc: targetDeliveries.reduce((a,c)=>a+(c.etc_fee||0),0),
                                            total: targetDeliveries.reduce((a,c)=>a+(c.install_fee||0)+(c.yangjung||0)+(c.naerim||0)+(c.etc_fee||0),0)
                                        } : null;

                                        return (
                                            <details className="group/summary bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                                                <summary className="p-3 bg-slate-50 cursor-pointer list-none flex justify-between items-center select-none hover:bg-slate-100 transition-colors">
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-bold text-slate-700">💰 {targetTitle}</span>
                                                        <span className="text-lg font-black text-indigo-900">
                                                            {targetStats ? targetStats.total.toLocaleString() : grandTotal.toLocaleString()}원
                                                        </span>
                                                    </div>
                                                    <svg className="w-5 h-5 text-slate-400 transition-transform group-open/summary:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                        <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
                                                    </svg>
                                                </summary>
                                                <div className="p-4 border-t border-slate-100 animate-fade-in space-y-4 bg-white">
                                                    {/* 1. 기사별 합계 리스트 (Leaderboard) */}
                                                    <div className="space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                                        {sorted.map(([name, val]) => (
                                                            <div key={name} className={`flex justify-between items-center p-3 rounded-lg ${name === targetDriver || (targetDriver === '미배정' && name === '미배정') ? 'bg-sky-50 border border-indigo-200' : 'bg-[#F4F5F7]'}`}>
                                                                <div className="flex items-center gap-2">
                                                                    <span className={`font-bold text-sm ${name === targetDriver || (targetDriver === '미배정' && name === '미배정') ? 'text-indigo-700' : 'text-slate-600'}`}>
                                                                        {name} {name === currentUser && '(나)'}
                                                                    </span>
                                                                </div>
                                                                <span className={`font-bold ${name === targetDriver || (targetDriver === '미배정' && name === '미배정') ? 'text-indigo-700' : 'text-slate-800'}`}>{val.toLocaleString()}원</span>
                                                            </div>
                                                        ))}
                                                        {sorted.length === 0 && <div className="text-center text-gray-400 py-4">데이터 없음</div>}
                                                    </div>

                                                    {/* 2. 상세 내역 (선택된 기사 또는 본인) */}
                                                    {targetStats && (
                                                        <div className="border-t border-slate-100 pt-4">
                                                            <div className="text-xs font-bold text-slate-400 mb-2 uppercase">상세 내역</div>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <div className="bg-slate-50 p-2 rounded text-center">
                                                                    <div className="text-[10px] text-slate-500">설치</div>
                                                                    <div className="font-bold text-slate-700">{targetStats.install.toLocaleString()}</div>
                                                                </div>
                                                                <div className="bg-slate-50 p-2 rounded text-center">
                                                                    <div className="text-[10px] text-slate-500">양중</div>
                                                                    <div className="font-bold text-slate-700">{targetStats.yangjung.toLocaleString()}</div>
                                                                </div>
                                                                <div className="bg-slate-50 p-2 rounded text-center">
                                                                    <div className="text-[10px] text-slate-500">내림</div>
                                                                    <div className="font-bold text-slate-700">{targetStats.naerim.toLocaleString()}</div>
                                                                </div>
                                                                <div className="bg-slate-50 p-2 rounded text-center">
                                                                    <div className="text-[10px] text-slate-500">기타</div>
                                                                    <div className="font-bold text-slate-700">{targetStats.etc.toLocaleString()}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </details>
                                        );
                                    })()}
                                </Card>

                                    {/* 3. [Card] 월별 정산 관리 */}
                                    <Card 
                                        className=""
                                    title={
                                        <input type="month" className="bg-transparent border-none p-0 text-xl font-bold text-slate-800 focus:ring-0 cursor-pointer" 
                                            value={settleMonth} onChange={e => setSettleMonth(e.target.value)} />
                                    }
                                    description="월별 매출 및 부가세 현황"
                                >
                                    {(() => {
                                        const mList = deliveries.filter(d => {
                                            if (!String(d.date || '').startsWith(settleMonth)) return false;
                                            if (currentUser === 'admin') {
                                                if (adminDriverFilter === 'all') return true;
                                                if (adminDriverFilter === 'unassigned') return !d.driver;
                                                return d.driver === adminDriverFilter;
                                            }
                                            return d.driver === currentUser;
                                        });
                                        const mInstall = mList.reduce((a,c) => a+(c.install_fee||0), 0);
                                        const mYangjung = mList.reduce((a,c) => a+(c.yangjung||0), 0);
                                        const mNaerim = mList.reduce((a,c) => a+(c.naerim||0), 0);
                                        const mEtc = mList.reduce((a,c) => a+(c.etc_fee||0), 0);
                                        const mSubTotal = mInstall + mYangjung + mNaerim + mEtc;
                                        const mVAT = Math.floor(mSubTotal * 0.1);
                                        const mGrandTotal = mSubTotal + mVAT;

                                        return (
                                            <div className="space-y-3">
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">설치비</div>
                                                        <div className="font-bold text-lg text-slate-800 text-right">{mInstall.toLocaleString()}</div>
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">양중비</div>
                                                        <div className="font-bold text-lg text-slate-800 text-right">{mYangjung.toLocaleString()}</div>
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">내림비</div>
                                                        <div className="font-bold text-lg text-slate-800 text-right">{mNaerim.toLocaleString()}</div>
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">기타</div>
                                                        <div className="font-bold text-lg text-slate-800 text-right">{mEtc.toLocaleString()}</div>
                                                    </div>
                                                </div>
                                                <div className="bg-[#0052CC] p-4 rounded-xl shadow-lg text-white mt-4 text-right">
                                                    <div className="mb-2">
                                                        <div className="text-xs opacity-80 font-bold mb-1 uppercase">최종 지급액 (VAT포함)</div>
                                                        <div className="text-[10px] opacity-70">공급가액: {mSubTotal.toLocaleString()} + VAT: {mVAT.toLocaleString()}</div>
                                                    </div>
                                                    <div className="font-black text-3xl">
                                                        {mGrandTotal.toLocaleString()}<span className="text-sm font-medium opacity-80 ml-1">원</span>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </Card>

                                    {/* 📢 광고 ② */} 
                                    <div className="my-6"> 
                                        <AdBanner 
                                            slot="2345678901" 
                                            format="auto" 
                                        /> 
                                    </div>
                                </section>

                                {view === 'admin' && ( 
                                   <div className="mt-6"> 
                                     <AdBanner 
                                       slot="4567890123" 
                                       format="auto" 
                                     /> 
                                   </div> 
                                 )}

                                {/* 수동 등록 폼 & 엑셀 업로드 & 검증 */}
                                <div className="col-span-12 grid grid-cols-12 gap-6">
                                    {!showManualRegister ? (
                                        <div className="col-span-12">
                                            <button 
                                                onClick={() => setShowManualRegister(true)}
                                                className="w-full bg-white border border-indigo-200 text-indigo-900 p-4 rounded-xl font-bold text-lg hover:bg-sky-50 transition-all flex items-center justify-center gap-2 shadow-sm"
                                            >
                                                <span>✍️</span> 개별 배송 건 등록하기
                                            </button>
                                        </div>
                                    ) : (
                                        <Card 
                                            className="col-span-12"
                                            title={
                                                <div className="flex justify-between items-center w-full">
                                                    <span>개별 등록</span>
                                                    <button 
                                                        onClick={() => setShowManualRegister(false)}
                                                        className="text-sm bg-slate-100 px-3 py-1 rounded-lg text-slate-500 hover:bg-slate-200"
                                                    >
                                                        닫기
                                                    </button>
                                                </div>
                                            }
                                            description="상품 정보를 입력하여 배송 건을 등록하세요."
                                        >
                                            <form onSubmit={handleManualAdd} className="space-y-4">
                                                {/* 예약 시스템 (날짜/시간) - 아이콘/타이틀 삭제 */}
                                                <div className="bg-sky-50 p-4 rounded-xl border border-sky-100">
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label className="text-xs font-bold text-indigo-700 mb-1 block">예약 날짜</label>
                                                            <input type="date" 
                                                                min={reservationConstraints.min} 
                                                                max={reservationConstraints.max}
                                                                className="w-full bg-white p-2.5 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 text-sm"
                                                                value={form.reservationDate} 
                                                                onChange={e => setForm({...form, reservationDate: e.target.value})} 
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-indigo-700 mb-1 block">예약 시간</label>
                                                            <select 
                                                                disabled={!form.reservationDate}
                                                                className="w-full bg-white p-2.5 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 text-sm disabled:bg-slate-100"
                                                                value={form.reservationTime} 
                                                                onChange={e => setForm({...form, reservationTime: e.target.value})} 
                                                            >
                                                                <option value="">시간 선택</option>
                                                                {timeSlots.map(time => {
                                                                    const blocked = isTimeBlocked(form.reservationDate, time);
                                                                    return (
                                                                        <option key={time} value={time} disabled={blocked} className={blocked ? 'text-gray-400 bg-gray-50' : ''}>
                                                                            {time} {blocked ? '(마감)' : ''}
                                                                        </option>
                                                                    );
                                                                })}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* 비용 입력 필드 (월별매출 박스 스타일) */}
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">설치비</div>
                                                        <input type="number" placeholder="0" className="w-full bg-transparent font-bold text-lg text-slate-800 placeholder-slate-300 focus:outline-none" 
                                                            value={form.install_fee || ''} onChange={e => setForm({...form, install_fee: e.target.value})} />
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">양중비</div>
                                                        <input type="number" placeholder="0" className="w-full bg-transparent font-bold text-lg text-slate-800 placeholder-slate-300 focus:outline-none" 
                                                            value={form.yangjung || ''} onChange={e => setForm({...form, yangjung: e.target.value})} />
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">내림비</div>
                                                        <input type="number" placeholder="0" className="w-full bg-transparent font-bold text-lg text-slate-800 placeholder-slate-300 focus:outline-none" 
                                                            value={form.naerim || ''} onChange={e => setForm({...form, naerim: e.target.value})} />
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">기타</div>
                                                        <input type="number" placeholder="0" className="w-full bg-transparent font-bold text-lg text-slate-800 placeholder-slate-300 focus:outline-none" 
                                                            value={form.etc_fee || ''} onChange={e => setForm({...form, etc_fee: e.target.value})} />
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="text-xs font-bold text-slate-500 mb-1 block">상품명 (필수)</label>
                                                    <input type="text" required placeholder="상품 정보를 입력하세요" className="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                        value={form.item} onChange={e => setForm({...form, item: e.target.value})} />
                                                </div>
                                                
                                                <div className="grid grid-cols-1 gap-4">
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 mb-1 block">전화번호</label>
                                                        <input type="tel" required placeholder="010-0000-0000" className="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                            value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 mb-1 block">주소</label>
                                                        <input type="text" required placeholder="전체 주소 입력" className="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                            value={form.address} onChange={e => setForm({...form, address: e.target.value})} />
                                                    </div>
                                                </div>

                                                {/* 배송 메모 */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <label className="text-xs font-bold text-slate-500">배송 메모</label>
                                                        <span className={`text-[10px] ${form.memo.length < Config.MEMO.MIN_LENGTH ? 'text-red-500' : 'text-green-500'}`}>
                                                            {form.memo.length} / {Config.MEMO.MAX_LENGTH}자
                                                        </span>
                                                    </div>
                                                    <textarea 
                                                        className="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-sm resize-none"
                                                        placeholder={`특이사항을 입력하세요 (최소 ${Config.MEMO.MIN_LENGTH}자, 특수문자 제외)`}
                                                        rows="3"
                                                        value={form.memo}
                                                        onChange={handleMemoChange}
                                                    ></textarea>
                                                    {form.memo && form.memo.length < Config.MEMO.MIN_LENGTH && (
                                                        <p className="text-[10px] text-red-500 mt-1">⚠️ 최소 {Config.MEMO.MIN_LENGTH}자 이상 입력해주세요.</p>
                                                    )}
                                                </div>

                                                <button type="submit" className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 active:scale-[0.98] transition-all shadow-lg shadow-indigo-200 mt-2">
                                                    등록하기
                                                </button>
                                            </form>
                                        </Card>
                                    )}

                                    <div className="col-span-12 space-y-3">
                                        <details className="group">
                                            <summary className="w-full bg-white border border-indigo-200 text-indigo-900 p-4 rounded-xl font-bold text-lg hover:bg-sky-50 transition-all flex items-center justify-between gap-2 shadow-sm cursor-pointer list-none">
                                                <span className="flex items-center gap-2"><span>🛠</span> 관리자 도구</span>
                                                <span className="text-slate-400 transition-transform group-open:rotate-180">▾</span>
                                            </summary>
                                            <div className="mt-3 bg-white p-4 rounded-xl border border-amber-100 shadow-sm">
                                                <h4 className="text-sm font-bold text-amber-900 mb-2 flex items-center gap-2">
                                                    <span>📊</span> 엑셀 대량 등록
                                                </h4>
                                                <div className="flex gap-3 mb-2">
                                                    <button onClick={downloadTemplate} className="flex-1 bg-slate-50 text-slate-700 py-3 rounded-lg font-bold hover:bg-slate-100 transition-all text-sm flex flex-col items-center justify-center gap-1 border border-slate-200">
                                                        <span className="text-lg">📥</span>
                                                        양식 다운로드
                                                    </button>
                                                    <label className="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-all text-sm flex flex-col items-center justify-center gap-1 shadow-md cursor-pointer active:scale-[0.98]">
                                                        <span className="text-lg">📂</span>
                                                        엑셀 업로드
                                                        <input type="file" hidden accept=".xlsx" onChange={handleFileUpload} />
                                                    </label>
                                                </div>
                                                {uploadedFileName && (
                                                    <div className="text-center text-xs font-bold text-green-600 bg-green-50 p-2 rounded border border-green-100">
                                                        ✅ 마지막 업로드: {uploadedFileName}
                                                    </div>
                                                )}
                                                <p className="text-xs text-slate-400 mt-2">
                                                    * 날짜 형식은 "01월 30일" 처럼 입력하면 자동으로 처리됩니다.
                                                </p>
                                            </div>
                                        </details>
                                        
                                        <details className="group">
                                            <summary className="w-full bg-white border border-indigo-200 text-indigo-900 p-3 rounded-xl font-bold text-sm hover:bg-sky-50 transition-all flex items-center justify-between gap-2 shadow-sm cursor-pointer list-none">
                                                <span className="flex items-center gap-2"><span>💾</span> 데이터 관리</span>
                                                <span className="text-slate-400 transition-transform group-open:rotate-180">▾</span>
                                            </summary>
                                            <div className="mt-3 bg-white p-4 rounded-xl border border-amber-100 shadow-sm">
                                                <div className="mb-3">
                                                     <button onClick={() => setCloudModalOpen(true)} className="w-full bg-indigo-50 text-indigo-900 py-2 rounded-lg text-xs font-bold border border-indigo-100 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                                                         {isCloudConnected ? "☁️ 서버 연결됨" : "⚙️ 서버 설정"}
                                                     </button>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <button onClick={() => handleCloudSync('push')} className="bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition text-sm shadow-md flex flex-col items-center justify-center gap-1">
                                                        <span className="text-lg">☁️⬆️</span>
                                                        <span>서버에 올리기</span>
                                                    </button>
                                                    <button onClick={() => handleCloudSync('pull')} className="bg-white text-indigo-900 py-3 rounded-lg font-bold hover:bg-indigo-50 transition text-sm border border-indigo-200 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-lg">☁️⬇️</span>
                                                        <span>서버에서 받기</span>
                                                    </button>
                                                    
                                                    <button onClick={() => {
                                                        const blob = new Blob([JSON.stringify(deliveries)], {type: "application/json"});
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.href = url;
                                                        a.download = `manager_data_${new Date().toISOString().slice(0,10)}.json`;
                                                        a.click();
                                                    }} className="bg-slate-50 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-100 transition text-xs border border-slate-200 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-lg">💾</span>
                                                        <span>파일저장</span>
                                                    </button>
                                                    
                                                    <label className="bg-slate-50 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-100 transition text-xs border border-slate-200 flex flex-col items-center justify-center gap-1 cursor-pointer">
                                                        <span className="text-lg">📂</span>
                                                        <span>파일불러오기</span>
                                                        <input type="file" hidden accept=".json" onChange={(e) => {
                                                            const file = e.target.files[0];
                                                            if(!file) return;
                                                            readJsonFileWithEncoding(file, (data) => {
                                                                if(Array.isArray(data)) {
                                                                    if(confirm(`기사님이 작업한 ${data.length}건의 데이터를 불러오시겠습니까? 기존 데이터는 업데이트됩니다.`)) {
                                                                        setDeliveries(data);
                                                                        StorageManager.saveDeliveries(data);
                                                                        alert("데이터가 동기화되었습니다.");
                                                                    }
                                                                } else {
                                                                    alert("올바르지 않은 데이터 형식입니다.");
                                                                }
                                                            });
                                                        }} />
                                                    </label>

                                                    <button onClick={handleVerifyData} className="bg-sky-50 text-indigo-900 py-3 rounded-lg font-bold hover:bg-indigo-100 transition text-sm border border-sky-100">
                                                        📊 데이터 검증
                                                    </button>
                                                    <button onClick={fixCoordinates} className="bg-red-50 text-red-600 py-3 rounded-lg font-bold hover:bg-red-100 transition text-sm border border-red-100">
                                                        🛠 좌표 보정
                                                    </button>
                                                    <button onClick={async () => {
                                                        setLoading(true);
                                                        const removed = await StorageManager.cleanupEphemeral();
                                                        setLoading(false);
                                                        alert(`저장소 정리를 완료했습니다.\n정리 항목: ${removed}개\n(검증 리포트/브라우저 캐시 등)\n※ 자동 백업은 유지됩니다.`);
                                                    }} className="bg-indigo-50 text-indigo-900 py-3 rounded-lg font-bold hover:bg-indigo-100 transition text-sm border border-indigo-200">
                                                        🧹 저장소 정리
                                                    </button>
                                                    <button onClick={async () => {
                                                        await StorageManager.ensurePersistent();
                                                    }} className="bg-slate-50 text-slate-700 py-3 rounded-lg font-bold hover:bg-slate-100 transition text-sm border border-slate-200">
                                                        🔒 영구 저장 요청
                                                    </button>
                                                    <button onClick={async () => {
                                                        await StorageManager.showEstimate();
                                                    }} className="bg-slate-50 text-slate-700 py-3 rounded-lg font-bold hover:bg-slate-100 transition text-sm border border-slate-200">
                                                        💾 사용량 확인
                                                    </button>
                                                    <button onClick={() => {
                                                        const settings = StorageManager.get(Config.STORAGE_KEYS.SETTINGS) || {};
                                                        const daysStr = prompt('클라우드에 유지할 최근 일수 입력 (예: 60):', String(settings.cloud_compact_days || 60));
                                                        if (!daysStr) return;
                                                        const days = parseInt(daysStr, 10);
                                                        if (isNaN(days) || days <= 0) {
                                                            alert('유효한 숫자를 입력하세요.');
                                                            return;
                                                        }
                                                        const enable = confirm(`클라우드 데이터를 최근 ${days}일만 유지하도록 경량화합니다.\n서버의 이전 데이터는 덮어씌워질 수 있습니다. 진행하시겠습니까?`);
                                                        if (!enable) return;
                                                        const next = { ...(settings || {}), cloud_compact_enabled: true, cloud_compact_days: days };
                                                        StorageManager.set(Config.STORAGE_KEYS.SETTINGS, next);
                                                        alert('클라우드 경량화 설정이 적용되었습니다. 다음 저장부터 반영됩니다.');
                                                    }} className="bg-amber-50 text-amber-800 py-3 rounded-lg font-bold hover:bg-amber-100 transition text-sm border border-amber-200">
                                                        ☁️ 클라우드 경량화 설정
                                                    </button>
                                                    <button onClick={() => {
                                                        const settings = StorageManager.get(Config.STORAGE_KEYS.SETTINGS) || {};
                                                        const daysStr = prompt('아카이브로 내보낼 기준: 최근 일수 (예: 60). 입력한 일수보다 오래된 데이터를 내보냅니다.', String(settings.cloud_compact_days || 60));
                                                        if (!daysStr) return;
                                                        const days = parseInt(daysStr, 10);
                                                        if (isNaN(days) || days <= 0) {
                                                            alert('유효한 숫자를 입력하세요.');
                                                            return;
                                                        }
                                                        StorageManager.exportArchive(deliveries, days);
                                                    }} className="bg-slate-50 text-slate-700 py-3 rounded-lg font-bold hover:bg-slate-100 transition text-sm border border-slate-200">
                                                        📦 아카이브 내보내기
                                                    </button>
                                                     
                                                    <button onClick={() => {
                                                        const backupList = StorageManager.get('mvp_backup_list') || [];
                                                        if(backupList.length === 0) {
                                                            alert("저장된 자동 백업이 없습니다.");
                                                            return;
                                                        }
                                                        const msg = backupList.map((b, i) => `${i+1}. ${b.time} (${b.count}건)`).join('\n');
                                                        const choice = prompt(`[자동 백업 복구]\n복구할 백업 번호를 입력하세요:\n\n${msg}`);
                                                        if (!choice) return;
                                                        
                                                        const idx = parseInt(choice) - 1;
                                                        if(idx >= 0 && idx < backupList.length) {
                                                            const backupKey = backupList[idx].key;
                                                            const backup = StorageManager.get(backupKey);
                                                            if(backup && backup.deliveries) {
                                                                if(confirm(`"${backupList[idx].time}" 시점의 데이터(${backup.deliveries.length}건)로 복구하시겠습니까?\n\n⚠️ 현재 작업 중인 내용은 덮어씌워집니다.`)) {
                                                                    setDeliveries(backup.deliveries);
                                                                    StorageManager.saveDeliveries(backup.deliveries);
                                                                    alert("✅ 데이터가 성공적으로 복구되었습니다.");
                                                                }
                                                            } else {
                                                                alert("백업 데이터를 찾을 수 없거나 손상되었습니다.");
                                                            }
                                                        } else {
                                                            alert("잘못된 번호입니다.");
                                                        }
                                                    }} className="col-span-2 bg-orange-50 text-orange-800 py-3 rounded-lg font-bold hover:bg-orange-100 transition text-sm border border-orange-200 shadow-sm flex items-center justify-center gap-2">
                                                        <span>↺</span> 자동 백업 복구
                                                    </button>
                                                    <button onClick={() => {
                                                        if (!confirm('모든 데이터가 삭제됩니다. 진행하시겠습니까?')) return;
                                                        localStorage.removeItem(Config.STORAGE_KEYS.DELIVERIES);
                                                        location.reload();
                                                    }} className="col-span-2 bg-red-600 text-white py-3 rounded-lg font-bold hover:bg-red-700 transition text-sm shadow-md flex items-center justify-center gap-2">
                                                        🗑 전체 데이터 초기화
                                                    </button>
                                                </div>
                                            </div>
                                        </details>
                                    </div>
                                </div>

                                <details className="group col-span-12">
                                    <summary className="w-full bg-white border border-indigo-200 text-indigo-900 p-4 rounded-xl font-bold text-lg hover:bg-sky-50 transition-all flex items-center justify-between gap-2 shadow-sm cursor-pointer list-none">
                                        <span className="flex items-center gap-2">{`👥 고객 목록 (${
                                            deliveries.filter(d => {
                                                const dateMatch = customerViewMode === 'daily' ? d.date === customerFilterDate : String(d.date||'').startsWith(customerFilterMonth);
                                                if (!dateMatch) return false;
                                                if (currentUser === 'admin') {
                                                    if (adminDriverFilter === 'all') return true;
                                                    if (adminDriverFilter === 'unassigned') return !d.driver;
                                                    return d.driver === adminDriverFilter;
                                                }
                                                return d.driver === currentUser;
                                            }).length
                                        }건)`}</span>
                                        <span className="text-slate-400 transition-transform group-open:rotate-180">▾</span>
                                    </summary>
                                    <div className="mt-3 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                                    

                                    <div className="flex flex-col gap-2 mb-4">
                                        <div className="flex justify-end gap-1 bg-slate-100 p-1 rounded-lg self-end">
                                             <button onClick={() => setCustomerViewMode('daily')} className={`px-3 py-1 text-xs font-bold rounded-md transition ${customerViewMode === 'daily' ? 'bg-white shadow text-indigo-900' : 'text-gray-500 hover:text-gray-700'}`}>일별</button>
                                             <button onClick={() => setCustomerViewMode('monthly')} className={`px-3 py-1 text-xs font-bold rounded-md transition ${customerViewMode === 'monthly' ? 'bg-white shadow text-indigo-900' : 'text-gray-500 hover:text-gray-700'}`}>월별</button>
                                             <button onClick={showDeleteRangePrompt} className="px-3 py-1 text-xs font-bold rounded-md transition bg-red-50 text-red-700 border border-red-200 hover:bg-red-100">데이터 삭제</button>
                                        </div>
                                        
                                        {/* [New] 검색 필터 */}
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">🔍</span>
                                            <input 
                                                type="text" 
                                                className="w-full pl-9 pr-3 py-2 border rounded-lg text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                                placeholder="이름, 주소, 상품, 주문번호 등 검색..."
                                                value={customerSearchTerm}
                                                onChange={(e) => setCustomerSearchTerm(e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    {customerViewMode === 'daily' && (
                                        <div className="flex gap-2 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                            <input type="date" className="bg-white border p-2 rounded text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 w-full" 
                                                value={customerFilterDate} onChange={e => setCustomerFilterDate(e.target.value)} />
                                        </div>
                                    )}

                                    {customerViewMode === 'monthly' && (
                                        <div className="flex gap-2 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                            <input type="month" className="bg-white border p-2 rounded text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500" 
                                                value={customerFilterMonth} onChange={e => setCustomerFilterMonth(e.target.value)} />
                                            <button onClick={downloadCustomerExcel} className="flex-1 bg-green-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-green-700 flex items-center justify-center gap-1 shadow-sm">
                                                <span>📥</span> 엑셀 다운로드
                                            </button>
                                        </div>
                                    )}

                                    <div className="space-y-3 max-h-[500px] overflow-y-auto pr-1">
                                        {(() => {
                                            const listData = deliveries.filter(d => {
                                                const dateMatch = customerViewMode === 'daily' 
                                                    ? d.date === customerFilterDate
                                                    : String(d.date || '').startsWith(customerFilterMonth);
                                                
                                                if (!dateMatch) return false;

                                                if (currentUser === 'admin') {
                                                    // [New] 검색어 필터
                                                    if (customerSearchTerm) {
                                                        const term = customerSearchTerm.toLowerCase();
                                                        const searchTarget = [
                                                            d.item, d.address, d.phone, d.driver, 
                                                            d.order_number, d.invoice_number, d.center, d.region
                                                        ].map(v => String(v || '').toLowerCase());
                                                        
                                                        if (!searchTarget.some(val => val.includes(term))) return false;
                                                    }

                                                    if (adminDriverFilter === 'all') return true;
                                                    if (adminDriverFilter === 'unassigned') return !d.driver;
                                                    return d.driver === adminDriverFilter;
                                                }
                                                return d.driver === currentUser;
                                            });

                                            if (listData.length === 0) {
                                                const totalCount = deliveries.length;
                                                return (
                                                    <div className="text-center py-8 bg-slate-50 rounded-lg border border-dashed border-slate-300">
                                                        <p className="text-gray-500 mb-2 font-medium">
                                                            {customerViewMode === 'daily' ? `${customerFilterDate}에 등록된 배송 건이 없습니다.` : '해당 월에 배송 건이 없습니다.'}
                                                        </p>
                                                        {totalCount > 0 && (
                                                            <div className="text-xs text-indigo-500">
                                                                <p className="mb-2">전체 데이터: {totalCount}건 보관 중</p>
                                                                <button 
                                                                    onClick={() => {
                                                                        const dates = [...new Set(deliveries.map(d => d.date))].sort();
                                                                        alert(`데이터가 있는 날짜 목록:\n${dates.join(', ')}`);
                                                                    }}
                                                                    className="bg-white border border-indigo-200 px-3 py-1 rounded shadow-sm hover:bg-indigo-50"
                                                                >
                                                                    📅 데이터가 있는 날짜 확인하기
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            }

                                            return listData.map(d => (
                                                <div key={d.id} className="border p-3 rounded-lg bg-gray-50 hover:bg-white transition shadow-sm relative group">
                                                    <div className="flex justify-between items-start mb-2 gap-2">
                                                        <div className="flex-1 min-w-0 overflow-hidden">
                                                            {/* [New] 관리자 모드 추가 정보 표시 */}
                                                            {currentUser === 'admin' && (
                                                                <div className="flex flex-wrap gap-2 mb-1 text-[10px] text-slate-500">
                                                                    {d.order_number && <span className="bg-slate-100 px-1 rounded border">ORD: {d.order_number}</span>}
                                                                    {d.invoice_number && <span className="bg-slate-100 px-1 rounded border">INV: {d.invoice_number}</span>}
                                                                    {d.center && <span className="bg-sky-50 text-indigo-700 px-1 rounded border border-sky-100">{d.center}</span>}
                                                                    {d.region && <span className="bg-slate-100 px-1 rounded border">{d.region}</span>}
                                                                </div>
                                                            )}
                                                            <div className={`font-bold ${(d._mergedOriginals || (d.detail_items && d.detail_items.length > 1)) ? 'text-red-600' : 'text-indigo-900'}`}>{d.item}</div>
                                                            <div className="text-xs text-gray-500">{d.address}</div>
                                                            <div className="flex gap-1 mt-1 flex-wrap">
                                                                {d.completed && <span className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold">✅ 완료</span>}
                                                                {d.partial && <span className="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold">🌗 부분</span>}
                                                                {d.canceled && (
                                                                    d.cancel_type === 'postpone' 
                                                                    ? <span className="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-bold">🕒 연기</span>
                                                                    : <span className="text-[10px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded font-bold">❌ 취소</span>
                                                                )}
                                                                {customerViewMode === 'monthly' && <span className="text-[10px] text-slate-500 border border-slate-200 px-1.5 py-0.5 rounded">📅 {d.date}</span>}
                                                                {currentUser === 'admin' && d.driver && <span className="text-[10px] bg-sky-50 text-indigo-700 px-1.5 py-0.5 rounded font-bold border border-sky-100">👷 {d.driver}</span>}
                                                            </div>
                                                        </div>
                                                        <button onClick={() => deleteDelivery([d.id])} className="w-8 h-8 flex items-center justify-center text-red-400 hover:text-red-600 rounded-full hover:bg-red-50 transition flex-shrink-0 bg-white border border-gray-100 shadow-sm">🗑️</button>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div>
                                                            <label className="text-xs font-bold text-gray-500 block mb-1">설치비</label>
                                                            <input type="text" inputMode="numeric" className="w-full border rounded p-2 text-right text-sm font-bold focus:ring-2 focus:ring-indigo-200 outline-none"
                                                                value={(d.install_fee || 0).toLocaleString()}
                                                                onChange={(e) => {
                                                                    const val = parseInt(e.target.value.replace(/,/g, '')) || 0;
                                                                    const newDeliveries = deliveries.map(item => item.id === d.id ? { ...item, install_fee: val } : item);
                                                                    setDeliveries(newDeliveries);
                                                                    StorageManager.saveDeliveries(newDeliveries);
                                                                }}
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-gray-500 block mb-1">양중비</label>
                                                            <input type="text" inputMode="numeric" className="w-full border rounded p-2 text-right text-sm font-bold focus:ring-2 focus:ring-indigo-200 outline-none"
                                                                value={(d.yangjung || 0).toLocaleString()}
                                                                onChange={(e) => {
                                                                    const val = parseInt(e.target.value.replace(/,/g, '')) || 0;
                                                                    const newDeliveries = deliveries.map(item => item.id === d.id ? { ...item, yangjung: val } : item);
                                                                    setDeliveries(newDeliveries);
                                                                    StorageManager.saveDeliveries(newDeliveries);
                                                                }}
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-gray-500 block mb-1">내림비</label>
                                                            <input type="text" inputMode="numeric" className="w-full border rounded p-2 text-right text-sm font-bold focus:ring-2 focus:ring-indigo-200 outline-none"
                                                                value={(d.naerim || 0).toLocaleString()}
                                                                onChange={(e) => {
                                                                    const val = parseInt(e.target.value.replace(/,/g, '')) || 0;
                                                                    const newDeliveries = deliveries.map(item => item.id === d.id ? { ...item, naerim: val } : item);
                                                                    setDeliveries(newDeliveries);
                                                                    StorageManager.saveDeliveries(newDeliveries);
                                                                }}
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-gray-500 block mb-1">기타비용</label>
                                                            <input type="text" inputMode="numeric" className="w-full border rounded p-2 text-right text-sm font-bold focus:ring-2 focus:ring-indigo-200 outline-none"
                                                                value={(d.etc_fee || 0).toLocaleString()}
                                                                onChange={(e) => {
                                                                    const val = parseInt(e.target.value.replace(/,/g, '')) || 0;
                                                                    const newDeliveries = deliveries.map(item => item.id === d.id ? { ...item, etc_fee: val } : item);
                                                                    setDeliveries(newDeliveries);
                                                                    StorageManager.saveDeliveries(newDeliveries);
                                                                }}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        })()}
                                    </div>
                                    </div>
                                </details>
                            </div>
                        )}

                        {/* 📢 광고 ③ (화면 최하단) */}
                        {view === 'admin' && (
                           <div className="mt-4">
                               <AdBanner 
                                 slot="3456789012" 
                                 className="rounded-xl" 
                               />
                           </div>
                        )}

                        {/* 기사 모드: 배송 추가 화면 (Admin 폼 재사용 형태) */}
                        {view === 'driver_add' && (
                            <div className="bg-white p-4 rounded-xl shadow-sm border min-h-[500px]">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="font-bold text-lg flex items-center gap-2">📦 새 배송지 추가</h2>
                                    <button onClick={() => setView('driver')} className="text-gray-500 font-bold">✕ 닫기</button>
                                </div>
                                <form onSubmit={(e) => {
                                    handleManualAdd(e).then(() => setView('driver'));
                                }} className="space-y-4">
                                    {/* 날짜는 현재 선택된 날짜 자동 적용 */}
                                    <input type="hidden" value={targetDate} /> 
                                    
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">방문예정시간 (30분 단위)</label>
                                        <select 
                                            className="w-full bg-gray-100 p-3 rounded text-lg font-bold"
                                            value={form.time} 
                                            onChange={e => {
                                                const val = e.target.value;
                                                if(checkTimeConflict(val, 30, [])) {
                                                    alert("⚠️ 이미 예약된 시간대입니다.");
                                                    return;
                                                }
                                                setForm({...form, time: val});
                                            }}
                                        >
                                            <option value="">시간 선택</option>
                                            {TIME_SLOTS.map(t => {
                                                const isConflict = checkTimeConflict(t, 30, []);
                                                return (
                                                    <option key={t} value={t} disabled={isConflict} className={isConflict ? 'text-gray-400' : ''}>
                                                        {t} {isConflict ? '(마감)' : ''}
                                                    </option>
                                                );
                                            })}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">상품명 (필수)</label>
                                        <input type="text" required placeholder="상품명 입력" className="w-full bg-gray-100 p-3 rounded" 
                                            value={form.item} onChange={e => setForm({...form, item: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">전화번호 (필수)</label>
                                        <input type="tel" required placeholder="010-0000-0000" className="w-full bg-gray-100 p-3 rounded" 
                                            value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">주소 (필수)</label>
                                        <input type="text" required placeholder="주소 입력" className="w-full bg-gray-100 p-3 rounded" 
                                            value={form.address} onChange={e => setForm({...form, address: e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">설치비</label>
                                            <input type="number" placeholder="0" className="w-full bg-gray-100 p-3 rounded text-right" 
                                                value={form.install_fee || ''} onChange={e => setForm({...form, install_fee: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">양중비</label>
                                            <input type="number" placeholder="0" className="w-full bg-gray-100 p-3 rounded text-right" 
                                                value={form.yangjung || ''} onChange={e => setForm({...form, yangjung: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">내림비</label>
                                            <input type="number" placeholder="0" className="w-full bg-gray-100 p-3 rounded text-right" 
                                                value={form.naerim || ''} onChange={e => setForm({...form, naerim: e.target.value})} />
                                        </div>
                                    </div>
                                    <button type="submit" className="w-full bg-green-500 text-white py-4 rounded-lg font-bold hover:bg-green-600 transition text-lg">
                                        추가 완료
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* 기사 모드 */}
                        {view === 'driver' && (
                            <div className="space-y-4">


                                {/* 지도 영역: Active 목록 상위 30개만 표시 (성능 최적화) */}
                                {showMap && (
                                    <>
                                        {groupedDeliveries.filter(d => d.is_active).length > 30 && (
                                            <div className="text-xs text-orange-600 font-bold mb-1 text-right">
                                                * 성능 최적화를 위해 상위 30개 마커만 지도에 표시됩니다.
                                            </div>
                                        )}
                                        <MapView 
                                            locations={[
                                                ...groupedDeliveries.filter(d => d.is_active).slice(0, 30),
                                                ...(endPoint ? [endPoint] : [])
                                            ]} 
                                                center={
                                                    groupedDeliveries.find(d => d.is_active && d.lat && d.lng && !isNaN(d.lat) && !isNaN(d.lng)) 
                                                    || (startPoint && startPoint.lat && startPoint.lng ? startPoint : null)
                                                } 
                                            startPoint={startPoint}
                                        />
                                    </>
                                )}

                                {/* 리스트 영역 */}
                                <div className="space-y-4">
                                    {/* 상단 제어바 제거: 아래로 이동 */}
                                    
                                    {/* 합치기 실행 버튼 (모드 활성화 시 표시) */}
                                    
                                    
                                    {/* Sortable List Container (Horizontal Carousel) */}
                                    <div className="relative group">
                                        {/* PC Scroll Button Left */}
                                        <button 
                                            onClick={() => document.getElementById('delivery-list-container').scrollBy({ left: -300, behavior: 'smooth' })}
                                            className="hidden md:flex absolute left-0 top-1/2 -translate-y-1/2 z-20 bg-white/90 hover:bg-white shadow-lg border border-slate-200 rounded-full w-10 h-10 items-center justify-center text-slate-600 transition-all backdrop-blur-sm -ml-4 hover:scale-110 active:scale-95"
                                            aria-label="이전"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                                            </svg>
                                        </button>
                                        
                                        <div id="delivery-list-container" className="flex overflow-x-auto gap-4 pb-8 snap-x snap-mandatory scroll-smooth -mx-6 px-6 items-start">
                                    {(() => {
                                        const firstActiveUncompletedIndex = groupedDeliveries.findIndex(g => g.is_active && !g.completed);
                                        return groupedDeliveries.map((group, idx) => {
                                        const groupId = group.ids.join('_');
                                        const isExpanded = expandedGroups[groupId] === true; // Default Closed
                                        const dist = startPoint && group.lat && group.lng ? getDistance(startPoint.lat, startPoint.lng, group.lat, group.lng).toFixed(1) : null;
                                        const directInstall = ((group.address || '').includes('고객직접설치') || (group.address || '').includes('직접설치'));

                                        return (
                                        <div 
                                            key={idx} 
                                            id={`card-${groupId}`}
                                            style={{ scrollSnapStop: 'always' }}
                                            onClick={() => {
                                                if (isMergeMode) {
                                                    setSelectedMergeIds(prev => {
                                                        const allIds = group.ids;
                                                        const isAllSelected = allIds.every(id => prev.includes(id));
                                                        if (isAllSelected) {
                                                            return prev.filter(id => !allIds.includes(id));
                                                        } else {
                                                            return [...prev, ...allIds];
                                                        }
                                                    });
                                                } else if (isDriverChangeMode) {
                                                    toggleDriverSelection(group.ids);
                                                } else {
                                                    setExpandedGroups(prev => ({ 
                                                        ...prev, 
                                                        [groupId]: !prev[groupId] 
                                                    }));
                                                }
                                            }}
                                            className={`delivery-card snap-center shrink-0 w-[92vw] max-w-[480px] cursor-pointer ${
                                                (idx === firstActiveUncompletedIndex) ? 'current' : ''
                                            } ${group.completed ? 'completed' : ''} ${group.canceled ? (group.cancel_type === 'postpone' ? 'postponed' : 'canceled') : ''} ${
                                                isDriverChangeMode && group.ids.every(id => selectedDriverChangeIds.has(id)) ? 'ring-4 ring-green-500 bg-green-50' : ''
                                            }`}
                                        >
                                            <div className="left-strip"></div>
                                            {/* Inline order badge in header row; removed absolute badge */}

                                            {/* Driver Change Checkbox Overlay */}
                                            {isDriverChangeMode && (
                                                <div className="absolute top-3 right-3 z-20">
                                                    <input 
                                                        type="checkbox"
                                                        checked={group.ids.every(id => selectedDriverChangeIds.has(id))}
                                                        readOnly
                                                        className="w-6 h-6 rounded border-gray-300 text-green-600 focus:ring-green-500"
                                                    />
                                                </div>
                                            )}

                                            {/* Merge Checkbox Overlay */}
                                            {isMergeMode && (
                                                <div className="absolute top-3 right-3 z-20">
                                                    <input 
                                                        type="checkbox"
                                                        checked={group.ids.every(id => selectedMergeIds.includes(id))}
                                                        readOnly
                                                        className="w-6 h-6 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                    />
                                                </div>
                                            )}

                                            <div className="card-body">
                                                {/* Header row: left current-label, right badges */}
                                                <div className={`ml-3 mb-0 flex items-center gap-2`}>
                                                    <div className="inline-flex w-10 h-10 bg-indigo-600 text-white rounded-full text-[13px] font-extrabold items-center justify-center shrink-0">
                                                        {group.sequence_number || '-'}
                                                    </div>
                                                    {(idx === firstActiveUncompletedIndex) && (
                                                        <div className="current-label">🚚 현재 배송 중</div>
                                                    )}
                                                    <div className="ml-auto flex items-center gap-1">
                                                        {directInstall && (
                                                            <span className="text-[10px] font-bold text-white bg-red-600 px-2 py-1 rounded-full shrink-0">직접</span>
                                                        )}
                                                        {group.time && (
                                                            <span className="text-[10px] font-bold text-white bg-indigo-500 px-2 py-1 rounded-full shrink-0">⏰ {group.time}</span>
                                                        )}
                                                        {group.unattended && (
                                                            <span className="text-[10px] font-bold text-white bg-sky-600 px-2 py-1 rounded-full shrink-0">무인</span>
                                                        )}
                                                        {group.canceled && group.cancel_type === 'postpone' && <span className="text-[10px] font-bold text-white bg-orange-500 px-2 py-1 rounded-full shrink-0">연기</span>}
                                                        {group.canceled && group.cancel_type !== 'postpone' && <span className="text-[10px] font-bold text-white bg-red-500 px-2 py-1 rounded-full shrink-0">취소됨</span>}
                                                        {group.completed && <span className="text-[10px] font-bold text-white bg-green-600 px-2 py-1 rounded-full shrink-0">완료</span>}
                                                    </div>
                                                </div>
                                                {/* Collapsed address line removed */}
                                                {/* Phone (Inline Editable on Button for Driver) - Top */}
                                                <div className="mb-1">
                                                    {view === 'driver' && editingPhoneGroupId === groupId ? (
                                                        <input 
                                                            type="tel"
                                                            className="phone-btn"
                                                            value={editingPhoneValue}
                                                            onChange={(e) => setEditingPhoneValue(e.target.value)}
                                                            onBlur={(e) => { updateGroupContact(group.ids, { phone: e.target.value }); setEditingPhoneGroupId(null); }}
                                                            onKeyDown={(e) => { if (e.key === 'Enter') { updateGroupContact(group.ids, { phone: editingPhoneValue }); setEditingPhoneGroupId(null); } }}
                                                            placeholder="전화번호 입력"
                                                            autoFocus
                                                        />
                                                    ) : (
                                                        <a 
                                                            href={`tel:${group.phone}`} 
                                                            onClick={(e) => { 
                                                                e.stopPropagation(); 
                                                                if (view === 'driver') { 
                                                                    e.preventDefault(); 
                                                                    setEditingPhoneGroupId(groupId); 
                                                                    setEditingPhoneValue(group.phone || ''); 
                                                                } 
                                                            }} 
                                                            className="phone-btn"
                                                        >
                                                            📞 {group.phone || '번호없음'}
                                                        </a>
                                                    )}
                                                </div>
                                                {/* Header / Top Info moved above phone */}
                                                
                                                {/* Phone moved to top */}
                                                
                                                {/* 예약 시간 버튼형 선택 (Vertical Grid) - Duration Removed */}
                                                <div className="mb-2 relative z-10 flex items-center gap-2">
                                                    <div className="relative flex-1">
                                                        <button 
                                                            className="w-full px-3 py-2 rounded-full border text-xs font-bold text-left hover:bg-slate-50 transition-colors flex items-center justify-between"
                                                            onClick={(e) => { e.stopPropagation(); setOpenTimePickerId(openTimePickerId === groupId ? null : groupId); }}
                                                        >
                                                            <span className="truncate">⏰ {group.time ? group.time : '예약시간 설정'}</span>
                                                            {group.time && (
                                                                <span 
                                                                    className="text-slate-400 hover:text-red-500 px-2 -mr-2 z-20 relative"
                                                                    onClick={(e) => {
                                                                        e.preventDefault();
                                                                        e.stopPropagation();
                                                                        handleTimeSelect(group.ids, '', group.duration || 30);
                                                                    }}
                                                                >✕</span>
                                                            )}
                                                        </button>
                                                        {openTimePickerId === groupId && (
                                                            <div className="absolute top-full left-0 mt-2 w-full bg-white border rounded-xl shadow-xl z-50 p-3" onClick={(e) => e.stopPropagation()}>
                                                                <div className="mb-2 text-xs text-slate-500 font-bold px-1">예약 시간 선택</div>
                                                                <div className="grid grid-cols-4 gap-2 max-h-60 overflow-y-auto">
                                                                    {TIME_SLOTS.map(t => {
                                                                        const disabled = checkTimeConflict(t, group.duration || 30, group.ids);
                                                                        return (
                                                                            <button 
                                                                                key={t}
                                                                                disabled={disabled}
                                                                                className={`px-2 py-3 rounded-lg border text-sm font-bold shadow-sm transition-all active:scale-95 ${
                                                                                    group.time === t ? 'bg-indigo-600 text-white border-indigo-600 ring-2 ring-indigo-200' : 
                                                                                    disabled ? 'bg-slate-100 text-slate-300 cursor-not-allowed' : 'bg-white text-slate-700 hover:bg-slate-50 border-slate-200'
                                                                                }`}
                                                                                onClick={() => { 
                                                                                    handleTimeSelect(group.ids, t, group.duration || 30); 
                                                                                    setOpenTimePickerId(null); 
                                                                                }}
                                                                            >
                                                                                {t}
                                                                            </button>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* [New] Unattended Toggle (Moved from Details) */}
                                                    <div 
                                                        className={`flex items-center gap-2 px-3 py-2 rounded-full border cursor-pointer transition-colors ${group.unattended ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:bg-slate-50'}`}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            updateGroupStatus(group.ids, { unattended: !group.unattended });
                                                        }}
                                                    >
                                                        <div className={`w-4 h-4 rounded border flex items-center justify-center ${group.unattended ? 'bg-indigo-500 border-indigo-500' : 'bg-white border-slate-300'}`}>
                                                            {group.unattended && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>}
                                                        </div>
                                                        <span className="text-xs font-bold text-slate-600 whitespace-nowrap">무인</span>
                                                    </div>
                                                </div>

                                                {/* Address (Driver Editable) */}
                                                {view === 'driver' ? (
                                                    <div className="mb-2">
                                                        <div className="flex items-start gap-2">
                                                            <div className="text-xs text-slate-600 font-bold whitespace-nowrap flex-shrink-0">📍</div>
                                                            <div className="flex-1">
                                                                <textarea 
                                                                    rows={2}
                                                                    className="w-full bg-transparent border-0 p-0 text-[11px] leading-snug font-semibold text-slate-800 focus:outline-none focus:ring-0 whitespace-pre-wrap break-words resize-none" 
                                                                    value={group.address || ''} 
                                                                    onChange={(e) => { 
                                                                        updateGroupContact(group.ids, { address: e.target.value });
                                                                    }}
                                                                    onBlur={(e) => updateGroupAddress(group.ids, e.target.value)}
                                                                    placeholder="주소 입력"
                                                                />
                                                            </div>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="address">📍 {formatAddressDisplay(group.address)}</div>
                                                )}
                                                <div className="border-t border-slate-200 my-2"></div>
                                                
                                                {/* Status Badges Removed (Moved to Header) */}

                                                {/* Accordion Details */}
                                                {isExpanded && !group.completed && (
                                                    <div className="mt-3 text-sm text-slate-600 space-y-4 p-3 bg-slate-50 rounded-xl border border-slate-100 animate-fade-in" onClick={(e) => e.stopPropagation()}>
                                                        <div>
                                                            <div className="font-bold mb-1">📦 품목</div>
                                                            <div className="space-y-1">
                                                                {group.items && group.items.map((it, i) => (
                                                                    <div key={i} className="flex gap-2 items-start" onClick={() => toggleItemCheck(it._oid, it._oidx)}>
                                                                        <div className={`w-4 h-4 mt-0.5 rounded border flex items-center justify-center shrink-0 ${it.checked ? 'bg-indigo-500 border-indigo-500' : 'bg-white border-slate-300'}`}>
                                                                            {it.checked && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>}
                                                                        </div>
                                                                        <span className={it.checked ? 'line-through opacity-50' : ''}>{it.item}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <div className="font-bold mb-1">📝 메모</div>
                                                            <textarea 
                                                                className="w-full text-sm p-2 border border-slate-200 rounded-lg resize-none h-16"
                                                                placeholder="메모를 입력하세요"
                                                                value={group.memo || ''}
                                                                onChange={(e) => updateMemo(group.ids, e.target.value)}
                                                            />
                                                        </div>
                                            



                                                        <div className="grid grid-cols-2 gap-3">
                                                            {['install_fee', 'yangjung', 'naerim', 'etc_fee'].map(key => (
                                                                <div key={key} className="bg-white p-3 rounded-xl border border-slate-200 flex flex-col justify-between shadow-sm">
                                                                    <span className="text-xs text-slate-500 font-bold mb-1">{key === 'install_fee' ? '설치비' : key === 'yangjung' ? '양중비' : key === 'naerim' ? '내림비' : '기타비용'}</span>
                                                                    <div className="flex items-center gap-1">
                                                                        <input 
                                                                            type="tel" 
                                                                            className="w-full text-right text-xl font-black text-slate-800 focus:outline-none bg-transparent placeholder-slate-300" 
                                                                            placeholder="0" 
                                                                            value={group[key] ? group[key].toLocaleString() : ''} 
                                                                            onChange={(e) => updateGroupFees(group.ids, key, e.target.value.replace(/,/g, ''))} 
                                                                            onClick={(e) => e.stopPropagation()}
                                                                        />
                                                                        <span className="text-xs text-slate-400 font-bold">원</span>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                            
                                                       
                                                    </div>
                                                )}
                                                
                                                {/* 완료 메시지 */}
                                                {isExpanded && group.completed && (
                                                    <p className="text-[11px] text-slate-400 mt-2">
                                                        완료된 배송입니다
                                                    </p>
                                                )}
                                                {!isExpanded && group.items && group.items.length > 0 && (
                                                    <div className="mb-1 text-sm text-slate-600 truncate flex items-baseline gap-2">
                                                        <div className="text-xs text-slate-600 font-bold whitespace-nowrap flex-shrink-0">📦</div>
                                                        <span className="truncate">{group.items[0] && group.items[0].item ? group.items[0].item : ''}</span>
                                                    </div>
                                                )}
                                            
                                                <button 
                                                    onClick={(e) => { 
                                                        e.stopPropagation(); 
                                                        const newState = !group.completed;
                                                        updateGroupStatus(group.ids, { 
                                                            completed: newState,
                                                            // 완료 시 취소/연기 해제
                                                            canceled: newState ? false : group.canceled,
                                                            cancel_type: newState ? null : group.cancel_type
                                                        }); 
                                                    }} 
                                                    className={`complete-btn w-full mb-2 ${group.completed ? 'opacity-80' : ''}`}
                                                >
                                                    {group.completed ? '✅ 배송 완료됨 (취소하려면 클릭)' : '🚚 배송 완료'}
                                                </button>
                                                <div className="grid grid-cols-2 gap-2 mb-2">
                                                    <button
                                                        onClick={(e) => { 
                                                            e.stopPropagation(); 
                                                            const isCanceling = !group.canceled || group.cancel_type !== 'cancel';
                                                            updateGroupStatus(group.ids, { 
                                                                canceled: isCanceling, 
                                                                cancel_type: isCanceling ? 'cancel' : null,
                                                                // 취소 시 완료 해제
                                                                completed: isCanceling ? false : group.completed
                                                            }); 
                                                        }}
                                                        className={`py-3 text-sm font-extrabold rounded-[14px] text-white transition-all active:scale-95 ${
                                                            (group.canceled && group.cancel_type === 'cancel') 
                                                            ? 'bg-red-800 ring-2 ring-red-300' 
                                                            : 'bg-red-500 hover:bg-red-600'
                                                        }`}
                                                    >
                                                        {(group.canceled && group.cancel_type === 'cancel') ? '취소됨 (해제)' : '취소'}
                                                    </button>
                                                    <button
                                                        onClick={(e) => { 
                                                            e.stopPropagation(); 
                                                            const isPostponing = !group.canceled || group.cancel_type !== 'postpone';
                                                            updateGroupStatus(group.ids, { 
                                                                canceled: isPostponing, 
                                                                cancel_type: isPostponing ? 'postpone' : null,
                                                                // 연기 시 완료 해제
                                                                completed: isPostponing ? false : group.completed
                                                            }); 
                                                        }}
                                                        className={`py-3 text-sm font-extrabold rounded-[14px] text-white transition-all active:scale-95 ${
                                                            (group.canceled && group.cancel_type === 'postpone') 
                                                            ? 'bg-amber-700 ring-2 ring-amber-300' 
                                                            : 'bg-amber-500 hover:bg-amber-600'
                                                        }`}
                                                    >
                                                        {(group.canceled && group.cancel_type === 'postpone') ? '연기됨 (해제)' : '연기'}
                                                    </button>
                                                </div>
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); handleNavigation(group.lat, group.lng, group.address); }} 
                                                    className="map-btn border border-indigo-200 bg-white text-indigo-900 hover:bg-sky-50"
                                                >
                                                    🗺️ 지도
                                                </button>
                                            </div>
                                        </div>
                                        );
                                    });
                                    })()}
                                        </div>

                                        {/* PC Scroll Button Right */}
                                        <button 
                                            onClick={() => document.getElementById('delivery-list-container').scrollBy({ left: 300, behavior: 'smooth' })}
                                            className="hidden md:flex absolute right-0 top-1/2 -translate-y-1/2 z-20 bg-white/90 hover:bg-white shadow-lg border border-slate-200 rounded-full w-10 h-10 items-center justify-center text-slate-600 transition-all backdrop-blur-sm -mr-4 hover:scale-110 active:scale-95"
                                            aria-label="다음"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    {groupedDeliveries.length === 0 && (
                                        <div className="text-center py-10 text-gray-400">
                                            <p className="mb-2">등록된 배송 건이 없습니다.</p>
                                            <p className="text-xs">선택된 날짜: {targetDate}</p>
                                            <p className="text-xs mt-1">관리자 모드에서 엑셀을 업로드하세요.</p>
                                        </div>
                                    )}
                                </div>
 

                                

                                {/* 데이터 동기화 (백업/복원) */}
                                <div className="mt-4 flex gap-2">
                                    {!isDriverChangeMode && (
                                        <button onClick={openAddItemForm} className="flex-1 bg-indigo-50 text-indigo-700 border border-indigo-200 py-4 rounded-lg font-bold hover:bg-indigo-100 transition text-sm shadow-sm flex items-center justify-center gap-2">
                                            <span className="text-xl">➕</span>
                                            <span>개별상품추가</span>
                                        </button>
                                    )}
                                    {isDriverChangeMode && (
                                        <button 
                                            onClick={() => {
                                                setIsDriverChangeMode(false);
                                                setSelectedDriverChangeIds(new Set());
                                                setToastMsg('취소되었습니다.');
                                            }} 
                                            className="flex-1 bg-slate-500 text-white py-4 rounded-lg font-bold hover:bg-slate-600 transition text-sm shadow-lg flex items-center justify-center gap-2"
                                        >
                                            <span className="text-xl">❌</span>
                                            <span>취소</span>
                                        </button>
                                    )}
                                    <button 
                                        onClick={() => {
                                            if (isDriverChangeMode) {
                                                handleBatchDriverChange();
                                            } else {
                                                setIsDriverChangeMode(true);
                                                setToastMsg('📌 기사 변경 모드: 배송 건을 선택해주세요.');
                                            }
                                        }}
                                        className={`flex-1 py-4 rounded-lg font-bold transition text-sm shadow-sm flex items-center justify-center gap-2 ${
                                            isDriverChangeMode 
                                            ? 'bg-green-600 text-white hover:bg-green-700 shadow-lg animate-pulse' 
                                            : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200 shadow-sm'
                                        }`}
                                    >
                                        <span className="text-xl">🔄</span>
                                        <span>{isDriverChangeMode ? `변경 적용 (${selectedDriverChangeIds.size})` : '기사변경'}</span>
                                    </button>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mt-6">
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                            🔄 데이터 동기화
                                        </h3>
                                        <button onClick={() => setCloudModalOpen(true)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition flex items-center gap-1 ${isCloudConnected ? 'bg-white text-slate-500 border-slate-200' : 'bg-indigo-600 text-white border-indigo-600 shadow-md animate-pulse'}`}>
                                            {isCloudConnected ? "⚙️ 서버 설정" : "☁️ 서버 연결하기"}
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {/* Cloud Buttons - Always Visible */}
                                        <button onClick={() => handleCloudSync('pull')} className="col-span-2 bg-indigo-600 text-white py-4 rounded-lg font-bold hover:bg-indigo-700 transition text-sm shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                                            <span className="text-xl">☁️</span>
                                            <span>서버에서 목록 불러오기</span>
                                        </button>
                                        <button onClick={() => handleCloudSync('push')} className="col-span-2 bg-white text-indigo-900 py-3 rounded-lg font-bold hover:bg-sky-50 transition text-sm border border-indigo-200 flex items-center justify-center gap-2 mb-2">
                                            <span className="text-xl">☁️</span>
                                            <span>작업 결과 서버에 저장</span>
                                        </button>

                                        <button onClick={showDeleteRangePrompt} className="col-span-2 bg-red-50 text-red-700 py-3 rounded-lg font-bold hover:bg-red-100 transition text-sm border border-red-200 flex items-center justify-center gap-2">
                                            <span className="text-xl">🗑️</span>
                                            <span>데이터 삭제</span>
                                        </button>

                                        <button onClick={() => {
                                            const blob = new Blob([JSON.stringify(deliveries)], {type: "application/json"});
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `driver_data_${new Date().toISOString().slice(0,10)}.json`;
                                            a.click();
                                        }} className="bg-white text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition text-sm border border-slate-200 shadow-sm flex flex-col items-center justify-center gap-1">
                                            <span className="text-xl">📤</span>
                                            <span>파일로 저장</span>
                                        </button>
                                        <label className="bg-white text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition text-sm border border-slate-200 shadow-sm flex flex-col items-center justify-center gap-1 cursor-pointer">
                                            <span className="text-xl">📥</span>
                                            <span>파일 불러오기</span>
                                            <input type="file" hidden accept=".json" onChange={(e) => {
                                                const file = e.target.files[0];
                                                if(!file) return;
                                                readJsonFileWithEncoding(file, (data) => {
                                                    if(Array.isArray(data)) {
                                                        if(confirm(`총 ${data.length}건의 데이터를 불러오시겠습니까? 현재 데이터는 덮어씌워집니다.`)) {
                                                            setDeliveries(data);
                                                            StorageManager.saveDeliveries(data);
                                                            alert("데이터가 업데이트되었습니다.");
                                                        }
                                                    } else {
                                                        alert("올바르지 않은 데이터 형식입니다.");
                                                    }
                                                });
                                            }} />
                                        </label>
                                    </div>
                                    <p className="text-xs text-slate-400 mt-2 text-center">
                                        * 관리자가 보낸 파일을 '불러오기' 하고, 작업 후 '저장'하여 관리자에게 보내세요.
                                    </p>
                                </div>
                                
                                {/* Undo Button (Floating) */}
                                {history.length > 0 && (
                                    <div className="fixed bottom-6 right-6 z-50 animate-slide-up">
                                        <button 
                                            onClick={handleUndo}
                                            className="bg-slate-800 text-white px-5 py-3 rounded-full shadow-2xl font-bold flex items-center gap-2 hover:bg-slate-900 transition active:scale-95 border border-slate-700"
                                        >
                                            <span className="text-xl">↩️</span>
                                            <span className="text-sm">되돌리기 ({history.length})</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                    
                    {/* [Admin Only Area] */} 
                    <div id="admin-only" style={{display:'none', border:'1px dashed #e5e7eb', padding:'12px', margin:'12px', borderRadius:'12px'}}> 
                        <strong>관리자 영역</strong> 
                        <div style={{fontSize:'12px', color:'#64748b', marginTop:'4px'}}> 관리자 전용 콘텐츠 </div> 
                    </div>

                    {/* [New] Guide Modal */}
                    <GuideModal isOpen={showGuideModal} onClose={() => setShowGuideModal(false)} />

                    {/* [New] Cloud Settings Modal */}
                    <CloudSettingsModal 
                        isOpen={isCloudModalOpen} 
                        onClose={() => {
                            setCloudModalOpen(false);
                            // Re-check connection status on close
                            const config = StorageManager.get('mvp_supabase_config');
                            setCloudConnected(!!(config && config.url && config.key && CloudManager.isConnected));
                        }}
                        onReset={() => {
                            setDeliveries([]);
                            StorageManager.saveDeliveries([]);
                        }} 
                    />

                    {/* [New] Floating Undo Button */}
                    {history.length > 0 && (
                        <button 
                            onClick={handleUndo}
                            className="fixed bottom-32 left-4 z-[70] bg-gray-800 text-white p-3 rounded-full shadow-2xl hover:bg-gray-700 active:scale-95 transition-all flex items-center gap-2 pr-4 border border-gray-600"
                            aria-label="실행 취소"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                            <span className="text-xs font-bold">되돌리기</span>
                        </button>
                    )}

                    {/* 완료 축하 모달 (접근성 적용) */}
                    {showCompletionModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" 
                             style={{animation: 'fadeIn 0.5s'}}
                             role="dialog"
                             aria-modal="true"
                             aria-labelledby="modal-title"
                             aria-describedby="modal-desc">
                            <style>{`
                                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                                @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                            `}</style>
                            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center relative overflow-hidden" 
                                 style={{animation: 'slideUp 0.5s 0.1s both'}}>
                                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-purple-500"></div>
                                <button 
                                    onClick={() => setShowCompletionModal(false)}
                                    className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
                                    aria-label="닫기"
                                >
                                    ✕
                                </button>
                                <div className="text-6xl mb-6 animate-bounce" aria-hidden="true">☁️</div>
                                <h2 id="modal-title" className="text-2xl font-bold text-gray-800 mb-2">작업 완료</h2>
                                <p id="modal-desc" className="text-gray-600 mb-8 font-medium">
                                    모든 배송이 완료되었습니다.<br/>
                                    <span className="text-indigo-900 font-bold text-lg block mt-2">작업 결과가 서버에<br/>자동 저장되었습니다!</span>
                                </p>
                                <div className="flex flex-col gap-3">
                                    <button 
                                        onClick={() => setShowCompletionModal(false)}
                                        className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transform active:scale-95 transition w-full"
                                        autoFocus
                                    >
                                        확인
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setEnableCompletionMessage(false);
                                            StorageManager.set('mvp_enable_completion_msg', false);
                                            setShowCompletionModal(false);
                                        }}
                                        className="text-xs text-gray-400 hover:text-gray-600 underline"
                                    >
                                        이 메시지 다시 보지 않기
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* [수정] 상세 정보 편집 모달 */}
                    {showEditModal && editTarget && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={() => setShowEditModal(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                {/* Header */}
                                <div className="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-slate-800">배송 상세 정보 수정</h3>
                                    <button onClick={() => setShowEditModal(false)} className="text-slate-400 hover:text-slate-600">
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                
                                {/* Tabs */}
                                <div className="flex border-b">
                                    <button className={`flex-1 py-3 text-sm font-bold ${editTab === 'basic' ? 'text-indigo-900 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setEditTab('basic')}>기본 정보</button>
                                    <button className={`flex-1 py-3 text-sm font-bold ${editTab === 'cost' ? 'text-indigo-900 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setEditTab('cost')}>비용/정산</button>
                                    <button className={`flex-1 py-3 text-sm font-bold ${editTab === 'attach' ? 'text-indigo-900 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setEditTab('attach')}>첨부파일</button>
                                    <button className={`flex-1 py-3 text-sm font-bold ${editTab === 'history' ? 'text-indigo-900 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setEditTab('history')}>수정 이력</button>
                                </div>

                                {/* Content */}
                                <div className="p-6 overflow-y-auto flex-1">
                                    {editTab === 'basic' && (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">상품명 <span className="text-red-500">*</span></label>
                                                <input type="text" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                    value={editTarget.item} 
                                                    onChange={e => setEditTarget({...editTarget, item: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">전화번호 <span className="text-red-500">*</span></label>
                                                <input type="tel" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                    value={editTarget.phone} 
                                                    onChange={e => setEditTarget({...editTarget, phone: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">주소 <span className="text-red-500">*</span></label>
                                                <input type="text" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                    value={editTarget.address} 
                                                    onChange={e => setEditTarget({...editTarget, address: e.target.value})} />
                                                <p className="text-xs text-orange-500 mt-1">⚠️ 주소 변경 시 좌표가 자동으로 재검색됩니다.</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">메모</label>
                                                <textarea className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none h-24 resize-none" 
                                                    value={editTarget.memo || ''} 
                                                    onChange={e => setEditTarget({...editTarget, memo: e.target.value})}></textarea>
                                            </div>
                                        </div>
                                    )}

                                    {editTab === 'cost' && (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">설치비</label>
                                                <input type="number" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                    value={editTarget.install_fee || 0} 
                                                    onChange={e => setEditTarget({...editTarget, install_fee: Number(e.target.value)})} />
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-600 mb-1">양중비</label>
                                                    <input type="number" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                        value={editTarget.yangjung || 0} 
                                                        onChange={e => setEditTarget({...editTarget, yangjung: Number(e.target.value)})} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-600 mb-1">내림비</label>
                                                    <input type="number" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                        value={editTarget.naerim || 0} 
                                                        onChange={e => setEditTarget({...editTarget, naerim: Number(e.target.value)})} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-600 mb-1">기타비용</label>
                                                    <input type="number" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                        value={editTarget.etc_fee || 0} 
                                                        onChange={e => setEditTarget({...editTarget, etc_fee: Number(e.target.value)})} />
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 p-3 rounded text-right">
                                                <span className="text-sm font-bold text-slate-500 mr-2">총 합계:</span>
                                                <span className="text-lg font-extrabold text-indigo-900">
                                                    {((editTarget.install_fee||0) + (editTarget.yangjung||0) + (editTarget.naerim||0) + (editTarget.etc_fee||0)).toLocaleString()}원
                                                </span>
                                            </div>
                                        </div>
                                    )}

                                    {editTab === 'attach' && (
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-2">이미지 (최대 3장)</label>
                                                <div className="grid grid-cols-3 gap-2 mb-2">
                                                    {(editTarget.images || []).map((img, idx) => (
                                                        <div key={idx} className="relative aspect-square bg-slate-100 rounded overflow-hidden group">
                                                            <img src={img} alt="preview" className="w-full h-full object-cover" />
                                                            <button onClick={() => {
                                                                const newImages = [...editTarget.images];
                                                                newImages.splice(idx, 1);
                                                                setEditTarget({...editTarget, images: newImages});
                                                            }} className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">✕</button>
                                                        </div>
                                                    ))}
                                                    {(editTarget.images || []).length < 3 && (
                                                        <label className="border-2 border-dashed border-slate-300 rounded flex items-center justify-center cursor-pointer hover:border-indigo-500 aspect-square">
                                                            <span className="text-2xl text-slate-400">+</span>
                                                            <input type="file" className="hidden" accept="image/*" onChange={e => {
                                                                const file = e.target.files[0];
                                                                if(file) {
                                                                    if(file.size > 500 * 1024) { alert("이미지는 500KB 이하만 가능합니다."); return; }
                                                                    const reader = new FileReader();
                                                                    reader.onload = (ev) => {
                                                                        setEditTarget({...editTarget, images: [...(editTarget.images || []), ev.target.result]});
                                                                    };
                                                                    reader.readAsDataURL(file);
                                                                }
                                                            }} />
                                                        </label>
                                                    )}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-2">기타 첨부파일</label>
                                                <div className="flex gap-2 mb-2">
                                                    <input type="file" id="attachFile" className="hidden" onChange={e => {
                                                        const file = e.target.files[0];
                                                        if(file) {
                                                            setEditTarget({...editTarget, attachments: [...(editTarget.attachments || []), file.name]});
                                                        }
                                                    }} />
                                                    <label htmlFor="attachFile" className="bg-slate-100 px-3 py-2 rounded text-sm cursor-pointer hover:bg-slate-200 border">파일 선택</label>
                                                </div>
                                                <ul className="space-y-1">
                                                    {(editTarget.attachments || []).map((file, idx) => (
                                                        <li key={idx} className="flex justify-between items-center text-sm bg-slate-50 p-2 rounded">
                                                            <span className="truncate max-w-[200px]">📎 {file}</span>
                                                            <button onClick={() => {
                                                                const newAttach = [...editTarget.attachments];
                                                                newAttach.splice(idx, 1);
                                                                setEditTarget({...editTarget, attachments: newAttach});
                                                            }} className="text-red-500 hover:text-red-700 text-xs">삭제</button>
                                                        </li>
                                                    ))}
                                                    {(editTarget.attachments || []).length === 0 && <li className="text-xs text-gray-400">첨부된 파일이 없습니다.</li>}
                                                </ul>
                                                <p className="text-xs text-orange-500 mt-2">※ 로컬 모드에서는 파일명만 저장됩니다.</p>
                                            </div>
                                        </div>
                                    )}

                                    {editTab === 'history' && (
                                        <div className="space-y-3 h-full">
                                            {(!deliveries.find(d => d.id === editTarget.id)?.history || deliveries.find(d => d.id === editTarget.id)?.history.length === 0) ? (
                                                <div className="text-center text-gray-400 py-10">수정 이력이 없습니다.</div>
                                            ) : (
                                                deliveries.find(d => d.id === editTarget.id).history.slice().reverse().map((log, idx) => (
                                                    <div key={idx} className="border-l-2 border-indigo-200 pl-3 py-1">
                                                        <div className="text-xs text-gray-400 mb-1">{new Date(log.date).toLocaleString()}</div>
                                                        <div className="space-y-1">
                                                            {log.changes.map((c, cIdx) => (
                                                                <div key={cIdx} className="text-xs">
                                                                    <span className="font-bold text-slate-600">{c.field}</span>: 
                                                                    <span className="text-red-400 line-through mx-1">{c.old}</span>
                                                                    → 
                                                                    <span className="text-blue-600 font-bold mx-1">{c.new}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="p-4 border-t bg-slate-50 flex justify-end gap-2">
                                    <button onClick={() => setShowEditModal(false)} className="px-4 py-2 text-slate-600 font-bold hover:bg-slate-200 rounded-lg">취소</button>
                                    <button onClick={handleEditSave} className="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200">저장하기</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 삭제 확인 모달 */}
                    {showDeleteModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" 
                             style={{animation: 'fadeIn 0.5s'}}
                             role="dialog"
                             aria-modal="true">
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center relative overflow-hidden" style={{animation: 'slideUp 0.3s'}}>
                                <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                    </svg>
                                </div>
                                <h3 className="text-lg font-bold text-gray-900 mb-2">항목 삭제</h3>
                                <p className="text-sm text-gray-500 mb-6 leading-relaxed">
                                    선택한 배송 항목을 삭제하시겠습니까?<br/>
                                    <span className="text-xs text-red-500 font-bold">⚠️ 삭제된 데이터는 복구할 수 없습니다.</span>
                                </p>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setShowDeleteModal(false)}
                                        className="flex-1 px-4 py-3 rounded-lg border border-gray-200 font-bold text-gray-600 hover:bg-gray-50 transition"
                                    >
                                        취소
                                    </button>
                                    <button 
                                        onClick={executeDelete}
                                        className="flex-1 px-4 py-3 rounded-lg bg-red-500 font-bold text-white hover:bg-red-600 transition shadow-lg shadow-red-200"
                                    >
                                        삭제하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 기사 이동 모달 */}
                    {moveDriverModal.isOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={() => setMoveDriverModal({ ...moveDriverModal, isOpen: false })}>
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full relative" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                    <span>🚚</span> 기사 변경
                                </h3>
                                <p className="text-sm text-slate-500 mb-4">
                                    이 배송 건을 전달할 기사님을 선택해주세요.
                                </p>
                                <div className="space-y-2 mb-6 max-h-60 overflow-y-auto">
                                    {Array.from(new Set(deliveries.map(d => d.driver).filter(Boolean))).sort().filter(d => d !== moveDriverModal.currentDriver).map(driver => (
                                        <button 
                                            key={String(driver)}
                                            onClick={() => setMoveDriverTarget(String(driver))}
                                            className={`w-full text-left px-4 py-3 rounded-lg font-bold border transition-all ${moveDriverTarget === String(driver) ? 'border-indigo-500 bg-sky-50 text-indigo-700 ring-2 ring-indigo-200' : 'border-slate-200 hover:bg-slate-50 text-slate-700'}`}
                                        >
                                            {String(driver)} 기사님
                                        </button>
                                    ))}
                                    {Array.from(new Set(deliveries.map(d => d.driver).filter(Boolean))).filter(d => d !== moveDriverModal.currentDriver).length === 0 && (
                                        <div className="text-center py-4 text-slate-400 text-sm">
                                            이동할 다른 기사님이 없습니다.
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setMoveDriverModal({ ...moveDriverModal, isOpen: false })}
                                        className="flex-1 px-4 py-3 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition"
                                    >
                                        취소
                                    </button>
                                    <button 
                                        onClick={handleMoveDriverConfirm}
                                        disabled={!moveDriverTarget}
                                        className="flex-1 px-4 py-3 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-indigo-200"
                                    >
                                        이동하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddItemModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={() => setShowAddItemModal(false)}>
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full relative" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                    <span>📦</span> 개별 상품 추가
                                </h3>
                                <div className="space-y-3 mb-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">배송날짜</label>
                                        <input type="date" className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            value={addForm.date}
                                            onChange={e => setAddForm({ ...addForm, date: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">전화번호</label>
                                        <input type="tel" className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            value={addForm.phone}
                                            onChange={e => setAddForm({ ...addForm, phone: e.target.value })}
                                            placeholder="숫자만 입력"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">주소</label>
                                        <input type="text" className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            value={addForm.address}
                                            onChange={e => setAddForm({ ...addForm, address: e.target.value })}
                                            placeholder="주소 입력"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">품목</label>
                                        <input type="text" className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            value={addForm.item}
                                            onChange={e => setAddForm({ ...addForm, item: e.target.value })}
                                            placeholder="예: 침대 프레임"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setShowAddItemModal(false)}
                                        className="flex-1 px-4 py-3 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition"
                                    >
                                        취소
                                    </button>
                                    <button 
                                        onClick={handleAddItemSubmit}
                                        className="flex-1 px-4 py-3 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition shadow-lg shadow-indigo-200"
                                    >
                                        추가하기
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 월별 비용 합계 모달 */}
                    {showMonthlyCostModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={() => setShowMonthlyCostModal(false)}>
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full relative max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-900 flex items-center gap-2">
                                        <span>📊</span> 월별 비용 합계
                                    </h3>
                                    <button onClick={() => setShowMonthlyCostModal(false)} className="text-slate-400 hover:text-slate-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                            <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <div className="flex items-center gap-4 mb-6 bg-slate-50 p-3 rounded-xl border border-slate-100">
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={() => setMonthlyViewMode('month')}
                                            className={`px-3 py-1 rounded-full text-xs font-bold ${monthlyViewMode === 'month' ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 border border-slate-300'}`}
                                        >
                                            월
                                        </button>
                                        <button 
                                            onClick={() => setMonthlyViewMode('day')}
                                            className={`px-3 py-1 rounded-full text-xs font-bold ${monthlyViewMode === 'day' ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 border border-slate-300'}`}
                                        >
                                            일
                                        </button>
                                    </div>
                                    {monthlyViewMode === 'month' ? (
                                        <input 
                                            type="month" 
                                            value={monthlyCostTargetMonth} 
                                            onChange={(e) => setMonthlyCostTargetMonth(e.target.value)}
                                            className="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 text-base font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        />
                                    ) : (
                                        <input 
                                            type="date" 
                                            value={monthlyCostTargetDay} 
                                            onChange={(e) => setMonthlyCostTargetDay(e.target.value)}
                                            className="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 text-base font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        />
                                    )}
                                </div>

                                <div className="flex-1 overflow-y-auto custom-scrollbar pb-2">
                                    {(() => {
                                        const targetMonth = monthlyCostTargetMonth;
                                        let filtered = deliveries.filter(d => {
                                            if (!d.date || d.canceled) return false;
                                            if (monthlyViewMode === 'month') {
                                                return d.date.startsWith(targetMonth);
                                            } else {
                                                return d.date === monthlyCostTargetDay;
                                            }
                                        });
                                        
                                        // 2. 권한 필터: 기사는 본인 것만, 관리자는 전체(또는 필터링 가능하지만 여기선 전체 합계 보여줌)
                                        // "이 내용은 로그인한 기사만 확인 가능" -> 기사 모드일 땐 본인 데이터만.
                                        if (view === 'driver') {
                                            if (!currentUser) return <div className="text-center text-gray-400 py-8">로그인이 필요합니다.</div>;
                                            filtered = filtered.filter(d => d.driver === currentUser);
                                        }

                                        // 3. 통계 계산
                                        const stats = filtered.reduce((acc, d) => ({
                                            install: acc.install + (d.install_fee||0),
                                            yangjung: acc.yangjung + (d.yangjung||0),
                                            naerim: acc.naerim + (d.naerim||0),
                                            etc: acc.etc + (d.etc_fee||0),
                                            total: acc.total + ((d.install_fee||0)+(d.yangjung||0)+(d.naerim||0)+(d.etc_fee||0))
                                        }), { install: 0, yangjung: 0, naerim: 0, etc: 0, total: 0 });

                                        // Today summary (same month)
                                        const refDay = monthlyViewMode === 'day' ? monthlyCostTargetDay : new Date().toISOString().slice(0,10);
                                        const dayItems = filtered.filter(d => d.date === refDay);
                                        const dayInstall = dayItems.reduce((s, d) => s + (d.install_fee || 0), 0);
                                        const dayExtra = dayItems.reduce((s, d) => s + ((d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0)), 0);
                                        const dayTotal = dayInstall + dayExtra;

                                        return (
                                            <div className="space-y-4 animate-slide-up">
                                                {/* Today Summary Card - placed above monthly total */}
                                                <div className="bg-sky-50 p-3 rounded-xl border border-slate-100">
                                                    <div className="flex items-center justify-center">
                                                        <span className="text-xs font-bold text-slate-700">오늘 비용 합계</span>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                                        <div className="bg-white rounded-lg px-3 py-2 border border-slate-200 text-center">
                                                            <span className="block text-[11px] font-bold text-indigo-700 mb-0.5">예상 설치비</span>
                                                            <span className="block text-sm font-black text-indigo-900">{dayInstall.toLocaleString()}원</span>
                                                        </div>
                                                        <div className="bg-white rounded-lg px-3 py-2 border border-slate-200 text-center">
                                                            <span className="block text-[11px] font-bold text-orange-600 mb-0.5">추가비용</span>
                                                            <span className="block text-sm font-black text-orange-900">{dayExtra.toLocaleString()}원</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {/* Total Card */}
                                                <div className="bg-gradient-to-br from-indigo-600 to-indigo-700 text-white p-6 rounded-2xl shadow-lg shadow-indigo-200 text-center relative overflow-hidden">
                                                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-xl"></div>
                                                    <div className="absolute bottom-0 left-0 w-24 h-24 bg-black/10 rounded-full -ml-12 -mb-12 blur-xl"></div>
                                                    
                                                    <p className="text-indigo-100 font-medium mb-2 relative z-10">
                                                        <span className="block opacity-90 text-sm mb-1">{view === 'driver' ? `${currentUser} 기사님` : '전체 기사'}</span>
                                                        <span className="block text-xl font-bold">{parseInt(targetMonth.split('-')[1])}월 총 수익</span>
                                                    </p>
                                                    <h2 className="text-4xl font-black relative z-10 tracking-tight">
                                                        {stats.total.toLocaleString()}
                                                        <span className="text-2xl font-bold opacity-80 ml-1">원</span>
                                                    </h2>
                                                </div>

                                                {/* Breakdown Grid */}
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">설치비</span>
                                                        <span className="text-lg font-black text-slate-800">{stats.install.toLocaleString()}원</span>
                                                    </div>
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">양중비</span>
                                                        <span className="text-lg font-black text-slate-800">{stats.yangjung.toLocaleString()}원</span>
                                                    </div>
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">내림비</span>
                                                        <span className="text-lg font-black text-slate-800">{stats.naerim.toLocaleString()}원</span>
                                                    </div>
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">기타비용</span>
                                                        <span className="text-lg font-black text-slate-800">{stats.etc.toLocaleString()}원</span>
                                                    </div>
                                                </div>
                                                
                                                

                                                {filtered.length === 0 && (
                                                    <div className="text-center text-slate-400 text-sm py-4">
                                                        해당 월의 정산 데이터가 없습니다.
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 토스트 메시지 */}
                    {toastMsg && (
                        <div className="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-[60] animate-fade-in text-sm font-bold flex items-center gap-2">
                            <span>⚠️</span>
                            {toastMsg}
                        </div>
                    )}

                    {loading && (
                        <div className="absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center animate-bounce">
                                <div className="text-4xl mb-2">🚚</div>
                                <div className="font-bold text-gray-700">처리중입니다...</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
                <ErrorBoundary>
                    <App />
                </ErrorBoundary>
            );

            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => console.log('SW registered'))
                        .catch(err => console.log('SW registration failed', err));
                });
            }
    </script>

    <!-- [AdSense] Initialization Guard -->
    <script>
        window.adsbygoogle = window.adsbygoogle || [];
        if (!window.__adsInitialized) {
            try {
                window.adsbygoogle.push({});
                window.__adsInitialized = true;
                console.log("AdSense initialized");
            } catch (e) {
                console.warn("AdSense init skipped", e);
            }
        }
    </script>
</body>
</html>


