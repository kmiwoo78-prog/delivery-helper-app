
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ì†¡ ê´€ë¦¬ MVP</title>
    
    <!-- [AdSense] Main Script (1íšŒ ë¡œë“œ) -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4652108502419331" crossorigin="anonymous"></script>
    
    <!-- PWA Setup (iOS & Android) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ë°°ì†¡ë§ˆìŠ¤í„°">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest & Icons -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="./icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="./icon.svg">
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('SW registered: ', registration.scope))
                    .catch(err => console.log('SW registration failed: ', err));
            });
        }
    </script>

    <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <!-- SortableJS (ë“œë˜ê·¸ ì•¤ ë“œë¡­) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- ì§€ë„ (Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- í°íŠ¸ & ìŠ¤íƒ€ì¼ ì„¤ì • -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans KR"', 'sans-serif'],
                    },
                    colors: {
                        slate: { 850: '#1e293b' }, // Custom dark
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        marquee: { '0%': { transform: 'translateX(100%)' }, '100%': { transform: 'translateX(-100%)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-font-smoothing: antialiased; overscroll-behavior-y: none; overflow-y: auto; }
        html { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        input, button, select, textarea { font-size: 16px !important; } /* iOS Zoom ë°©ì§€ */
        
        .animate-marquee { animation: marquee 15s linear infinite; white-space: nowrap; }
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* Scrollbar Hide Utility */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .map-container { height: 60vh; min-height: 400px; width: 100%; border-radius: 1rem; z-index: 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .custom-marker { text-align: center; }
        .marker-pin {
            width: 36px; height: 36px; border-radius: 50% 50% 50% 0; background: #4f46e5; position: absolute; transform: rotate(-45deg);
            left: 50%; top: 50%; margin: -18px 0 0 -18px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 2px solid white;
        }
        .marker-pin::after {
            content: ''; width: 24px; height: 24px; margin: 4px 0 0 4px; background: #fff; position: absolute; border-radius: 50%;
        }
        .marker-text {
            position: absolute; width: 36px; font-size: 14px; font-weight: 800; text-align: center; top: 6px; left: 0; z-index: 10; color: #4f46e5;
            transform: rotate(45deg); /* í•€ì´ íšŒì „ë˜ì–´ ìˆìœ¼ë¯€ë¡œ í…ìŠ¤íŠ¸ ë³´ì • í•„ìš”í•  ìˆ˜ ìˆìŒ -> ê¸°ì¡´ ë¡œì§ í™•ì¸ í•„ìš” */
        }
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* [User Custom Design] Delivery Card */
        .delivery-card { 
           position: relative; 
           background: #ffffff; 
           border-radius: 16px; 
           border: 1px solid #e5e7eb; 
           margin: 12px; 
           overflow: hidden; 
           transition: all 0.2s;
         } 
         
         .delivery-card.current { 
           border-color: #4f46e5; 
           background: #eef2ff; 
         } 
         
         .status-bar { 
           height: 4px; 
           background: #4f46e5; 
         } 
         
         .order-badge { 
           position: absolute; 
           top: 8px; 
           left: 8px; 
           width: 32px; 
           height: 32px; 
           background: #4f46e5; 
           color: #ffffff; 
           border-radius: 50%; 
           font-size: 13px; 
           font-weight: 800; 
           display: flex; 
           align-items: center; 
           justify-content: center; 
           z-index: 10;
         } 
         
         .card-body { 
           padding: 16px; 
           padding-top: 24px; 
           display: flex; 
           flex-direction: column; 
           gap: 12px; 
         } 
         
         .current-label { 
           font-size: 12px; 
           font-weight: 800; 
           color: #4338ca; 
         } 
         
         .phone-btn { 
           display: block; 
           background: #4f46e5; 
           color: #ffffff; 
           text-align: center; 
          padding: 14px; 
           border-radius: 14px; 
           font-size: 22px; 
           font-weight: 800; 
           text-decoration: none; 
         } 
         
         .address { 
           font-size: 14px; 
           font-weight: 600; 
           color: #1f2937; 
           line-height: 1.4;
         } 
         
         .time { 
           font-size: 12px; 
           color: #475569; 
         } 
         
         .complete-btn { 
           margin-top: 4px; 
           padding: 14px; 
           font-size: 15px; 
           font-weight: 800; 
           border: none; 
           border-radius: 14px; 
           background: #22c55e; 
           color: #ffffff; 
           cursor: pointer;
         }
         
         .map-btn {
            margin-top: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: 700;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: #f8fafc;
            color: #475569;
            width: 100%;
            cursor: pointer;
         }
 
         .time-pill {
            align-self: flex-start;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
            background: #e0e7ff;
            color: #4338ca;
         }
 
         /* Status Variants */
         .delivery-card.completed {
             background: #f8fafc;
             border-color: #e2e8f0;
             opacity: 0.6;
         }
         .delivery-card.canceled {
             border-color: #fecaca;
             background: #fff;
         }
         .delivery-card.postponed {
             border-color: #fb923c;
             background: #fff7ed;
         }
        
        /* Left status strip */
        .left-strip {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: #4f46e5;
            border-top-left-radius: 16px;
            border-bottom-left-radius: 16px;
        }
        .delivery-card.current .left-strip { background: #4f46e5; }
        .delivery-card.completed .left-strip { background: #22c55e; }
        .delivery-card.canceled .left-strip { background: #ef4444; }
        .delivery-card.postponed .left-strip { background: #fb923c; }
    </style>
</head>
<body class="bg-[#F4F5F7] text-slate-800 antialiased selection:bg-indigo-100 selection:text-indigo-700">

    <!-- [Safety] Global Error Handler & Loading Watchdog -->
    <script>
        // 1. Global Error Handler (Must be non-module, non-babel to catch early errors)
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global Error:', msg, error);
            var root = document.getElementById('root');
            if (root && (root.innerHTML.trim() === '' || root.innerHTML.includes('ë¡œë”© ì¤‘'))) {
                root.innerHTML = '<div style="padding:20px;text-align:center;color:red;margin-top:50px;font-family:sans-serif;"><h1>âš ï¸ ì•± ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</h1><p style="color:#666;margin:10px 0;">'+msg+'</p><button onclick="location.reload()" style="margin-top:20px;padding:10px 20px;background:#333;color:white;border:none;border-radius:5px;cursor:pointer;">ìƒˆë¡œê³ ì¹¨</button></div>';
            }
            return false;
        };

        // 2. Loading Watchdog (Check if React mounted within 3 seconds)
        setTimeout(function() {
            var root = document.getElementById('root');
            if (!root || root.innerHTML.trim() === '') {
                var msg = document.createElement('div');
                msg.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:white;color:#333;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:20px;text-align:center;font-family:sans-serif;";
                msg.innerHTML = '<h1 style="font-size:24px;margin-bottom:10px;">âš ï¸ ì•± ë¡œë”© ì‹¤íŒ¨</h1><p style="color:#666;margin-bottom:20px;">3ì´ˆ ì´ìƒ í™”ë©´ì´ ë‚˜ì˜¤ì§€ ì•Šìœ¼ë©´ ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p><ul style="text-align:left;display:inline-block;margin:0 0 20px 0;font-size:14px;color:#333;line-height:1.6;"><li>ë¸Œë¼ìš°ì € ë²„ì „ì´ ë„ˆë¬´ ë‚®ì§€ ì•Šì€ì§€ í™•ì¸ (iOS 12 ì´í•˜ëŠ” ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)</li><li>ì¸í„°ë„· ì—°ê²° ìƒíƒœ í™•ì¸ (ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì‹¤íŒ¨)</li><li>ìë°”ìŠ¤í¬ë¦½íŠ¸ ì„¤ì • í™•ì¸</li></ul><div style="display:flex;gap:10px;"><button onclick="location.reload()" style="padding:10px 20px;background:#333;color:white;border:none;border-radius:8px;font-size:16px;font-weight:bold;cursor:pointer;">ìƒˆë¡œê³ ì¹¨</button><button onclick="localStorage.clear();location.reload()" style="padding:10px 20px;background:#eee;color:#333;border:none;border-radius:8px;font-size:16px;cursor:pointer;">ë°ì´í„° ì´ˆê¸°í™”</button></div>';
                document.body.appendChild(msg);
            }
        }, 3000);
    </script>

    <div id="root"></div>

    <script type="text/babel">
        // [ì„¤ì •] Config & Constants
        const Config = {
            MAP_KEY: "MVP_DEMO_KEY",
            SUPABASE_URL: "https://yzgsyyolhsxvavcmussi.supabase.co",
            SUPABASE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6Z3N5eW9saHN4dmF2Y211c3NpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NzY1MjgsImV4cCI6MjA4NTM1MjUyOH0.g6DiBPEfnO5SIsC9iBAzgSurNR3pPF403-JiRUfIS88",
            FIXED_START: {
                address: "ê²½ê¸°ë„ ê¹€í¬ì‹œ ì–‘ì´Œì í•™ìš´ì‚°ë‹¨5ë¡œê°€ê¸¸ 22",
                lat: 37.619, lng: 126.634
            },
            FIXED_END: {
                address: "ê¹€í¬í•œê°•8ë¡œ 15",
                lat: 37.643, lng: 126.626
            },
            // ìŠ¤í† ë¦¬ì§€ í‚¤
            STORAGE_KEYS: {
                DELIVERIES: 'mvp_deliveries',
                SETTINGS: 'mvp_settings'
            },
            // ì˜ˆì•½ ì‹œìŠ¤í…œ ì„¤ì •
            RESERVATION: {
                MIN_DAYS: 3,
                MAX_DAYS: 30,
                START_HOUR: 9,
                END_HOUR: 20
            },
            // ì„¤ì¹˜ ì„œë¹„ìŠ¤ ì„¤ì •
            INSTALL: {
                START_HOUR: 9,
                END_HOUR: 18,
                WEEKDAYS_ONLY: true
            },
            // ë°°ì†¡ ë©”ëª¨ ì„¤ì •
            MEMO: {
                MIN_LENGTH: 10,
                MAX_LENGTH: 200
            },
            // [Safety] ë°ì´í„° ë³´í˜¸ ì„¤ì •
            PROTECTED_DATES: ['2026-02-12', '2025-02-12']
        };

        // [ìœ í‹¸ë¦¬í‹°] Safe Storage Manager
        const StorageManager = {
            get: (key, defaultValue = null) => {
                try {
                    const item = localStorage.getItem(key);
                    if (item === null || item === "undefined") return defaultValue;
                    return JSON.parse(item);
                } catch (e) {
                    console.warn(`[Storage] Failed to parse ${key}, using default.`, e);
                    return defaultValue;
                }
            },
            set: (key, value) => {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                } catch (e) {
                    console.error(`[Storage] Failed to save ${key}`, e);
                    alert("ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¼ë¶€ ë°ì´í„°ë¥¼ ì •ë¦¬í•´ì£¼ì„¸ìš”.");
                }
            },
            remove: (key) => {
                localStorage.removeItem(key);
            },
            clearAll: () => {
                localStorage.clear();
                console.log("[Storage] All data cleared.");
            },
            // ë°ì´í„°ë³„ í¸ì˜ ë©”ì„œë“œ
            saveDeliveries: async (data) => {
                try {
                    // [Requirement] Data must always be Supabase
                    // 1. Local Backup (Immediate UI consistency)
                    localStorage.setItem(Config.STORAGE_KEYS.DELIVERIES, JSON.stringify(data));
                    
                    // 2. Cloud Sync (Critical)
                    // Ensure connection
                    if (!CloudManager.isConnected) {
                         CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
                    }
                    
                    if (CloudManager.isConnected && CloudManager.client) {
                        await CloudManager.push(data);
                        console.log("[AutoSync] Synced to cloud");
                    } else {
                        console.warn("[AutoSync] Cloud not connected - attempting reconnect");
                        CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
                        if (CloudManager.isConnected) {
                            await CloudManager.push(data);
                        }
                    }
                    
                    return true;
                } catch (e) {
                    console.error("[Storage] Failed to save deliveries", e);
                    return false;
                }
            },
            loadDeliveries: () => {
                try {
                    const item = localStorage.getItem(Config.STORAGE_KEYS.DELIVERIES);
                    return item ? JSON.parse(item) : [];
                } catch (e) {
                    return [];
                }
            },
            // [New] ì„œë²„ì—ì„œ ë°ì´í„° ë™ê¸°í™” (ì´ˆê¸° ë¡œë”©ìš©)
            syncFromServer: async () => {
                try {
                    const res = await fetch('/api/load');
                    if (res.ok) {
                        const data = await res.json();
                        if (Array.isArray(data)) { // ë¹ˆ ë°°ì—´ì´ì–´ë„ ì„œë²„ ë°ì´í„°ê°€ ìš°ì„ ì¼ ìˆ˜ ìˆìŒ
                            console.log("[Server] Data loaded from server:", data.length);
                            localStorage.setItem(Config.STORAGE_KEYS.DELIVERIES, JSON.stringify(data));
                            return data;
                        }
                    }
                } catch (e) {
                    console.warn("[Server] Load failed", e);
                }
                return null;
            },
            // [New] ê³µì§€ì‚¬í•­ ì €ì¥
            saveNotice: (text) => {
                localStorage.setItem('mvp_notice', text || '');
                // [Auto-Sync] ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì„œë²„ì— í‘¸ì‹œ
                if (CloudManager.isConnected && CloudManager.client) {
                    CloudManager.pushNotice(text).then(() => {
                        console.log("[AutoSync] Notice synced");
                    }).catch(e => console.warn("[AutoSync] Notice sync failed", e));
                }
            },
            loadNotice: () => {
                return localStorage.getItem('mvp_notice') || '';
            }
        };

        // [í´ë¼ìš°ë“œ] Cloud Manager (Supabase)
        const CloudManager = {
            client: null,
            isConnected: false,
            init: (url, key) => {
                if (!url || !key || url.includes("YOUR_")) return false;
                
                // [Auto-Fix] í”„ë¡œí† ì½œ(https://) ëˆ„ë½ ì‹œ ìë™ ì¶”ê°€
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }

                try {
                    CloudManager.client = window.supabase.createClient(url, key);
                    CloudManager.isConnected = true;
                    return true;
                } catch (e) {
                    console.error("Supabase init failed", e);
                    CloudManager.isConnected = false;
                    return false;
                }
            },
            // ì „ì²´ ë°ì´í„° ì—…ë¡œë“œ (ë®ì–´ì“°ê¸°) - MVP ë‹¨ìˆœí™”
            async push(deliveries) {
                if (!CloudManager.client) throw new Error("ì„œë²„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                
                // í…Œì´ë¸”: delivery_sync (id: 'master', data: jsonb)
                const { data, error } = await CloudManager.client
                    .from('delivery_sync')
                    .upsert({ id: 'master', data: deliveries, updated_at: new Date().toISOString() })
                    .select();
                
                if (error) throw error;
                return true;
            },
            // ê³µì§€ì‚¬í•­ ì—…ë¡œë“œ
            async pushNotice(text) {
                if (!CloudManager.client) return;
                const { error } = await CloudManager.client
                    .from('delivery_sync')
                    .upsert({ id: 'notice', data: { text }, updated_at: new Date().toISOString() });
                if (error) console.error("Notice sync failed", error);
            },
            // ì „ì²´ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
            async pull() {
                if (!CloudManager.client) throw new Error("ì„œë²„ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                
                const { data, error } = await CloudManager.client
                    .from('delivery_sync')
                    .select('*')
                    .eq('id', 'master')
                    .maybeSingle(); 
                
                if (error) throw error;
                return data ? data.data : null;
            },
            // ê³µì§€ì‚¬í•­ ë‹¤ìš´ë¡œë“œ
            async pullNotice() {
                if (!CloudManager.client) return '';
                const { data, error } = await CloudManager.client
                    .from('delivery_sync')
                    .select('*')
                    .eq('id', 'notice')
                    .maybeSingle();
                return (data && data.data) ? data.data.text : '';
            }
        };

        // ì´ˆê¸°í™” ì‹œë„
        // [Change] Configì— ì„¤ì •ëœ ê°’ìœ¼ë¡œ ì¦‰ì‹œ ì´ˆê¸°í™” (ì‚¬ìš©ì ìš”ì²­: ë¬´ì¡°ê±´ ì‚¬ìš©)
        if (Config.SUPABASE_URL && !Config.SUPABASE_URL.includes("YOUR_")) {
            CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
            console.log("[Cloud] Initialized with Hardcoded Config");
        } else {
            const savedCloudConfig = StorageManager.get('mvp_supabase_config');
            if (savedCloudConfig) {
                CloudManager.init(savedCloudConfig.url, savedCloudConfig.key);
            }
        }

        const { useState, useEffect, useRef, useMemo } = React;

        // [ìœ í‹¸ë¦¬í‹°]
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * (Math.PI/180)) * Math.cos(lat2 * (Math.PI/180)) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function geocodeAddress(address, strict = false) {
            // [ì•ˆì „ì¥ì¹˜] ì£¼ì†Œ ìœ íš¨ì„± ê²€ì‚¬
            if (!address || typeof address !== 'string') {
                return strict ? null : { lat: 37.5665, lng: 126.9780 };
            }

            try {
                // [ê°œì„ ëœ ì§€ì˜¤ì½”ë”© ë¡œì§]
                // 1. ê¸°ë³¸ ì •ì œ: ê´„í˜¸ ì œê±°, ì•ë’¤ ê³µë°± ì œê±°
                let cleanAddr = address.split('(')[0].trim();
                
                // ë„ìš°ë¯¸ í•¨ìˆ˜: Nominatim ê²€ìƒ‰
                const search = async (query) => {
                    try {
                        // console.log("Searching:", query); // Debug
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
                        const data = await res.json();
                        if (data && data.length > 0) {
                            const lat = parseFloat(data[0].lat);
                            const lng = parseFloat(data[0].lon);
                            if (isNaN(lat) || isNaN(lng)) return null;
                            return { lat, lng };
                        }
                    } catch(e) { return null; }
                    return null;
                };

                // ì „ëµ 1: ì „ì²´ ì£¼ì†Œ ê²€ìƒ‰ (ì˜ˆ: "ì¸ì²œ ì—°ìˆ˜êµ¬ ì†¡ë„ê³¼í•™ë¡œ27ë²ˆê¸¸ 15")
                let result = await search(cleanAddr);
                if (result) return result;

                // [New] ì „ëµ 2: ë„ë¡œëª… ì£¼ì†Œ íŒŒì‹± (ì‹œ/êµ°/êµ¬ + ë„ë¡œëª… + ê±´ë¬¼ë²ˆí˜¸)
                // ì •ê·œì‹ìœ¼ë¡œ "êµ¬/êµ°/ì‹œ", "ë¡œ/ê¸¸", ìˆ«ì ì¶”ì¶œ ì‹œë„
                // ì˜ˆ: "ì¸ì²œ ì—°ìˆ˜êµ¬ ì†¡ë„ê³¼í•™ë¡œ27ë²ˆê¸¸ 15" -> ["ì¸ì²œ", "ì—°ìˆ˜êµ¬", "ì†¡ë„ê³¼í•™ë¡œ27ë²ˆê¸¸", "15"]
                
                // ê°„ë‹¨í•œ í† í° ë¶„ë¦¬ ë°©ì‹ì´ ë” ê°•ë ¥í•  ìˆ˜ ìˆìŒ
                const tokens = cleanAddr.split(/\s+/); // ê³µë°±ìœ¼ë¡œ ë¶„ë¦¬
                
                // í† í° ë¶„ì„
                let siDo = "";
                let guGun = "";
                let roadName = "";
                let buildingNum = "";

                // ì—­ìˆœìœ¼ë¡œ íƒìƒ‰í•˜ì—¬ ê±´ë¬¼ë²ˆí˜¸, ë„ë¡œëª… ì‹ë³„
                for (let i = tokens.length - 1; i >= 0; i--) {
                    const t = tokens[i];
                    // ìˆ«ì í¬í•¨ ì—¬ë¶€ í™•ì¸ (ê±´ë¬¼ë²ˆí˜¸) - ë³´í†µ ë§¨ ë’¤ ë˜ëŠ” ë§¨ ë’¤ì—ì„œ ë‘ë²ˆì§¸
                    if (!buildingNum && /^\d+(-\d+)?$/.test(t)) {
                        buildingNum = t;
                        continue;
                    }
                    // ë¡œ/ê¸¸ë¡œ ëë‚˜ëŠ”ì§€ í™•ì¸ (ë„ë¡œëª…)
                    if (!roadName && (t.endsWith('ë¡œ') || t.endsWith('ê¸¸') || t.match(/[ë¡œê¸¸]\d+ë²ˆê¸¸/))) {
                        roadName = t;
                        continue;
                    }
                    // êµ¬/êµ°/ì‹œ í™•ì¸
                    if (!guGun && (t.endsWith('êµ¬') || t.endsWith('êµ°') || (t.endsWith('ì‹œ') && t.length > 2))) { // "ì‹œ"ëŠ” "ì„œìš¸ì‹œ" ë“±
                        guGun = t;
                        continue;
                    }
                    // ì‹œ/ë„ í™•ì¸ (ë‚¨ì€ ê²ƒ ì¤‘ ë§¨ ì•ìª½ì¼ ê°€ëŠ¥ì„± ë†’ìŒ)
                    if (!siDo && (t.endsWith('ì‹œ') || t.endsWith('ë„'))) {
                        siDo = t;
                    }
                }

                // íŒŒì‹±ëœ ì¡°í•©ìœ¼ë¡œ ì¬ê²€ìƒ‰
                if (roadName && buildingNum) {
                    // ì¡°í•© 1: ì‹œ/ë„ + êµ¬/êµ° + ë„ë¡œëª… + ê±´ë¬¼ë²ˆí˜¸ (Full)
                    if (siDo && guGun) {
                        result = await search(`${siDo} ${guGun} ${roadName} ${buildingNum}`);
                        if (result) return result;
                    }

                    // ì¡°í•© 2: êµ¬/êµ° + ë„ë¡œëª… + ê±´ë¬¼ë²ˆí˜¸
                    if (guGun) {
                        result = await search(`${guGun} ${roadName} ${buildingNum}`);
                        if (result) return result;
                    }

                    // ì¡°í•© 3: ë„ë¡œëª… + ê±´ë¬¼ë²ˆí˜¸ (ìµœí›„ì˜ ìˆ˜ë‹¨, ì •í™•ë„ ë‚®ì„ ìˆ˜ ìˆìŒ)
                    result = await search(`${roadName} ${buildingNum}`);
                    if (result) return result;
                }

                // ì „ëµ 3: ìƒì„¸ì£¼ì†Œ(ë§ˆì§€ë§‰ ì–´ì ˆ) ì œê±° í›„ ê²€ìƒ‰ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                if (tokens.length > 2) { 
                    tokens.pop(); 
                    const lessDetail = tokens.join(' ');
                    result = await search(lessDetail);
                    if (result) return result;
                }

                // ì „ëµ 4: ë” ë„“ì€ ë²”ìœ„ ê²€ìƒ‰
                if (tokens.length > 2) {
                    tokens.pop();
                    const moreLessDetail = tokens.join(' ');
                    result = await search(moreLessDetail);
                    if (result) return result;
                }

            } catch (e) { console.error("Geocoding failed", e); }
            
            // Strict ëª¨ë“œì¼ ê²½ìš° Fallback ì‚¬ìš© ì•ˆ í•¨
            if (strict) return null;

            // [Fallback] ì‹¤íŒ¨ ì‹œ ì§€ì—­ë³„ ê¸°ë³¸ ì¢Œí‘œ ë°˜í™˜ (ì„œìš¸ ì ë¦¼ ë°©ì§€)
            if (address.includes('ì¸ì²œ')) return { lat: 37.4563, lng: 126.7052 }; // ì¸ì²œì‹œì²­
            if (address.includes('ê²½ê¸°')) return { lat: 37.2752, lng: 127.0097 }; // ê²½ê¸°ë„ì²­
            if (address.includes('ë¶€ì‚°')) return { lat: 35.1796, lng: 129.0756 }; // ë¶€ì‚°ì‹œì²­
            if (address.includes('ëŒ€êµ¬')) return { lat: 35.8714, lng: 128.6014 }; // ëŒ€êµ¬ì‹œì²­
            
            return { lat: 37.5665, lng: 126.9780 }; // Default: ì„œìš¸ì‹œì²­
        }

        function formatTimeRange(start, minutes) {
            if (!start) return 'ì˜ˆì•½ì‹œê°„';
            const [hh, mm] = start.split(':').map(x => parseInt(x, 10));
            const total = hh * 60 + mm + (parseInt(minutes, 10) || 0);
            const eh = Math.floor(total / 60);
            const em = total % 60;
            const pad = n => (n < 10 ? '0' + n : '' + n);
            return `${start} ~ ${pad(eh)}:${pad(em)}`;
        }

        function parseCustomDate(dateStr) {
            // [ì•ˆì „ì¥ì¹˜] ê°’ì´ ì—†ìœ¼ë©´ ì˜¤ëŠ˜ ë‚ ì§œ ë°˜í™˜ (Local Time - KST Support)
            if (!dateStr) {
                const d = new Date();
                const offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().split('T')[0];
            }

            // ì—‘ì…€ ë‚ ì§œ ê°ì²´ì¸ ê²½ìš°
            if (dateStr instanceof Date) {
                const offset = dateStr.getTimezoneOffset() * 60000;
                return new Date(dateStr.getTime() - offset).toISOString().split('T')[0];
            }

            let str = String(dateStr).trim();

            // [ê°œì„ ] "2025. 2. 3" ë˜ëŠ” "2025/02/03" ë“±ì˜ í˜•ì‹ì„ "2025-02-03"ìœ¼ë¡œ ì •ê·œí™”
            // 1. ë…„ì›”ì¼ í•œê¸€ í˜•ì‹ ("2ì›” 3ì¼")
            const koreanMatch = str.match(/(\d+)ì›”\s*(\d+)ì¼/);
            if (koreanMatch) {
                const year = new Date().getFullYear();
                const month = koreanMatch[1].padStart(2, '0');
                const day = koreanMatch[2].padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // 2. êµ¬ë¶„ì(., /)ë¥¼ -ë¡œ í†µì¼í•˜ê³  ê³µë°± ì œê±°
            // ì˜ˆ: "2025. 02. 03" -> "2025-02-03"
            const normalized = str.replace(/[\.\/]/g, '-').replace(/\s+/g, '');
            
            // 3. YYYY-M-D í˜•ì‹ì„ YYYY-MM-DDë¡œ ë³´ì •
            const parts = normalized.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const month = parts[1].padStart(2, '0');
                const day = parts[2].padStart(2, '0');
                // ì—°ë„ê°€ 2ìë¦¬ì¸ ê²½ìš° (25-02-03) ì²˜ë¦¬ (ì„ íƒì‚¬í•­, ì—¬ê¸°ì„  4ìë¦¬ ê°€ì •í•˜ë˜ í•„ìš”ì‹œ ì¶”ê°€)
                return `${year}-${month}-${day}`;
            }
            
            return normalized; 
        }

        // [ì•Œê³ ë¦¬ì¦˜] Nearest Neighbor (ì¶œë°œì§€ -> ê°€ì¥ ê°€ê¹Œìš´ ê³³ -> ... -> ë„ì°©ì§€)
        function solveTSP(startNode, nodes, endNode) {
            let current = startNode;
            let unvisited = [...nodes];
            const path = [];

            while (unvisited.length > 0) {
                // í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ë…¸ë“œ ì°¾ê¸°
                unvisited.sort((a, b) => {
                    const distA = getDistance(current.lat, current.lng, a.lat, a.lng);
                    const distB = getDistance(current.lat, current.lng, b.lat, b.lng);
                    return distA - distB;
                });

                const next = unvisited.shift();
                path.push({
                    ...next,
                    // [ìˆ˜ì •] ê±°ë¦¬ëŠ” í•­ìƒ ì¶œë°œì§€(startNode) ê¸°ì¤€ìœ¼ë¡œ í‘œì‹œ
                    distanceFromPrev: getDistance(startNode.lat, startNode.lng, next.lat, next.lng)
                });
                current = next;
            }

            // [ì¶”ê°€] ë§ˆì§€ë§‰ ë„ì°©ì§€(ì§‘) ì¶”ê°€
            if (endNode) {
                path.push({
                    ...endNode,
                    distanceFromPrev: getDistance(current.lat, current.lng, endNode.lat, endNode.lng),
                    type: 'destination' // ì‹ë³„ìš© íƒœê·¸
                });
            }

            return path;
        }

        // [ì»´í¬ë„ŒíŠ¸] ì§€ë„
        function MapView({ locations, center, startPoint }) {
            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const polylineRef = useRef(null);

            useEffect(() => {
                if (!mapRef.current) return;
                
                // [ë””ë²„ê·¸] ë§ˆì»¤ ìƒíƒœ ë¡œê·¸
                console.log(`[Map] ë Œë”ë§: í™œì„± ë§ˆì»¤ ${locations.length}ê°œ, ì¤‘ì‹¬: ${center?.address || 'N/A'}`);

                // ì´ˆê¸°í™”
                if (!mapInstance.current) {
                    mapInstance.current = L.map(mapRef.current, {
                        zoomControl: false // [ìˆ˜ì •] ì¤Œ ì»¨íŠ¸ë¡¤(+/-) ì œê±°
                    }).setView([center.lat, center.lng], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(mapInstance.current);
                } else {
                    mapInstance.current.setView([center.lat, center.lng], 12);
                }

                // ë§ˆì»¤ í´ë¦¬ì–´
                mapInstance.current.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) mapInstance.current.removeLayer(layer);
                });

                // 1. ì¶œë°œì§€ ë§ˆì»¤ (íŒŒë‘)
                if (startPoint) {
                    const startIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color:#2563eb; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow:0 0 5px black;"></div>`,
                        iconSize: [20, 20]
                    });
                    const startMarker = L.marker([startPoint.lat, startPoint.lng], { icon: startIcon }).addTo(mapInstance.current).bindPopup("ğŸš© ì¶œë°œì§€ (ë¬¼ë¥˜ì„¼í„°)");
                    startMarker.off('click');
                    startMarker.on('click', function() {
                        if (this.isPopupOpen()) this.closePopup();
                        else this.openPopup();
                    });
                }

                // 2. ë°°ì†¡ì§€ ë° ë„ì°©ì§€ ë§ˆì»¤
                locations.forEach((group, idx) => {
                    // [ì•ˆì „ì¥ì¹˜] ì¢Œí‘œ ìœ íš¨ì„± ê²€ì‚¬
                    if (!group.lat || !group.lng || isNaN(group.lat) || isNaN(group.lng)) return;

                    // [ë„ì°©ì§€(ì§‘) ë§ˆì»¤]
                    if (group.type === 'destination') {
                        const icon = L.divIcon({
                            className: 'custom-div-icon',
                            html: `<div style='background-color:#10b981; color:white; border-radius:50%; width:30px; height:30px; text-align:center; line-height:30px; font-size:18px; border:2px solid white; box-shadow:1px 1px 3px rgba(0,0,0,0.5);'>ğŸ </div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        const destMarker = L.marker([group.lat, group.lng], { icon }).addTo(mapInstance.current)
                         .bindPopup(`<div class="font-bold text-center p-2">ğŸ  ë„ì°©ì§€(ì§‘)<br/><span class="text-xs text-gray-500">${group.address}</span></div>`);
                        destMarker.off('click');
                        destMarker.on('click', function() {
                            if (this.isPopupOpen()) this.closePopup();
                            else this.openPopup();
                        });
                        return;
                    }

                    // [ì¼ë°˜ ë°°ì†¡ì§€ ë§ˆì»¤]
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style='background-color:#ef4444; color:white; border-radius:50%; width:24px; height:24px; text-align:center; line-height:24px; font-weight:bold; border:2px solid white; box-shadow:1px 1px 3px rgba(0,0,0,0.5);'>${idx + 1}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    
                    // [ìˆ˜ì •] ê±°ë¦¬ ê³„ì‚° ë° í‘œì‹œ (ì§€ë„ íŒì—…)
                    const dist = startPoint ? getDistance(startPoint.lat, startPoint.lng, group.lat, group.lng).toFixed(1) : null;
                    const distHtml = dist ? `<span class="text-xs font-bold text-blue-700 bg-blue-100 px-1.5 py-0.5 rounded border border-blue-200 ml-1 whitespace-nowrap">${dist}km</span>` : '';

                    const popupContent = `
                        <div class="p-2 min-w-[200px]">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">${idx + 1}ë²ˆ</span>
                                <span class="font-bold text-lg text-gray-800">${group.phone}</span>
                            </div>
                            <div class="text-sm text-gray-600 mb-1 flex items-center flex-wrap">ğŸ“ ${group.address} ${distHtml}</div>
                            <div class="border-t pt-2">
                                <ul class="list-disc pl-4 text-sm space-y-0.5 text-gray-700">
                                    ${(group.items || []).map(i => `<li>${i.item}</li>`).join('')}
                                </ul>
                                <div class="flex gap-1 mt-2">
                                    <button onclick="window.handleAppNavigation(${group.lat}, ${group.lng}, '${group.address.replace(/'/g, "\\'")}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">
                                        ë°°ì†¡ì¶œë°œ
                                    </button>
                                    <button onclick="window.handlePopupSequenceChange('${group.ids.join(',')}')" class="flex-1 bg-sky-500 hover:bg-indigo-600 text-white font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">
                                        ìˆœì„œë³€ê²½
                                    </button>
                                    <button onclick="document.querySelector('.leaflet-popup-close-button').click()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 rounded-lg flex items-center justify-center transition shadow-sm text-xs">
                                        ë‹«ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    const marker = L.marker([group.lat, group.lng], { icon }).addTo(mapInstance.current).bindPopup(popupContent);
                    marker.off('click');
                    marker.on('click', function() {
                        if (this.isPopupOpen()) {
                            this.closePopup();
                        } else {
                            this.openPopup();
                        }
                    });
                });

                // 3. ê²½ë¡œ ì„  ê·¸ë¦¬ê¸°
                if (startPoint && locations.length > 0) {
                    const latlngs = [
                        [startPoint.lat, startPoint.lng],
                        ...locations.map(l => [l.lat, l.lng])
                    ];
                    L.polyline(latlngs, { color: '#2563eb', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(mapInstance.current);
                }

            }, [locations, center, startPoint]);

            return <div ref={mapRef} className="map-container mb-4 shadow-md bg-gray-200"></div>;
        }

        // [ì»´í¬ë„ŒíŠ¸] ë¡œê·¸ì¸/ë©”ì¸ ì§„ì… í™”ë©´
        function LoginScreen({ onLogin }) {
            const [driverName, setDriverName] = useState('');

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50 flex flex-col items-center justify-center p-6 animate-fade-in">
                    <div className="bg-white/80 backdrop-blur-xl p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center space-y-8 border border-white/50 ring-1 ring-indigo-50">
                        <div className="space-y-4">
                            <div className="w-24 h-24 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl mx-auto flex items-center justify-center shadow-lg shadow-indigo-200 mb-6 transform hover:scale-105 transition-transform duration-300">
                                <span className="text-5xl filter drop-shadow-md">ğŸšš</span>
                            </div>
                            <div>
                                <h1 className="text-3xl font-black text-slate-900 tracking-tight mb-2">ë°°ì†¡ ë§ˆìŠ¤í„°</h1>
                                <p className="text-slate-500 font-medium text-sm">ê¸°ì‚¬ë‹˜, ì˜¤ëŠ˜ë„ ì•ˆì „ìš´ì „ í•˜ì„¸ìš”!</p>
                            </div>
                        </div>

                        <div className="space-y-4">
                            <div className="relative group">
                                <div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <span className="text-gray-400 group-focus-within:text-indigo-500 transition-colors">ğŸ‘¤</span>
                                </div>
                                <input 
                                    type="text" 
                                    placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" 
                                    className="w-full bg-slate-50 border border-slate-200 p-4 pl-11 rounded-2xl text-lg font-bold text-slate-800 placeholder:text-slate-400 focus:ring-4 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition-all"
                                    value={driverName}
                                    onChange={(e) => setDriverName(e.target.value)}
                                    onKeyPress={(e) => {
                                        if(e.key === 'Enter') {
                                            if (/^[ê°€-í£]{2,10}$/.test(driverName.trim())) {
                                                onLogin('driver', driverName.trim());
                                            } else {
                                                alert("ì˜¬ë°”ë¥¸ í•œê¸€ ì´ë¦„(2~10ì)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                                            }
                                        }
                                    }}
                                />
                            </div>

                            <button 
                                onClick={() => {
                                    if (/^[ê°€-í£]{2,10}$/.test(driverName.trim())) {
                                        onLogin('driver', driverName.trim());
                                    } else {
                                        alert("ì˜¬ë°”ë¥¸ í•œê¸€ ì´ë¦„(2~10ì)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                                    }
                                }}
                                className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-4 rounded-2xl font-bold text-lg shadow-lg shadow-indigo-200 hover:shadow-indigo-300 hover:-translate-y-0.5 active:scale-95 transition-all flex items-center justify-center gap-2"
                            >
                                <span>ì‹œì‘í•˜ê¸°</span>
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                            </button>

                            <div className="relative flex py-2 items-center">
                                <div className="flex-grow border-t border-slate-200"></div>
                                <span className="flex-shrink-0 mx-4 text-slate-300 text-xs font-bold uppercase tracking-wider">Admin Access</span>
                                <div className="flex-grow border-t border-slate-200"></div>
                            </div>
                            
                            <button 
                                onClick={() => {
                                    const pwd = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                                    if (pwd === '1234') {
                                        onLogin('admin', 'admin');
                                    } else if (pwd !== null) {
                                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                                    }
                                }}
                                className="w-full bg-white text-slate-500 border border-slate-200 p-3 rounded-xl font-bold text-sm hover:bg-slate-50 hover:text-slate-700 active:bg-slate-100 transition-all flex items-center justify-center gap-2"
                            >
                                <span>âš™ï¸</span> ê´€ë¦¬ì ëª¨ë“œ
                            </button>
                        </div>
                        
                        <div className="text-xs text-slate-400">
                            v2.1 MVP Release
                        </div>
                    </div>
                </div>
            );
        }

        // [Component] Reusable Card Component (Modernized)
        const Card = ({ title, description, actions, children, className = "", loading = false }) => {
            return (
                <div className={`bg-white rounded-2xl shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 border border-slate-100 overflow-hidden group ${className}`}>
                    {(title || actions) && (
                        <div className="px-4 py-3 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center relative">
                            <div className="w-full text-center">
                                {title && <h3 className="font-bold text-lg text-slate-800 flex items-center justify-center gap-2">{title}</h3>}
                                {description && <p className="text-sm text-slate-500 mt-1">{description}</p>}
                            </div>
                            {actions && <div className="flex gap-2 absolute right-5 top-1/2 -translate-y-1/2">{actions}</div>}
                        </div>
                    )}
                    <div className={`px-4 py-3 relative ${loading ? 'opacity-50 pointer-events-none' : ''}`}>
                        {loading && (
                            <div className="absolute inset-0 bg-white/60 backdrop-blur-[1px] z-10 flex items-center justify-center">
                                 <div className="animate-spin rounded-full h-8 w-8 border-4 border-slate-200 border-t-indigo-600"></div>
                            </div>
                        )}
                        {children}
                    </div>
                </div>
            );
        };

        function DeliveryCard({ item, order, isCurrent, onComplete }) {
            return (
                <div className={`relative rounded-2xl px-4 py-3 border transition ${item.completed ? 'opacity-60' : ''} ${isCurrent ? 'border-indigo-600 bg-indigo-50' : 'border-slate-200 bg-white'}`}>
                    <div className="absolute -top-2 -left-2 w-7 h-7 rounded-full bg-indigo-600 text-white text-xs font-bold flex items-center justify-center">
                        {order}
                    </div>
                    <div className="flex justify-between items-start">
                        <div className="flex-1 pr-2">
                            {isCurrent && (
                                <p className="text-[11px] font-bold text-indigo-600 mb-1">
                                    ğŸšš í˜„ì¬ ë°°ì†¡ ì¤‘
                                </p>
                            )}
                            <div className="font-semibold text-slate-900 text-sm leading-snug">ğŸ“ {item.address}</div>
                            <div className="text-xs text-slate-500 mt-0.5">ğŸ“¦ {item.item}</div>
                            <div className="text-xs text-slate-500 mt-1">
                                <a href={`tel:${item.phone}`}>ğŸ“ {item.phone || 'ë²ˆí˜¸ì—†ìŒ'}</a>
                            </div>
                        </div>
                        <div className="flex gap-1 shrink-0 items-center">
                            {(item.scheduled_time || item.time) && (
                                <span className="text-[10px] font-bold text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded-full shrink-0">
                                    â° {(item.scheduled_time || item.time)}
                                </span>
                            )}
                            {item.canceled && <span className="text-[10px] font-bold text-white bg-red-500 px-2 py-1 rounded-full shrink-0">ì·¨ì†Œë¨</span>}
                            {item.completed && <span className="text-[10px] font-bold text-white bg-green-600 px-2 py-1 rounded-full shrink-0">ì™„ë£Œ</span>}
                            {!item.completed && (
                                <button onClick={() => onComplete(item.id, order)} className="px-2 py-1 text-xs font-bold rounded bg-indigo-600 text-white shadow-sm active:scale-95">
                                    ì™„ë£Œ
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // [ê´‘ê³ ] AdSense Banner Component
        const AdBanner = ({ className = "", slot, format = "auto", fullWidth = true }) => {
            useEffect(() => {
                try {
                    (window.adsbygoogle = window.adsbygoogle || []).push({});
                } catch (e) {
                    console.warn("AdSense push failed", e);
                }
            }, []);

            return (
                <div className={`ad-container ${className}`} style={{ minHeight: '100px', textAlign: 'center', overflow: 'hidden' }}>
                    <ins className="adsbygoogle"
                         style={{ display: 'block' }}
                         data-ad-client="ca-pub-4652108502419331"
                         data-ad-slot={slot}
                         data-ad-format={format}
                         data-full-width-responsive={fullWidth ? "true" : "false"}></ins>
                </div>
            );
        };

        // [ì„¤ì • ëª¨ë‹¬] Supabase Cloud Config
        function CloudSettingsModal({ isOpen, onClose, onReset }) {
            if (!isOpen) return null;
            const [url, setUrl] = useState(CloudManager.client?.supabaseUrl || '');
            const [key, setKey] = useState(CloudManager.client?.supabaseKey || '');
            const [showKey, setShowKey] = useState(false);

            const handleSave = () => {
                if (!url || !key) {
                    alert("URLê³¼ Keyë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                // [Auto-Fix] URL ë³´ì •
                let fixedUrl = url.trim();
                if (!fixedUrl.startsWith('http://') && !fixedUrl.startsWith('https://')) {
                    fixedUrl = 'https://' + fixedUrl;
                }

                const success = CloudManager.init(fixedUrl, key);
                if (success) {
                    StorageManager.set('mvp_supabase_config', { url: fixedUrl, key });
                    alert("âœ… ì„œë²„ ì—°ê²°ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!");
                    onClose();
                } else {
                    alert("âš ï¸ ì—°ê²° ì‹¤íŒ¨. URLê³¼ Keyë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
            };

            return (
                <div className="fixed inset-0 z-[9999] flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-md m-4 border border-slate-200">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">â˜ï¸ ì„œë²„(Cloud) ì„¤ì •</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 font-bold text-xl">âœ•</button>
                        </div>
                        
                        <div className="space-y-4 mb-6">
                            <div className="bg-blue-50 p-4 rounded-xl text-sm text-blue-700 leading-relaxed">
                                <strong>ğŸ”‘ í‚¤ í™•ì¸ ë°©ë²• (Supabase ëŒ€ì‹œë³´ë“œ)</strong><br/>
                                1. í”„ë¡œì íŠ¸ ëŒ€ì‹œë³´ë“œ ì ‘ì†<br/>
                                2. ì¢Œì¸¡ ë©”ë‰´ ìµœí•˜ë‹¨ <strong>í†±ë‹ˆë°”í€´ ì•„ì´ì½˜ (Project Settings)</strong> í´ë¦­<br/>
                                3. <strong>API</strong> ë©”ë‰´ ì„ íƒ<br/>
                                4. <strong>Project URL</strong> ë° <strong>anon / public</strong> í‚¤ ë³µì‚¬<br/>
                                <br/>
                                <strong>âš¡ ì´ˆê¸° ì„¤ì • (SQL Editor)</strong><br/>
                                ì¢Œì¸¡ <strong>SQL Editor</strong> ë©”ë‰´ > ì•„ë˜ ì¿¼ë¦¬ ë¶™ì—¬ë„£ê¸° í›„ <strong>Run</strong>:<br/>
                                <code className="block bg-blue-100 p-2 mt-2 rounded font-mono text-xs select-all">
                                    create table delivery_sync (
                                      id text primary key,
                                      data jsonb,
                                      updated_at timestamptz default now()
                                    );
                                </code>
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Project URL</label>
                                <div className="flex gap-2">
                                    <input type="text" className="flex-1 bg-slate-50 border p-3 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none" 
                                        placeholder="https://your-project.supabase.co" value={url} onChange={e => setUrl(e.target.value)} />
                                    <button onClick={() => { navigator.clipboard.writeText(url); alert("URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); }} 
                                        className="bg-slate-100 px-3 rounded-lg hover:bg-slate-200 text-lg transition" title="URL ë³µì‚¬">ğŸ“‹</button>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Anon / Public Key</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <input type={showKey ? "text" : "password"} className="w-full bg-slate-50 border p-3 rounded-lg text-sm font-mono focus:ring-2 focus:ring-indigo-500 outline-none pr-10" 
                                            placeholder="eyJh..." value={key} onChange={e => setKey(e.target.value)} />
                                        <button onClick={() => setShowKey(!showKey)} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 z-10 p-1">
                                            {showKey ? "ğŸ™ˆ" : "ğŸ‘ï¸"}
                                        </button>
                                    </div>
                                    <button onClick={() => { navigator.clipboard.writeText(key); alert("Keyê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"); }} 
                                        className="bg-slate-100 px-3 rounded-lg hover:bg-slate-200 text-lg transition" title="Key ë³µì‚¬">ğŸ“‹</button>
                                </div>
                            </div>
                        </div>

                        <div className="flex gap-3">
                            <button onClick={() => {
                                StorageManager.remove('mvp_supabase_config');
                                setUrl(''); setKey('');
                                CloudManager.client = null;
                                alert("ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                                onClose();
                            }} className="flex-1 bg-slate-100 text-slate-600 py-3 rounded-xl font-bold hover:bg-slate-200 transition">ì—°ê²° í•´ì œ</button>
                            <button onClick={handleSave} className="flex-[2] bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition">ì—°ê²° ì €ì¥</button>
                        </div>
                        
                        <div className="mt-4 pt-4 border-t border-slate-100">
                            <button onClick={async () => {
                                if (!CloudManager.isConnected && !CloudManager.client) {
                                    alert("ë¨¼ì € ì„œë²„ì— ì—°ê²°í•´ì•¼ ë°ì´í„°ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                                    return;
                                }
                                if(confirm("âš ï¸ ì •ë§ë¡œ ì„œë²„ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                                    try {
                                        await CloudManager.push([]); // ë¹ˆ ë°°ì—´ ì—…ë¡œë“œ
                                        if (onReset) onReset(); // ë¡œì»¬ ë°ì´í„° ì´ˆê¸°í™”
                                        alert("âœ… ì„œë²„ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”.");
                                        onClose();
                                    } catch(e) {
                                        alert("âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: " + e.message);
                                    }
                                }
                            }} className="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold hover:bg-red-100 transition text-sm flex items-center justify-center gap-2">
                                ğŸ—‘ï¸ ì„œë²„ ë°ì´í„° ì´ˆê¸°í™” (ì „ì²´ ì‚­ì œ)
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // [ê°€ì´ë“œ ëª¨ë‹¬] ì•± ì‚¬ìš© ì„¤ëª…ì„œ
        function GuideModal({ isOpen, onClose }) {
            if (!isOpen) return null;
            const [tab, setTab] = useState('driver'); // driver | admin | cloud

            return (
                <div className="fixed inset-0 z-[10000] flex items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl m-4 overflow-hidden flex flex-col max-h-[85vh]" onClick={e => e.stopPropagation()}>
                        <div className="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                            <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">ğŸ“˜ ì‚¬ìš© ê°€ì´ë“œ</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 font-bold text-xl">âœ•</button>
                        </div>
                        
                        <div className="flex border-b">
                            <button className={`flex-1 py-3 text-sm font-bold transition ${tab === 'driver' ? 'text-indigo-900 border-b-2 border-indigo-600 bg-sky-50/50' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setTab('driver')}>ğŸ›µ ê¸°ì‚¬ë‹˜ ê°€ì´ë“œ</button>
                            <button className={`flex-1 py-3 text-sm font-bold transition ${tab === 'admin' ? 'text-indigo-900 border-b-2 border-indigo-600 bg-sky-50/50' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setTab('admin')}>ğŸ‘¨â€ğŸ’¼ ê´€ë¦¬ì ê°€ì´ë“œ</button>
                            <button className={`flex-1 py-3 text-sm font-bold transition ${tab === 'cloud' ? 'text-indigo-900 border-b-2 border-indigo-600 bg-sky-50/50' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setTab('cloud')}>â˜ï¸ ì„œë²„ ì—°ê²°</button>
                        </div>

                        <div className="p-6 overflow-y-auto leading-relaxed text-slate-700 space-y-6">
                            {tab === 'driver' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                        <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2">ğŸ“Œ ê¸°ë³¸ ì›Œí¬í”Œë¡œìš°</h3>
                                        <ol className="list-decimal list-inside text-sm space-y-1 text-blue-900">
                                            <li>ì•± ì‹¤í–‰ ì‹œ ë°ì´í„°ê°€ <strong>ìë™ ë™ê¸°í™”</strong>ë©ë‹ˆë‹¤. (ë˜ëŠ” <strong>[ì„œë²„ì—ì„œ ë°›ê¸°]</strong>)</li>
                                            <li>ë°°ì†¡ ëª©ë¡ì„ í™•ì¸í•˜ê³  ì¶œë°œí•©ë‹ˆë‹¤.</li>
                                            <li>í˜„ì¥ì—ì„œ <strong>ë¹„ìš©(ì–‘ì¤‘ë¹„ ë“±)</strong>ê³¼ <strong>ìƒíƒœ(ì™„ë£Œ/ì·¨ì†Œ)</strong>ë¥¼ ì…ë ¥í•©ë‹ˆë‹¤.</li>
                                            <li>ì‘ì—… ë‚´ìš©ì€ <strong>ìë™ìœ¼ë¡œ ì„œë²„ì— ì €ì¥</strong>ë©ë‹ˆë‹¤. (ë˜ëŠ” <strong>[ì„œë²„ì— ì˜¬ë¦¬ê¸°]</strong>)</li>
                                        </ol>
                                    </div>
                                    
                                    {/* ì œì–´ë°”: ë°°ì†¡ì¹´ë“œ ì•„ë˜ë¡œ ì´ë™ */}
                                    <div className="mt-2">
                                        <div className="flex items-center justify-between px-3 py-2 gap-2">
                                            <div className="flex-1 min-h-[44px] flex items-center">
                                                {isMergeMode && (
                                                    <div className="w-full rounded-xl bg-indigo-50 border border-indigo-100 px-3 py-2 flex items-center justify-between">
                                                        <div>
                                                            <p className="text-xs font-semibold text-indigo-700">í•©ì¹  ë°°ì†¡ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                                                            <p className="text-[11px] text-indigo-500">{selectedMergeIds.length}ê±´ ì„ íƒë¨</p>
                                                        </div>
                                                        <button
                                                            disabled={selectedMergeIds.length < 2}
                                                            onClick={handleMergeDeliveries}
                                                            className={`ml-3 px-3 py-1.5 rounded-lg text-xs font-bold ${
                                                                selectedMergeIds.length < 2
                                                                ? 'bg-slate-200 text-slate-400'
                                                                : 'bg-indigo-600 text-white'
                                                            }`}
                                                        >
                                                            í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                            <div className="flex items-center gap-2 flex-shrink-0">
                                                <button
                                                    onClick={() => { setIsMergeMode(!isMergeMode); setSelectedMergeIds([]); }}
                                                    className={`px-3 py-1 rounded-full text-xs font-medium ${isMergeMode ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-600'}`}
                                                >
                                                    í•©ì¹˜ê¸°
                                                </button>
                                                <button
                                                    onClick={() => setView('driver_add')}
                                                    className="w-9 h-9 rounded-full bg-indigo-600 text-white text-xl leading-none"
                                                    title="ë°°ì†¡ì§€ ì¶”ê°€"
                                                    aria-label="ë°°ì†¡ì§€ ì¶”ê°€"
                                                >
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div className="space-y-3">
                                        <h4 className="font-bold text-slate-800 border-l-4 border-indigo-500 pl-3">ì£¼ìš” ê¸°ëŠ¥</h4>
                                        <ul className="space-y-2 text-sm">
                                            <li className="flex gap-2"><span className="text-indigo-900 font-bold min-w-[60px]">ì§€ë„ ì—´ê¸°</span> ì£¼ì†Œ ì˜† ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì¹´ì¹´ì˜¤ë§µ/í‹°ë§µì´ ì‹¤í–‰ë©ë‹ˆë‹¤.</li>
                                            <li className="flex gap-2"><span className="text-indigo-900 font-bold min-w-[60px]">ë¹„ìš© ì…ë ¥</span> ì„¤ì¹˜ë¹„, ì–‘ì¤‘ë¹„, ë‚´ë¦¼ë¹„, ê¸°íƒ€ë¹„ìš©ì„ ì…ë ¥í•˜ë©´ ìë™ í•©ì‚°ë©ë‹ˆë‹¤.</li>
                                            <li className="flex gap-2"><span className="text-indigo-900 font-bold min-w-[60px]">ìƒíƒœ ë³€ê²½</span> ë°°ì†¡ì™„ë£Œ í›„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì™„ë£Œ/ì·¨ì†Œ/ì—°ê¸°/ë¶€ë¶„ë°°ì†¡ ìƒíƒœë¡œ ë³€ê²½í•©ë‹ˆë‹¤.</li>
                                        </ul>
                                    </div>
                                </div>
                            )}

                            {tab === 'admin' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                                        <h3 className="font-bold text-emerald-800 mb-2 flex items-center gap-2">ğŸ“Œ ê´€ë¦¬ì ì›Œí¬í”Œë¡œìš°</h3>
                                        <ol className="list-decimal list-inside text-sm space-y-1 text-emerald-900">
                                            <li>ì—‘ì…€ íŒŒì¼ë¡œ ê³ ê° ëª©ë¡ì„ <strong>ì¼ê´„ ë“±ë¡</strong>í•©ë‹ˆë‹¤.</li>
                                            <li><strong>[ì„œë²„ì— ì˜¬ë¦¬ê¸°]</strong> ë²„íŠ¼ìœ¼ë¡œ ë°ì´í„°ë¥¼ ê¸°ì‚¬ë‹˜ë“¤ì—ê²Œ ê³µìœ í•©ë‹ˆë‹¤.</li>
                                            <li>ê¸°ì‚¬ë‹˜ë“¤ì´ ì‘ì—…ì„ ë§ˆì¹˜ë©´ <strong>[ì„œë²„ì—ì„œ ë°›ê¸°]</strong>ë¡œ ê²°ê³¼ë¥¼ ì·¨í•©í•©ë‹ˆë‹¤.</li>
                                            <li>ìµœì¢… ë‚´ì—­ì„ <strong>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</strong>í•˜ì—¬ ì •ì‚°ì— í™œìš©í•©ë‹ˆë‹¤.</li>
                                        </ol>
                                    </div>

                                    <div className="space-y-3">
                                        <h4 className="font-bold text-slate-800 border-l-4 border-emerald-500 pl-3">ë°ì´í„° ê´€ë¦¬ íŒ</h4>
                                        <ul className="space-y-2 text-sm">
                                            <li className="flex gap-2"><span className="text-emerald-600 font-bold min-w-[80px]">ì—‘ì…€ ì—…ë¡œë“œ</span> [ê³ ê°ë“±ë¡] íŒ¨ë„ì—ì„œ ì—‘ì…€ íŒŒì¼ì„ ë“œë˜ê·¸ì•¤ë“œë¡­ í•˜ì„¸ìš”.</li>
                                            <li className="flex gap-2"><span className="text-emerald-600 font-bold min-w-[80px]">ìˆ˜ì •/ì‚­ì œ</span> ëª©ë¡ì˜ ì•„ì´í…œì„ í´ë¦­í•˜ë©´ ìƒì„¸ ìˆ˜ì •ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</li>
                                            <li className="flex gap-2"><span className="text-emerald-600 font-bold min-w-[80px]">ì´ˆê¸°í™”</span> [ì „ì²´ ì‚­ì œ] ê¸°ëŠ¥ì€ ëª¨ë“  ë°ì´í„°ë¥¼ ì§€ìš°ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”.</li>
                                        </ul>
                                    </div>
                                </div>
                            )}

                            {tab === 'cloud' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-purple-50 p-4 rounded-xl border border-purple-100">
                                        <h3 className="font-bold text-purple-800 mb-2">â˜ï¸ Supabase ì—°ê²° ë°©ë²•</h3>
                                        <p className="text-sm text-purple-900 mb-2">ë¬´ë£Œ í´ë¼ìš°ë“œ ë°ì´í„°ë² ì´ìŠ¤ì¸ Supabaseë¥¼ ì—°ê²°í•˜ì—¬ ë°ì´í„°ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë™ê¸°í™”í•˜ì„¸ìš”.</p>
                                        <button 
                                            onClick={() => window.open('https://supabase.com', '_blank')}
                                            className="text-xs bg-purple-600 text-white px-3 py-1.5 rounded hover:bg-purple-700 transition"
                                        >
                                            Supabase ë°”ë¡œê°€ê¸° â†—
                                        </button>
                                    </div>

                                    <div className="space-y-3 text-sm">
                                        <h4 className="font-bold text-slate-800">1. í”„ë¡œì íŠ¸ ìƒì„± & API í‚¤ ë°œê¸‰</h4>
                                        <p className="text-slate-600 pl-4 border-l-2 border-slate-200">
                                            Supabase íšŒì›ê°€ì… í›„ 'New Project'ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.<br/>
                                            Settings > API ë©”ë‰´ì—ì„œ <strong>Project URL</strong>ê³¼ <strong>anon / public key</strong>ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.
                                        </p>

                                        <h4 className="font-bold text-slate-800">2. í…Œì´ë¸” ìƒì„± (SQL Editor)</h4>
                                        <p className="text-slate-600 pl-4 border-l-2 border-slate-200">
                                            ì¢Œì¸¡ 'SQL Editor' ë©”ë‰´ì—ì„œ ì•„ë˜ ì½”ë“œë¥¼ ì‹¤í–‰(Run)í•˜ì„¸ìš”.
                                        </p>
                                        <div className="bg-slate-800 text-slate-200 p-3 rounded-lg font-mono text-xs overflow-x-auto">
                                            create table delivery_sync (<br/>
                                            &nbsp;&nbsp;id text primary key,<br/>
                                            &nbsp;&nbsp;data jsonb,<br/>
                                            &nbsp;&nbsp;updated_at timestamptz default now()<br/>
                                            );
                                        </div>

                                        <h4 className="font-bold text-slate-800">3. ì•±ì— ì—°ê²°</h4>
                                        <p className="text-slate-600 pl-4 border-l-2 border-slate-200">
                                            ê´€ë¦¬ì ëª¨ë“œì˜ [ë°ì´í„° ë„êµ¬] > [ì„œë²„ ì„¤ì •] ë²„íŠ¼ì„ ëˆ„ë¥´ê³  URLê³¼ Keyë¥¼ ì…ë ¥í•˜ë©´ ë!
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="bg-slate-50 p-4 border-t flex justify-end">
                            <button onClick={onClose} className="bg-slate-800 text-white px-6 py-2.5 rounded-xl font-bold hover:bg-slate-900 transition">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            );
        }

        // [ì•ˆì „ì¥ì¹˜] Error Boundary
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }

            componentDidCatch(error, errorInfo) {
                console.error("ErrorBoundary caught an error", error, errorInfo);
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center bg-red-50">
                            <div className="text-6xl mb-4">ğŸ˜µ</div>
                            <h1 className="text-2xl font-bold text-red-600 mb-2">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h1>
                            <p className="text-gray-600 mb-6 max-w-xs mx-auto break-words">{this.state.error?.toString() || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}</p>
                            <div className="flex flex-col gap-3 w-full max-w-xs">
                                <button 
                                    onClick={() => location.reload()}
                                    className="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition"
                                >
                                    ì•± ì¬ì‹œì‘
                                </button>
                                <button 
                                    onClick={() => {
                                        if(confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                                            localStorage.clear();
                                            location.reload();
                                        }
                                    }}
                                    className="bg-white text-red-500 border border-red-200 px-6 py-3 rounded-xl font-bold hover:bg-red-50 transition"
                                >
                                    ë°ì´í„° ì´ˆê¸°í™” (ë¬¸ì œ í•´ê²°)
                                </button>
                            </div>
                        </div>
                    );
                }

                return this.props.children; 
            }
        }

        // [ë©”ì¸ ì•±]
        function App() {
            // [State] Global & UI
            const [fatalError, setFatalError] = useState(null); // [New] Critical Error State
            // [Auth] Auto Login Check
            const [isLoggedIn, setIsLoggedIn] = useState(() => !!localStorage.getItem('delivery_app_session_driver'));
            const [currentUser, setCurrentUser] = useState(() => localStorage.getItem('delivery_app_session_driver') || null);
            const [adminDriverFilter, setAdminDriverFilter] = useState('all'); // [New] ê´€ë¦¬ììš© ê¸°ì‚¬ í•„í„°
            const [view, setView] = useState('driver');
            const [isTracking, setIsTracking] = useState(false);
            const [deliveries, setDeliveries] = useState([]);
            const [loading, setLoading] = useState(false);
            const [toastMsg, setToastMsg] = useState('');
            const [showMap, setShowMap] = useState(true);

            // [Modal] ì™„ë£Œ ì¶•í•˜ ë©”ì‹œì§€ ìƒíƒœ
            const [showCompletionModal, setShowCompletionModal] = useState(false);
            const [enableCompletionMessage, setEnableCompletionMessage] = useState(() => {
                // Safe initialization
                return StorageManager.get('mvp_enable_completion_msg', true);
            });

            // [Modal] ì‚­ì œ í™•ì¸ ìƒíƒœ
            const [showDeleteModal, setShowDeleteModal] = useState(false);
            const [deleteTarget, setDeleteTarget] = useState(null); // ids to delete

            // [Modal] ê°€ì´ë“œ ëª¨ë‹¬ ìƒíƒœ
            const [showGuideModal, setShowGuideModal] = useState(false);

            // [ê²€ì¦] ë°ì´í„° ê²€ì¦ ë¦¬í¬íŠ¸ ìƒíƒœ
            const [verificationReport, setVerificationReport] = useState(null);
            
            // [ì •ì‚°] ì›”ë³„ ì •ì‚° ìƒíƒœ
            const [settleMonth, setSettleMonth] = useState(new Date().toISOString().slice(0, 7)); // YYYY-MM

            // [ìˆ˜ì •] ë°°ì†¡ ê±´ ìƒì„¸ í¸ì§‘ ìƒíƒœ
            const [editTarget, setEditTarget] = useState(null); // ìˆ˜ì •í•  ëŒ€ìƒ ê°ì²´ (ë³µì‚¬ë³¸)
            const [showEditModal, setShowEditModal] = useState(false);
            const [editTab, setEditTab] = useState('basic'); // basic | cost | history

            // [ê³ ê°ëª©ë¡] ë·° ëª¨ë“œ ë° í•„í„°
            const [customerViewMode, setCustomerViewMode] = useState('daily'); // 'daily' | 'monthly'
            const [customerFilterMonth, setCustomerFilterMonth] = useState(new Date().toISOString().slice(0, 7));
            const [customerFilterDate, setCustomerFilterDate] = useState(new Date().toISOString().slice(0, 10));
            const [customerSearchTerm, setCustomerSearchTerm] = useState(''); // [New] ê²€ìƒ‰ì–´ ìƒíƒœ
            const [showAllDates, setShowAllDates] = useState(false); // [New] ì „ì²´ ë‚ ì§œ ë³´ê¸° í† ê¸€

            // [Cloud] í´ë¼ìš°ë“œ ë™ê¸°í™” ìƒíƒœ
            const [isCloudModalOpen, setCloudModalOpen] = useState(false);
            const [isCloudConnected, setCloudConnected] = useState(false);

            // [Modal] ì›”ë³„ ë¹„ìš© í•©ê³„ ìƒíƒœ
            const [showMonthlyCostModal, setShowMonthlyCostModal] = useState(false);
            const [monthlyCostTargetMonth, setMonthlyCostTargetMonth] = useState(new Date().toISOString().slice(0, 7));
            const [monthlyViewMode, setMonthlyViewMode] = useState('month');
            const [monthlyCostTargetDay, setMonthlyCostTargetDay] = useState(new Date().toISOString().slice(0, 10));

            // [UI] ì—‘ì…€ ì—…ë¡œë“œ íŒŒì¼ëª…
            const [uploadedFileName, setUploadedFileName] = useState('');
            // [UI] í—¤ë” ë©”ë‰´ ìƒíƒœ
            const [showMenu, setShowMenu] = useState(false);
            // [UI] ë°°ì†¡ ì¹´ë“œ ì ‘ê¸°/í¼ì¹˜ê¸° ìƒíƒœ
            const [expandedGroups, setExpandedGroups] = useState({});

            // [New] ê¸°ì‚¬ ì´ë™ ê¸°ëŠ¥ ìƒíƒœ
            const [moveDriverModal, setMoveDriverModal] = useState({ isOpen: false, targetIds: [], currentDriver: '' });
            const [showManualRegister, setShowManualRegister] = useState(false);
            const [moveDriverTarget, setMoveDriverTarget] = useState(''); // ì„ íƒëœ ìƒˆ ê¸°ì‚¬

            // [New] ë°°ì†¡ ê±´ í•©ì¹˜ê¸° ëª¨ë“œ ìƒíƒœ
            const [isMergeMode, setIsMergeMode] = useState(false);
            const [selectedMergeIds, setSelectedMergeIds] = useState([]);
            const [currentOrder, setCurrentOrder] = useState(1);
            
            function mergeSelectedDeliveries() {
                handleMergeDeliveries();
            }

            // [State] History (Undo)
            const [history, setHistory] = useState([]);
            
            // [State] Notice
            const [notice, setNotice] = useState(() => StorageManager.loadNotice());
            
            // [Ref] Remote Update Flag (Infinite Loop Prevention)
            const isRemoteUpdate = useRef(false);

            // [Helper] Add to history
            const pushHistory = (currentData) => {
                setHistory(prev => [...prev.slice(-19), JSON.stringify(currentData)]);
            };

            // [ê¸°ëŠ¥] ë°°ì†¡ ê±´ í•©ì¹˜ê¸° ì‹¤í–‰
            const handleMergeDeliveries = () => {
                if (selectedMergeIds.length < 2) {
                    alert("í•©ì¹  ë°°ì†¡ ê±´ì„ 2ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                
                if (!confirm(`ì„ íƒí•œ ${selectedMergeIds.length}ê°œì˜ ë°°ì†¡ ê±´ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì²« ë²ˆì§¸ ì„ íƒí•œ ê±´ì˜ ì£¼ì†Œì™€ ì „í™”ë²ˆí˜¸ë¡œ í†µí•©ë©ë‹ˆë‹¤)`)) return;

                pushHistory(deliveries); // Undo ì €ì¥

                // 1. ì„ íƒëœ ë°°ì†¡ ê±´ ì°¾ê¸°
                // ìˆœì„œ ë³´ì¥ì„ ìœ„í•´ deliveries ë°°ì—´ ìˆœì„œëŒ€ë¡œ ì •ë ¬
                const targets = deliveries.filter(d => selectedMergeIds.includes(d.id));
                const baseItem = targets[0]; // ê¸°ì¤€ì´ ë  ì²« ë²ˆì§¸ ì•„ì´í…œ
                
                // 2. í†µí•© ë°ì´í„° ìƒì„±
                const mergedItem = {
                    ...baseItem,
                    id: baseItem.id, // ID ìœ ì§€
                    // [New] ë¶„ë¦¬ë¥¼ ìœ„í•œ ì›ë³¸ ë°ì´í„° ì €ì¥ (ê¹Šì€ ë³µì‚¬)
                    _mergedOriginals: JSON.parse(JSON.stringify(targets)),
                    // í’ˆëª© í•©ì¹˜ê¸° (ê¸°ì¡´ detail_itemsê°€ ìˆìœ¼ë©´ ìœ ì§€í•˜ê³ , ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¦)
                    detail_items: targets.flatMap(t => {
                        if (t.detail_items && t.detail_items.length > 0) return t.detail_items;
                        return [{
                            item: t.item,
                            install_fee: t.install_fee || 0,
                            yangjung: t.yangjung || 0,
                            naerim: t.naerim || 0,
                            etc_fee: t.etc_fee || 0,
                            checked: t.checked || false
                        }];
                    }),
                    // ë¹„ìš© í•©ì‚°
                    install_fee: targets.reduce((sum, t) => sum + (t.install_fee || 0), 0),
                    yangjung: targets.reduce((sum, t) => sum + (t.yangjung || 0), 0),
                    naerim: targets.reduce((sum, t) => sum + (t.naerim || 0), 0),
                    etc_fee: targets.reduce((sum, t) => sum + (t.etc_fee || 0), 0),
                    
                    // ëŒ€í‘œ í’ˆëª©ëª… ê°±ì‹ 
                    item: targets.map(t => t.item).join(' + '),
                };

                // 3. ê¸°ì¡´ ëª©ë¡ì—ì„œ ë³‘í•©ëœ ê±´ë“¤ì€ ì œê±°í•˜ê³ , ë³‘í•©ëœ ìƒˆ ê±´(ì‚¬ì‹¤ì€ ì—…ë°ì´íŠ¸ëœ baseItem)ë§Œ ë‚¨ê¹€
                // baseItem ìë¦¬ì— mergedItemì„ ë„£ê³ , ë‚˜ë¨¸ì§€ targetsëŠ” ì œê±°
                const otherIds = selectedMergeIds.filter(id => id !== baseItem.id);
                const newDeliveries = deliveries.map(d => {
                    if (d.id === baseItem.id) return mergedItem;
                    return d;
                }).filter(d => !otherIds.includes(d.id));

                setDeliveries(newDeliveries);
                StorageManager.saveDeliveries(newDeliveries);
                
                // ì´ˆê¸°í™”
                setIsMergeMode(false);
                setSelectedMergeIds([]);
                setToastMsg("ğŸ“¦ ë°°ì†¡ ê±´ì´ ì„±ê³µì ìœ¼ë¡œ í•©ì³ì¡ŒìŠµë‹ˆë‹¤.");
            };

            // [New] ë°°ì†¡ ê±´ ë¶„ë¦¬í•˜ê¸° (Undo Merge)
            const handleSplitDelivery = (mergedId) => {
                if(!confirm("í•©ì³ì§„ ë°°ì†¡ ê±´ì„ ë‹¤ì‹œ ë¶„ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                
                pushHistory(deliveries); // Undo ì €ì¥

                const target = deliveries.find(d => d.id === mergedId);
                if (!target) return;

                // Case 1: ì›ë³¸ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° (ì™„ë²½ ë³µì›)
                if (target._mergedOriginals) {
                    const originals = target._mergedOriginals;
                    const targetIndex = deliveries.findIndex(d => d.id === mergedId);
                    const newDeliveries = [...deliveries];
                    newDeliveries.splice(targetIndex, 1, ...originals);
                    setDeliveries(newDeliveries);
                    StorageManager.saveDeliveries(newDeliveries);
                    setToastMsg("â™»ï¸ ë°°ì†¡ ê±´ì´ ì›ë˜ëŒ€ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } 
                // Case 2: ì›ë³¸ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° (detail_items ê¸°ë°˜ ì¬ìƒì„± - ë ˆê±°ì‹œ ì§€ì›)
                else if (target.detail_items && target.detail_items.length > 0) {
                    const newItems = target.detail_items.map(dt => ({
                        ...target,
                        id: crypto.randomUUID(), // ìƒˆë¡œìš´ ID ë°œê¸‰
                        item: dt.item,
                        install_fee: dt.install_fee || 0,
                        yangjung: dt.yangjung || 0,
                        naerim: dt.naerim || 0,
                        etc_fee: dt.etc_fee || 0,
                        checked: dt.checked || false,
                        detail_items: [], // ìƒì„¸ í’ˆëª© ì´ˆê¸°í™”
                        _mergedOriginals: null // ë³‘í•© ì •ë³´ ì œê±°
                    }));

                    const targetIndex = deliveries.findIndex(d => d.id === mergedId);
                    const newDeliveries = [...deliveries];
                    newDeliveries.splice(targetIndex, 1, ...newItems);
                    setDeliveries(newDeliveries);
                    StorageManager.saveDeliveries(newDeliveries);
                    setToastMsg("â™»ï¸ ë°°ì†¡ ê±´ì´ ê°œë³„ í•­ëª©ìœ¼ë¡œ ë¶„ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } else {
                    alert("ë¶„ë¦¬í•  ìƒì„¸ í’ˆëª© ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            };

            // [Function] Undo
            const handleUndo = () => {
                if (history.length === 0) return;
                const lastState = JSON.parse(history[history.length - 1]);
                setHistory(prev => prev.slice(0, -1));
                setDeliveries(lastState);
                StorageManager.saveDeliveries(lastState);
                setToastMsg("â†©ï¸ ì´ì „ ìƒíƒœë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤.");
            };

            // [Function] ì „í™”ë²ˆí˜¸ ìˆ˜ì •
            const handlePhoneEdit = (ids, newPhone) => {
                if (!newPhone) return;
                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) return { ...d, phone: newPhone };
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            };

            // [New] ê¸°ì‚¬ ì´ë™ ì²˜ë¦¬ í•¨ìˆ˜
            const handleMoveDriverConfirm = () => {
                if (!moveDriverTarget) {
                    alert('ì´ë™í•  ê¸°ì‚¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
                const updated = deliveries.map(d => {
                    if (moveDriverModal.targetIds.includes(d.id)) return { ...d, driver: moveDriverTarget };
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
                setMoveDriverModal({ isOpen: false, targetIds: [], currentDriver: '' });
                setToastMsg(`ğŸšš ${moveDriverTarget} ê¸°ì‚¬ë‹˜ì—ê²Œ ë°°ì†¡ ê±´ì„ ì „ë‹¬í–ˆìŠµë‹ˆë‹¤.`);
            };

            // [Function] ìˆœì„œ ë³€ê²½ (Reorder)
            const handleSequenceChange = (targetIds, newSeqStr) => {
                const newSeq = parseInt(newSeqStr);
                if (isNaN(newSeq) || newSeq < 1) return;

                pushHistory(deliveries); // Save state

                // íƒ€ê²Ÿ ì•„ì´í…œë“¤ì˜ í˜„ì¬ ìˆœì„œ ì°¾ê¸° (ì²« ë²ˆì§¸ ì•„ì´í…œ ê¸°ì¤€)
                const targetItem = deliveries.find(d => targetIds.includes(d.id));
                if (!targetItem) return;
                const oldSeq = targetItem.sequence_number;

                if (oldSeq === newSeq) return;

                const newDeliveries = deliveries.map(d => {
                    // íƒ€ê²Ÿ ê·¸ë£¹ì¸ ê²½ìš° ìƒˆ ìˆœì„œ ë¶€ì—¬
                    if (targetIds.includes(d.id)) {
                        return { ...d, sequence_number: newSeq };
                    }
                    // ì˜í–¥ ë°›ëŠ” ë‹¤ë¥¸ ì•„ì´í…œë“¤ ìˆœì„œ ë°€ê¸°/ë‹¹ê¸°ê¸°
                    // Case 1: ì•„ë˜ë¡œ ì´ë™ (ì˜ˆ: 1 -> 3) => 2, 3ë²ˆì´ 1, 2ë²ˆìœ¼ë¡œ ë‹¹ê²¨ì§ (-1)
                    if (oldSeq < newSeq) {
                        if (d.sequence_number > oldSeq && d.sequence_number <= newSeq) {
                            return { ...d, sequence_number: d.sequence_number - 1 };
                        }
                    }
                    // Case 2: ìœ„ë¡œ ì´ë™ (ì˜ˆ: 3 -> 1) => 1, 2ë²ˆì´ 2, 3ë²ˆìœ¼ë¡œ ë°€ë¦¼ (+1)
                    else {
                        if (d.sequence_number >= newSeq && d.sequence_number < oldSeq) {
                            return { ...d, sequence_number: d.sequence_number + 1 };
                        }
                    }
                    return d;
                });
                
                // ì •ë ¬ ë° ì €ì¥
                newDeliveries.sort((a, b) => a.sequence_number - b.sequence_number);
                setDeliveries(newDeliveries);
                StorageManager.saveDeliveries(newDeliveries);
                // setToastMsg(`ìˆœì„œê°€ ${oldSeq}ë²ˆì—ì„œ ${newSeq}ë²ˆìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            };

            // [ê¸°ëŠ¥] ë°ì´í„° ë°±ì—… (Excel ë‹¤ìš´ë¡œë“œ)
            const handleBackupData = async () => {
                try {
                    if (!window.ExcelJS) {
                        alert("ExcelJS ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    setLoading(true); // ë°±ì—… ì§„í–‰ ì¤‘ í‘œì‹œ

                    const workbook = new ExcelJS.Workbook();
                    
                    // 1. ë°°ì†¡ ë°ì´í„° ì‹œíŠ¸
                    const sheet = workbook.addWorksheet('ë°°ì†¡ëª©ë¡');
                    
                    // [ìˆ˜ì •] ì‚¬ìš©ì ìš”ì²­ ì»¬ëŸ¼ ì ìš©
                    sheet.columns = [
                        { header: 'ë‚ ì§œ', key: 'date', width: 12 },
                        { header: 'ì œí’ˆëª…', key: 'item', width: 30 },
                        { header: 'ì£¼ì†Œ', key: 'address', width: 40 },
                        { header: 'ì—°ë½ì²˜', key: 'phone', width: 15 },
                        { header: 'ê¸°ì‚¬', key: 'driver', width: 10 },
                        { header: 'ìƒíƒœ', key: 'status_text', width: 12 }, // ì •ìƒ/ì—°ê¸°/ì·¨ì†Œ/ë¶€ë¶„/ì™„ë£Œ
                        { header: 'ì„¤ì¹˜ë¹„', key: 'install_fee', width: 10 },
                        { header: 'ì–‘ì¤‘ë¹„', key: 'yangjung', width: 10 },
                        { header: 'ë‚´ë¦¼ë¹„', key: 'naerim', width: 10 },
                        { header: 'ê¸°íƒ€ë¹„ìš©', key: 'etc_fee', width: 10 },
                        { header: 'ë©”ëª¨', key: 'memo', width: 20 },
                        { header: 'ì˜ˆì•½ì‹œê°„', key: 'time', width: 15 },
                        { header: 'ì„¤ì¹˜ì‹œê°„', key: 'duration', width: 10 },
                        { header: 'ìˆœì„œ', key: 'sequence_number', width: 8 },
                        { header: 'í•©ì¹˜ê¸°', key: 'merge_info', width: 15 }
                    ];

                    // [Helper] ë°ì´í„° ì •ì œ: ê¹¨ì§„ ë¬¸ì(ï¿½) ë“±ì„ '_'ë¡œ ì¹˜í™˜
                    const clean = (val) => {
                        if (!val) return '';
                        return String(val).replace(/\uFFFD/g, '_');
                    };

                    deliveries.forEach(d => {
                        // ìƒíƒœ ë¡œì§: ì •ìƒ/ì—°ê¸°/ì·¨ì†Œ/ë¶€ë¶„/ì™„ë£Œ
                        let status = 'ì •ìƒ';
                        if (d.canceled) {
                            status = d.cancel_type === 'ì—°ê¸°' ? 'ì—°ê¸°' : 'ì·¨ì†Œ';
                        } else if (d.completed) {
                            status = 'ì™„ë£Œ';
                        } else if (d.partial) {
                            status = 'ë¶€ë¶„';
                        }

                        // í•©ì¹˜ê¸° ì •ë³´
                        let mergeInfo = '';
                        if (d._mergedOriginals) mergeInfo = 'í•©ì³ì§';
                        else if (d.detail_items && d.detail_items.length > 1) mergeInfo = `ìƒì„¸ ${d.detail_items.length}ê±´`;

                        const row = {
                            date: clean(d.date),
                            item: clean(d.item),
                            address: clean(d.address),
                            phone: clean(d.phone),
                            driver: clean(d.driver),
                            status_text: clean(status),
                            install_fee: d.install_fee || 0,
                            yangjung: d.yangjung || 0,
                            naerim: d.naerim || 0,
                            etc_fee: d.etc_fee || 0,
                            memo: clean(d.memo),
                            time: clean(d.time),
                            duration: d.duration ? `${d.duration}ë¶„` : '',
                            sequence_number: d.sequence_number || '',
                            merge_info: clean(mergeInfo)
                        };

                        sheet.addRow(row);
                    });

                    // 2. ì„¤ì • ë° ê¸°íƒ€ ë°ì´í„° ì‹œíŠ¸ (ìœ ì§€)
                    const metaSheet = workbook.addWorksheet('ì„¤ì •_ë°_ê¸°íƒ€');
                    metaSheet.columns = [{ header: 'Key', key: 'key', width: 20 }, { header: 'Value (JSON)', key: 'value', width: 50 }];
                    
                    metaSheet.addRow({ key: 'notice', value: JSON.stringify(notice) });
                    metaSheet.addRow({ key: 'startPoint', value: JSON.stringify(StorageManager.get('mvp_start_point')) });
                    metaSheet.addRow({ key: 'settings', value: JSON.stringify(StorageManager.get('mvp_settings')) });
                    metaSheet.addRow({ key: 'app_version', value: "2.1" });
                    metaSheet.addRow({ key: 'backup_date', value: new Date().toISOString() });

                    // íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const url = window.URL.createObjectURL(blob);
                    const anchor = document.createElement('a');
                    anchor.href = url;
                    anchor.download = `delivery_backup_${new Date().toISOString().slice(0,10)}.xlsx`;
                    anchor.click();
                    window.URL.revokeObjectURL(url);
                    
                    setShowMenu(false);
                    setLoading(false);
                    setToastMsg("ğŸ“Š ì—‘ì…€ ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) {
                    console.error("Backup failed", e);
                    alert("ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message);
                    setLoading(false);
                }
            };

            // [ê¸°ëŠ¥] ì£¼ì†Œ ì„¤ì • í•¸ë“¤ëŸ¬ (ì¶œë°œì§€ + ë„ì°©ì§€)
            const handleUpdateStartPoint = async () => {
                setShowMenu(false);
                const currentAddr = startPoint ? startPoint.address : "";
                const addr = prompt("ìƒˆë¡œìš´ ì¶œë°œì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", currentAddr);
                if (!addr || addr === currentAddr) return;
                
                try {
                    setLoading(true);
                    // Strict Mode: ì •í™•í•œ ì¢Œí‘œë¥¼ ëª» ì°¾ìœ¼ë©´ Fallback(ì‹œì²­ ì¢Œí‘œ) ëŒ€ì‹  null ë°˜í™˜
                    const coords = await geocodeAddress(addr, true);
                    if (coords) {
                        const newPoint = { address: addr, lat: coords.lat, lng: coords.lng };
                        setStartPoint(newPoint);
                        StorageManager.set('mvp_start_point', newPoint);
                        
                        // [ë³€ê²½] ë„ì°©ì§€(í™ˆ) ì„¤ì • ë¡œì§ í†µí•©
                        if(confirm("ë„ì°©ì§€(í™ˆ)ë„ í•¨ê»˜ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                            const currentEndAddr = endPoint ? endPoint.address : "";
                            const endAddr = prompt("ë„ì°©ì§€(í™ˆ) ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", currentEndAddr || addr);
                            if (endAddr) {
                                const endCoords = await geocodeAddress(endAddr, true);
                                if (endCoords) {
                                    const newEndPoint = { address: endAddr, lat: endCoords.lat, lng: endCoords.lng, type: 'destination' };
                                    setEndPoint(newEndPoint);
                                    StorageManager.set('mvp_end_point', newEndPoint);
                                } else {
                                    alert("ë„ì°©ì§€ ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                                }
                            }
                        }
                    } else {
                        alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në„ë¡œëª… ì£¼ì†Œì™€ ê±´ë¬¼ë²ˆí˜¸ë¥¼ í¬í•¨í•˜ì—¬ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    }
                } catch(e) {
                    console.error(e);
                    alert("ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    setLoading(false);
                }
            };

            // [PWA] Install Prompt Logic
            const [deferredPrompt, setDeferredPrompt] = useState(null);
            
            useEffect(() => {
                const handler = (e) => {
                    e.preventDefault();
                    setDeferredPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstallApp = async () => {
                if (!deferredPrompt) {
                    alert("ì•„ì´í°(Safari) ë˜ëŠ” ì¼ë¶€ ë¸Œë¼ìš°ì €ëŠ” ìˆ˜ë™ ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n\n[ì•„ì´í°]\ní•˜ë‹¨ ê³µìœ  ë²„íŠ¼(â†‘) > 'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ\n\n[ì•ˆë“œë¡œì´ë“œ]\në¸Œë¼ìš°ì € ë©”ë‰´(â‹®) > 'ì•± ì„¤ì¹˜' ë˜ëŠ” 'í™ˆ í™”ë©´ì— ì¶”ê°€' ì„ íƒ");
                    return;
                }
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    setDeferredPrompt(null);
                }
            };

            const handleUpdateEndPoint = async () => {
                setShowMenu(false);
                const currentAddr = endPoint ? endPoint.address : "";
                const addr = prompt("ìƒˆë¡œìš´ ë„ì°©ì§€(í™ˆ) ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", currentAddr);
                if (!addr || addr === currentAddr) return;
                
                try {
                    setLoading(true);
                    // Strict Mode ì‚¬ìš©
                    const coords = await geocodeAddress(addr, true);
                    if (coords) {
                        const newPoint = { address: addr, lat: coords.lat, lng: coords.lng, type: 'destination' };
                        setEndPoint(newPoint);
                        
                        // [ë³€ê²½] ê¸°ì‚¬ë³„ ë„ì°©ì§€ ë¶„ë¦¬ ì €ì¥
                        const key = currentUser ? `mvp_end_point_${currentUser}` : 'mvp_end_point';
                        StorageManager.set(key, newPoint);
                        // StorageManager.set('mvp_end_point', newPoint); // Deprecated common key
                        
                        // alert("ë„ì°©ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në„ë¡œëª… ì£¼ì†Œì™€ ê±´ë¬¼ë²ˆí˜¸ë¥¼ í¬í•¨í•˜ì—¬ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    }
                } catch(e) {
                    console.error(e);
                    alert("ì£¼ì†Œ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    setLoading(false);
                }
            };

            // [New] Data Initialization & Sync Strategy
            useEffect(() => {
                const initializeData = async () => {
                    console.log("ğŸš€ Initializing Data...");

                    // 1. Load Local Data First (Instant UI)
                    let currentData = StorageManager.loadDeliveries();
                    if (currentData && currentData.length > 0) {
                        setDeliveries(currentData);
                    } else {
                        currentData = [];
                    }

                    // 2. Initialize Cloud & Sync
                    const params = new URLSearchParams(window.location.search);
                    const configUrl = params.get('config_url');
                    const configKey = params.get('config_key');
                    
                    let initialized = false;

                    if (configUrl && configKey) {
                        try {
                            let fixedUrl = configUrl.trim();
                            if (!fixedUrl.startsWith('http://') && !fixedUrl.startsWith('https://')) {
                                fixedUrl = 'https://' + fixedUrl;
                            }

                            if (CloudManager.init(fixedUrl, configKey)) {
                                StorageManager.set('mvp_supabase_config', { url: fixedUrl, key: configKey });
                                initialized = true;
                                setCloudConnected(true);
                                alert("âœ… ì„œë²„ ì„¤ì •ì´ ìë™ìœ¼ë¡œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!");
                                const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
                                window.history.replaceState({path: newUrl}, '', newUrl);
                            }
                        } catch(e) {
                            console.error("Auto Config Failed", e);
                        }
                    } 
                    
                    if (!initialized) {
                        const config = StorageManager.get('mvp_supabase_config');
                        if (config && config.url && config.key) {
                            initialized = CloudManager.init(config.url, config.key);
                        } else if (Config.SUPABASE_URL && !Config.SUPABASE_URL.includes("YOUR_")) {
                             initialized = CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
                        }
                        setCloudConnected(initialized);
                    }

                    if (initialized) {
                        try {
                            // ê³µì§€ì‚¬í•­ ë™ê¸°í™”
                            const serverNotice = await CloudManager.pullNotice();
                            if (serverNotice) {
                                setNotice(serverNotice);
                                StorageManager.saveNotice(serverNotice);
                            }

                            // ë°ì´í„° ë™ê¸°í™” (The Truth)
                            const serverData = await CloudManager.pull();
                            if (serverData && Array.isArray(serverData)) {
                                console.log("â˜ï¸ Initial Sync from Supabase:", serverData.length);
                                if (JSON.stringify(currentData) !== JSON.stringify(serverData)) {
                                    currentData = serverData; // Update reference for Smart Date
                                    setDeliveries(serverData);
                                    localStorage.setItem(Config.STORAGE_KEYS.DELIVERIES, JSON.stringify(serverData));
                                    setToastMsg("â˜ï¸ ìµœì‹  ë°°ì†¡ ì •ë³´ë¥¼ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                                }
                            }
                        } catch (e) {
                            console.warn("Initial Cloud Pull Failed", e);
                        }
                    }

                    // 3. Smart Date Logic
                    if (Array.isArray(currentData) && currentData.length > 0) {
                        let relevantData = currentData;
                        const savedDriver = localStorage.getItem('delivery_app_session_driver');
                        if (savedDriver && savedDriver !== 'admin') {
                            const myData = currentData.filter(d => d.driver === savedDriver);
                            if (myData.length > 0) relevantData = myData;
                        }

                        const availableDates = [...new Set(relevantData.map(d => d.date))].sort().reverse();
                        const today = getLocalDateString();
                        
                        if (!availableDates.includes(today) && availableDates.length > 0) {
                            console.log(`[Smart Date] Auto-switching to ${availableDates[0]}`);
                            setForm(prev => ({ ...prev, date: availableDates[0] }));
                        }
                    }

                    // 4. Load Settings (Start/End Points)
                    // Start Point
                    let start = StorageManager.get('mvp_start_point');
                    if (!start) {
                        start = { ...Config.FIXED_START };
                        // Fallback Geocoding omitted for speed
                        StorageManager.set('mvp_start_point', start);
                    }
                    setStartPoint(start);

                    // End Point
                    const sessionDriver = localStorage.getItem('delivery_app_session_driver');
                    const endKey = sessionDriver ? `mvp_end_point_${sessionDriver}` : 'mvp_end_point';
                    let end = StorageManager.get(endKey);
                    if (end && end.type !== 'destination') {
                        end = { ...end, type: 'destination' };
                    }
                    setEndPoint(end);

                    // Notice
                    const savedNotice = StorageManager.get('mvp_notice', '');
                    if (!notice && savedNotice) setNotice(savedNotice);

                    console.log("âœ… Initialization Complete");
                };

                initializeData();
            }, []);

            // [Cloud] ë™ê¸°í™” í•¸ë“¤ëŸ¬
            const handleCloudSync = async (direction) => {
                if (!isCloudConnected) {
                    // ì—°ê²° ì•ˆë¨ -> ì¦‰ì‹œ ì„¤ì • ëª¨ë‹¬ ì˜¤í”ˆ (Alert ì œê±°)
                    setCloudModalOpen(true);
                    return;
                }

                try {
                    setLoading(true);
                    if (direction === 'push') {
                        if (confirm("í˜„ì¬ ë°ì´í„°ë¥¼ ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì„œë²„ì˜ ê¸°ì¡´ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)")) {
                            await Promise.all([
                                CloudManager.push(deliveries),
                                CloudManager.pushNotice(notice)
                            ]);
                            alert("â˜ï¸ ì„œë²„ì— ì•ˆì „í•˜ê²Œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        }
                    } else if (direction === 'pull') {
                        if (confirm("ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? (í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì€ ì‚¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤)")) {
                            const [data, serverNotice] = await Promise.all([
                                CloudManager.pull(),
                                CloudManager.pullNotice()
                            ]);
                            
                            if (data) {
                                setDeliveries(data);
                                StorageManager.saveDeliveries(data);
                                
                                if (serverNotice) {
                                    setNotice(serverNotice);
                                    StorageManager.saveNotice(serverNotice);
                                }
                                
                                alert("â˜ï¸ ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                            } else {
                                alert("ì„œë²„ì— ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                            }
                        }
                    }
                } catch (e) {
                    console.error(e);
                    alert(`ì˜¤ë¥˜ ë°œìƒ: ${e.message}`);
                } finally {
                    setLoading(false);
                }
            };

            // [ê¸°ëŠ¥] ê³µì§€ì‚¬í•­ ì €ì¥
            const handleNoticeSave = async (newNotice) => {
                setNotice(newNotice);
                StorageManager.saveNotice(newNotice);
                
                // í´ë¼ìš°ë“œ ë™ê¸°í™” (ê´€ë¦¬ìê°€ ì €ì¥í•˜ë©´ ì¦‰ì‹œ ì„œë²„ë¡œ ì „ì†¡)
                if (CloudManager.client) {
                    await CloudManager.pushNotice(newNotice);
                }

                setToastMsg("ğŸ“¢ ê³µì§€ì‚¬í•­ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            // [ê¸°ëŠ¥] ê³ ê° ë°°ë‹¬ ì™„ë£Œ ë‚´ì—­ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            async function downloadCustomerExcel() {
                const targetMonth = customerFilterMonth;
                // [Server Validation Simulation] ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
                const filtered = deliveries.filter(d => String(d.date || '').startsWith(targetMonth));
                
                if (filtered.length === 0) {
                    alert("ì„ íƒí•œ ì›”ì— ë°°ë‹¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                try {
                    const workbook = new ExcelJS.Workbook();
                    const sheet = workbook.addWorksheet('ë°°ì†¡í˜„í™©');
                    
                    sheet.columns = [
                        { header: 'ìƒíƒœ', key: 'status', width: 10 },
                        { header: 'ë°°ì†¡ì¼', key: 'date', width: 15 },
                        { header: 'ì£¼ë¬¸ë²ˆí˜¸', key: 'order_number', width: 15 }, // [New]
                        { header: 'ì†¡ì¥ë²ˆí˜¸', key: 'invoice_number', width: 15 }, // [New]
                        { header: 'ê³ ê°ëª…(ìƒí’ˆëª…)', key: 'item', width: 30 },
                        { header: 'ì „í™”ë²ˆí˜¸', key: 'phone', width: 15 },
                        { header: 'ì£¼ì†Œ', key: 'address', width: 40 },
                        { header: 'ì„¼í„°', key: 'center', width: 10 }, // [New]
                        { header: 'ì§€ì—­', key: 'region', width: 10 }, // [New]
                        { header: 'ë‹´ë‹¹ê¸°ì‚¬', key: 'driver', width: 10 }, // [New]
                        { header: 'ì„¤ì¹˜ë¹„', key: 'install_fee', width: 12 },
                        { header: 'ì–‘ì¤‘ë¹„', key: 'yangjung', width: 12 },
                        { header: 'ë‚´ë¦¼ë¹„', key: 'naerim', width: 12 },
                        { header: 'ê¸°íƒ€ë¹„ìš©', key: 'etc_fee', width: 12 },
                        { header: 'ë©”ëª¨', key: 'memo', width: 30 },
                    ];
                    
                    // ìŠ¤íƒ€ì¼
                    sheet.getRow(1).font = { bold: true };
                    sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
                    
                    // ë°ì´í„° ì¶”ê°€
                    filtered.forEach(d => {
                        let status = 'ëŒ€ê¸°';
                        if (d.completed) status = 'ì™„ë£Œ';
                        else if (d.partial) status = 'ë¶€ë¶„';
                        else if (d.canceled) {
                            status = d.cancel_type === 'postpone' ? 'ì—°ê¸°' : 'ì·¨ì†Œ';
                        }

                        sheet.addRow({
                            status: status,
                            date: d.date,
                            order_number: d.order_number || '', // [New]
                            invoice_number: d.invoice_number || '', // [New]
                            item: d.item,
                            phone: d.phone,
                            address: d.address,
                            center: d.center || '', // [New]
                            region: d.region || '', // [New]
                            driver: d.driver || '', // [New]
                            install_fee: d.install_fee || 0,
                            yangjung: d.yangjung || 0,
                            naerim: d.naerim || 0,
                            etc_fee: d.etc_fee || 0,
                            memo: d.memo || ''
                        });
                    });

                    // ìˆ«ì í¬ë§·
                    ['install_fee', 'yangjung', 'naerim', 'etc_fee'].forEach(key => {
                        sheet.getColumn(key).numFmt = '#,##0';
                    });

                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `ë°°ì†¡í˜„í™©_${targetMonth.replace('-', '')}.xlsx`;
                    a.click();
                } catch(e) {
                    console.error(e);
                    alert("ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }

            // [New] ê¸°ì‚¬ë³„ ë„ì°©ì§€(EndPoint) ë¡œë“œ
            useEffect(() => {
                if (view === 'driver' && currentUser) {
                    const key = `mvp_end_point_${currentUser}`;
                    let end = StorageManager.get(key);
                    
                    if (end && end.type !== 'destination') {
                        end = { ...end, type: 'destination' };
                    }
                    setEndPoint(end || null);
                }
            }, [currentUser, view]);

            // [New] ê¸°ì‚¬ ëª¨ë“œ ì§„ì… ì‹œ ë„ì°©ì§€ ë¯¸ì„¤ì • ì•Œë¦¼ (ì‚­ì œë¨ - ì‚¬ìš©ì ìš”ì²­)
            /*
            useEffect(() => {
                // [Fix] ë¡œê·¸ì¸ ìƒíƒœ(isLoggedIn)ì¼ ë•Œë§Œ ì•Œë¦¼ í‘œì‹œ
                if (isLoggedIn && view === 'driver' && !loading && !endPoint && !fatalError) {
                    const timer = setTimeout(() => {
                        // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ë¥¼ ìœ„í•´ í™•ì¸
                        const key = currentUser ? `mvp_end_point_${currentUser}` : 'mvp_end_point';
                        const currentEnd = StorageManager.get(key);
                        if (!currentEnd) {
                            if(confirm("ë„ì°©ì§€(í™ˆ)ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\ní‡´ê·¼ ê²½ë¡œ ìµœì í™”ë¥¼ ìœ„í•´ ë„ì°©ì§€ë¥¼ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                                handleUpdateEndPoint();
                            }
                        }
                    }, 1500); // 1.5ì´ˆ ë”œë ˆì´
                    return () => clearTimeout(timer);
                }
            }, [view, loading, endPoint, currentUser, isLoggedIn]);
            */

            // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìë™ ìˆ¨ê¹€
            useEffect(() => {
                if (toastMsg) {
                    const timer = setTimeout(() => setToastMsg(''), 3000);
                    return () => clearTimeout(timer);
                }
            }, [toastMsg]);

            // [Speed Fix] ë°±ê·¸ë¼ìš´ë“œ ì§€ì˜¤ì½”ë”© ì²˜ë¦¬
            // needsGeocoding í”Œë˜ê·¸ê°€ ìˆëŠ” í•­ëª©ì„ ì°¾ì•„ ìˆœì°¨ì ìœ¼ë¡œ ì¢Œí‘œ ë³€í™˜
            useEffect(() => {
                const processGeocoding = async () => {
                    const pending = deliveries.filter(d => d.needsGeocoding);
                    if (pending.length === 0) return;

                    // í•œ ë²ˆì— í•˜ë‚˜ì”© ì²˜ë¦¬ (API ì œí•œ ê³ ë ¤)
                    const target = pending[0];
                    // console.log(`[Background Geocoding] Processing: ${target.address}`);
                    
                    try {
                        const coords = await geocodeAddress(target.address);
                        if (coords) {
                            // ì„±ê³µ ì‹œ ì—…ë°ì´íŠ¸
                            setDeliveries(prev => prev.map(d => 
                                d.id === target.id ? { ...d, ...coords, needsGeocoding: false } : d
                            ));
                            // *ì£¼ì˜: ì—¬ê¸°ì„œ ì €ì¥í•˜ë©´ ë„ˆë¬´ ì¦ì€ ì“°ê¸°ê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ.
                            // í•˜ì§€ë§Œ React state ì—…ë°ì´íŠ¸ê°€ ë¹„ë™ê¸°ì´ë¯€ë¡œ, 
                            // ì‹¤ì œë¡œëŠ” ë Œë”ë§ ì‚¬ì´í´ì— ë”°ë¼ ë°°ì¹˜ ì²˜ë¦¬ë  ê°€ëŠ¥ì„±ì´ ë†’ìŒ.
                            // ì•ˆì „ì„ ìœ„í•´ ë³€ê²½ëœ ì „ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ ì €ì¥í•˜ëŠ” ë¡œì§ì€ setDeliveries ë‚´ë¶€ ë¡œì§ì´ë‚˜ ë³„ë„ effectë¡œ ìœ„ì„í•˜ëŠ” ê²ƒì´ ì¢‹ìœ¼ë‚˜,
                            // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ì§ì ‘ ì €ì¥í•˜ì§€ ì•Šê³  setDeliveriesë§Œ í˜¸ì¶œ (App ì»´í¬ë„ŒíŠ¸ êµ¬ì¡°ìƒ state ë³€ê²½ ì‹œ ìë™ ì €ì¥ì´ ì—†ë‹¤ë©´ ì¶”ê°€ í•„ìš”)
                        } else {
                            // ì‹¤íŒ¨ ì‹œì—ë„ í”Œë˜ê·¸ ì œê±°í•˜ì—¬ ë¬´í•œ ë£¨í”„ ë°©ì§€ (ë˜ëŠ” ì¬ì‹œë„ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥)
                            setDeliveries(prev => prev.map(d => 
                                d.id === target.id ? { ...d, needsGeocoding: false } : d
                            ));
                        }
                    } catch (e) {
                        console.error("Geocoding failed", e);
                        // ì—ëŸ¬ ë°œìƒ ì‹œ í•´ë‹¹ í•­ëª© ê±´ë„ˆë›°ê¸°
                        setDeliveries(prev => prev.map(d => 
                            d.id === target.id ? { ...d, needsGeocoding: false } : d
                        ));
                    }
                };

                // 1ì´ˆ ë”œë ˆì´ í›„ ì‹¤í–‰ (UI ë Œë”ë§ ìš°ì„ )
                const timer = setTimeout(processGeocoding, 1000);
                return () => clearTimeout(timer);
            }, [deliveries]);

            // [Auto Save] deliveries ë³€ê²½ ì‹œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ë° ì„œë²„ ë™ê¸°í™”
            useEffect(() => {
                if (isRemoteUpdate.current) {
                    console.log('[AutoSave] Skipped cloud push due to remote update');
                    localStorage.setItem(Config.STORAGE_KEYS.DELIVERIES, JSON.stringify(deliveries));
                    isRemoteUpdate.current = false;
                    return;
                }

                if (deliveries.length > 0) {
                    StorageManager.saveDeliveries(deliveries);
                }
            }, [deliveries]);

            // [New] Realtime Subscription (Server -> Client)
            useEffect(() => {
                let channel = null;

                const initAndSubscribe = () => {
                    // Ensure connection
                    if (!CloudManager.isConnected) {
                        CloudManager.init(Config.SUPABASE_URL, Config.SUPABASE_KEY);
                    }
                    
                    if (CloudManager.isConnected && CloudManager.client) {
                        console.log('[Realtime] Subscribing to delivery_sync...');
                        channel = CloudManager.client
                            .channel('public:delivery_sync')
                            .on('postgres_changes', 
                                { event: '*', schema: 'public', table: 'delivery_sync' }, 
                                (payload) => {
                                    if (payload.new && payload.new.id === 'master') {
                                        const serverData = payload.new.data;
                                        if (Array.isArray(serverData)) {
                                            setDeliveries(prev => {
                                                const currentStr = JSON.stringify(prev);
                                                const serverStr = JSON.stringify(serverData);
                                                if (currentStr !== serverStr) {
                                                    console.log('[Realtime] Syncing from server...');
                                                    isRemoteUpdate.current = true;
                                                    setToastMsg("â˜ï¸ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¨");
                                                    return serverData;
                                                }
                                                return prev;
                                            });
                                        }
                                    }
                                }
                            )
                            .subscribe();
                    }
                };

                initAndSubscribe();

                return () => {
                    if (channel && CloudManager.client) CloudManager.client.removeChannel(channel);
                };
            }, []);
            
            // [Helper] Local Date String (KST Support)
            const getLocalDateString = () => {
                const d = new Date();
                const offset = d.getTimezoneOffset() * 60000;
                return new Date(d.getTime() - offset).toISOString().split('T')[0];
            };

            // ìƒíƒœ: ì¶œë°œì§€, ë„ì°©ì§€, ë‚ ì§œ
            const [startPoint, setStartPoint] = useState(null); // { lat, lng, address }
            const [endPoint, setEndPoint] = useState(null); // { lat, lng, address }
            const [targetDate, setTargetDate] = useState(parseCustomDate(null));

            // ì…ë ¥ í¼
            const [form, setForm] = useState({ 
                date: getLocalDateString(), 
                item: '', 
                phone: '', 
                address: '', 
                install_fee: 0,
                yangjung: 0,
                naerim: 0,
                etc_fee: 0,
                reservationDate: '',
                reservationTime: '',
                isInstallNeeded: false,
                installTime: '',
                memo: ''
            });

            // [Expansion 3] ì‹¤ì‹œê°„ ìœ„ì¹˜ ì¶”ì  ë¡œì§ (Always On in Background)
            useEffect(() => {
                let watchId;
                // Driver ëª¨ë“œì¼ ë•Œ í•­ìƒ ì‘ë™ (MVP: isTracking ìƒíƒœ ì˜ì¡´ì„± ì œê±° ë° ê¸°ë³¸ í™œì„±í™”)
                if (view === 'driver') {
                    watchId = navigator.geolocation.watchPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            // console.log(`[Tracking] Location Update: ${latitude}, ${longitude}`); // Log noise reduction
                            // ë°±ì—”ë“œ ì „ì†¡ ì‹œë®¬ë ˆì´ì…˜
                        },
                        (error) => console.error(error),
                        { enableHighAccuracy: true }
                    );
                }
                return () => { if(watchId) navigator.geolocation.clearWatch(watchId); };
            }, [view]);

            // [Initial Data Load] Unified & Safe
            useEffect(() => {
                async function loadData() {
                    try {
                        console.log("ğŸš€ Initializing Data...");
                        
                        // 1. Load Deliveries
                        let data = StorageManager.loadDeliveries();
                        
                        // [New] Server Sync (Mobile Support) - PCì—ì„œ ì—…ë¡œë“œí•œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        try {
                            const serverData = await StorageManager.syncFromServer();
                            if (serverData && Array.isArray(serverData) && serverData.length > 0) {
                                console.log(`[Sync] Server data applied: ${serverData.length} items`);
                                data = serverData;
                            }
                        } catch (err) {
                            console.warn("[Sync] Server sync skipped", err);
                        }

                        // [New] Supabase Sync (Cross-Network Support) - ë‹¤ë¥¸ ì™€ì´íŒŒì´ ê¸°ì‚¬ ì§€ì›
                        if (CloudManager.isConnected) {
                            try {
                                const cloudData = await CloudManager.pull();
                                if (cloudData && Array.isArray(cloudData) && cloudData.length > 0) {
                                    console.log(`[Sync] Supabase data applied: ${cloudData.length} items`);
                                    data = cloudData; // Cloud data overrides local server data (assumed fresher/more accessible)
                                }
                            } catch (err) {
                                console.warn("[Sync] Supabase sync failed", err);
                            }
                        }
                        
                        // [ì•ˆì „ì¥ì¹˜] ë°ì´í„° ì •ê·œí™” (ë‚ ì§œ í•„ë“œ ë¬¸ìì—´ ë³´ì¥)
                        if (Array.isArray(data)) {
                            data = data.map(d => ({
                                ...d,
                                date: typeof d.date === 'string' ? d.date : String(d.date || getLocalDateString())
                            }));
                        }

                        // [Cloud] í´ë¼ìš°ë“œ ì—°ê²° ì‹œ ìë™ ë™ê¸°í™” (ì˜µì…˜) - í˜„ì¬ëŠ” ìˆ˜ë™ ë™ê¸°í™” ê¶Œì¥
                        setDeliveries(Array.isArray(data) ? data : []);

                        // [Smart Date] ë°ì´í„°ê°€ ìˆëŠ” ìµœì‹  ë‚ ì§œë¡œ ìë™ ì´ë™
                        if (Array.isArray(data) && data.length > 0) {
                            // [Fix] ê¸°ì‚¬ ëª¨ë“œì¸ ê²½ìš°, ë³¸ì¸ì—ê²Œ ë°°ì •ëœ ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œ ìš°ì„ 
                            let relevantData = data;
                            const savedDriver = localStorage.getItem('delivery_app_session_driver'); // Closure safe
                            if (savedDriver && savedDriver !== 'admin') {
                                const myData = data.filter(d => d.driver === savedDriver);
                                if (myData.length > 0) relevantData = myData;
                            }

                            const availableDates = [...new Set(relevantData.map(d => d.date))].sort().reverse();
                            const today = getLocalDateString();
                            
                            // [Smart Date V2] ë°ì´í„° ìë™ ì´ë™ ë¡œì§ ê°œì„ 
                            // 1. ì˜¤ëŠ˜ ë‚ ì§œì— (ë‚˜ì˜) ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€ (ìš°ì„ ìˆœìœ„ 1)
                            if (availableDates.includes(today)) {
                                // Stay on today
                            } else if (availableDates.length > 0) {
                                // 2. ì˜¤ëŠ˜ ë°ì´í„°ê°€ ì—†ìœ¼ë©´, ê°€ì¥ ìµœì‹  ë°ì´í„° ë‚ ì§œë¡œ ì´ë™ (ê³¼ê±° ê¸°ë¡ í™•ì¸)
                                // ì‚¬ìš©ì ìš”ì²­: ë¯¸ì™„ë£Œ ì—…ë¬´ ìš°ì„  í‘œì‹œ ë¡œì§ ì œê±° -> ë‹¨ìˆœ ìµœì‹  ë‚ ì§œ ì´ë™
                                console.log(`[Smart Date] Auto-switching to ${availableDates[0]} (Latest data)`);
                                setForm(prev => ({ ...prev, date: availableDates[0] }));
                            }
                        }

                        // 2. Load Start Point
                        let start = StorageManager.get('mvp_start_point');
                        if (!start) {
                            start = { ...Config.FIXED_START };
                            try {
                                const coords = await geocodeAddress(Config.FIXED_START.address);
                                if (coords && (coords.lat !== 37.5665 || coords.lng !== 126.9780)) {
                                     start = { ...coords, address: Config.FIXED_START.address };
                                }
                            } catch(e) { console.warn("Start point geocoding fallback"); }
                            StorageManager.set('mvp_start_point', start);
                        }
                        setStartPoint(start);

                        // 3. Load End Point
                        const sessionDriver = localStorage.getItem('delivery_app_session_driver');
                        const endKey = sessionDriver ? `mvp_end_point_${sessionDriver}` : 'mvp_end_point';
                        let end = StorageManager.get(endKey);
                        
                        // [ë³€ê²½] ë„ì°©ì§€ ìë™ ì„¤ì • í•´ì œ (User Request)
                        // ê¸°ì‚¬ê°€ ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ì§ì ‘ ì„¤ì •í•˜ë„ë¡ ìœ ë„í•˜ê¸° ìœ„í•´ ê¸°ë³¸ê°’(FIXED_END) ì ìš© ë¡œì§ ì œê±°
                        
                        // [Safety] ê¸°ì¡´ ë°ì´í„°ì— typeì´ ì—†ëŠ” ê²½ìš° ë³´ì •
                        if (end && end.type !== 'destination') {
                            end = { ...end, type: 'destination' };
                        }
                        setEndPoint(end);
                        
                        // 4. Load Notice
                        const savedNotice = StorageManager.get('mvp_notice', '');
                        setNotice(savedNotice);
                        
                        console.log("âœ… Initialization Complete - Refactored & Verified");

                    } catch (e) {
                        console.error("Critical Data Loading Error", e);
                        setFatalError({ message: e.message || "Failed to load application data." });
                    }
                }
                loadData();
            }, []);

            // [New] Driver Change Mode State
            const [isDriverChangeMode, setIsDriverChangeMode] = useState(false);
            const [selectedDriverChangeIds, setSelectedDriverChangeIds] = useState(new Set());

            const toggleDriverSelection = (ids) => {
                const newSet = new Set(selectedDriverChangeIds);
                const allSelected = ids.every(id => newSet.has(id));
                
                if (allSelected) {
                    ids.forEach(id => newSet.delete(id));
                } else {
                    ids.forEach(id => newSet.add(id));
                }
                setSelectedDriverChangeIds(newSet);
            };

            const handleBatchDriverChange = () => {
                 if (selectedDriverChangeIds.size === 0) {
                    alert('ê¸°ì‚¬ë¥¼ ë³€ê²½í•  ë°°ì†¡ ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const newName = prompt('ì„ íƒí•œ ë°°ì†¡ ê±´ì˜ ë‹´ë‹¹ ê¸°ì‚¬ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:', currentUser);
                if (!newName || newName.trim() === '') return;

                if (confirm(`ì„ íƒí•œ ${selectedDriverChangeIds.size}ê±´ì˜ ë‹´ë‹¹ ê¸°ì‚¬ë¥¼ '${newName}'(ìœ¼)ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    const updated = deliveries.map(d => {
                        if (selectedDriverChangeIds.has(d.id)) {
                            return { ...d, driver: newName };
                        }
                        return d;
                    });

                    setDeliveries(updated);
                    StorageManager.saveDeliveries(updated);
                    setIsDriverChangeMode(false);
                    setSelectedDriverChangeIds(new Set());
                    setToastMsg(`ğŸšš ë‹´ë‹¹ ê¸°ì‚¬ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    
                    // ë§Œì•½ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ ë³¸ì¸ì˜ ë°°ì†¡ ê±´ì„ ë‹¤ë¥¸ ì‚¬ëŒì—ê²Œ ë„˜ê²¼ë‹¤ë©´,
                    // í™”ë©´ ê°±ì‹ ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ (ì´ë¯¸ ë¦¬ì•¡íŠ¸ ìƒíƒœ ë³€ê²½ìœ¼ë¡œ ì²˜ë¦¬ë¨)
                }
            };

            // [Sync] Form Date -> Target Date (Dashboard Date Filter)
            useEffect(() => {
                setTargetDate(form.date);
            }, [form.date]);

            // [Render] Fatal Error Screen
            if (fatalError) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4 bg-red-600 text-white font-sans">
                        <div className="max-w-md w-full bg-white text-red-600 rounded-xl shadow-2xl p-8 text-center">
                            <h1 className="text-3xl font-bold mb-4">Critical Error</h1>
                            <p className="mb-6 text-gray-700 break-words">{fatalError.message}</p>
                            <button onClick={() => { StorageManager.clearAll(); window.location.reload(); }} 
                                    className="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition shadow-lg">
                                Full Reset & Reload
                            </button>
                        </div>
                    </div>
                );
            }



            // [ë¡œì§] ë°ì´í„° ê·¸ë£¹í™” ë° ì •ë ¬ (Active/Inactive ë¶„ë¦¬ + Active ê±°ë¦¬ìˆœ ì •ë ¬)
            const groupedDeliveries = useMemo(() => {
                // 1. ë‚ ì§œ í•„í„°ë§ ë° ê¶Œí•œ í•„í„°ë§ (ê´€ë¦¬ìëŠ” ì „ì²´, ê¸°ì‚¬ëŠ” ë³¸ì¸ ë°°ì • ê±´ë§Œ)
                const filtered = deliveries.filter(d => {
                    // [Fix] targetDateê°€ 'all'ì´ë©´ ë‚ ì§œ í•„í„° ë¬´ì‹œ
                    // [New] 'ì „ì²´ ë‚ ì§œ ë³´ê¸°' ì²´í¬ ì‹œ ë‚ ì§œ í•„í„° ë¬´ì‹œ
                    const dateMatch = showAllDates || targetDate === 'all' || d.date === targetDate;
                    
                    let driverMatch = true;
                    if (currentUser === 'admin' || view === 'admin') { // [Fix] ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œë„ ì „ì²´ ì¡°íšŒ ê¶Œí•œ ë¶€ì—¬
                        // ê´€ë¦¬ì: í•„í„° ìƒíƒœì— ë”°ë¼ ì¡°íšŒ
                        if (adminDriverFilter === 'all') driverMatch = true;
                        else if (adminDriverFilter === 'unassigned') driverMatch = !d.driver;
                        else driverMatch = d.driver === adminDriverFilter;
                    } else {
                        // ê¸°ì‚¬: ë³¸ì¸ ë°°ì • ê±´ë§Œ ì¡°íšŒ (ì—„ê²© ëª¨ë“œ)
                        driverMatch = (d.driver && d.driver === currentUser);
                    }
                    
                    return dateMatch && driverMatch;
                });
                
                // 2. ì£¼ì†Œ(ì¢Œí‘œ) + ì „í™”ë²ˆí˜¸ ê¸°ì¤€ ê·¸ë£¹í™” (ë™ì¼ ì¥ì†Œë¼ë„ ì—°ë½ì²˜ ë‹¤ë¥´ë©´ ë³„ë„ ë°°ì†¡)
                const groups = {};
                filtered.forEach(d => {
                    const isDefault = d.lat === 37.5665 && d.lng === 126.9780;
                    // ì¢Œí‘œ/ì£¼ì†Œ + ì „í™”ë²ˆí˜¸ë¡œ ìœ ë‹ˆí¬ í‚¤ ìƒì„±
                    const key = isDefault 
                        ? `${d.address.trim()}_${d.phone}` 
                        : `${d.lat},${d.lng}_${d.phone}`;

                    if (!groups[key]) {
                        // ì´ˆê¸° ê·¸ë£¹ ìƒì„±
                        groups[key] = { 
                            ...d, 
                            items: d.detail_items ? d.detail_items.map((it, idx) => ({...it, _oid: d.id, _oidx: idx})) : [{ item: d.item, settlement_amount: d.settlement_amount, checked: d.checked, _oid: d.id, _oidx: -1 }], // ìƒì„¸ í’ˆëª© ë¦¬ìŠ¤íŠ¸
                            ids: [d.id],
                            count: 1, // ë°°ì†¡ ê±´ìˆ˜ (Record ìˆ˜)
                            completed: d.completed || false,
                            partial: d.partial || false,
                            canceled: d.canceled || false,
                            cancel_type: d.cancel_type || null,
                            install_fee: (d.install_fee || 0),
                            yangjung: (d.yangjung || 0),
                            naerim: (d.naerim || 0),
                            settlement_amount: (d.settlement_amount || 0), // ì •ì‚°ê¸ˆì•¡ í•©ê³„
                            // [New] í•©ì³ì§„ ê±´ì˜ ID ì €ì¥ (ë¶„ë¦¬í•˜ê¸° ê¸°ëŠ¥ìš© - ë ˆê±°ì‹œ ë°ì´í„° í˜¸í™˜)
                            mergedId: (d._mergedOriginals || (d.detail_items && d.detail_items.length > 1)) ? d.id : null
                        };
                    } else {
                        // ê¸°ì¡´ ê·¸ë£¹ì— ë³‘í•©
                        if (d.detail_items) {
                            groups[key].items.push(...d.detail_items.map((it, idx) => ({...it, _oid: d.id, _oidx: idx})));
                        } else {
                            groups[key].items.push({ item: d.item, settlement_amount: d.settlement_amount, checked: d.checked, _oid: d.id, _oidx: -1 });
                        }
                        
                        groups[key].ids.push(d.id);
                        groups[key].count++;
                        groups[key].install_fee += (d.install_fee || 0);
                        groups[key].yangjung += (d.yangjung || 0);
                        groups[key].naerim += (d.naerim || 0);
                        groups[key].settlement_amount += (d.settlement_amount || 0);
                        
                        if (!d.completed) groups[key].completed = false;
                        if (!d.canceled) groups[key].canceled = false; 
                        
                        // [Fix] Merge Status Details
                        if (d.partial) groups[key].partial = true;
                        if (d.cancel_type) groups[key].cancel_type = d.cancel_type;
                            if (d.unattended) groups[key].unattended = true;

                        // [New] í•©ì³ì§„ ê±´ì´ ë‚˜ì¤‘ì— ì¶”ê°€ë  ê²½ìš° ID ì—…ë°ì´íŠ¸ (ë ˆê±°ì‹œ ë°ì´í„° í˜¸í™˜)
                        if (d._mergedOriginals || (d.detail_items && d.detail_items.length > 1)) groups[key].mergedId = d.id;
                    }
                });
                
                const allGroups = Object.values(groups);

                // 3. Active / Inactive ë¶„ë¦¬
                // [ìˆ˜ì •] ì™„ë£Œëœ í•­ëª©ë„ 'Active' ê·¸ë£¹ì— í¬í•¨í•˜ì—¬ TSP ê²½ë¡œ ê³„ì‚° ë° ìˆœë²ˆ(sequence_number)ì„ ìœ ì§€í•¨.
                // InactiveëŠ” 'ì·¨ì†Œëœ' í•­ëª©ë§Œ í•´ë‹¹ë¨.
                // ì—°ê¸°(cancel_type === 'postpone')ëŠ” ì·¨ì†Œì™€ ë™ì¼í•˜ê²Œ ë¹„í™œì„±(inactive)ë¡œ ë¶„ë¥˜í•˜ì—¬ ë§¨ ë’¤ë¡œ ì´ë™
                const active = allGroups.filter(g => !g.canceled && g.cancel_type !== 'postpone'); 
                const inactive = allGroups.filter(g => g.canceled || g.cancel_type === 'postpone');

                // 4. Active ê·¸ë£¹ ì •ë ¬ (ì˜ˆì•½ì‹œê°„ ìš°ì„  -> TSP Nearest Neighbor)
                // [New] ì˜ˆì•½ ì‹œê°„ ìˆëŠ” ê±´ì€ ìµœìš°ì„ , ë‚˜ë¨¸ì§€ëŠ” 'í˜„ì¬ ìœ„ì¹˜ì—ì„œ ê°€ì¥ ê°€ê¹Œìš´ ê³³'ìœ¼ë¡œ ì—°ê²°
                let sortedActive = [];
                const withTime = active.filter(x => x.time);
                const withoutTime = active.filter(x => !x.time);

                // 4-1. ì˜ˆì•½ì‹œê°„ ì˜¤ë¦„ì°¨ìˆœ
                withTime.sort((a, b) => a.time.localeCompare(b.time));
                sortedActive = [...withTime];

                // 4-2. Nearest Neighbor (Greedy TSP)
                if (withoutTime.length > 0) {
                    if (startPoint) {
                        // ì‹œì‘ì  ì„¤ì •: ì˜ˆì•½ ê±´ì´ ìˆìœ¼ë©´ ë§ˆì§€ë§‰ ì˜ˆì•½ ê±´ ìœ„ì¹˜, ì—†ìœ¼ë©´ ì„¼í„°(ì¶œë°œì§€)
                        let currentPos = sortedActive.length > 0 ? sortedActive[sortedActive.length - 1] : startPoint;
                        
                        // ë³µì‚¬ë³¸ ìƒì„± (splice ì‚¬ìš©ì„ ìœ„í•´)
                        const remaining = [...withoutTime];
                        
                        // [Optimization] ìˆ˜ë™ ìˆœì„œ(sequence_number)ê°€ ì´ë¯¸ ì§€ì •ëœ ê²½ìš° TSP ì œì™¸? 
                        // -> ì‚¬ìš©ì ìš”ì²­ì´ "1ë²ˆì€ ì„¼í„°ì—ì„œ ì œì¼ ê°€ê¹Œìš´ ê³³..."ì´ë¯€ë¡œ ì „ì²´ ì¬ì •ë ¬ë¡œ ê°„ì£¼.
                        // ë‹¨, ê¸°ì¡´ ë¡œì§ìƒ sequence_numberê°€ ìš°ì„ ìˆœìœ„ê°€ ìˆì—ˆìœ¼ë‚˜, 
                        // ì´ë²ˆ ìš”ì²­("ë³€ê²½í•´ì¤˜")ì— ë”°ë¼ ê±°ë¦¬ ê¸°ë°˜ ìë™ ì •ë ¬ì„ ìš°ì„ ì‹œí•¨.

                        while (remaining.length > 0) {
                            let nearestIdx = -1;
                            let minDist = Infinity;

                            for (let i = 0; i < remaining.length; i++) {
                                const item = remaining[i];
                                const dist = getDistance(currentPos.lat, currentPos.lng, item.lat, item.lng);
                                if (dist < minDist) {
                                    minDist = dist;
                                    nearestIdx = i;
                                }
                            }

                            if (nearestIdx !== -1) {
                                const nextItem = remaining[nearestIdx];
                                sortedActive.push(nextItem);
                                currentPos = nextItem; // ë‹¤ìŒ ê¸°ì¤€ì  ì´ë™
                                remaining.splice(nearestIdx, 1);
                            } else {
                                // [Safety] ê±°ë¦¬ ê³„ì‚° ì‹¤íŒ¨ ë“±ìœ¼ë¡œ ë‚¨ì€ í•­ëª©ì´ ìˆë‹¤ë©´ ëª¨ë‘ ì¶”ê°€ (ëˆ„ë½ ë°©ì§€)
                                sortedActive.push(...remaining);
                                break; 
                            }
                        }
                    } else {
                        // ì¢Œí‘œ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°©ì‹(ìˆ˜ë™ ìˆœì„œ) ìœ ì§€
                        withoutTime.sort((a, b) => (a.sequence_number || 99999) - (b.sequence_number || 99999));
                        sortedActive = [...sortedActive, ...withoutTime];
                    }
                }

                // ê±°ë¦¬ ì •ë³´ í• ë‹¹ (UI í‘œì‹œìš©)
                if (startPoint) {
                    sortedActive.forEach(item => {
                        // ë‹¨ìˆœíˆ ì„¼í„°ì™€ì˜ ê±°ë¦¬ë§Œ í‘œì‹œí• ì§€, ê²½ë¡œìƒ ê±°ë¦¬ë¥¼ í‘œì‹œí• ì§€?
                        // UIì—ì„œëŠ” ë³´í†µ 'ì„¼í„°ë¡œë¶€í„°ì˜ ê±°ë¦¬'ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²ƒì´ ì¼ë°˜ì ì„.
                        // í•˜ì§€ë§Œ ì •ë ¬ì€ 'ê²½ë¡œìˆœ'ìœ¼ë¡œ ë˜ì—ˆìŒ.
                        item.distanceFromStart = getDistance(startPoint.lat, startPoint.lng, item.lat, item.lng);
                    });
                }

                // 5. ìˆœë²ˆ í• ë‹¹ ë° ì†ì„± ì¶”ê°€
                const finalActive = sortedActive.map((g, i) => ({
                    ...g,
                    sequence_number: i + 1,
                    is_active: true
                }));

                const finalInactive = inactive.map(g => ({
                    ...g,
                    sequence_number: null,
                    is_active: false
                }));

                return [...finalActive, ...finalInactive];
            }, [deliveries, targetDate, startPoint, currentUser, adminDriverFilter, view]); // [Fix] view ì˜ì¡´ì„± ì¶”ê°€

            // [Sync] ê³„ì‚°ëœ ìˆœì„œ(TSP ë˜ëŠ” ìˆ˜ë™)ë¥¼ ë°ì´í„° ìƒíƒœì— ë°˜ì˜ (Persist Order)
            useEffect(() => {
                if (!groupedDeliveries.length) return;
                
                let needsUpdate = false;
                const updates = {}; 

                groupedDeliveries.forEach(g => {
                    if (g.is_active && g.sequence_number) {
                        g.ids.forEach(id => {
                             const item = deliveries.find(d => d.id === id);
                             if (item && item.sequence_number !== g.sequence_number) {
                                 needsUpdate = true;
                                 updates[id] = g.sequence_number;
                             }
                        });
                    }
                });
                
                if (needsUpdate) {
                     setDeliveries(prev => {
                         const next = prev.map(d => {
                             if (updates[d.id]) return { ...d, sequence_number: updates[d.id] };
                             return d;
                         });
                         StorageManager.saveDeliveries(next);
                         return next;
                     });
                }
            }, [groupedDeliveries, deliveries]);

            // [Effect] SortableJS ì´ˆê¸°í™” (ë“œë˜ê·¸ ì•¤ ë“œë¡­)
            useEffect(() => {
                if (view !== 'driver') return;
                
                const listContainer = document.getElementById('delivery-list-container');
                if (!listContainer) return;

                // SortableJS ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
                const sortable = new Sortable(listContainer, {
                    animation: 150,
                    delay: 200, // í„°ì¹˜ ì‹¤ìˆ˜ ë°©ì§€ (200ms ë¡±í”„ë ˆìŠ¤ ì‹œ ë“œë˜ê·¸ ì‹œì‘)
                    delayOnTouchOnly: true,
                    ghostClass: 'bg-sky-50', // ë“œë˜ê·¸ ì¤‘ì¸ í•­ëª© ìŠ¤íƒ€ì¼
                    handle: '.cursor-pointer', // í—¤ë” ë¶€ë¶„ì„ í•¸ë“¤ë¡œ ì‚¬ìš©
                    onEnd: function (evt) {
                        const { oldIndex, newIndex } = evt;
                        if (oldIndex === newIndex) return;

                        const targetGroup = groupedDeliveries[oldIndex];
                        // ìœ íš¨ì„± ê²€ì‚¬: Active í•­ëª©ë§Œ ì´ë™ ê°€ëŠ¥
                        if (!targetGroup || !targetGroup.is_active) return; 

                        // ì·¨ì†Œëœ í•­ëª©(Inactive) ì˜ì—­ìœ¼ë¡œ ì´ë™ ë°©ì§€
                        const activeCount = groupedDeliveries.filter(g => g.is_active).length;
                        if (newIndex >= activeCount) {
                            return; // ë¬´ì‹œ (Reactê°€ ë¦¬ë Œë”ë§í•˜ë©° ì›ë³µ)
                        }

                        // ìˆœì„œ ë³€ê²½ ì‹¤í–‰ (1-based index)
                        handleSequenceChange(targetGroup.ids, (newIndex + 1).toString());
                    }
                });

                return () => {
                    sortable.destroy();
                };
            }, [view, groupedDeliveries]);

            // [ê¸°ëŠ¥] ì´ ì˜ˆìƒ ì„¤ì¹˜ë¹„ (ê¸°ì‚¬ë³„ ì¼ì¼ í•©ê³„: ì„¤ì¹˜+ì–‘ì¤‘+ë‚´ë¦¼+ê¸°íƒ€)
            const totalInstallFeeOnly = useMemo(() => {
                return deliveries
                    .filter(d => d.date === targetDate && !d.canceled)
                    .filter(d => d.driver === currentUser) // [Fix] ë³¸ì¸ ë°ì´í„°ë§Œ í•©ì‚°
                    .reduce((sum, d) => sum + (d.install_fee || 0) + (d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0), 0);
            }, [deliveries, targetDate, currentUser]);

            // [ê¸°ëŠ¥] ì–‘ì¤‘ë¹„ + ë‚´ë¦¼ë¹„ + ê¸°íƒ€ë¹„ í•©ê³„ (ë³„ë„ í‘œì‹œìš©)
            const extraFeesTotal = useMemo(() => {
                return deliveries
                    .filter(d => d.date === targetDate && !d.canceled)
                    .filter(d => d.driver === currentUser) // [Fix] ë³¸ì¸ ë°ì´í„°ë§Œ í•©ì‚°
                    .reduce((sum, d) => sum + (d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0), 0);
            }, [deliveries, targetDate, currentUser]);
            
            const sortedDeliveries = useMemo(() => {
                return deliveries
                    .filter(d => !d.canceled)
                    .filter(d => showAllDates || targetDate === 'all' || d.date === targetDate)
                    .filter(d => (currentUser === 'admin' || view === 'admin') ? true : d.driver === currentUser)
                    .sort((a, b) => ((a.sequence_number || 99999) - (b.sequence_number || 99999)));
            }, [deliveries, targetDate, showAllDates, currentUser, view]);
            
            // [ê¸°ëŠ¥] ë¹„ìš© ì—…ë°ì´íŠ¸ (ê¸°ì‚¬ ì…ë ¥)
            const updateGroupFees = (ids, field, value) => {
                let numVal = parseInt(value);
                if (isNaN(numVal) || numVal < 0) numVal = 0;
                if (numVal > 10000000) numVal = 10000000; // ìµœëŒ€ 1,000ë§Œì› ì œí•œ

                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        // ê·¸ë£¹ì˜ ì²« ë²ˆì§¸ ì•„ì´í…œì—ë§Œ ë¹„ìš© í• ë‹¹ (ì¤‘ë³µ í•©ì‚° ë°©ì§€)
                        if (d.id === ids[0]) {
                            return { ...d, [field]: numVal };
                        } else {
                            return { ...d, [field]: 0 };
                        }
                    }
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            };
 
            // [ê¸°ëŠ¥] ì—°ë½ì²˜/ì£¼ì†Œ ì—…ë°ì´íŠ¸ (ê¸°ì‚¬ í¸ì§‘)
            function updateGroupContact(ids, changes) {
                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        return { ...d, ...changes };
                    }
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            }
 
            async function updateGroupAddress(ids, newAddress) {
                // 1) ì£¼ì†Œ ë¬¸ìì—´ ì—…ë°ì´íŠ¸
                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        return { ...d, address: newAddress };
                    }
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
 
                // 2) ì§€ì˜¤ì½”ë”© í›„ ì¢Œí‘œ ê°±ì‹  (ì„±ê³µ ì‹œ)
                try {
                    const coords = await geocodeAddress(newAddress, true);
                    if (coords) {
                        const updated2 = updated.map(d => {
                            if (ids.includes(d.id)) {
                                return { ...d, lat: coords.lat, lng: coords.lng };
                            }
                            return d;
                        });
                        setDeliveries(updated2);
                        StorageManager.saveDeliveries(updated2);
                    }
                } catch (e) {
                    console.warn("ì£¼ì†Œ ì¢Œí‘œ ê°±ì‹  ì‹¤íŒ¨", e);
                }
            }

            // [ê¸°ëŠ¥] ë„¤ë¹„ê²Œì´ì…˜ ë° í† ìŠ¤íŠ¸ ë©”ì‹œì§€
            const showToast = (msg) => {
                setToastMsg(msg);
            };

            const handleNavigation = (lat, lng, addressName) => {
                if (!addressName && (!lat || !lng)) {
                    showToast("ìœ„ì¹˜ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const query = addressName || 'ë„ì°©ì§€';
                const encodedQuery = encodeURIComponent(query);
                
                const isAndroid = /Android/i.test(navigator.userAgent);
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const isMobile = isAndroid || isIOS;

                // Web Fallback: Search
                const webUrl = `https://map.kakao.com/link/search/${encodedQuery}`;

                if (isMobile) {
                    if (isAndroid) {
                        // Android: Search Intent
                        const intentUrl = `intent://search?q=${encodedQuery}#Intent;scheme=kakaomap;package=net.daum.android.map;S.browser_fallback_url=${webUrl};end`;
                        window.location.href = intentUrl;
                    } else if (isIOS) {
                        // iOS: Search Scheme
                        const schemeUrl = `kakaomap://search?q=${encodedQuery}`;
                        
                        const start = Date.now();
                        window.location.href = schemeUrl;
                        
                        setTimeout(() => {
                            if (Date.now() - start < 2500) {
                                window.location.href = webUrl;
                            }
                        }, 2000);
                    }
                } else {
                    // Desktop: Web Map Search
                    window.open(webUrl, '_blank');
                }
            };

            // [Effect] Expose navigation & sequence change to global window for MapView popup
            useEffect(() => {
                window.handleAppNavigation = handleNavigation;
                window.handlePopupSequenceChange = (idsStr) => {
                    const ids = idsStr.split(',');
                    const newSeq = prompt("ë³€ê²½í•  ìˆœì„œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
                    if (newSeq && !isNaN(newSeq)) {
                        handleSequenceChange(ids, newSeq);
                    }
                };
            }, [handleSequenceChange]);

            // [ê¸°ëŠ¥] ë©”ëª¨ ì—…ë°ì´íŠ¸
            const updateMemo = (ids, newMemo) => {
                const updated = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        return { ...d, memo: newMemo };
                    }
                    return d;
                });
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
            };

            const prevAllCompletedRef = useRef(false);

            useEffect(() => {
                if (!enableCompletionMessage) return;
                
                const todaysDeliveries = deliveries.filter(d => d.date === targetDate);
                const activeDeliveries = todaysDeliveries.filter(d => !d.canceled);
                const isAllCompleted = activeDeliveries.length > 0 && activeDeliveries.every(d => d.completed);

                if (!prevAllCompletedRef.current && isAllCompleted) {
                    setShowCompletionModal(true);
                }
                
                prevAllCompletedRef.current = isAllCompleted;
            }, [deliveries, targetDate, enableCompletionMessage]);

            // [ê¸°ëŠ¥] ìƒì„¸ ì •ë³´ ìˆ˜ì • (Admin)
            const handleEditOpen = (delivery) => {
                // ìˆ˜ì • ì‹œ ì „ì²´ ê·¸ë£¹ì´ ì•„ë‹Œ í•´ë‹¹ ë°°ì†¡ ê±´ë§Œ ìˆ˜ì • (ê°œë³„ ìˆ˜ì •)
                setEditTarget({ 
                    images: [], 
                    attachments: [], 
                    ...delivery 
                }); 
                setEditTab('basic');
                setShowEditModal(true);
            };

            const handleEditSave = async () => {
                if (!editTarget) return;
                
                // 1. ìœ íš¨ì„± ê²€ì‚¬
                if (!editTarget.item || !editTarget.phone || !editTarget.address) {
                    alert("í•„ìˆ˜ í•­ëª©(ìƒí’ˆëª…, ì—°ë½ì²˜, ì£¼ì†Œ)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                setLoading(true);

                // 2. ë³€ê²½ ë‚´ì—­ ê°ì§€ ë° ë¡œê·¸ ìƒì„±
                const original = deliveries.find(d => d.id === editTarget.id);
                if (!original) { alert("ì›ë³¸ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); setLoading(false); return; }

                const changes = [];
                const fields = ['item', 'phone', 'address', 'install_fee', 'yangjung', 'naerim', 'etc_fee', 'memo', 'images', 'attachments'];
                
                fields.forEach(field => {
                    const oldVal = original[field] || (['images', 'attachments'].includes(field) ? [] : '');
                    const newVal = editTarget[field] || (['images', 'attachments'].includes(field) ? [] : '');
                    
                    // ìˆ«ìí˜• ë¹„êµ
                    if (['install_fee', 'yangjung', 'naerim', 'etc_fee'].includes(field)) {
                        if (Number(oldVal) !== Number(newVal)) {
                            changes.push({ field, old: oldVal, new: newVal });
                        }
                    } else if (['images', 'attachments'].includes(field)) {
                        // ë°°ì—´ ë¹„êµ
                        if (JSON.stringify(oldVal) !== JSON.stringify(newVal)) {
                             changes.push({ field, old: `${oldVal.length}ê°œ`, new: `${newVal.length}ê°œ` });
                        }
                    } else {
                        // ë¬¸ìì—´ ë¹„êµ
                        if (String(oldVal).trim() !== String(newVal).trim()) {
                            changes.push({ field, old: oldVal, new: newVal });
                        }
                    }
                });

                // ë³€ê²½ì‚¬í•­ ì—†ìœ¼ë©´ ì¢…ë£Œ
                if (changes.length === 0) {
                    alert("ë³€ê²½ëœ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
                    setLoading(false);
                    return;
                }

                // 3. ì£¼ì†Œ ë³€ê²½ ì‹œ ì¢Œí‘œ ì¬ê²€ìƒ‰
                let newCoords = { lat: editTarget.lat, lng: editTarget.lng };
                if (original.address !== editTarget.address) {
                    newCoords = await geocodeAddress(editTarget.address);
                }

                // 4. íˆìŠ¤í† ë¦¬ ìƒì„±
                const newHistory = {
                    date: new Date().toISOString(),
                    changes: changes
                };

                // 5. ì—…ë°ì´íŠ¸ ë°˜ì˜
                const updatedDeliveries = deliveries.map(d => {
                    if (d.id === editTarget.id) {
                        // [Fix] ìƒì„¸ í’ˆëª©(detail_items) ë™ê¸°í™”
                        // ê·¸ë£¹í™”ëœ ë°ì´í„°(editTarget)ì˜ ë³€ê²½ì‚¬í•­ì„ ì›ë³¸ ë°ì´í„°ì˜ detail_itemsì—ë„ ë°˜ì˜í•´ì•¼ ë¦¬ìŠ¤íŠ¸ì— ì¦‰ì‹œ ì ìš©ë¨
                        let updatedDetailItems = d.detail_items ? [...d.detail_items] : null;
                        
                        if (updatedDetailItems && updatedDetailItems.length > 0) {
                            // 1) ìƒí’ˆëª… ë³€ê²½ ì‹œ ì²« ë²ˆì§¸ ìƒì„¸ í’ˆëª© ì´ë¦„ ì—…ë°ì´íŠ¸
                            if (editTarget.item !== d.item) {
                                updatedDetailItems[0] = { ...updatedDetailItems[0], item: editTarget.item };
                            }
                            // 2) ì„¤ì¹˜ë¹„ ë³€ê²½ ì‹œ: ë‹¨ì¼ í’ˆëª©ì´ë©´ í•´ë‹¹ í’ˆëª© ë¹„ìš© ì—…ë°ì´íŠ¸
                            if (updatedDetailItems.length === 1 && Number(editTarget.install_fee) !== Number(d.install_fee)) {
                                updatedDetailItems[0] = { ...updatedDetailItems[0], install_fee: Number(editTarget.install_fee) };
                            }
                        } else {
                            // detail_itemsê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„± (ë‹¨ì¼ í’ˆëª© í˜¸í™˜ì„±)
                            updatedDetailItems = [{ item: editTarget.item, install_fee: Number(editTarget.install_fee) }];
                        }

                        return {
                            ...d,
                            ...editTarget,
                            ...newCoords,
                            detail_items: updatedDetailItems, // [ì¤‘ìš”] ìƒì„¸ í’ˆëª© ì—…ë°ì´íŠ¸
                            history: [...(d.history || []), newHistory]
                        };
                    }
                    return d;
                });

                setDeliveries(updatedDeliveries);
                StorageManager.saveDeliveries(updatedDeliveries);
                
                alert("ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                setShowEditModal(false);
                setEditTarget(null);
                setLoading(false);
            };

            // [Helper] ì˜ˆì•½ ì‹œìŠ¤í…œ ìœ íš¨ì„± ê²€ì‚¬ ë° ë¡œì§
            const reservationConstraints = useMemo(() => {
                const today = new Date();
                const min = new Date(today); min.setDate(today.getDate() + Config.RESERVATION.MIN_DAYS);
                const max = new Date(today); max.setDate(today.getDate() + Config.RESERVATION.MAX_DAYS);
                return { min: min.toISOString().split('T')[0], max: max.toISOString().split('T')[0] };
            }, []);

            const timeSlots = useMemo(() => {
                const slots = [];
                for(let i=Config.RESERVATION.START_HOUR; i<=Config.RESERVATION.END_HOUR; i++) {
                    slots.push(`${i.toString().padStart(2,'0')}:00`);
                    slots.push(`${i.toString().padStart(2,'0')}:30`);
                }
                return slots;
            }, []);

            const isTimeBlocked = (date, time) => {
                if (!date || !time) return false;
                return deliveries.some(d => d.reservationDate === date && d.reservationTime === time);
            };

            const handleMemoChange = (e) => {
                const val = e.target.value;
                const clean = val.replace(/[^a-zA-Z0-9ã„±-ã…ã…-ã…£ê°€-í£\s.,!?]/g, '');
                if (clean.length <= Config.MEMO.MAX_LENGTH) setForm(prev => ({ ...prev, memo: clean }));
            };

            // [ê¸°ëŠ¥] ìˆ˜ë™ ë“±ë¡
            async function handleManualAdd(e) {
                e.preventDefault();
                
                // 1. ê¸°ë³¸ í•„ìˆ˜ê°’ ê²€ì‚¬
                if (!form.item || !form.phone || !form.address) {
                    alert("í•„ìˆ˜ í•­ëª©(ìƒí’ˆëª…, ì „í™”ë²ˆí˜¸, ì£¼ì†Œ)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }

                // 2. ì˜ˆì•½ ì‹œìŠ¤í…œ ìœ íš¨ì„± ê²€ì‚¬
                if (form.reservationDate) {
                    if (form.reservationDate < reservationConstraints.min || form.reservationDate > reservationConstraints.max) {
                        alert(`ì˜ˆì•½ ê°€ëŠ¥ ê¸°ê°„ì€ ${reservationConstraints.min} ~ ${reservationConstraints.max} ì…ë‹ˆë‹¤.`);
                        return;
                    }
                    if (isTimeBlocked(form.reservationDate, form.reservationTime)) {
                        alert("ì„ íƒí•˜ì‹  ì‹œê°„ëŒ€ëŠ” ì´ë¯¸ ì˜ˆì•½ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
                        return;
                    }
                }

                // 3. ì„¤ì¹˜ ì‹œê°„ ê²€ì‚¬
                if (form.isInstallNeeded && form.installTime) {
                    const hour = parseInt(form.installTime.split(':')[0]);
                    const rDate = new Date(form.reservationDate || form.date);
                    const day = rDate.getDay();
                    
                    if (Config.INSTALL.WEEKDAYS_ONLY && (day === 0 || day === 6)) { 
                         alert("ì„¤ì¹˜ ì„œë¹„ìŠ¤ëŠ” í‰ì¼(ì›”~ê¸ˆ)ì—ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); 
                         return;
                    }
                    if (hour < Config.INSTALL.START_HOUR || hour >= Config.INSTALL.END_HOUR) {
                        alert(`ì„¤ì¹˜ ê°€ëŠ¥ ì‹œê°„ì€ ${Config.INSTALL.START_HOUR.toString().padStart(2,'0')}:00 ~ ${Config.INSTALL.END_HOUR.toString().padStart(2,'0')}:00 ì…ë‹ˆë‹¤.`);
                        return;
                    }
                }

                // 4. ë©”ëª¨ ê¸¸ì´ ê²€ì‚¬
                if (form.memo && form.memo.length < Config.MEMO.MIN_LENGTH) {
                    alert(`ë°°ì†¡ ë©”ëª¨ëŠ” ìµœì†Œ ${Config.MEMO.MIN_LENGTH}ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
                    return;
                }

                setLoading(true);
                const coords = await geocodeAddress(form.address);

                // [Driver Logic] ê¸°ì‚¬ ë°°ì • ë¡œì§ (ë³¸ì¸ ë˜ëŠ” ê´€ë¦¬ì ì„ íƒ)
                let assignedDriver = '';
                if (currentUser !== 'admin') {
                    assignedDriver = currentUser;
                } else if (adminDriverFilter !== 'all' && adminDriverFilter !== 'unassigned') {
                    assignedDriver = adminDriverFilter;
                }

                const newItem = {
                    id: crypto.randomUUID(),
                    date: form.reservationDate || form.date, 
                    driver: assignedDriver, // ê¸°ì‚¬ ë°°ì •
                    item: form.item,
                    phone: form.phone,
                    address: form.address,
                    install_fee: Number(form.install_fee) || 0,
                    yangjung: Number(form.yangjung) || 0,
                    naerim: Number(form.naerim) || 0,
                    etc_fee: Number(form.etc_fee) || 0,
                    reservationDate: form.reservationDate,
                    reservationTime: form.reservationTime,
                    isInstallNeeded: form.isInstallNeeded,
                    installTime: form.installTime,
                    memo: form.memo,
                    ...coords
                };

                // Local Save (Cloud Sync is manual)
                const updated = [...deliveries, newItem];
                setDeliveries(updated);
                StorageManager.saveDeliveries(updated);
                
                alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                // í¼ ì´ˆê¸°í™”
                setForm(prev => ({ 
                    ...prev, 
                    item: '', phone: '', address: '', 
                    install_fee: 0, yangjung: 0, naerim: 0, etc_fee: 0,
                    reservationDate: '', reservationTime: '', isInstallNeeded: false, installTime: '', memo: ''
                }));
                setLoading(false);
            }

            // [ê¸°ëŠ¥] ìƒíƒœ ì´ˆê¸°í™” (ì²´í¬ í•´ì œ)
            function resetStatus(ids, type) {
                if(!confirm(`'${type === 'completed' ? 'ë°©ë¬¸ì™„ë£Œ' : 'ë¶€ë¶„'}' ìƒíƒœë¥¼ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                updateGroupStatus(ids, { [type]: false });
            }

            // [ê¸°ëŠ¥] ì‚­ì œ ìš”ì²­ (ëª¨ë‹¬ ì˜¤í”ˆ)
            function requestDelete(ids) {
                setDeleteTarget(ids);
                setShowDeleteModal(true);
            }

            // [ê¸°ëŠ¥] ì‹¤ì œ ì‚­ì œ ì‹¤í–‰ (API ì‹œë®¬ë ˆì´ì…˜)
            async function executeDelete() {
                if (!deleteTarget) return;
                
                try {
                    // API í˜¸ì¶œ ì‹œë®¬ë ˆì´ì…˜ (0.3ì´ˆ)
                    await new Promise(resolve => setTimeout(resolve, 300));

                    let newDeliveries = deliveries.filter(d => !deleteTarget.includes(d.id));
                    
                    setDeliveries(newDeliveries);
                    StorageManager.saveDeliveries(newDeliveries);
                    
                    setToastMsg("ğŸ—‘ï¸ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    setShowDeleteModal(false);
                    setDeleteTarget(null);
                } catch (e) {
                    setToastMsg("âŒ ì‚­ì œ ì‹¤íŒ¨");
                }
            }

            // [ê¸°ëŠ¥] ìƒíƒœ ì—…ë°ì´íŠ¸ (ë°©ë¬¸ì™„ë£Œ, ë¹„ìš© ë“±)
            function updateGroupStatus(ids, updates) {
                const newDeliveries = deliveries.map(d => {
                    if (ids.includes(d.id)) {
                        return { ...d, ...updates };
                    }
                    return d;
                });
                setDeliveries(newDeliveries);
                StorageManager.saveDeliveries(newDeliveries);
            }
            
            function readJsonFileWithEncoding(file, cb) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const buf = ev.target.result;
                    let text = '';
                    let data = null;
                    
                    // 1. Try UTF-8 first (Strict Check for ï¿½)
                    try {
                        text = new TextDecoder('utf-8').decode(buf);
                        const temp = JSON.parse(text);
                        // If it parses but has replacement characters, it might be EUC-KR
                        if (text.includes('\uFFFD')) {
                             throw new Error('Suspicious UTF-8 with replacement characters');
                        }
                        data = temp;
                    } catch (e) {
                        // UTF-8 parse failed or was suspicious
                    }
                    
                    // 2. Try EUC-KR if UTF-8 failed or was suspicious
                    if (!data) {
                        try {
                            text = new TextDecoder('euc-kr').decode(buf);
                            data = JSON.parse(text);
                        } catch (e) {
                            // EUC-KR failed too
                        }
                    }
                    
                    // 3. Fallback: If strict UTF-8 failed but EUC-KR also failed, 
                    // use loose UTF-8 (maybe it really had ï¿½)
                    if (!data) {
                        try {
                            text = new TextDecoder('utf-8').decode(buf);
                            data = JSON.parse(text);
                        } catch {}
                    }

                    if (!data) {
                        alert('íŒŒì¼ ì¸ì½”ë”©ì„ í™•ì¸í•´ì£¼ì„¸ìš”. UTF-8 ë˜ëŠ” EUC-KR í˜•ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤.');
                        return;
                    }
                    cb(data);
                };
                reader.readAsArrayBuffer(file);
            }
            
            function completeDelivery(id) {
                const newDeliveries = deliveries.map(d => {
                    if (d.id === id) return { ...d, completed: true };
                    return d;
                });
                setDeliveries(newDeliveries);
                StorageManager.saveDeliveries(newDeliveries);
            }
            
            function handleComplete(id, order) {
                completeDelivery(id);
                setCurrentOrder(order + 1);
            }

            // [ê¸°ëŠ¥] ê²½ë¡œ ìµœì í™” (Nearest Neighbor)
            const [optimizedRoute, setOptimizedRoute] = useState([]);
            // ì „í™”ë²ˆí˜¸ ì¸ë¼ì¸ í¸ì§‘ ìƒíƒœ
            const [editingPhoneGroupId, setEditingPhoneGroupId] = useState(null);
            const [editingPhoneValue, setEditingPhoneValue] = useState('');
            // ì˜ˆì•½/ì„¤ì¹˜ ì‹œê°„ ë²„íŠ¼í˜• ì„ íƒ íŒì—… ìƒíƒœ
            const [openTimePickerId, setOpenTimePickerId] = useState(null);
            const [openDurationPickerId, setOpenDurationPickerId] = useState(null);
            const [showAddItemModal, setShowAddItemModal] = useState(false);
            const [addForm, setAddForm] = useState({ date: '', phone: '', address: '', item: '' });

            // [ê¸°ëŠ¥] ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
            async function downloadTemplate() {
                const workbook = new ExcelJS.Workbook();
                const sheet = workbook.addWorksheet('ë°°ì†¡ëª©ë¡');
                
                sheet.columns = [
                    { header: 'ë‚ ì§œ', key: 'date', width: 15 },
                    { header: 'ì£¼ë¬¸ë²ˆí˜¸', key: 'order_number', width: 20 },
                    { header: 'ìš´ì†¡ì¥ë²ˆí˜¸', key: 'invoice_number', width: 20 },
                    { header: 'ì œí’ˆëª…', key: 'item', width: 40 },
                    { header: 'ì•ˆì‹¬ë²ˆí˜¸', key: 'phone', width: 20 },
                    { header: 'ì£¼ì†Œ', key: 'address', width: 50 },
                    { header: 'ê¸°ì‚¬', key: 'driver', width: 15 },
                    { header: 'ë‹¨ê°€', key: 'settlement_amount', width: 15 },
                ];
                
                // ìŠ¤íƒ€ì¼
                sheet.getRow(1).font = { bold: true };
                sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFD9D9D9' } };
                
                // ìœ íš¨ì„± ê²€ì‚¬ (ìˆ«ìë§Œ ì…ë ¥ ì•ˆë‚´)
                for(let i=2; i<=100; i++) {
                    sheet.getCell(`H${i}`).numFmt = '#,##0'; // ë‹¨ê°€
                }

                // [ì˜ˆì‹œ] ë‹¤ì¤‘ ìƒí’ˆ ì…ë ¥ (Fill-down)
                sheet.addRow(['2025-01-30', 'ORD-001', 'INV-001', 'ì‚¼ì„± TV 65ì¸ì¹˜', '010-1234-5678', 'ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123', 'í™ê¸¸ë™', 50000]);
                sheet.addRow(['', '', '', 'ë²½ê±¸ì´ ë¸Œë¼ì¼“ (ì¶”ê°€)', '', '', '', 15000]); 
                sheet.addRow(['2025-01-30', 'ORD-002', 'INV-002', 'LG ëƒ‰ì¥ê³ ', '010-9876-5432', 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬ íŒêµë¡œ 456', 'ê¹€ì² ìˆ˜', 80000]);

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'ë°°ì†¡ì–‘ì‹_í†µí•©.xlsx';
                a.click();
            }

            // [ê¸°ëŠ¥] íŒŒì¼ ì—…ë¡œë“œ (ìƒí’ˆ í†µí•© ë¡œì§ ì ìš©)
            async function handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                // [New] Auto Backup: ë®ì–´ì“°ê¸° ì „ ë°ì´í„° ìë™ ë°±ì—…
                if (deliveries.length > 0) {
                    try {
                        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                        const backupKey = `mvp_backup_auto_${timestamp}`;
                        const backupData = {
                            timestamp: new Date().toISOString(),
                            deliveries: deliveries,
                            reason: 'before_upload'
                        };
                        StorageManager.set(backupKey, backupData);
                        
                        // ë°±ì—… ëª©ë¡ ê´€ë¦¬ (ìµœê·¼ 5ê°œë§Œ ìœ ì§€)
                        const backupList = StorageManager.get('mvp_backup_list') || [];
                        backupList.unshift({ key: backupKey, time: new Date().toLocaleString(), count: deliveries.length });
                        if (backupList.length > 5) {
                            const removed = backupList.pop();
                            StorageManager.remove(removed.key);
                        }
                        StorageManager.set('mvp_backup_list', backupList);
                        console.log(`[Auto Backup] Saved to ${backupKey}`);
                    } catch(err) {
                        console.warn("Auto backup failed:", err);
                    }
                }

                setUploadedFileName(file.name); // íŒŒì¼ëª… í‘œì‹œ
                setLoading(true);

                try {
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(await file.arrayBuffer());
                    const sheet = workbook.worksheets[0];
                    
                    // í—¤ë” ì°¾ê¸°
                    const header = { 
                        date: -1, order_number: -1, invoice_number: -1, item: -1, 
                        phone: -1, address: -1, center: -1, region: -1, 
                        settlement_amount: -1, driver: -1,
                        // [New] ìƒì„¸ ë¹„ìš© ì»¬ëŸ¼ ì¶”ê°€
                        install_fee: -1, yangjung: -1, naerim: -1, etc_fee: -1
                    };

                    sheet.getRow(1).eachCell((cell, col) => {
                        const val = cell.value ? cell.value.toString().trim() : '';
                        if(val.includes('ë‚ ì§œ')) header.date = col;
                        if(val.includes('ì£¼ë¬¸') || val.includes('ì˜¤ë”')) header.order_number = col;
                        if(val.includes('ìš´ì†¡ì¥') || val.includes('ì†¡ì¥') || val.includes('ì¸ë³´ì´ìŠ¤')) header.invoice_number = col;
                        if(val.includes('ì œí’ˆ') || val.includes('ìƒí’ˆ')) header.item = col;
                        if(val.includes('ì•ˆì‹¬ë²ˆí˜¸') || val.includes('ì „í™”')) header.phone = col;
                        if(val.includes('ì£¼ì†Œ')) header.address = col;
                        if(val.includes('ê¸°ì‚¬') || val.includes('ë‹´ë‹¹')) header.driver = col;
                        
                        // ë¹„ìš© ê´€ë ¨ ì»¬ëŸ¼ ë§¤í•‘
                        if(val.includes('ë‹¨ê°€') || val.includes('ê¸ˆì•¡') || val.includes('ì •ì‚°')) header.settlement_amount = col;
                        if(val.includes('ì„¤ì¹˜ë¹„') || val.includes('ì„¤ì¹˜')) header.install_fee = col;
                        if(val.includes('ì–‘ì¤‘')) header.yangjung = col;
                        if(val.includes('ë‚´ë¦¼')) header.naerim = col;
                        if(val.includes('ê¸°íƒ€')) header.etc_fee = col;

                        // Legacy support (optional)
                        if(val.includes('ì„¼í„°')) header.center = col;
                        if(val.includes('ì§€ì—­')) header.region = col;
                    });

                    if (header.address === -1 || header.item === -1) {
                        throw new Error("í•„ìˆ˜ ì»¬ëŸ¼(ì£¼ì†Œ, ìƒí’ˆ)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    }

                    let lastDate = '';
                    let lastOrder = '';
                    let lastInvoice = '';
                    let lastAddress = '';
                    let lastPhone = '';
                    let lastCenter = '';
                    let lastRegion = '';
                    let lastDriver = '';
                    
                    // 1ì°¨ íŒŒì‹±: Raw ë°ì´í„° ì¶”ì¶œ
                    const rawRows = [];
                    sheet.eachRow((row, rowNum) => {
                        if(rowNum === 1) return;

                        const getVal = (colIdx) => {
                            if (colIdx === -1) return null;
                            const cell = row.getCell(colIdx);
                            if (cell.value && typeof cell.value === 'object') {
                                if (cell.value.richText) return cell.value.richText.map(r => r.text).join('');
                                if (cell.value.text) return cell.value.text;
                                if (cell.value.result) return cell.value.result; 
                            }
                            return cell.value;
                        };

                        // [Helper] ê¸ˆì•¡ íŒŒì‹± (ì½¤ë§ˆ ì œê±° ë° ìˆ«ì ë³€í™˜)
                        const parseMoney = (v) => {
                            if (!v) return 0;
                            if (typeof v === 'number') return v;
                            // ë¬¸ìì—´ì¸ ê²½ìš° ì½¤ë§ˆ, ì›, ê³µë°± ë“± ì œê±°í•˜ê³  ìˆ«ìë§Œ ì¶”ì¶œ
                            const str = String(v).replace(/[^\d.-]/g, '');
                            const num = Number(str);
                            return isNaN(num) ? 0 : num;
                        };

                        let dateRaw = getVal(header.date);
                        let orderRaw = getVal(header.order_number);
                        let invoiceRaw = getVal(header.invoice_number);
                        let address = getVal(header.address);
                        let phone = getVal(header.phone);
                        let item = getVal(header.item);
                        let centerRaw = getVal(header.center);
                        let regionRaw = getVal(header.region);
                        let driver = getVal(header.driver);
                        
                        // ë¹„ìš© ì¶”ì¶œ
                        let settlementRaw = getVal(header.settlement_amount);
                        let installRaw = getVal(header.install_fee);
                        let yangjungRaw = getVal(header.yangjung);
                        let naerimRaw = getVal(header.naerim);
                        let etcRaw = getVal(header.etc_fee);

                        // Fill-down ë¡œì§
                        if (address) {
                            lastAddress = address.toString().trim();
                            if (dateRaw) lastDate = dateRaw;
                            if (orderRaw) lastOrder = orderRaw.toString().trim();
                            if (invoiceRaw) lastInvoice = invoiceRaw.toString().trim();
                            if (phone) lastPhone = phone.toString().trim();
                            if (centerRaw) lastCenter = centerRaw.toString().trim();
                            if (regionRaw) lastRegion = regionRaw.toString().trim();
                            if (driver) lastDriver = driver.toString().trim();
                        }
                        
                        if (!dateRaw && lastDate) dateRaw = lastDate;
                        if (!orderRaw && lastOrder) orderRaw = lastOrder;
                        if (!invoiceRaw && lastInvoice) invoiceRaw = lastInvoice;
                        if (!phone && lastPhone) phone = lastPhone;
                        if (!centerRaw && lastCenter) centerRaw = lastCenter;
                        if (!regionRaw && lastRegion) regionRaw = lastRegion;
                        if (!driver && lastDriver) driver = lastDriver;

                        if (lastAddress && item) {
                            // ë¹„ìš© ìš°ì„ ìˆœìœ„ ê²°ì •: ìƒì„¸ ì»¬ëŸ¼ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ í†µí•© ì»¬ëŸ¼ ì‚¬ìš©
                            let iFee = parseMoney(installRaw);
                            const yFee = parseMoney(yangjungRaw);
                            const nFee = parseMoney(naerimRaw);
                            const eFee = parseMoney(etcRaw);
                            
                            // ìƒì„¸ ì„¤ì¹˜ë¹„ê°€ 0ì´ê³  í†µí•© ê¸ˆì•¡ì´ ìˆë‹¤ë©´ í†µí•© ê¸ˆì•¡ì„ ì„¤ì¹˜ë¹„ë¡œ ê°„ì£¼ (Legacy í˜¸í™˜)
                            if (iFee === 0 && parseMoney(settlementRaw) > 0 && yFee === 0 && nFee === 0 && eFee === 0) {
                                iFee = parseMoney(settlementRaw);
                            }

                            rawRows.push({
                                rawDate: dateRaw,
                                order_number: orderRaw || '',
                                invoice_number: invoiceRaw || '',
                                address: lastAddress,
                                phone: lastPhone || '',
                                item: item.toString().trim(),
                                center: centerRaw || '',
                                region: regionRaw || '',
                                driver: driver ? String(driver).trim() : '',
                                // ë¹„ìš© ë°ì´í„°
                                install_fee: iFee,
                                yangjung: yFee,
                                naerim: nFee,
                                etc_fee: eFee
                            });
                        }
                    });

                    // [ê²€ì¦ ë¡œì§] 1ì°¨ ìë™ ëŒ€ì¡° ë° ë¡œê·¸ ìƒì„±
                    const validationLogs = [];
                    const phoneGroups = {}; // ì „í™”ë²ˆí˜¸ ê¸°ì¤€ ê·¸ë£¹í™” (ê²€ì¦ìš©)

                    rawRows.forEach(row => {
                        const phoneKey = String(row.phone).replace(/\D/g, '');
                        if (!phoneGroups[phoneKey]) phoneGroups[phoneKey] = new Set();
                        phoneGroups[phoneKey].add(row.address); // ì›ë³¸ ì£¼ì†Œ ì €ì¥
                    });

                    // ë¶ˆì¼ì¹˜ í•­ëª©(ë™ì¼ ì „í™”ë²ˆí˜¸ì¸ë° ì£¼ì†Œê°€ ë¯¸ì„¸í•˜ê²Œ ë‹¤ë¥¸ ê²½ìš°) ê°ì§€
                    Object.entries(phoneGroups).forEach(([phone, addresses]) => {
                        if (addresses.size > 1) {
                            const addrList = Array.from(addresses);
                            validationLogs.push({
                                type: 'mismatch',
                                phone: phone,
                                msg: `ë™ì¼ ì—°ë½ì²˜(${phone})ì— ì„œë¡œ ë‹¤ë¥¸ ì£¼ì†Œ ${addresses.size}ê±´ ë°œê²¬ (ìë™ ë¶„ë¦¬ë¨)`,
                                details: addrList
                            });
                        }
                    });

                    // 2ì°¨ ê°€ê³µ: ì£¼ì†Œ+ê¸°ì‚¬ ê¸°ì¤€ ë³‘í•©
                    // (ì£¼ì†Œê°€ ê°™ì•„ë„ ê¸°ì‚¬ê°€ ë‹¤ë¥´ë©´ ë³„ë„ ì •ì‚° ê±´ìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨)
                    const mergedMap = new Map();

                    rawRows.forEach(row => {
                        // [ìˆ˜ì •] ì£¼ì†Œ + ê¸°ì‚¬ ì •ë³´ë¡œ ê·¸ë£¹í™”
                        // ê¸°ì‚¬ê°€ ë‹¤ë¥´ë©´ ì£¼ì†Œê°€ ê°™ì•„ë„ ì„ì´ì§€ ì•Šë„ë¡ í•¨
                        const strictKey = `${row.address.trim()}_${row.driver || 'unknown'}`;
                        
                        if (!mergedMap.has(strictKey)) {
                            mergedMap.set(strictKey, {
                                rawDate: row.rawDate,
                                order_number: row.order_number,
                                invoice_number: row.invoice_number,
                                address: row.address, 
                                phone: row.phone,
                                driver: row.driver,
                                center: row.center,
                                region: row.region,
                                items: [], 
                                totalInstallFee: 0,
                                totalYangjung: 0,
                                totalNaerim: 0,
                                totalEtc: 0
                            });
                        }
                        
                        const group = mergedMap.get(strictKey);
                        group.items.push({
                            item: row.item,
                            install_fee: row.install_fee,
                            yangjung: row.yangjung,
                            naerim: row.naerim,
                            etc_fee: row.etc_fee
                        });
                        group.totalInstallFee += row.install_fee;
                        group.totalYangjung += row.yangjung;
                        group.totalNaerim += row.naerim;
                        group.totalEtc += row.etc_fee;
                    });

                    // ê²€ì¦ ë¦¬í¬íŠ¸ ì €ì¥ (localStorage)
                    if (validationLogs.length > 0) {
                        const report = {
                            date: new Date().toISOString(),
                            logs: validationLogs,
                            totalRows: rawRows.length,
                            mergedCount: mergedMap.size
                        };
                        StorageManager.set('mvp_validation_report', report);
                        setVerificationReport(report); // UI ì—…ë°ì´íŠ¸ìš© ìƒíƒœ
                        alert(`[ë°ì´í„° ê²€ì¦ ê²½ê³ ] ì´ ${validationLogs.length}ê±´ì˜ ì£¼ì†Œ ë¶ˆì¼ì¹˜ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. \nê´€ë¦¬ì íŒ¨ë„ ìƒë‹¨ 'ê²€ì¦ ë¦¬í¬íŠ¸'ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
                    } else {
                        setVerificationReport(null);
                        StorageManager.remove('mvp_validation_report');
                    }

                    console.log(`ì´ ${rawRows.length}ê°œ í–‰ -> ${mergedMap.size}ê°œ ë°°ì†¡ ê±´ìœ¼ë¡œ í†µí•©ë¨.`);

                    // 3ì°¨: ì§€ì˜¤ì½”ë”© ë° ê°ì²´ ìƒì„±
                    const results = [];

                    for (const [key, group] of mergedMap) {
                        // [Speed Fix] ì´ˆê¸° ë¡œë”© ì‹œ ì§€ì˜¤ì½”ë”© ê±´ë„ˆë›°ê¸° (ì¦‰ì‹œ ë¡œë”©)
                        // ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í”Œë˜ê·¸(needsGeocoding) ì„¤ì • ë° ê¸°ë³¸ ì¢Œí‘œ í• ë‹¹
                        const coords = { lat: 37.5665, lng: 126.9780, needsGeocoding: true };

                        // ëŒ€í‘œ ìƒí’ˆëª… ìƒì„±
                        let displayItem = group.items[0].item;
                        if (group.items.length > 1) {
                            displayItem = `${displayItem} ì™¸ ${group.items.length - 1}ê±´`;
                        }

                        results.push({
                            id: crypto.randomUUID(),
                            date: parseCustomDate(group.rawDate),
                            order_number: group.order_number, // [New] ì£¼ë¬¸ë²ˆí˜¸
                            invoice_number: group.invoice_number, // [New] ì†¡ì¥ë²ˆí˜¸
                            item: displayItem,
                            detail_items: group.items, // ìƒì„¸ ë‚´ì—­ ì €ì¥
                            phone: group.phone,
                            address: group.address,
                            driver: group.driver, // [New] ê¸°ì‚¬ ì •ë³´ ë§¤í•‘
                            center: group.center, // [New] ì„¼í„°
                            region: group.region, // [New] ì§€ì—­
                            install_fee: group.totalInstallFee,
                            yangjung: group.totalYangjung,
                            naerim: group.totalNaerim,
                            etc_fee: group.totalEtc,
                            ...(coords || { lat: 37.5665, lng: 126.9780, needsGeocoding: true }) // [ì•ˆì „ì¥ì¹˜] ê¸°ë³¸ê°’ + í”Œë˜ê·¸
                        });
                    }

                    // [ìˆ˜ì •] ì¤‘ë³µ ë°©ì§€ ë³‘í•© ë¡œì§ (Address ê¸°ì¤€)
                    const existingMap = new Map();
                    // ê¸°ì¡´ ë°ì´í„°ë¥¼ Mapì— ì €ì¥ (Key: ì£¼ì†Œ)
                    deliveries.forEach(d => {
                         const key = d.address.trim();
                         existingMap.set(key, d);
                    });

                    let updateCount = 0;
                    let newCount = 0;

                    results.forEach(newInfo => {
                        const key = newInfo.address.trim();
                        
                        if (existingMap.has(key)) {
                            // ê¸°ì¡´ ë°ì´í„° ì—…ë°ì´íŠ¸ (ID, ìƒíƒœ ìœ ì§€)
                            const existing = existingMap.get(key);
                            const merged = {
                                ...existing,
                                ...newInfo, // ìƒˆë¡œìš´ ì •ë³´ë¡œ ë®ì–´ì“°ê¸° (items, fees ë“±)
                                id: existing.id, // ID ìœ ì§€
                                sequence_number: existing.sequence_number, // ìˆœì„œ ìœ ì§€
                                completed: existing.completed, // ì™„ë£Œ ìƒíƒœ ìœ ì§€
                                canceled: existing.canceled, // ì·¨ì†Œ ìƒíƒœ ìœ ì§€
                                cancel_type: existing.cancel_type,
                            };
                            existingMap.set(key, merged);
                            updateCount++;
                        } else {
                            // ì‹ ê·œ ì¶”ê°€
                            existingMap.set(key, newInfo);
                            newCount++;
                        }
                    });

                    const updated = Array.from(existingMap.values());
                    setDeliveries(updated);
                    const isLocalSaved = await StorageManager.saveDeliveries(updated);
                    
                    // [Sync Check] ì„œë²„ ë™ê¸°í™” ìƒíƒœ í™•ì¸ ë° ì•Œë¦¼
                    let syncMsg = "";
                    if (isLocalSaved) {
                         syncMsg += "\nâœ… PC ì„œë²„ ì €ì¥ ì™„ë£Œ (ìë™)";
                    } else {
                         syncMsg += "\nâš ï¸ PC ì„œë²„ ì €ì¥ ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”)";
                    }
                    
                    if (CloudManager.isConnected && CloudManager.client) {
                        try {
                            // ëª…ì‹œì  ë™ê¸°í™” ì‹œë„ (ì‚¬ìš©ì í”¼ë“œë°±ìš©)
                            await CloudManager.push(updated);
                            syncMsg += "\nâ˜ï¸ í´ë¼ìš°ë“œ ë°±ì—… ì™„ë£Œ";
                        } catch (e) {
                            console.error(e);
                            syncMsg += "\nâš ï¸ í´ë¼ìš°ë“œ ë°±ì—… ì‹¤íŒ¨";
                        }
                    } else {
                        // syncMsg += "\n(í´ë¼ìš°ë“œ ë¯¸ì—°ê²°)"; // ë„ˆë¬´ ê¸´ ë©”ì‹œì§€ ìƒëµ
                    }

                    if (results.length > 0) {
                        const uniqueDates = [...new Set(results.map(r => r.date))];
                        
                        // [Fix] ì—¬ëŸ¬ ë‚ ì§œê°€ í¬í•¨ëœ ê²½ìš° 'ì „ì²´ ë³´ê¸°' ëª¨ë“œë¡œ ì „í™˜
                        if (uniqueDates.length > 1) {
                            setTargetDate('all');
                            setForm(prev => ({ ...prev, date: uniqueDates[0] })); // í¼ì—ëŠ” ì²«ë²ˆì§¸ ë‚ ì§œ í‘œì‹œ
                        } else {
                            const uploadedDate = results[0].date;
                            setTargetDate(uploadedDate);
                            setForm(prev => ({ ...prev, date: uploadedDate }));
                        }
                        
                        // [Fix] ì—…ë¡œë“œ ì‹œ ê´€ë¦¬ì í•„í„° ì´ˆê¸°í™” (ìˆ¨ê²¨ì§„ ë°ì´í„° ë°©ì§€)
                        setAdminDriverFilter('all');

                        let dateMsg = "";
                        if (uniqueDates.length > 1) {
                             dateMsg = `\nğŸ“… ${uniqueDates.length}ì¼ì¹˜ ë°ì´í„°ê°€ í†µí•©ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ì „ì²´ ë‚ ì§œ ë³´ê¸° ëª¨ë“œë¡œ ì „í™˜ë¨)`;
                        }

                        alert(`ì—‘ì…€ ì—…ë¡œë“œ ì™„ë£Œ! (ì‹ ê·œ ${newCount}ê±´, ì—…ë°ì´íŠ¸ ${updateCount}ê±´)${syncMsg}${dateMsg}`);
                    } else {
                        alert("ì—…ë¡œë“œëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    }

                } catch(err) {
                    console.error(err);
                    alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message}`);
                } finally {
                    setLoading(false);
                    e.target.value = '';
                }
            }

            // [ê¸°ëŠ¥] ì¶œë°œì§€ ì„¤ì •
            async function handleSetStartPoint() {
                const addr = prompt("ì¶œë°œì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”:", startPoint?.address || "");
                if (addr) {
                    const coords = await geocodeAddress(addr);
                    const newStart = { ...coords, address: addr };
                    setStartPoint(newStart);
                    StorageManager.set('mvp_start_point', newStart);
                }
            }

            // [ê¸°ëŠ¥] GPSë¡œ ì¶œë°œì§€ ì„¤ì •
            function handleGPSStartPoint() {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const coords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    // ì—­ì§€ì˜¤ì½”ë”© ìƒëµ (ë‹¨ìˆœ ì¢Œí‘œ ì‚¬ìš©)
                    const newStart = { ...coords, address: 'í˜„ì¬ ìœ„ì¹˜ (GPS)' };
                    setStartPoint(newStart);
                    StorageManager.set('mvp_start_point', newStart);
                }, () => alert("ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."));
            }

            // [ê¸°ëŠ¥] ì¢Œí‘œ ë³´ì • (ì„œìš¸ ì ë¦¼ í˜„ìƒ ìˆ˜ì •)
            async function fixCoordinates() {
                if (!confirm("ëª¨ë“  ë°°ì†¡ì§€ì˜ ì¢Œí‘œë¥¼ ì¬ê²€ì¦í•˜ê³  ë³´ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹œê°„ì´ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)")) return;
                
                setLoading(true);
                const updated = [...deliveries];
                let fixCount = 0;

                // ìˆœì°¨ ì²˜ë¦¬
                for (let i = 0; i < updated.length; i++) {
                    const d = updated[i];
                    const isSeoulDefault = d.lat === 37.5665 && d.lng === 126.9780;
                    const addressHasSeoul = d.address.includes('ì„œìš¸');
                    
                    // ì„œìš¸ì´ ì•„ë‹Œë° ì„œìš¸ ì‹œì²­ ì¢Œí‘œ(ê¸°ë³¸ê°’)ë¥¼ ê°€ì§„ ê²½ìš° ì¬ê²€ì¦
                    if (isSeoulDefault && !addressHasSeoul) {
                        const newCoords = await geocodeAddress(d.address);
                        // ì¢Œí‘œê°€ ë³€ê²½ë˜ì—ˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                        if (newCoords.lat !== d.lat || newCoords.lng !== d.lng) {
                            updated[i] = { ...d, ...newCoords };
                            fixCount++;
                        }
                    }
                }

                if (fixCount > 0) {
                    setDeliveries(updated);
                    StorageManager.saveDeliveries(updated);
                    alert(`${fixCount}ê±´ì˜ ì¢Œí‘œê°€ ë³´ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    alert("ë³´ì •ì´ í•„ìš”í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
                setLoading(false);
            }

            // [ê¸°ëŠ¥] ë°°ì†¡ ê±´ ì‚­ì œ
            function deleteDelivery(ids) {
                if(confirm('ì„ íƒí•œ ë°°ì†¡ ê±´ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    const newDeliveries = deliveries.filter(d => !ids.includes(d.id));
                    setDeliveries(newDeliveries);
                    StorageManager.saveDeliveries(newDeliveries);
                    setToastMsg("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            }

            // [ê¸°ëŠ¥] ìƒí’ˆ ì²´í¬ í† ê¸€
            function toggleItemCheck(oid, oidx) {
                setDeliveries(prev => {
                    const next = prev.map(d => {
                        if (d.id === oid) {
                            if (oidx === -1) {
                                // ë‹¨ì¼ ìƒí’ˆ ëª¨ë“œ
                                return { ...d, checked: !d.checked };
                            } else if (d.detail_items && d.detail_items[oidx]) {
                                // ìƒì„¸ í’ˆëª© ëª¨ë“œ
                                const newItems = [...d.detail_items];
                                newItems[oidx] = { ...newItems[oidx], checked: !newItems[oidx].checked };
                                return { ...d, detail_items: newItems };
                            }
                        }
                        return d;
                    });
                    StorageManager.saveDeliveries(next);
                    return next;
                });
            }

            // [ê¸°ëŠ¥] ê·¸ë£¹ì— ìƒí’ˆ ì¶”ê°€ (ì²« ë²ˆì§¸ ì›ë³¸ì— ìƒì„¸ í’ˆëª©ìœ¼ë¡œ ì¶”ê°€)
            function addGroupItem(ids) {
                if (!ids || ids.length === 0) return;
                const targetId = ids[0];
                setDeliveries(prev => {
                    const next = prev.map(d => {
                        if (d.id === targetId) {
                            let items = d.detail_items ? [...d.detail_items] : null;
                            if (!items) {
                                // ê¸°ì¡´ ë‹¨ì¼ í•­ëª©ì„ ìƒì„¸ë¡œ ìŠ¹ê²©
                                items = [{ item: d.item || 'ìƒí’ˆ', checked: !!d.checked, settlement_amount: d.settlement_amount || 0 }];
                            }
                            items.push({ item: 'ìƒí’ˆ', checked: false, settlement_amount: 0 });
                            return { ...d, detail_items: items };
                        }
                        return d;
                    });
                    StorageManager.saveDeliveries(next);
                    return next;
                });
                setToastMsg('ğŸ“¦ ìƒí’ˆì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');
            }

            function openAddItemForm() {
                setAddForm({ date: targetDate || '', phone: '', address: '', item: '' });
                setShowAddItemModal(true);
            }

            function handleAddItemSubmit() {
                const { date, phone, address, item } = addForm;
                if (!date || !phone || !address || !item) {
                    alert('ë°°ì†¡ë‚ ì§œ, ì „í™”ë²ˆí˜¸, ì£¼ì†Œ, í’ˆëª©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                const newDelivery = {
                    id: crypto.randomUUID(),
                    date,
                    item,
                    address,
                    phone,
                    driver: currentUser || '',
                    settlement_amount: 0,
                    completed: false,
                    canceled: false,
                    time: '',
                    duration: 30,
                };
                const next = [newDelivery, ...deliveries];
                setDeliveries(next);
                StorageManager.saveDeliveries(next);
                setShowAddItemModal(false);
                setToastMsg('âœ… ê°œë³„ ìƒí’ˆì„ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.');
            }

            // [ê¸°ëŠ¥] í…ŒìŠ¤íŠ¸ ë°ì´í„° ë¡œë“œ (12ê±´)
            function handleLoadTestData() {
                const today = new Date().toISOString().split('T')[0];
                const testData = [
                    // ì„œìš¸ (10ê±´)
                    { address: "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™ 123-45", item: "ì¹¨ëŒ€ í”„ë ˆì„", phone: "010-1111-2222" },
                    { address: "ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬ ë°˜í¬ë™ 50-1", item: "ì†ŒíŒŒ 3ì¸ìš©", phone: "010-3333-4444" },
                    { address: "ì„œìš¸ ì†¡íŒŒêµ¬ ì ì‹¤ë™ 22", item: "ì‹íƒ ì„¸íŠ¸", phone: "010-5555-6666" },
                    { address: "ì„œìš¸ ë§ˆí¬êµ¬ ë§ì›ë™ 400", item: "ì±…ìƒ", phone: "010-7777-8888" },
                    { address: "ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬ ì—¬ì˜ë„ë™ 1", item: "ì˜ì 4ê°œ", phone: "010-9999-0000" },
                    { address: "ì„œìš¸ ì¢…ë¡œêµ¬ í˜œí™”ë™ 90", item: "ì„œëì¥", phone: "010-1212-3434" },
                    { address: "ì„œìš¸ ì¤‘êµ¬ ëª…ë™ 10", item: "ê±°ì‹¤ì¥", phone: "010-5656-7878" },
                    { address: "ì„œìš¸ ìš©ì‚°êµ¬ ì´íƒœì›ë™ 300", item: "í™”ì¥ëŒ€", phone: "010-9090-1212" },
                    { address: "ì„œìš¸ ì„±ë™êµ¬ ì„±ìˆ˜ë™ 1ê°€ 10", item: "ë§¤íŠ¸ë¦¬ìŠ¤ Q", phone: "010-3434-5656" },
                    { address: "ì„œìš¸ ê°•ë™êµ¬ ì²œí˜¸ë™ 55", item: "ì˜·ì¥", phone: "010-7878-9090" },
                    // ë¹„ì„œìš¸ (2ê±´)
                    { address: "ê²½ê¸°ë„ ì„±ë‚¨ì‹œ ë¶„ë‹¹êµ¬ íŒêµë™ 500", item: "ì‚¬ë¬´ìš© ì˜ì", phone: "010-1122-3344" },
                    { address: "ì¸ì²œê´‘ì—­ì‹œ ì—°ìˆ˜êµ¬ ì†¡ë„ë™ 10-1", item: "ê²Œì´ë° ì±…ìƒ", phone: "010-5566-7788" },
                ];

                if(!confirm("ê¸°ì¡´ ë°ì´í„°ë¥¼ ì§€ìš°ê³  í…ŒìŠ¤íŠ¸ ë°ì´í„°(12ê±´)ë¥¼ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                
                setLoading(true);
                Promise.all(testData.map(async (d, i) => {
                    const coords = await geocodeAddress(d.address);
                    return {
                        id: crypto.randomUUID(),
                        date: today,
                        time: `ì˜¤ì „ ${9 + i}:00`,
                        item: d.item,
                        phone: d.phone,
                        address: d.address,
                        settlement_amount: (i + 5) * 10000, // í…ŒìŠ¤íŠ¸ìš© ê¸ˆì•¡
                        install_fee: (i % 2) * 5000,
                        yangjung: (i % 3 === 0) ? 10000 : 0,
                        naerim: 0,
                        ...coords
                    };
                })).then(results => {
                    setDeliveries(results);
                    StorageManager.saveDeliveries(results);
                    alert("í…ŒìŠ¤íŠ¸ ë°ì´í„° 12ê±´ ë¡œë“œ ì™„ë£Œ!");
                    setLoading(false);
                    // ìë™ ê²€ì¦ ì‹¤í–‰
                    setTimeout(handleVerifyData, 500);
                });
            }

            // [ê¸°ëŠ¥] ì£¼ì†Œ ê²€ì¦ ë° ë¦¬í¬íŠ¸
            function handleVerifyData() {
                if (verificationReport) {
                    const { date, logs, totalRows, mergedCount } = verificationReport;
                    const logContent = logs.map(l => 
                        `âš ï¸ [${l.type}] ${l.msg}\n   - ëŒ€ìƒ: ${l.phone}\n   - ì£¼ì†Œ ëª©ë¡:\n${l.details.map(a => `     â€¢ "${a}"`).join('\n')}`
                    ).join('\n\n');

                    const reportText = `
[ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ë¦¬í¬íŠ¸]
- ê²€ì¦ ì¼ì‹œ: ${new Date(date).toLocaleString()}
- ì´ ë°ì´í„° í–‰: ${totalRows}ê±´
- ìµœì¢… ë³‘í•©ëœ ë°°ì†¡ ê±´ìˆ˜: ${mergedCount}ê±´
- ë°œê²¬ëœ ë¶ˆì¼ì¹˜ ì´ìŠˆ: ${logs.length}ê±´

[ì´ìŠˆ ìƒì„¸ ë‚´ì—­]
${logContent}

* ìœ„ ë‚´ì—­ì€ "ë™ì¼ ì—°ë½ì²˜ì´ë‚˜ ì£¼ì†Œê°€ ë¯¸ì„¸í•˜ê²Œ ë‹¬ë¼(ê³µë°±/íŠ¹ìˆ˜ë¬¸ì ë“±)"
  ì‹œìŠ¤í…œì´ ë³„ë„ ë°°ì†¡ ê±´ìœ¼ë¡œ ë¶„ë¦¬í•œ ì¼€ì´ìŠ¤ì…ë‹ˆë‹¤.
* ë™ì¼ ê±´ìœ¼ë¡œ ì²˜ë¦¬í•˜ë ¤ë©´ ì—‘ì…€ ì›ë³¸ì˜ ì£¼ì†Œë¥¼ 100% ì¼ì¹˜ì‹œì¼œ ì¬ì—…ë¡œë“œí•˜ì„¸ìš”.
                    `;
                    alert(reportText);
                    console.log(reportText);
                    return;
                }
                
                // ê¸°ì¡´ ë‹¨ìˆœ ê²€ì¦ ë¡œì§ ìœ ì§€ (ë¦¬í¬íŠ¸ ì—†ì„ ë•Œ)
                const targetList = deliveries.filter(d => d.date === form.date); 
                if (targetList.length === 0) { alert(`${form.date} ë‚ ì§œì— ê²€ì¦í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`); return; }
                alert("ìµœê·¼ ì—…ë¡œë“œëœ ì—‘ì…€ íŒŒì¼ ê²€ì¦ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•˜ë©´ ê²€ì¦ì´ ìˆ˜í–‰ë©ë‹ˆë‹¤.");
            }

            // [ê¸°ëŠ¥] ì‹œê°„ ìŠ¬ë¡¯ ìƒì„± (09:00 ~ 20:00, 30ë¶„ ë‹¨ìœ„)
            const TIME_SLOTS = [];
            for(let h=8; h<=20; h++) {
                TIME_SLOTS.push(`${h.toString().padStart(2,'0')}:00`);
                if(h !== 20) TIME_SLOTS.push(`${h.toString().padStart(2,'0')}:30`);
            }

            // [ê¸°ëŠ¥] ì‹œê°„ ì¶©ëŒ í™•ì¸
            const checkTimeConflict = (newTime, duration, currentIds) => {
                if (!newTime) return false;
                const parse = t => {
                    const [h, m] = t.split(':').map(Number);
                    return h * 60 + m;
                };
                const newStart = parse(newTime);
                const newEnd = newStart + duration;

                return groupedDeliveries.some(g => {
                    if (g.canceled || g.completed) return false;
                    if (g.ids.some(id => currentIds.includes(id))) return false; // ìê¸° ìì‹  ì œì™¸
                    const gTime = g.time;
                    if (!gTime) return false;
                    const gStart = parse(gTime);
                    const gEnd = gStart + (g.duration || 30);
                    
                    return (newStart < gEnd && newEnd > gStart);
                });
            };

            // [ê¸°ëŠ¥] ì‹œê°„ ë³€ê²½ í•¸ë“¤ëŸ¬ (ë‚´ë¶€ ê´€ë¦¬ìš©)
            // ì£¼ì˜: ê³ ê° ì•Œë¦¼ ë°œì†¡ ë¡œì§ì€ í¬í•¨ë˜ì§€ ì•ŠìŒ (ë‚´ë¶€ ìŠ¤ì¼€ì¤„ë§ ì „ìš©)
            const handleTimeSelect = (ids, newTime, duration) => {
                if (checkTimeConflict(newTime, duration, ids)) {
                    alert("âš ï¸ ì„ íƒí•œ ì‹œê°„ëŒ€ëŠ” ì´ë¯¸ ë‹¤ë¥¸ ë°°ì†¡ ì¼ì •ê³¼ ê²¹ì¹©ë‹ˆë‹¤.");
                    return;
                }
                updateGroupStatus(ids, { time: newTime });
                
                // [Log] ë‚´ë¶€ ì‹œìŠ¤í…œ ë¡œê·¸ (ê³ ê° ì•Œë¦¼ ë¯¸ë°œì†¡ í™•ì¸ìš©)
                console.log(`[Internal Schedule] Time updated to ${newTime} for IDs: ${ids.join(', ')}`);
                console.log(`[Notification Check] Customer notification skipped (Policy: Internal Scheduling Only).`);
            };

            // [Test] ì˜ˆì•½ ì‹œìŠ¤í…œ ê²€ì¦ ë„êµ¬ (Consoleì—ì„œ ì‹¤í–‰ ê°€ëŠ¥)
            window.TestReservationSystem = {
                verifyNotificationSuppression: () => {
                    console.group("ğŸ§ª [Test] Reservation Notification Suppression");
                    console.log("Step 1: Updating schedule time...");
                    // Mock ID check
                    const testId = deliveries[0]?.id;
                    if(!testId) {
                        console.warn("No deliveries found to test.");
                        console.groupEnd();
                        return;
                    }
                    
                    // Spy on alert/console
                    const originalAlert = window.alert;
                    let alertCalled = false;
                    window.alert = (msg) => { 
                        if(msg.includes("ê³ ê°ì—ê²Œ")) alertCalled = true; 
                        else originalAlert(msg);
                    };

                    // Trigger update (Mock call)
                    console.log(`Triggering update for ID: ${testId} to 10:00`);
                    handleTimeSelect([testId], "10:00", 30);

                    // Verify
                    if(!alertCalled) {
                        console.log("âœ… PASS: No customer notification alert was triggered.");
                    } else {
                        console.error("âŒ FAIL: Customer notification alert was triggered!");
                    }
                    
                    // Restore
                    window.alert = originalAlert;
                    console.groupEnd();
                    return "Test Complete";
                }
            };

            if (fatalError) return <div className="p-8 text-center text-red-600 font-bold">ì˜¤ë¥˜ ë°œìƒ: {fatalError}</div>;

            if (!isLoggedIn) return <LoginScreen onLogin={(role, name) => {
                setIsLoggedIn(true);
                setView(role);
                setCurrentUser(name);
                if (role === 'driver' && name) {
                    localStorage.setItem('delivery_app_session_driver', name);
                }
            }} />;

            return (
                <div className="min-h-screen bg-slate-50 max-w-[480px] mx-auto shadow-2xl border-x border-slate-200">
                    {/* Header */}
                    <header className="sticky top-0 z-50 bg-white border-b border-slate-200"> 
                        <div className="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between relative"> 
                            
                            <div className="flex items-center gap-3"> 
                                <div className="w-12 h-12 rounded-xl bg-indigo-600 flex items-center justify-center text-white text-2xl shadow"> 
                                    ğŸšš 
                                </div> 
                                <div> 
                                    <h1 
                                        onClick={() => {
                                            // [Secret] 5íšŒ ì—°ì† í´ë¦­ ì‹œ ê´€ë¦¬ì ëª¨ë“œ ì§„ì… ì‹œë„
                                            if (view === 'driver') {
                                                const now = Date.now();
                                                const lastClick = window._lastLogoClick || 0;
                                                const clickCount = (window._logoClickCount || 0) + (now - lastClick < 1000 ? 1 : -window._logoClickCount + 1);
                                                
                                                window._lastLogoClick = now;
                                                window._logoClickCount = clickCount;

                                                if (clickCount === 5) {
                                                    const pwd = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
                                                    if (pwd === '1234') {
                                                        setView('admin');
                                                        window._logoClickCount = 0;
                                                    } else if (pwd !== null) {
                                                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                                                    }
                                                }
                                            }
                                        }}
                                        className="text-lg font-black text-slate-900 leading-tight cursor-pointer select-none"
                                    > 
                                        ë°°ì†¡ ë§ˆìŠ¤í„° 
                                    </h1> 
                                    <p className="text-xs text-slate-500"> 
                                        {currentUser} ê¸°ì‚¬ë‹˜ 
                                    </p> 
                                </div> 
                            </div> 
                            
                            <div className="flex items-center gap-2">
                                {view === 'driver' && (
                                    <button type="button" className="px-2 py-0 rounded-lg bg-transparent text-slate-700 text-[11px] font-bold text-right leading-tight">
                                        <span className="block leading-none text-[10px]">ì˜¤ëŠ˜ ë¹„ìš© í•©ê³„</span>
                                        <span className="block text-[13px] font-black opacity-90">
                                            {(() => {
                                                const list = deliveries.filter(d => d.date === targetDate && d.driver === currentUser);
                                                const total = list.reduce((s, d) => s + (d.install_fee || 0) + ((d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0)), 0);
                                                return `${total.toLocaleString()}ì›`;
                                            })()}
                                        </span>
                                    </button>
                                )}
                                <button 
                                    onClick={() => setShowMenu(v => !v)} 
                                    className="w-10 h-10 rounded-lg bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-xl" 
                                > 
                                    â˜° 
                                </button> 
                            </div>
                            
                            {/* Menu Dropdown */}
                            {showMenu && (
                                <div className="absolute right-4 top-16 w-56 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-50 animate-fade-in">
                                    <div className="p-1">
                                        <button onClick={handleUpdateStartPoint} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                            <span>ğŸ¢</span> ì¶œë°œì§€ ì„¤ì •
                                        </button>
                                        <button onClick={handleUpdateEndPoint} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                            <span>ğŸ </span> ë„ì°©ì§€(í™ˆ) ì„¤ì •
                                        </button>
                                        <button onClick={() => {
                                            setShowMenu(false);
                                            setShowMonthlyCostModal(true);
                                        }} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                            <span>ğŸ“Š</span> ì›”ë³„ ë¹„ìš© í•©ê³„
                                        </button>
                                        <button onClick={handleBackupData} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-700 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                            <span>ğŸ’¾</span> ë°ì´í„° ë°±ì—… (ì €ì¥)
                                        </button>
                                        <div className="h-px bg-slate-100 my-1"></div>
                                        <button onClick={() => {
                                            setShowMenu(false);
                                            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                                localStorage.removeItem('delivery_app_session_driver');
                                                setIsLoggedIn(false);
                                                setCurrentUser(null);
                                                setView('driver');
                                            }
                                        }} className="w-full text-left px-4 py-3 text-sm font-bold text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2">
                                            <span>ğŸšª</span> ë¡œê·¸ì•„ì›ƒ
                                        </button>
                                        {view === 'admin' && (
                                            <button onClick={() => {
                                                setShowMenu(false);
                                                setCurrentUser(null);
                                                setIsLoggedIn(false);
                                                localStorage.removeItem('delivery_app_session_driver');
                                                setView('driver');
                                            }} className="w-full text-left px-4 py-3 text-sm font-bold text-indigo-900 hover:bg-sky-50 rounded-lg flex items-center gap-2">
                                                <span>ğŸšš</span> ê¸°ì‚¬ ëª¨ë“œ ì „í™˜
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div> 
                    </header>

                    <div className="px-4 py-2 max-w-5xl mx-auto">
                        {/* [New] ê¸°ì‚¬ ëª¨ë“œ ë¹„ìš© ìš”ì•½ (ì ‘ê¸° ëª¨ë“œ ì ìš©) */}
                        {view === 'driver' && null}

                        {/* [New] ë‚ ì§œ ë° ì§€ë„ ì»¨íŠ¸ë¡¤ (í—¤ë”) */}
                        {view === 'driver' && (
                            <>
                                {view === 'driver' && notice && (
                                    <div className="mt-2 w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 shadow-sm overflow-hidden relative flex items-center gap-2">
                                        <span className="font-bold mr-2 whitespace-nowrap bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs z-10">ê³µì§€</span>
                                        <div className="overflow-hidden w-full relative h-5">
                                            <div className="whitespace-nowrap absolute animate-marquee top-0">
                                                {notice}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="mt-1 animate-fade-in">
                                    <input 
                                        type="date" 
                                        className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-xs font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm text-center tracking-tighter"
                                        value={targetDate} 
                                        onChange={e => setTargetDate(e.target.value)} 
                                    />
                                </div>
                                
                                <Card className="mt-2 mb-4 animate-fade-in"> 
                                   <div className="flex items-center justify-between flex-nowrap gap-2"> 
                                     <div className="flex-1 min-w-0"> 
                                       <h3 className="font-bold text-slate-800 text-base"> 
                                         ğŸš¦ ì˜¤ëŠ˜ ë°°ì†¡ í˜„í™© 
                                       </h3> 
                                      <p className="text-xs md:text-sm text-slate-500 truncate"> 
                                        {(() => {
                                          const remaining = groupedDeliveries.filter(d => !d.completed && !d.canceled).length;
                                          const done = groupedDeliveries.filter(d => d.completed).length;
                                          const postponed = groupedDeliveries.filter(d => d.canceled && d.cancel_type === 'postpone').length;
                                          const canceled = groupedDeliveries.filter(d => d.canceled && d.cancel_type !== 'postpone').length;
                                          return (
                                            <>
                                              <span>ëŒ€ê¸° </span>
                                              <span className="font-bold text-rose-600">{remaining}</span>
                                              <span> Â· ì™„ë£Œ </span>
                                              <span className="font-bold text-green-600">{done}</span>
                                              <span> Â· ì—°ê¸° </span>
                                              <span className="font-bold text-amber-600">{postponed}</span>
                                              <span> Â· ì·¨ì†Œ </span>
                                              <span className="font-bold text-red-600">{canceled}</span>
                                            </>
                                          );
                                        })()}
                                      </p> 
                                     </div> 
                                 
                                    <div className="flex items-center gap-2 shrink-0">
                                      <button 
                                        onClick={() => setShowMap(v => !v)} 
                                        className="px-4 py-2 rounded-lg bg-indigo-600 text-white font-bold text-sm shadow hover:bg-indigo-700 whitespace-nowrap" 
                                      > 
                                        {showMap ? 'ëª©ë¡ ë³´ê¸°' : 'ì§€ë„ ë³´ê¸°'} 
                                      </button> 
                                    </div>
                                   </div> 
                                 </Card>
                            </>
                        )}

                        

                        

                        
                    </div>

                    <main className="px-4 pb-32 max-w-7xl mx-auto pt-0">
                        {/* ê´€ë¦¬ì ìš”ì•½ ë° ê´‘ê³  */}
                        {view === 'admin' && ( 
                           <div className="space-y-4 mb-6"> 
                             {/* ê´€ë¦¬ì ìš”ì•½ */} 
                             <Card> 
                               <div className="grid grid-cols-3 gap-4 text-center"> 
                                 <div> 
                                   <p className="text-xs text-slate-500">ì´ ë°°ì†¡</p> 
                                   <p className="text-2xl font-black text-slate-900"> 
                                     {deliveries.length} 
                                   </p> 
                                 </div> 
                                 <div> 
                                   <p className="text-xs text-slate-500">ì™„ë£Œ</p> 
                                   <p className="text-2xl font-black text-emerald-600"> 
                                     {deliveries.filter(d => d.completed).length} 
                                   </p> 
                                 </div> 
                                 <div> 
                                  <p className="text-xs text-slate-500">ëŒ€ê¸°</p> 
                                   <p className="text-2xl font-black text-rose-600"> 
                                     {deliveries.filter(d => !d.completed).length} 
                                   </p> 
                                 </div> 
                               </div> 
                             </Card> 
                         
                             {/* ğŸ“¢ ê´‘ê³  â‘  */} 
                             <AdBanner 
                               slot="1234567890" 
                               className="rounded-xl overflow-hidden" 
                             /> 
                           </div> 
                         )}

                        {/* ê´€ë¦¬ì ëª¨ë“œ */}
                        {view === 'admin' && (
                            <div className="grid grid-cols-12 gap-2 animate-fade-in pb-20">

                                {/* [New] ê³µì§€ì‚¬í•­ ê´€ë¦¬ */}
                                <div className="col-span-12 bg-sky-50 p-2 rounded-xl border border-sky-100 flex flex-col gap-1 items-center">
                                    <div className="font-bold text-indigo-900 whitespace-nowrap flex items-center gap-2 text-xs">
                                        ê³µì§€ì‚¬í•­ ì„¤ì •
                                    </div>
                                    <div className="flex-1 w-full flex gap-2">
                                        <input 
                                            type="text" 
                                            className="flex-1 min-w-0 border border-indigo-200 rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                            placeholder="ê¸°ì‚¬ë‹˜ë“¤ì—ê²Œ ë³´ë‚¼ ê³µì§€ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."
                                            value={notice}
                                            onChange={(e) => setNotice(e.target.value)}
                                        />
                                        <button 
                                            onClick={() => handleNoticeSave(notice)}
                                            className="bg-indigo-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-indigo-700 whitespace-nowrap shrink-0"
                                        >
                                            ì €ì¥
                                        </button>
                                        <button 
                                            onClick={() => handleNoticeSave('')}
                                            className="bg-white text-red-500 border border-red-200 px-3 py-2 rounded text-sm font-bold hover:bg-red-50 whitespace-nowrap shrink-0"
                                        >
                                            ì‚­ì œ
                                        </button>
                                    </div>
                                </div>
                                
                                {/* [New] ê¸°ì‚¬ë³„ í•„í„° (ê´€ë¦¬ì ì „ìš©) */}
                                <section className="col-span-12 space-y-6 mb-8">
                                    <h2 className="text-lg font-black text-slate-900">
                                        ğŸ“Š ìš´ì˜ í†µê³„
                                    </h2>

                                    {/* [New] ì˜¤ëŠ˜ ë°°ì†¡ ìš”ì•½ */}
                                    <Card>
                                        <h3 className="font-bold text-slate-800 mb-3">
                                            ğŸ“… ì˜¤ëŠ˜ ë°°ì†¡ ìš”ì•½
                                        </h3>
                                        {(() => {
                                            const todayStr = new Date().toISOString().split('T')[0];
                                            const yesterday = new Date();
                                            yesterday.setDate(yesterday.getDate() - 1);
                                            const yesterdayStr = yesterday.toISOString().split('T')[0];
                                            
                                            const todayCompleted = deliveries.filter(d => d.date === todayStr && d.completed).length;
                                            const yesterdayCompleted = deliveries.filter(d => d.date === yesterdayStr && d.completed).length;

                                            return (
                                                <div className="grid grid-cols-2 gap-4 text-center">
                                                    <div className="bg-slate-50 rounded-xl py-4">
                                                        <p className="text-xs text-slate-500">ì˜¤ëŠ˜ ì™„ë£Œ</p>
                                                        <p className="text-2xl font-black text-indigo-600">
                                                            {todayCompleted}
                                                        </p>
                                                    </div>

                                                    <div className="bg-slate-50 rounded-xl py-4">
                                                        <p className="text-xs text-slate-500">ì–´ì œ ì™„ë£Œ</p>
                                                        <p className="text-2xl font-black text-slate-400">
                                                            {yesterdayCompleted}
                                                        </p>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </Card>

                                    {/* [New] ìš”ì¼ë³„ ë°°ì†¡ëŸ‰ (ë°” ì°¨íŠ¸) */}
                                    <Card> 
                                        <h3 className="font-bold text-slate-800 mb-3"> 
                                            ğŸ“ˆ ìš”ì¼ë³„ ë°°ì†¡ëŸ‰ 
                                        </h3> 
                                        {(() => {
                                            const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
                                            const weeklyStats = days.map((day, index) => {
                                                const count = deliveries.filter(d => {
                                                    if (!d.date) return false;
                                                    const parts = d.date.split('-');
                                                    if (parts.length !== 3) return false;
                                                    const date = new Date(parts[0], parts[1] - 1, parts[2]);
                                                    return date.getDay() === index;
                                                }).length;
                                                return { name: day, count };
                                            });
                                            const max = Math.max(1, ...weeklyStats.map(w => w.count));

                                            return (
                                                <div className="h-24 flex items-end justify-between gap-2 px-1">
                                                    {weeklyStats.map(w => (
                                                        <div key={w.name} className="flex-1 flex flex-col items-center gap-1">
                                                            <div 
                                                                className="w-full rounded-sm shadow-sm"
                                                                style={{ 
                                                                    height: `${Math.max(6, Math.round((w.count / max) * 100))}%`,
                                                                    backgroundColor: `rgba(239,68,68, ${Math.max(0.35, (w.count / max))})`
                                                                }}
                                                                title={`${w.name} ${w.count}ê±´`}
                                                            />
                                                            <span className="text-[10px] text-slate-500">{w.name}</span>
                                                            <span className="text-[10px] font-bold text-slate-700">{w.count}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            );
                                        })()}
                                    </Card>

                                    {/* [New] ìš´ì˜ ì¸ì‚¬ì´íŠ¸ */}
                                    <Card className="border-indigo-200 bg-indigo-50"> 
                                       <h3 className="font-black text-indigo-900 mb-2"> 
                                         ğŸ’¡ ìš´ì˜ ì¸ì‚¬ì´íŠ¸ 
                                       </h3> 
                                       <ul className="text-sm text-indigo-800 space-y-1"> 
                                         <li>â€¢ ì˜¤ì „ 10~12ì‹œ ë°°ì†¡ ì™„ë£Œìœ¨ ìµœê³ </li> 
                                         <li>â€¢ ì›”ìš”ì¼ ë°°ì†¡ëŸ‰ì´ í‰ê· ë³´ë‹¤ 23% ë§ìŒ</li> 
                                         <li>â€¢ ì§€ë„ ì‚¬ìš©ë¥  ë†’ì€ ê¸°ì‚¬ = í´ë ˆì„ ë‚®ìŒ</li> 
                                       </ul> 
                                     </Card>
                                    
                                    {/* ê¸°ì‚¬ë³„ í•„í„° */}
                                    

                                    {/* 2. [Card] ê¸ˆì¼ ë¹„ìš© ì§‘ê³„ */}
                                    <Card 
                                        className=""
                                    title={
                                        <div className="flex items-center gap-3">
                                            <input type="date" className="bg-transparent border-none p-0 text-xl font-bold text-slate-800 focus:ring-0 cursor-pointer" 
                                                value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                                            <label className="flex items-center gap-1 text-xs text-slate-500 cursor-pointer bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 transition select-none">
                                                <input type="checkbox" checked={showAllDates} onChange={e => setShowAllDates(e.target.checked)} className="rounded text-indigo-600 focus:ring-indigo-500 w-4 h-4" />
                                                <span>ì „ì²´ë³´ê¸°</span>
                                            </label>
                                        </div>
                                    }
                                    description="ì‹¤ì‹œê°„ í˜„ì¥ ë¹„ìš© í˜„í™©"
                                >
                                        {(() => {
                                            const stats = groupedDeliveries.reduce((acc, g) => {
                                                if (g.completed) acc.completed++;
                                                else if (g.canceled) {
                                                    if (g.cancel_type === 'postpone') acc.postponed++;
                                                    else acc.canceled++;
                                                }
                                                else if (g.partial) acc.partial++;
                                                return acc;
                                            }, { completed: 0, canceled: 0, postponed: 0, partial: 0 });
                                            return (
                                                <div className="mb-3 flex flex-wrap justify-center gap-2 text-xs font-medium">
                                                    <span className="text-green-700 bg-green-100 px-2 py-0.5 rounded">ì™„ë£Œ {stats.completed}</span>
                                                    <span className="text-red-700 bg-red-100 px-2 py-0.5 rounded">ì·¨ì†Œ {stats.canceled}</span>
                                                    <span className="text-amber-700 bg-amber-100 px-2 py-0.5 rounded">ì—°ê¸° {stats.postponed}</span>
                                                    <span className="text-blue-700 bg-blue-100 px-2 py-0.5 rounded">ë¶€ë¶„ {stats.partial}</span>
                                                    <span className="text-slate-700 px-2 py-0.5 rounded">ì´ {groupedDeliveries.length}ê±´</span>
                                                </div>
                                            );
                                        })()}
                                    {(() => {
                                        // [ìˆ˜ì •] ëª¨ë“  ì‚¬ìš©ìê°€ ì „ì²´ ê¸°ì‚¬ë“¤ì˜ ë¹„ìš© í•©ê³„ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡ í•¨ (Leaderboard)
                                        // [New] ì „ì²´ ë³´ê¸° ëª¨ë“œ ì§€ì›
                                        const allDailyDeliveries = deliveries.filter(d => showAllDates || d.date === form.date);
                                        
                                        const driverStats = {};
                                        allDailyDeliveries.forEach(d => {
                                            const dName = d.driver || 'ë¯¸ë°°ì •';
                                            const sum = (d.install_fee||0)+(d.yangjung||0)+(d.naerim||0)+(d.etc_fee||0);
                                            driverStats[dName] = (driverStats[dName] || 0) + sum;
                                        });
                                        const sorted = Object.entries(driverStats).sort((a,b) => b[1] - a[1]);

                                        // ìƒì„¸ ë° í•©ê³„ í‘œì‹œ ëŒ€ìƒ ê²°ì •
                                        let targetDriver = null;
                                        let targetTitle = '';
                                        let targetDeliveries = null;
                                        let grandTotal = allDailyDeliveries.reduce((a,c)=>a+(c.install_fee||0)+(c.yangjung||0)+(c.naerim||0)+(c.etc_fee||0),0);

                                        if (currentUser === 'admin' || view === 'admin') { // [Fix] ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œë„ ì „ì²´ í†µê³„ ë³´ê¸°
                                            if (adminDriverFilter === 'all') {
                                                targetDriver = null;
                                                targetTitle = 'ì „ì²´ ì´ í•©ê³„';
                                            } else if (adminDriverFilter === 'unassigned') {
                                                targetDriver = 'ë¯¸ë°°ì •';
                                                targetTitle = 'ë¯¸ë°°ì • í•©ê³„';
                                                targetDeliveries = allDailyDeliveries.filter(d => !d.driver);
                                            } else {
                                                targetDriver = adminDriverFilter;
                                                targetTitle = `${adminDriverFilter} ì´ í•©ê³„`;
                                                targetDeliveries = allDailyDeliveries.filter(d => d.driver === adminDriverFilter);
                                            }
                                        } else {
                                            targetDriver = currentUser;
                                            targetTitle = 'ë‚˜ì˜ ì´ í•©ê³„';
                                            targetDeliveries = allDailyDeliveries.filter(d => d.driver === currentUser);
                                        }

                                        const targetStats = targetDeliveries ? {
                                            install: targetDeliveries.reduce((a,c)=>a+(c.install_fee||0),0),
                                            yangjung: targetDeliveries.reduce((a,c)=>a+(c.yangjung||0),0),
                                            naerim: targetDeliveries.reduce((a,c)=>a+(c.naerim||0),0),
                                            etc: targetDeliveries.reduce((a,c)=>a+(c.etc_fee||0),0),
                                            total: targetDeliveries.reduce((a,c)=>a+(c.install_fee||0)+(c.yangjung||0)+(c.naerim||0)+(c.etc_fee||0),0)
                                        } : null;

                                        return (
                                            <details className="group/summary bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                                                <summary className="p-3 bg-slate-50 cursor-pointer list-none flex justify-between items-center select-none hover:bg-slate-100 transition-colors">
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-bold text-slate-700">ğŸ’° {targetTitle}</span>
                                                        <span className="text-lg font-black text-indigo-900">
                                                            {targetStats ? targetStats.total.toLocaleString() : grandTotal.toLocaleString()}ì›
                                                        </span>
                                                    </div>
                                                    <svg className="w-5 h-5 text-slate-400 transition-transform group-open/summary:rotate-180" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                        <path strokeLinecap="round" strokeLinejoin="round" d="M19 9l-7 7-7-7" />
                                                    </svg>
                                                </summary>
                                                <div className="p-4 border-t border-slate-100 animate-fade-in space-y-4 bg-white">
                                                    {/* 1. ê¸°ì‚¬ë³„ í•©ê³„ ë¦¬ìŠ¤íŠ¸ (Leaderboard) */}
                                                    <div className="space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                                                        {sorted.map(([name, val]) => (
                                                            <div key={name} className={`flex justify-between items-center p-3 rounded-lg ${name === targetDriver || (targetDriver === 'ë¯¸ë°°ì •' && name === 'ë¯¸ë°°ì •') ? 'bg-sky-50 border border-indigo-200' : 'bg-[#F4F5F7]'}`}>
                                                                <div className="flex items-center gap-2">
                                                                    <span className={`font-bold text-sm ${name === targetDriver || (targetDriver === 'ë¯¸ë°°ì •' && name === 'ë¯¸ë°°ì •') ? 'text-indigo-700' : 'text-slate-600'}`}>
                                                                        {name} {name === currentUser && '(ë‚˜)'}
                                                                    </span>
                                                                </div>
                                                                <span className={`font-bold ${name === targetDriver || (targetDriver === 'ë¯¸ë°°ì •' && name === 'ë¯¸ë°°ì •') ? 'text-indigo-700' : 'text-slate-800'}`}>{val.toLocaleString()}ì›</span>
                                                            </div>
                                                        ))}
                                                        {sorted.length === 0 && <div className="text-center text-gray-400 py-4">ë°ì´í„° ì—†ìŒ</div>}
                                                    </div>

                                                    {/* 2. ìƒì„¸ ë‚´ì—­ (ì„ íƒëœ ê¸°ì‚¬ ë˜ëŠ” ë³¸ì¸) */}
                                                    {targetStats && (
                                                        <div className="border-t border-slate-100 pt-4">
                                                            <div className="text-xs font-bold text-slate-400 mb-2 uppercase">ìƒì„¸ ë‚´ì—­</div>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <div className="bg-slate-50 p-2 rounded text-center">
                                                                    <div className="text-[10px] text-slate-500">ì„¤ì¹˜</div>
                                                                    <div className="font-bold text-slate-700">{targetStats.install.toLocaleString()}</div>
                                                                </div>
                                                                <div className="bg-slate-50 p-2 rounded text-center">
                                                                    <div className="text-[10px] text-slate-500">ì–‘ì¤‘</div>
                                                                    <div className="font-bold text-slate-700">{targetStats.yangjung.toLocaleString()}</div>
                                                                </div>
                                                                <div className="bg-slate-50 p-2 rounded text-center">
                                                                    <div className="text-[10px] text-slate-500">ë‚´ë¦¼</div>
                                                                    <div className="font-bold text-slate-700">{targetStats.naerim.toLocaleString()}</div>
                                                                </div>
                                                                <div className="bg-slate-50 p-2 rounded text-center">
                                                                    <div className="text-[10px] text-slate-500">ê¸°íƒ€</div>
                                                                    <div className="font-bold text-slate-700">{targetStats.etc.toLocaleString()}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </details>
                                        );
                                    })()}
                                </Card>

                                    {/* 3. [Card] ì›”ë³„ ì •ì‚° ê´€ë¦¬ */}
                                    <Card 
                                        className=""
                                    title={
                                        <input type="month" className="bg-transparent border-none p-0 text-xl font-bold text-slate-800 focus:ring-0 cursor-pointer" 
                                            value={settleMonth} onChange={e => setSettleMonth(e.target.value)} />
                                    }
                                    description="ì›”ë³„ ë§¤ì¶œ ë° ë¶€ê°€ì„¸ í˜„í™©"
                                >
                                    {(() => {
                                        const mList = deliveries.filter(d => {
                                            if (!String(d.date || '').startsWith(settleMonth)) return false;
                                            if (currentUser === 'admin') {
                                                if (adminDriverFilter === 'all') return true;
                                                if (adminDriverFilter === 'unassigned') return !d.driver;
                                                return d.driver === adminDriverFilter;
                                            }
                                            return d.driver === currentUser;
                                        });
                                        const mInstall = mList.reduce((a,c) => a+(c.install_fee||0), 0);
                                        const mYangjung = mList.reduce((a,c) => a+(c.yangjung||0), 0);
                                        const mNaerim = mList.reduce((a,c) => a+(c.naerim||0), 0);
                                        const mEtc = mList.reduce((a,c) => a+(c.etc_fee||0), 0);
                                        const mSubTotal = mInstall + mYangjung + mNaerim + mEtc;
                                        const mVAT = Math.floor(mSubTotal * 0.1);
                                        const mGrandTotal = mSubTotal + mVAT;

                                        return (
                                            <div className="space-y-3">
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">ì„¤ì¹˜ë¹„</div>
                                                        <div className="font-bold text-lg text-slate-800 text-right">{mInstall.toLocaleString()}</div>
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">ì–‘ì¤‘ë¹„</div>
                                                        <div className="font-bold text-lg text-slate-800 text-right">{mYangjung.toLocaleString()}</div>
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">ë‚´ë¦¼ë¹„</div>
                                                        <div className="font-bold text-lg text-slate-800 text-right">{mNaerim.toLocaleString()}</div>
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">ê¸°íƒ€</div>
                                                        <div className="font-bold text-lg text-slate-800 text-right">{mEtc.toLocaleString()}</div>
                                                    </div>
                                                </div>
                                                <div className="bg-[#0052CC] p-4 rounded-xl shadow-lg text-white mt-4 text-right">
                                                    <div className="mb-2">
                                                        <div className="text-xs opacity-80 font-bold mb-1 uppercase">ìµœì¢… ì§€ê¸‰ì•¡ (VATí¬í•¨)</div>
                                                        <div className="text-[10px] opacity-70">ê³µê¸‰ê°€ì•¡: {mSubTotal.toLocaleString()} + VAT: {mVAT.toLocaleString()}</div>
                                                    </div>
                                                    <div className="font-black text-3xl">
                                                        {mGrandTotal.toLocaleString()}<span className="text-sm font-medium opacity-80 ml-1">ì›</span>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </Card>

                                    {/* ğŸ“¢ ê´‘ê³  â‘¡ */} 
                                    <div className="my-6"> 
                                        <AdBanner 
                                            slot="2345678901" 
                                            format="auto" 
                                        /> 
                                    </div>
                                </section>

                                {view === 'admin' && ( 
                                   <div className="mt-6"> 
                                     <AdBanner 
                                       slot="4567890123" 
                                       format="auto" 
                                     /> 
                                   </div> 
                                 )}

                                {/* ìˆ˜ë™ ë“±ë¡ í¼ & ì—‘ì…€ ì—…ë¡œë“œ & ê²€ì¦ */}
                                <div className="col-span-12 grid grid-cols-12 gap-6">
                                    {!showManualRegister ? (
                                        <div className="col-span-12">
                                            <button 
                                                onClick={() => setShowManualRegister(true)}
                                                className="w-full bg-white border border-indigo-200 text-indigo-900 p-4 rounded-xl font-bold text-lg hover:bg-sky-50 transition-all flex items-center justify-center gap-2 shadow-sm"
                                            >
                                                <span>âœï¸</span> ê°œë³„ ë°°ì†¡ ê±´ ë“±ë¡í•˜ê¸°
                                            </button>
                                        </div>
                                    ) : (
                                        <Card 
                                            className="col-span-12"
                                            title={
                                                <div className="flex justify-between items-center w-full">
                                                    <span>ê°œë³„ ë“±ë¡</span>
                                                    <button 
                                                        onClick={() => setShowManualRegister(false)}
                                                        className="text-sm bg-slate-100 px-3 py-1 rounded-lg text-slate-500 hover:bg-slate-200"
                                                    >
                                                        ë‹«ê¸°
                                                    </button>
                                                </div>
                                            }
                                            description="ìƒí’ˆ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ë°°ì†¡ ê±´ì„ ë“±ë¡í•˜ì„¸ìš”."
                                        >
                                            <form onSubmit={handleManualAdd} className="space-y-4">
                                                {/* ì˜ˆì•½ ì‹œìŠ¤í…œ (ë‚ ì§œ/ì‹œê°„) - ì•„ì´ì½˜/íƒ€ì´í‹€ ì‚­ì œ */}
                                                <div className="bg-sky-50 p-4 rounded-xl border border-sky-100">
                                                    <div className="grid grid-cols-2 gap-3">
                                                        <div>
                                                            <label className="text-xs font-bold text-indigo-700 mb-1 block">ì˜ˆì•½ ë‚ ì§œ</label>
                                                            <input type="date" 
                                                                min={reservationConstraints.min} 
                                                                max={reservationConstraints.max}
                                                                className="w-full bg-white p-2.5 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 text-sm"
                                                                value={form.reservationDate} 
                                                                onChange={e => setForm({...form, reservationDate: e.target.value})} 
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-indigo-700 mb-1 block">ì˜ˆì•½ ì‹œê°„</label>
                                                            <select 
                                                                disabled={!form.reservationDate}
                                                                className="w-full bg-white p-2.5 rounded-lg border border-indigo-200 focus:ring-2 focus:ring-indigo-500 text-sm disabled:bg-slate-100"
                                                                value={form.reservationTime} 
                                                                onChange={e => setForm({...form, reservationTime: e.target.value})} 
                                                            >
                                                                <option value="">ì‹œê°„ ì„ íƒ</option>
                                                                {timeSlots.map(time => {
                                                                    const blocked = isTimeBlocked(form.reservationDate, time);
                                                                    return (
                                                                        <option key={time} value={time} disabled={blocked} className={blocked ? 'text-gray-400 bg-gray-50' : ''}>
                                                                            {time} {blocked ? '(ë§ˆê°)' : ''}
                                                                        </option>
                                                                    );
                                                                })}
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>

                                                {/* ë¹„ìš© ì…ë ¥ í•„ë“œ (ì›”ë³„ë§¤ì¶œ ë°•ìŠ¤ ìŠ¤íƒ€ì¼) */}
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">ì„¤ì¹˜ë¹„</div>
                                                        <input type="number" placeholder="0" className="w-full bg-transparent font-bold text-lg text-slate-800 placeholder-slate-300 focus:outline-none" 
                                                            value={form.install_fee || ''} onChange={e => setForm({...form, install_fee: e.target.value})} />
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">ì–‘ì¤‘ë¹„</div>
                                                        <input type="number" placeholder="0" className="w-full bg-transparent font-bold text-lg text-slate-800 placeholder-slate-300 focus:outline-none" 
                                                            value={form.yangjung || ''} onChange={e => setForm({...form, yangjung: e.target.value})} />
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">ë‚´ë¦¼ë¹„</div>
                                                        <input type="number" placeholder="0" className="w-full bg-transparent font-bold text-lg text-slate-800 placeholder-slate-300 focus:outline-none" 
                                                            value={form.naerim || ''} onChange={e => setForm({...form, naerim: e.target.value})} />
                                                    </div>
                                                    <div className="bg-[#F4F5F7] p-3 rounded-lg">
                                                        <div className="text-xs text-slate-500 font-bold mb-1 uppercase">ê¸°íƒ€</div>
                                                        <input type="number" placeholder="0" className="w-full bg-transparent font-bold text-lg text-slate-800 placeholder-slate-300 focus:outline-none" 
                                                            value={form.etc_fee || ''} onChange={e => setForm({...form, etc_fee: e.target.value})} />
                                                    </div>
                                                </div>

                                                <div>
                                                    <label className="text-xs font-bold text-slate-500 mb-1 block">ìƒí’ˆëª… (í•„ìˆ˜)</label>
                                                    <input type="text" required placeholder="ìƒí’ˆ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" className="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                        value={form.item} onChange={e => setForm({...form, item: e.target.value})} />
                                                </div>
                                                
                                                <div className="grid grid-cols-1 gap-4">
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 mb-1 block">ì „í™”ë²ˆí˜¸</label>
                                                        <input type="tel" required placeholder="010-0000-0000" className="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                            value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs font-bold text-slate-500 mb-1 block">ì£¼ì†Œ</label>
                                                        <input type="text" required placeholder="ì „ì²´ ì£¼ì†Œ ì…ë ¥" className="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" 
                                                            value={form.address} onChange={e => setForm({...form, address: e.target.value})} />
                                                    </div>
                                                </div>

                                                {/* ë°°ì†¡ ë©”ëª¨ */}
                                                <div>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <label className="text-xs font-bold text-slate-500">ë°°ì†¡ ë©”ëª¨</label>
                                                        <span className={`text-[10px] ${form.memo.length < Config.MEMO.MIN_LENGTH ? 'text-red-500' : 'text-green-500'}`}>
                                                            {form.memo.length} / {Config.MEMO.MAX_LENGTH}ì
                                                        </span>
                                                    </div>
                                                    <textarea 
                                                        className="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all text-sm resize-none"
                                                        placeholder={`íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ ${Config.MEMO.MIN_LENGTH}ì, íŠ¹ìˆ˜ë¬¸ì ì œì™¸)`}
                                                        rows="3"
                                                        value={form.memo}
                                                        onChange={handleMemoChange}
                                                    ></textarea>
                                                    {form.memo && form.memo.length < Config.MEMO.MIN_LENGTH && (
                                                        <p className="text-[10px] text-red-500 mt-1">âš ï¸ ìµœì†Œ {Config.MEMO.MIN_LENGTH}ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                                                    )}
                                                </div>

                                                <button type="submit" className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700 active:scale-[0.98] transition-all shadow-lg shadow-indigo-200 mt-2">
                                                    ë“±ë¡í•˜ê¸°
                                                </button>
                                            </form>
                                        </Card>
                                    )}

                                    <div className="col-span-12 space-y-3">
                                        <details className="group">
                                            <summary className="w-full bg-white border border-indigo-200 text-indigo-900 p-4 rounded-xl font-bold text-lg hover:bg-sky-50 transition-all flex items-center justify-between gap-2 shadow-sm cursor-pointer list-none">
                                                <span className="flex items-center gap-2"><span>ğŸ› </span> ê´€ë¦¬ì ë„êµ¬</span>
                                                <span className="text-slate-400 transition-transform group-open:rotate-180">â–¾</span>
                                            </summary>
                                            <div className="mt-3 bg-white p-4 rounded-xl border border-amber-100 shadow-sm">
                                                <h4 className="text-sm font-bold text-amber-900 mb-2 flex items-center gap-2">
                                                    <span>ğŸ“Š</span> ì—‘ì…€ ëŒ€ëŸ‰ ë“±ë¡
                                                </h4>
                                                <div className="flex gap-3 mb-2">
                                                    <button onClick={downloadTemplate} className="flex-1 bg-slate-50 text-slate-700 py-3 rounded-lg font-bold hover:bg-slate-100 transition-all text-sm flex flex-col items-center justify-center gap-1 border border-slate-200">
                                                        <span className="text-lg">ğŸ“¥</span>
                                                        ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                                                    </button>
                                                    <label className="flex-1 bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-all text-sm flex flex-col items-center justify-center gap-1 shadow-md cursor-pointer active:scale-[0.98]">
                                                        <span className="text-lg">ğŸ“‚</span>
                                                        ì—‘ì…€ ì—…ë¡œë“œ
                                                        <input type="file" hidden accept=".xlsx" onChange={handleFileUpload} />
                                                    </label>
                                                </div>
                                                {uploadedFileName && (
                                                    <div className="text-center text-xs font-bold text-green-600 bg-green-50 p-2 rounded border border-green-100">
                                                        âœ… ë§ˆì§€ë§‰ ì—…ë¡œë“œ: {uploadedFileName}
                                                    </div>
                                                )}
                                                <p className="text-xs text-slate-400 mt-2">
                                                    * ë‚ ì§œ í˜•ì‹ì€ "01ì›” 30ì¼" ì²˜ëŸ¼ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
                                                </p>
                                            </div>
                                        </details>
                                        
                                        <details className="group">
                                            <summary className="w-full bg-white border border-indigo-200 text-indigo-900 p-3 rounded-xl font-bold text-sm hover:bg-sky-50 transition-all flex items-center justify-between gap-2 shadow-sm cursor-pointer list-none">
                                                <span className="flex items-center gap-2"><span>ğŸ’¾</span> ë°ì´í„° ê´€ë¦¬</span>
                                                <span className="text-slate-400 transition-transform group-open:rotate-180">â–¾</span>
                                            </summary>
                                            <div className="mt-3 bg-white p-4 rounded-xl border border-amber-100 shadow-sm">
                                                <div className="mb-3">
                                                     <button onClick={() => setCloudModalOpen(true)} className="w-full bg-indigo-50 text-indigo-900 py-2 rounded-lg text-xs font-bold border border-indigo-100 hover:bg-indigo-100 transition flex items-center justify-center gap-2">
                                                         {isCloudConnected ? "â˜ï¸ ì„œë²„ ì—°ê²°ë¨" : "âš™ï¸ ì„œë²„ ì„¤ì •"}
                                                     </button>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <button onClick={() => handleCloudSync('push')} className="bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition text-sm shadow-md flex flex-col items-center justify-center gap-1">
                                                        <span className="text-lg">â˜ï¸â¬†ï¸</span>
                                                        <span>ì„œë²„ì— ì˜¬ë¦¬ê¸°</span>
                                                    </button>
                                                    <button onClick={() => handleCloudSync('pull')} className="bg-white text-indigo-900 py-3 rounded-lg font-bold hover:bg-indigo-50 transition text-sm border border-indigo-200 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-lg">â˜ï¸â¬‡ï¸</span>
                                                        <span>ì„œë²„ì—ì„œ ë°›ê¸°</span>
                                                    </button>
                                                    
                                                    <button onClick={() => {
                                                        const blob = new Blob([JSON.stringify(deliveries)], {type: "application/json"});
                                                        const url = URL.createObjectURL(blob);
                                                        const a = document.createElement('a');
                                                        a.href = url;
                                                        a.download = `manager_data_${new Date().toISOString().slice(0,10)}.json`;
                                                        a.click();
                                                    }} className="bg-slate-50 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-100 transition text-xs border border-slate-200 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-lg">ğŸ’¾</span>
                                                        <span>íŒŒì¼ì €ì¥</span>
                                                    </button>
                                                    
                                                    <label className="bg-slate-50 text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-100 transition text-xs border border-slate-200 flex flex-col items-center justify-center gap-1 cursor-pointer">
                                                        <span className="text-lg">ğŸ“‚</span>
                                                        <span>íŒŒì¼ë¶ˆëŸ¬ì˜¤ê¸°</span>
                                                        <input type="file" hidden accept=".json" onChange={(e) => {
                                                            const file = e.target.files[0];
                                                            if(!file) return;
                                                            readJsonFileWithEncoding(file, (data) => {
                                                                if(Array.isArray(data)) {
                                                                    if(confirm(`ê¸°ì‚¬ë‹˜ì´ ì‘ì—…í•œ ${data.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ë°ì´í„°ëŠ” ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.`)) {
                                                                        setDeliveries(data);
                                                                        StorageManager.saveDeliveries(data);
                                                                        alert("ë°ì´í„°ê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                                                    }
                                                                } else {
                                                                    alert("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");
                                                                }
                                                            });
                                                        }} />
                                                    </label>

                                                    <button onClick={handleVerifyData} className="bg-sky-50 text-indigo-900 py-3 rounded-lg font-bold hover:bg-indigo-100 transition text-sm border border-sky-100">
                                                        ğŸ“Š ë°ì´í„° ê²€ì¦
                                                    </button>
                                                    <button onClick={fixCoordinates} className="bg-red-50 text-red-600 py-3 rounded-lg font-bold hover:bg-red-100 transition text-sm border border-red-100">
                                                        ğŸ›  ì¢Œí‘œ ë³´ì •
                                                    </button>
                                                     
                                                    <button onClick={() => {
                                                        const backupList = StorageManager.get('mvp_backup_list') || [];
                                                        if(backupList.length === 0) {
                                                            alert("ì €ì¥ëœ ìë™ ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤.");
                                                            return;
                                                        }
                                                        const msg = backupList.map((b, i) => `${i+1}. ${b.time} (${b.count}ê±´)`).join('\n');
                                                        const choice = prompt(`[ìë™ ë°±ì—… ë³µêµ¬]\në³µêµ¬í•  ë°±ì—… ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n\n${msg}`);
                                                        if (!choice) return;
                                                        
                                                        const idx = parseInt(choice) - 1;
                                                        if(idx >= 0 && idx < backupList.length) {
                                                            const backupKey = backupList[idx].key;
                                                            const backup = StorageManager.get(backupKey);
                                                            if(backup && backup.deliveries) {
                                                                if(confirm(`"${backupList[idx].time}" ì‹œì ì˜ ë°ì´í„°(${backup.deliveries.length}ê±´)ë¡œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`)) {
                                                                    setDeliveries(backup.deliveries);
                                                                    StorageManager.saveDeliveries(backup.deliveries);
                                                                    alert("âœ… ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                                                }
                                                            } else {
                                                                alert("ë°±ì—… ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.");
                                                            }
                                                        } else {
                                                            alert("ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.");
                                                        }
                                                    }} className="col-span-2 bg-orange-50 text-orange-800 py-3 rounded-lg font-bold hover:bg-orange-100 transition text-sm border border-orange-200 shadow-sm flex items-center justify-center gap-2">
                                                        <span>â†º</span> ìë™ ë°±ì—… ë³µêµ¬
                                                    </button>
                                                </div>
                                            </div>
                                        </details>
                                    </div>
                                </div>

                                <details className="group col-span-12">
                                    <summary className="w-full bg-white border border-indigo-200 text-indigo-900 p-4 rounded-xl font-bold text-lg hover:bg-sky-50 transition-all flex items-center justify-between gap-2 shadow-sm cursor-pointer list-none">
                                        <span className="flex items-center gap-2">{`ğŸ‘¥ ê³ ê° ëª©ë¡ (${
                                            deliveries.filter(d => {
                                                const dateMatch = customerViewMode === 'daily' ? d.date === customerFilterDate : String(d.date||'').startsWith(customerFilterMonth);
                                                if (!dateMatch) return false;
                                                if (currentUser === 'admin') {
                                                    if (adminDriverFilter === 'all') return true;
                                                    if (adminDriverFilter === 'unassigned') return !d.driver;
                                                    return d.driver === adminDriverFilter;
                                                }
                                                return d.driver === currentUser;
                                            }).length
                                        }ê±´)`}</span>
                                        <span className="text-slate-400 transition-transform group-open:rotate-180">â–¾</span>
                                    </summary>
                                    <div className="mt-3 bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                                    

                                    <div className="flex flex-col gap-2 mb-4">
                                        <div className="flex justify-end gap-1 bg-slate-100 p-1 rounded-lg self-end">
                                             <button onClick={() => setCustomerViewMode('daily')} className={`px-3 py-1 text-xs font-bold rounded-md transition ${customerViewMode === 'daily' ? 'bg-white shadow text-indigo-900' : 'text-gray-500 hover:text-gray-700'}`}>ì¼ë³„</button>
                                             <button onClick={() => setCustomerViewMode('monthly')} className={`px-3 py-1 text-xs font-bold rounded-md transition ${customerViewMode === 'monthly' ? 'bg-white shadow text-indigo-900' : 'text-gray-500 hover:text-gray-700'}`}>ì›”ë³„</button>
                                        </div>
                                        
                                        {/* [New] ê²€ìƒ‰ í•„í„° */}
                                        <div className="relative">
                                            <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span>
                                            <input 
                                                type="text" 
                                                className="w-full pl-9 pr-3 py-2 border rounded-lg text-sm bg-slate-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 outline-none transition"
                                                placeholder="ì´ë¦„, ì£¼ì†Œ, ìƒí’ˆ, ì£¼ë¬¸ë²ˆí˜¸ ë“± ê²€ìƒ‰..."
                                                value={customerSearchTerm}
                                                onChange={(e) => setCustomerSearchTerm(e.target.value)}
                                            />
                                        </div>
                                    </div>

                                    {customerViewMode === 'daily' && (
                                        <div className="flex gap-2 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                            <input type="date" className="bg-white border p-2 rounded text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500 w-full" 
                                                value={customerFilterDate} onChange={e => setCustomerFilterDate(e.target.value)} />
                                        </div>
                                    )}

                                    {customerViewMode === 'monthly' && (
                                        <div className="flex gap-2 mb-4 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                            <input type="month" className="bg-white border p-2 rounded text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500" 
                                                value={customerFilterMonth} onChange={e => setCustomerFilterMonth(e.target.value)} />
                                            <button onClick={downloadCustomerExcel} className="flex-1 bg-green-600 text-white px-3 py-2 rounded text-sm font-bold hover:bg-green-700 flex items-center justify-center gap-1 shadow-sm">
                                                <span>ğŸ“¥</span> ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                                            </button>
                                        </div>
                                    )}

                                    <div className="space-y-3 max-h-[500px] overflow-y-auto pr-1">
                                        {(() => {
                                            const listData = deliveries.filter(d => {
                                                const dateMatch = customerViewMode === 'daily' 
                                                    ? d.date === customerFilterDate
                                                    : String(d.date || '').startsWith(customerFilterMonth);
                                                
                                                if (!dateMatch) return false;

                                                if (currentUser === 'admin') {
                                                    // [New] ê²€ìƒ‰ì–´ í•„í„°
                                                    if (customerSearchTerm) {
                                                        const term = customerSearchTerm.toLowerCase();
                                                        const searchTarget = [
                                                            d.item, d.address, d.phone, d.driver, 
                                                            d.order_number, d.invoice_number, d.center, d.region
                                                        ].map(v => String(v || '').toLowerCase());
                                                        
                                                        if (!searchTarget.some(val => val.includes(term))) return false;
                                                    }

                                                    if (adminDriverFilter === 'all') return true;
                                                    if (adminDriverFilter === 'unassigned') return !d.driver;
                                                    return d.driver === adminDriverFilter;
                                                }
                                                return d.driver === currentUser;
                                            });

                                            if (listData.length === 0) {
                                                const totalCount = deliveries.length;
                                                return (
                                                    <div className="text-center py-8 bg-slate-50 rounded-lg border border-dashed border-slate-300">
                                                        <p className="text-gray-500 mb-2 font-medium">
                                                            {customerViewMode === 'daily' ? `${customerFilterDate}ì— ë“±ë¡ëœ ë°°ì†¡ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.` : 'í•´ë‹¹ ì›”ì— ë°°ì†¡ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.'}
                                                        </p>
                                                        {totalCount > 0 && (
                                                            <div className="text-xs text-indigo-500">
                                                                <p className="mb-2">ì „ì²´ ë°ì´í„°: {totalCount}ê±´ ë³´ê´€ ì¤‘</p>
                                                                <button 
                                                                    onClick={() => {
                                                                        const dates = [...new Set(deliveries.map(d => d.date))].sort();
                                                                        alert(`ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œ ëª©ë¡:\n${dates.join(', ')}`);
                                                                    }}
                                                                    className="bg-white border border-indigo-200 px-3 py-1 rounded shadow-sm hover:bg-indigo-50"
                                                                >
                                                                    ğŸ“… ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì§œ í™•ì¸í•˜ê¸°
                                                                </button>
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            }

                                            return listData.map(d => (
                                                <div key={d.id} className="border p-3 rounded-lg bg-gray-50 hover:bg-white transition shadow-sm relative group">
                                                    <div className="flex justify-between items-start mb-2 gap-2">
                                                        <div className="flex-1 min-w-0 overflow-hidden">
                                                            {/* [New] ê´€ë¦¬ì ëª¨ë“œ ì¶”ê°€ ì •ë³´ í‘œì‹œ */}
                                                            {currentUser === 'admin' && (
                                                                <div className="flex flex-wrap gap-2 mb-1 text-[10px] text-slate-500">
                                                                    {d.order_number && <span className="bg-slate-100 px-1 rounded border">ORD: {d.order_number}</span>}
                                                                    {d.invoice_number && <span className="bg-slate-100 px-1 rounded border">INV: {d.invoice_number}</span>}
                                                                    {d.center && <span className="bg-sky-50 text-indigo-700 px-1 rounded border border-sky-100">{d.center}</span>}
                                                                    {d.region && <span className="bg-slate-100 px-1 rounded border">{d.region}</span>}
                                                                </div>
                                                            )}
                                                            <div className={`font-bold ${(d._mergedOriginals || (d.detail_items && d.detail_items.length > 1)) ? 'text-red-600' : 'text-indigo-900'}`}>{d.item}</div>
                                                            <div className="text-xs text-gray-500">{d.address}</div>
                                                            <div className="flex gap-1 mt-1 flex-wrap">
                                                                {d.completed && <span className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded font-bold">âœ… ì™„ë£Œ</span>}
                                                                {d.partial && <span className="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded font-bold">ğŸŒ— ë¶€ë¶„</span>}
                                                                {d.canceled && (
                                                                    d.cancel_type === 'postpone' 
                                                                    ? <span className="text-[10px] bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded font-bold">ğŸ•’ ì—°ê¸°</span>
                                                                    : <span className="text-[10px] bg-red-100 text-red-700 px-1.5 py-0.5 rounded font-bold">âŒ ì·¨ì†Œ</span>
                                                                )}
                                                                {customerViewMode === 'monthly' && <span className="text-[10px] text-slate-500 border border-slate-200 px-1.5 py-0.5 rounded">ğŸ“… {d.date}</span>}
                                                                {currentUser === 'admin' && d.driver && <span className="text-[10px] bg-sky-50 text-indigo-700 px-1.5 py-0.5 rounded font-bold border border-sky-100">ğŸ‘· {d.driver}</span>}
                                                            </div>
                                                        </div>
                                                        <button onClick={() => deleteDelivery([d.id])} className="w-8 h-8 flex items-center justify-center text-red-400 hover:text-red-600 rounded-full hover:bg-red-50 transition flex-shrink-0 bg-white border border-gray-100 shadow-sm">ğŸ—‘ï¸</button>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div>
                                                            <label className="text-xs font-bold text-gray-500 block mb-1">ì„¤ì¹˜ë¹„</label>
                                                            <input type="text" inputMode="numeric" className="w-full border rounded p-2 text-right text-sm font-bold focus:ring-2 focus:ring-indigo-200 outline-none"
                                                                value={(d.install_fee || 0).toLocaleString()}
                                                                onChange={(e) => {
                                                                    const val = parseInt(e.target.value.replace(/,/g, '')) || 0;
                                                                    const newDeliveries = deliveries.map(item => item.id === d.id ? { ...item, install_fee: val } : item);
                                                                    setDeliveries(newDeliveries);
                                                                    StorageManager.saveDeliveries(newDeliveries);
                                                                }}
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-gray-500 block mb-1">ì–‘ì¤‘ë¹„</label>
                                                            <input type="text" inputMode="numeric" className="w-full border rounded p-2 text-right text-sm font-bold focus:ring-2 focus:ring-indigo-200 outline-none"
                                                                value={(d.yangjung || 0).toLocaleString()}
                                                                onChange={(e) => {
                                                                    const val = parseInt(e.target.value.replace(/,/g, '')) || 0;
                                                                    const newDeliveries = deliveries.map(item => item.id === d.id ? { ...item, yangjung: val } : item);
                                                                    setDeliveries(newDeliveries);
                                                                    StorageManager.saveDeliveries(newDeliveries);
                                                                }}
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-gray-500 block mb-1">ë‚´ë¦¼ë¹„</label>
                                                            <input type="text" inputMode="numeric" className="w-full border rounded p-2 text-right text-sm font-bold focus:ring-2 focus:ring-indigo-200 outline-none"
                                                                value={(d.naerim || 0).toLocaleString()}
                                                                onChange={(e) => {
                                                                    const val = parseInt(e.target.value.replace(/,/g, '')) || 0;
                                                                    const newDeliveries = deliveries.map(item => item.id === d.id ? { ...item, naerim: val } : item);
                                                                    setDeliveries(newDeliveries);
                                                                    StorageManager.saveDeliveries(newDeliveries);
                                                                }}
                                                            />
                                                        </div>
                                                        <div>
                                                            <label className="text-xs font-bold text-gray-500 block mb-1">ê¸°íƒ€ë¹„ìš©</label>
                                                            <input type="text" inputMode="numeric" className="w-full border rounded p-2 text-right text-sm font-bold focus:ring-2 focus:ring-indigo-200 outline-none"
                                                                value={(d.etc_fee || 0).toLocaleString()}
                                                                onChange={(e) => {
                                                                    const val = parseInt(e.target.value.replace(/,/g, '')) || 0;
                                                                    const newDeliveries = deliveries.map(item => item.id === d.id ? { ...item, etc_fee: val } : item);
                                                                    setDeliveries(newDeliveries);
                                                                    StorageManager.saveDeliveries(newDeliveries);
                                                                }}
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        })()}
                                    </div>
                                    </div>
                                </details>
                            </div>
                        )}

                        {/* ğŸ“¢ ê´‘ê³  â‘¢ (í™”ë©´ ìµœí•˜ë‹¨) */}
                        {view === 'admin' && (
                           <div className="mt-4">
                               <AdBanner 
                                 slot="3456789012" 
                                 className="rounded-xl" 
                               />
                           </div>
                        )}

                        {/* ê¸°ì‚¬ ëª¨ë“œ: ë°°ì†¡ ì¶”ê°€ í™”ë©´ (Admin í¼ ì¬ì‚¬ìš© í˜•íƒœ) */}
                        {view === 'driver_add' && (
                            <div className="bg-white p-4 rounded-xl shadow-sm border min-h-[500px]">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="font-bold text-lg flex items-center gap-2">ğŸ“¦ ìƒˆ ë°°ì†¡ì§€ ì¶”ê°€</h2>
                                    <button onClick={() => setView('driver')} className="text-gray-500 font-bold">âœ• ë‹«ê¸°</button>
                                </div>
                                <form onSubmit={(e) => {
                                    handleManualAdd(e).then(() => setView('driver'));
                                }} className="space-y-4">
                                    {/* ë‚ ì§œëŠ” í˜„ì¬ ì„ íƒëœ ë‚ ì§œ ìë™ ì ìš© */}
                                    <input type="hidden" value={targetDate} /> 
                                    
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">ë°©ë¬¸ì˜ˆì •ì‹œê°„ (30ë¶„ ë‹¨ìœ„)</label>
                                        <select 
                                            className="w-full bg-gray-100 p-3 rounded text-lg font-bold"
                                            value={form.time} 
                                            onChange={e => {
                                                const val = e.target.value;
                                                if(checkTimeConflict(val, 30, [])) {
                                                    alert("âš ï¸ ì´ë¯¸ ì˜ˆì•½ëœ ì‹œê°„ëŒ€ì…ë‹ˆë‹¤.");
                                                    return;
                                                }
                                                setForm({...form, time: val});
                                            }}
                                        >
                                            <option value="">ì‹œê°„ ì„ íƒ</option>
                                            {TIME_SLOTS.map(t => {
                                                const isConflict = checkTimeConflict(t, 30, []);
                                                return (
                                                    <option key={t} value={t} disabled={isConflict} className={isConflict ? 'text-gray-400' : ''}>
                                                        {t} {isConflict ? '(ë§ˆê°)' : ''}
                                                    </option>
                                                );
                                            })}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">ìƒí’ˆëª… (í•„ìˆ˜)</label>
                                        <input type="text" required placeholder="ìƒí’ˆëª… ì…ë ¥" className="w-full bg-gray-100 p-3 rounded" 
                                            value={form.item} onChange={e => setForm({...form, item: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">ì „í™”ë²ˆí˜¸ (í•„ìˆ˜)</label>
                                        <input type="tel" required placeholder="010-0000-0000" className="w-full bg-gray-100 p-3 rounded" 
                                            value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">ì£¼ì†Œ (í•„ìˆ˜)</label>
                                        <input type="text" required placeholder="ì£¼ì†Œ ì…ë ¥" className="w-full bg-gray-100 p-3 rounded" 
                                            value={form.address} onChange={e => setForm({...form, address: e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">ì„¤ì¹˜ë¹„</label>
                                            <input type="number" placeholder="0" className="w-full bg-gray-100 p-3 rounded text-right" 
                                                value={form.install_fee || ''} onChange={e => setForm({...form, install_fee: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">ì–‘ì¤‘ë¹„</label>
                                            <input type="number" placeholder="0" className="w-full bg-gray-100 p-3 rounded text-right" 
                                                value={form.yangjung || ''} onChange={e => setForm({...form, yangjung: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">ë‚´ë¦¼ë¹„</label>
                                            <input type="number" placeholder="0" className="w-full bg-gray-100 p-3 rounded text-right" 
                                                value={form.naerim || ''} onChange={e => setForm({...form, naerim: e.target.value})} />
                                        </div>
                                    </div>
                                    <button type="submit" className="w-full bg-green-500 text-white py-4 rounded-lg font-bold hover:bg-green-600 transition text-lg">
                                        ì¶”ê°€ ì™„ë£Œ
                                    </button>
                                </form>
                            </div>
                        )}

                        {/* ê¸°ì‚¬ ëª¨ë“œ */}
                        {view === 'driver' && (
                            <div className="space-y-4">


                                {/* ì§€ë„ ì˜ì—­: Active ëª©ë¡ ìƒìœ„ 30ê°œë§Œ í‘œì‹œ (ì„±ëŠ¥ ìµœì í™”) */}
                                {showMap && (
                                    <>
                                        {groupedDeliveries.filter(d => d.is_active).length > 30 && (
                                            <div className="text-xs text-orange-600 font-bold mb-1 text-right">
                                                * ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•´ ìƒìœ„ 30ê°œ ë§ˆì»¤ë§Œ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤.
                                            </div>
                                        )}
                                        <MapView 
                                            locations={[
                                                ...groupedDeliveries.filter(d => d.is_active).slice(0, 30),
                                                ...(endPoint ? [endPoint] : [])
                                            ]} 
                                            center={
                                                // [ìˆ˜ì •] ì§€ë„ ì—´ë¦´ ë•Œ 1ë²ˆ ë°°ì†¡ì§€(ì²« ë²ˆì§¸ í™œì„± í•­ëª©)ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ í‘œì‹œ
                                                groupedDeliveries.find(d => d.is_active) || startPoint || { lat: 37.5665, lng: 126.9780 }
                                            } 
                                            startPoint={startPoint}
                                        />
                                    </>
                                )}

                                {/* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */}
                                <div className="space-y-4">
                                    {/* ìƒë‹¨ ì œì–´ë°” ì œê±°: ì•„ë˜ë¡œ ì´ë™ */}
                                    
                                    {/* í•©ì¹˜ê¸° ì‹¤í–‰ ë²„íŠ¼ (ëª¨ë“œ í™œì„±í™” ì‹œ í‘œì‹œ) */}
                                    
                                    
                                    {/* Sortable List Container (Horizontal Carousel) */}
                                    <div className="relative group">
                                        {/* PC Scroll Button Left */}
                                        <button 
                                            onClick={() => document.getElementById('delivery-list-container').scrollBy({ left: -300, behavior: 'smooth' })}
                                            className="hidden md:flex absolute left-0 top-1/2 -translate-y-1/2 z-20 bg-white/90 hover:bg-white shadow-lg border border-slate-200 rounded-full w-10 h-10 items-center justify-center text-slate-600 transition-all backdrop-blur-sm -ml-4 hover:scale-110 active:scale-95"
                                            aria-label="ì´ì „"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                                            </svg>
                                        </button>
                                        
                                        <div id="delivery-list-container" className="flex overflow-x-auto gap-4 pb-8 snap-x snap-mandatory scroll-smooth -mx-6 px-6 items-start">
                                    {(() => {
                                        const firstActiveUncompletedIndex = groupedDeliveries.findIndex(g => g.is_active && !g.completed);
                                        return groupedDeliveries.map((group, idx) => {
                                        const groupId = group.ids.join('_');
                                        const isExpanded = expandedGroups[groupId] === true; // Default Closed
                                        const dist = startPoint && group.lat && group.lng ? getDistance(startPoint.lat, startPoint.lng, group.lat, group.lng).toFixed(1) : null;
                                        const directInstall = ((group.address || '').includes('ê³ ê°ì§ì ‘ì„¤ì¹˜') || (group.address || '').includes('ì§ì ‘ì„¤ì¹˜'));

                                        return (
                                        <div 
                                            key={idx} 
                                            id={`card-${groupId}`}
                                            style={{ scrollSnapStop: 'always' }}
                                            onClick={() => {
                                                if (isMergeMode) {
                                                    setSelectedMergeIds(prev => {
                                                        const allIds = group.ids;
                                                        const isAllSelected = allIds.every(id => prev.includes(id));
                                                        if (isAllSelected) {
                                                            return prev.filter(id => !allIds.includes(id));
                                                        } else {
                                                            return [...prev, ...allIds];
                                                        }
                                                    });
                                                } else if (isDriverChangeMode) {
                                                    toggleDriverSelection(group.ids);
                                                } else {
                                                    setExpandedGroups(prev => ({ 
                                                        ...prev, 
                                                        [groupId]: !prev[groupId] 
                                                    }));
                                                }
                                            }}
                                            className={`delivery-card snap-center shrink-0 w-[92vw] max-w-[480px] cursor-pointer ${
                                                (idx === firstActiveUncompletedIndex) ? 'current' : ''
                                            } ${group.completed ? 'completed' : ''} ${group.canceled ? (group.cancel_type === 'postpone' ? 'postponed' : 'canceled') : ''} ${
                                                isDriverChangeMode && group.ids.every(id => selectedDriverChangeIds.has(id)) ? 'ring-4 ring-green-500 bg-green-50' : ''
                                            }`}
                                        >
                                            <div className="left-strip"></div>
                                            {/* Inline order badge in header row; removed absolute badge */}

                                            {/* Driver Change Checkbox Overlay */}
                                            {isDriverChangeMode && (
                                                <div className="absolute top-3 right-3 z-20">
                                                    <input 
                                                        type="checkbox"
                                                        checked={group.ids.every(id => selectedDriverChangeIds.has(id))}
                                                        readOnly
                                                        className="w-6 h-6 rounded border-gray-300 text-green-600 focus:ring-green-500"
                                                    />
                                                </div>
                                            )}

                                            {/* Merge Checkbox Overlay */}
                                            {isMergeMode && (
                                                <div className="absolute top-3 right-3 z-20">
                                                    <input 
                                                        type="checkbox"
                                                        checked={group.ids.every(id => selectedMergeIds.includes(id))}
                                                        readOnly
                                                        className="w-6 h-6 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                                    />
                                                </div>
                                            )}

                                            <div className="card-body">
                                                {/* Header row: left current-label, right badges */}
                                                <div className={`ml-3 mb-0 flex items-center gap-2`}>
                                                    <div className="inline-flex w-10 h-10 bg-indigo-600 text-white rounded-full text-[13px] font-extrabold items-center justify-center shrink-0">
                                                        {group.sequence_number || '-'}
                                                    </div>
                                                    {(idx === firstActiveUncompletedIndex) && (
                                                        <div className="current-label">ğŸšš í˜„ì¬ ë°°ì†¡ ì¤‘</div>
                                                    )}
                                                    <div className="ml-auto flex items-center gap-1">
                                                        {directInstall && (
                                                            <span className="text-[10px] font-bold text-white bg-red-600 px-2 py-1 rounded-full shrink-0">ì§ì ‘</span>
                                                        )}
                                                        {group.time && (
                                                            <span className="text-[10px] font-bold text-white bg-indigo-500 px-2 py-1 rounded-full shrink-0">â° {group.time}</span>
                                                        )}
                                                        {group.unattended && (
                                                            <span className="text-[10px] font-bold text-white bg-sky-600 px-2 py-1 rounded-full shrink-0">ë¬´ì¸</span>
                                                        )}
                                                        {group.canceled && group.cancel_type === 'postpone' && <span className="text-[10px] font-bold text-white bg-orange-500 px-2 py-1 rounded-full shrink-0">ì—°ê¸°</span>}
                                                        {group.canceled && group.cancel_type !== 'postpone' && <span className="text-[10px] font-bold text-white bg-red-500 px-2 py-1 rounded-full shrink-0">ì·¨ì†Œë¨</span>}
                                                        {group.completed && <span className="text-[10px] font-bold text-white bg-green-600 px-2 py-1 rounded-full shrink-0">ì™„ë£Œ</span>}
                                                    </div>
                                                </div>
                                                {/* Collapsed address line removed */}
                                                {/* Phone (Inline Editable on Button for Driver) - Top */}
                                                <div className="mb-1">
                                                    {view === 'driver' && editingPhoneGroupId === groupId ? (
                                                        <input 
                                                            type="tel"
                                                            className="phone-btn"
                                                            value={editingPhoneValue}
                                                            onChange={(e) => setEditingPhoneValue(e.target.value)}
                                                            onBlur={(e) => { updateGroupContact(group.ids, { phone: e.target.value }); setEditingPhoneGroupId(null); }}
                                                            onKeyDown={(e) => { if (e.key === 'Enter') { updateGroupContact(group.ids, { phone: editingPhoneValue }); setEditingPhoneGroupId(null); } }}
                                                            placeholder="ì „í™”ë²ˆí˜¸ ì…ë ¥"
                                                            autoFocus
                                                        />
                                                    ) : (
                                                        <a 
                                                            href={`tel:${group.phone}`} 
                                                            onClick={(e) => { 
                                                                e.stopPropagation(); 
                                                                if (view === 'driver') { 
                                                                    e.preventDefault(); 
                                                                    setEditingPhoneGroupId(groupId); 
                                                                    setEditingPhoneValue(group.phone || ''); 
                                                                } 
                                                            }} 
                                                            className="phone-btn"
                                                        >
                                                            ğŸ“ {group.phone || 'ë²ˆí˜¸ì—†ìŒ'}
                                                        </a>
                                                    )}
                                                </div>
                                                {/* Header / Top Info moved above phone */}
                                                
                                                {/* Phone moved to top */}
                                                
                                                {/* ì˜ˆì•½ ì‹œê°„ ë²„íŠ¼í˜• ì„ íƒ (Vertical Grid) - Duration Removed */}
                                                <div className="mb-2 relative z-10 flex items-center gap-2">
                                                    <div className="relative flex-1">
                                                        <button 
                                                            className="w-full px-3 py-2 rounded-full border text-xs font-bold text-left hover:bg-slate-50 transition-colors flex items-center justify-between"
                                                            onClick={(e) => { e.stopPropagation(); setOpenTimePickerId(openTimePickerId === groupId ? null : groupId); }}
                                                        >
                                                            <span className="truncate">â° {group.time ? group.time : 'ì˜ˆì•½ì‹œê°„ ì„¤ì •'}</span>
                                                            {group.time && (
                                                                <span 
                                                                    className="text-slate-400 hover:text-red-500 px-2 -mr-2 z-20 relative"
                                                                    onClick={(e) => {
                                                                        e.preventDefault();
                                                                        e.stopPropagation();
                                                                        handleTimeSelect(group.ids, '', group.duration || 30);
                                                                    }}
                                                                >âœ•</span>
                                                            )}
                                                        </button>
                                                        {openTimePickerId === groupId && (
                                                            <div className="absolute top-full left-0 mt-2 w-full bg-white border rounded-xl shadow-xl z-50 p-3" onClick={(e) => e.stopPropagation()}>
                                                                <div className="mb-2 text-xs text-slate-500 font-bold px-1">ì˜ˆì•½ ì‹œê°„ ì„ íƒ</div>
                                                                <div className="grid grid-cols-4 gap-2 max-h-60 overflow-y-auto">
                                                                    {TIME_SLOTS.map(t => {
                                                                        const disabled = checkTimeConflict(t, group.duration || 30, group.ids);
                                                                        return (
                                                                            <button 
                                                                                key={t}
                                                                                disabled={disabled}
                                                                                className={`px-2 py-3 rounded-lg border text-sm font-bold shadow-sm transition-all active:scale-95 ${
                                                                                    group.time === t ? 'bg-indigo-600 text-white border-indigo-600 ring-2 ring-indigo-200' : 
                                                                                    disabled ? 'bg-slate-100 text-slate-300 cursor-not-allowed' : 'bg-white text-slate-700 hover:bg-slate-50 border-slate-200'
                                                                                }`}
                                                                                onClick={() => { 
                                                                                    handleTimeSelect(group.ids, t, group.duration || 30); 
                                                                                    setOpenTimePickerId(null); 
                                                                                }}
                                                                            >
                                                                                {t}
                                                                            </button>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}
                                                    </div>

                                                    {/* [New] Unattended Toggle (Moved from Details) */}
                                                    <div 
                                                        className={`flex items-center gap-2 px-3 py-2 rounded-full border cursor-pointer transition-colors ${group.unattended ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-slate-200 hover:bg-slate-50'}`}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            updateGroupStatus(group.ids, { unattended: !group.unattended });
                                                        }}
                                                    >
                                                        <div className={`w-4 h-4 rounded border flex items-center justify-center ${group.unattended ? 'bg-indigo-500 border-indigo-500' : 'bg-white border-slate-300'}`}>
                                                            {group.unattended && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>}
                                                        </div>
                                                        <span className="text-xs font-bold text-slate-600 whitespace-nowrap">ë¬´ì¸</span>
                                                    </div>
                                                </div>

                                                {/* Address (Driver Editable) */}
                                                {view === 'driver' ? (
                                                    <div className="mb-2">
                                                        <div className="flex items-start gap-2">
                                                            <div className="text-xs text-slate-600 font-bold whitespace-nowrap flex-shrink-0">ğŸ“</div>
                                                            <div className="flex-1">
                                                                <textarea 
                                                                    rows={2}
                                                                    className="w-full bg-transparent border-0 p-0 text-[11px] leading-snug font-semibold text-slate-800 focus:outline-none focus:ring-0 whitespace-pre-wrap break-words resize-none" 
                                                                    value={group.address || ''} 
                                                                    onChange={(e) => updateGroupContact(group.ids, { address: e.target.value })}
                                                                    onBlur={(e) => updateGroupAddress(group.ids, e.target.value)}
                                                                    placeholder="ì£¼ì†Œ ì…ë ¥"
                                                                />
                                                            </div>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div className="address">ğŸ“ {group.address}</div>
                                                )}
                                                <div className="border-t border-slate-200 my-2"></div>
                                                
                                                {/* Status Badges Removed (Moved to Header) */}

                                                {/* Accordion Details */}
                                                {isExpanded && !group.completed && (
                                                    <div className="mt-3 text-sm text-slate-600 space-y-4 p-3 bg-slate-50 rounded-xl border border-slate-100 animate-fade-in" onClick={(e) => e.stopPropagation()}>
                                                        <div>
                                                            <div className="font-bold mb-1">ğŸ“¦ í’ˆëª©</div>
                                                            <div className="space-y-1">
                                                                {group.items && group.items.map((it, i) => (
                                                                    <div key={i} className="flex gap-2 items-start" onClick={() => toggleItemCheck(it._oid, it._oidx)}>
                                                                        <div className={`w-4 h-4 mt-0.5 rounded border flex items-center justify-center shrink-0 ${it.checked ? 'bg-indigo-500 border-indigo-500' : 'bg-white border-slate-300'}`}>
                                                                            {it.checked && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>}
                                                                        </div>
                                                                        <span className={it.checked ? 'line-through opacity-50' : ''}>{it.item}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <div className="font-bold mb-1">ğŸ“ ë©”ëª¨</div>
                                                            <textarea 
                                                                className="w-full text-sm p-2 border border-slate-200 rounded-lg resize-none h-16"
                                                                placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                                                value={group.memo || ''}
                                                                onChange={(e) => updateMemo(group.ids, e.target.value)}
                                                            />
                                                        </div>
                                            



                                                        <div className="grid grid-cols-2 gap-3">
                                                            {['install_fee', 'yangjung', 'naerim', 'etc_fee'].map(key => (
                                                                <div key={key} className="bg-white p-3 rounded-xl border border-slate-200 flex flex-col justify-between shadow-sm">
                                                                    <span className="text-xs text-slate-500 font-bold mb-1">{key === 'install_fee' ? 'ì„¤ì¹˜ë¹„' : key === 'yangjung' ? 'ì–‘ì¤‘ë¹„' : key === 'naerim' ? 'ë‚´ë¦¼ë¹„' : 'ê¸°íƒ€ë¹„ìš©'}</span>
                                                                    <div className="flex items-center gap-1">
                                                                        <input 
                                                                            type="tel" 
                                                                            className="w-full text-right text-xl font-black text-slate-800 focus:outline-none bg-transparent placeholder-slate-300" 
                                                                            placeholder="0" 
                                                                            value={group[key] ? group[key].toLocaleString() : ''} 
                                                                            onChange={(e) => updateGroupFees(group.ids, key, e.target.value.replace(/,/g, ''))} 
                                                                            onClick={(e) => e.stopPropagation()}
                                                                        />
                                                                        <span className="text-xs text-slate-400 font-bold">ì›</span>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                            
                                                       
                                                    </div>
                                                )}
                                                
                                                {/* ì™„ë£Œ ë©”ì‹œì§€ */}
                                                {isExpanded && group.completed && (
                                                    <p className="text-[11px] text-slate-400 mt-2">
                                                        ì™„ë£Œëœ ë°°ì†¡ì…ë‹ˆë‹¤
                                                    </p>
                                                )}
                                                {!isExpanded && group.items && group.items.length > 0 && (
                                                    <div className="mb-1 text-sm text-slate-600 truncate flex items-baseline gap-2">
                                                        <div className="text-xs text-slate-600 font-bold whitespace-nowrap flex-shrink-0">ğŸ“¦</div>
                                                        <span className="truncate">{group.items[0] && group.items[0].item ? group.items[0].item : ''}</span>
                                                    </div>
                                                )}
                                            
                                                <button 
                                                    onClick={(e) => { 
                                                        e.stopPropagation(); 
                                                        const newState = !group.completed;
                                                        updateGroupStatus(group.ids, { 
                                                            completed: newState,
                                                            // ì™„ë£Œ ì‹œ ì·¨ì†Œ/ì—°ê¸° í•´ì œ
                                                            canceled: newState ? false : group.canceled,
                                                            cancel_type: newState ? null : group.cancel_type
                                                        }); 
                                                    }} 
                                                    className={`complete-btn w-full mb-2 ${group.completed ? 'opacity-80' : ''}`}
                                                >
                                                    {group.completed ? 'âœ… ë°°ì†¡ ì™„ë£Œë¨ (ì·¨ì†Œí•˜ë ¤ë©´ í´ë¦­)' : 'ğŸšš ë°°ì†¡ ì™„ë£Œ'}
                                                </button>
                                                <div className="grid grid-cols-2 gap-2 mb-2">
                                                    <button
                                                        onClick={(e) => { 
                                                            e.stopPropagation(); 
                                                            const isCanceling = !group.canceled || group.cancel_type !== 'cancel';
                                                            updateGroupStatus(group.ids, { 
                                                                canceled: isCanceling, 
                                                                cancel_type: isCanceling ? 'cancel' : null,
                                                                // ì·¨ì†Œ ì‹œ ì™„ë£Œ í•´ì œ
                                                                completed: isCanceling ? false : group.completed
                                                            }); 
                                                        }}
                                                        className={`py-3 text-sm font-extrabold rounded-[14px] text-white transition-all active:scale-95 ${
                                                            (group.canceled && group.cancel_type === 'cancel') 
                                                            ? 'bg-red-800 ring-2 ring-red-300' 
                                                            : 'bg-red-500 hover:bg-red-600'
                                                        }`}
                                                    >
                                                        {(group.canceled && group.cancel_type === 'cancel') ? 'ì·¨ì†Œë¨ (í•´ì œ)' : 'ì·¨ì†Œ'}
                                                    </button>
                                                    <button
                                                        onClick={(e) => { 
                                                            e.stopPropagation(); 
                                                            const isPostponing = !group.canceled || group.cancel_type !== 'postpone';
                                                            updateGroupStatus(group.ids, { 
                                                                canceled: isPostponing, 
                                                                cancel_type: isPostponing ? 'postpone' : null,
                                                                // ì—°ê¸° ì‹œ ì™„ë£Œ í•´ì œ
                                                                completed: isPostponing ? false : group.completed
                                                            }); 
                                                        }}
                                                        className={`py-3 text-sm font-extrabold rounded-[14px] text-white transition-all active:scale-95 ${
                                                            (group.canceled && group.cancel_type === 'postpone') 
                                                            ? 'bg-amber-700 ring-2 ring-amber-300' 
                                                            : 'bg-amber-500 hover:bg-amber-600'
                                                        }`}
                                                    >
                                                        {(group.canceled && group.cancel_type === 'postpone') ? 'ì—°ê¸°ë¨ (í•´ì œ)' : 'ì—°ê¸°'}
                                                    </button>
                                                </div>
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); handleNavigation(group.lat, group.lng, group.address); }} 
                                                    className="map-btn border border-indigo-200 bg-white text-indigo-900 hover:bg-sky-50"
                                                >
                                                    ğŸ—ºï¸ ì§€ë„
                                                </button>
                                            </div>
                                        </div>
                                        );
                                    });
                                    })()}
                                        </div>

                                        {/* PC Scroll Button Right */}
                                        <button 
                                            onClick={() => document.getElementById('delivery-list-container').scrollBy({ left: 300, behavior: 'smooth' })}
                                            className="hidden md:flex absolute right-0 top-1/2 -translate-y-1/2 z-20 bg-white/90 hover:bg-white shadow-lg border border-slate-200 rounded-full w-10 h-10 items-center justify-center text-slate-600 transition-all backdrop-blur-sm -mr-4 hover:scale-110 active:scale-95"
                                            aria-label="ë‹¤ìŒ"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
                                            </svg>
                                        </button>
                                    </div>
                                    
                                    {groupedDeliveries.length === 0 && (
                                        <div className="text-center py-10 text-gray-400">
                                            <p className="mb-2">ë“±ë¡ëœ ë°°ì†¡ ê±´ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                            <p className="text-xs">ì„ íƒëœ ë‚ ì§œ: {targetDate}</p>
                                            <p className="text-xs mt-1">ê´€ë¦¬ì ëª¨ë“œì—ì„œ ì—‘ì…€ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
                                        </div>
                                    )}
                                </div>
 

                                

                                {/* ë°ì´í„° ë™ê¸°í™” (ë°±ì—…/ë³µì›) */}
                                <div className="mt-4 flex gap-2">
                                    {!isDriverChangeMode && (
                                        <button onClick={openAddItemForm} className="flex-1 bg-indigo-50 text-indigo-700 border border-indigo-200 py-4 rounded-lg font-bold hover:bg-indigo-100 transition text-sm shadow-sm flex items-center justify-center gap-2">
                                            <span className="text-xl">â•</span>
                                            <span>ê°œë³„ìƒí’ˆì¶”ê°€</span>
                                        </button>
                                    )}
                                    {isDriverChangeMode && (
                                        <button 
                                            onClick={() => {
                                                setIsDriverChangeMode(false);
                                                setSelectedDriverChangeIds(new Set());
                                                setToastMsg('ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                            }} 
                                            className="flex-1 bg-slate-500 text-white py-4 rounded-lg font-bold hover:bg-slate-600 transition text-sm shadow-lg flex items-center justify-center gap-2"
                                        >
                                            <span className="text-xl">âŒ</span>
                                            <span>ì·¨ì†Œ</span>
                                        </button>
                                    )}
                                    <button 
                                        onClick={() => {
                                            if (isDriverChangeMode) {
                                                handleBatchDriverChange();
                                            } else {
                                                setIsDriverChangeMode(true);
                                                setToastMsg('ğŸ“Œ ê¸°ì‚¬ ë³€ê²½ ëª¨ë“œ: ë°°ì†¡ ê±´ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                                            }
                                        }}
                                        className={`flex-1 py-4 rounded-lg font-bold transition text-sm shadow-sm flex items-center justify-center gap-2 ${
                                            isDriverChangeMode 
                                            ? 'bg-green-600 text-white hover:bg-green-700 shadow-lg animate-pulse' 
                                            : 'bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200 shadow-sm'
                                        }`}
                                    >
                                        <span className="text-xl">ğŸ”„</span>
                                        <span>{isDriverChangeMode ? `ë³€ê²½ ì ìš© (${selectedDriverChangeIds.size})` : 'ê¸°ì‚¬ë³€ê²½'}</span>
                                    </button>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mt-6">
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                            ğŸ”„ ë°ì´í„° ë™ê¸°í™”
                                        </h3>
                                        <button onClick={() => setCloudModalOpen(true)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition flex items-center gap-1 ${isCloudConnected ? 'bg-white text-slate-500 border-slate-200' : 'bg-indigo-600 text-white border-indigo-600 shadow-md animate-pulse'}`}>
                                            {isCloudConnected ? "âš™ï¸ ì„œë²„ ì„¤ì •" : "â˜ï¸ ì„œë²„ ì—°ê²°í•˜ê¸°"}
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {/* Cloud Buttons - Always Visible */}
                                        <button onClick={() => handleCloudSync('pull')} className="col-span-2 bg-indigo-600 text-white py-4 rounded-lg font-bold hover:bg-indigo-700 transition text-sm shadow-lg shadow-indigo-200 flex items-center justify-center gap-2">
                                            <span className="text-xl">â˜ï¸</span>
                                            <span>ì„œë²„ì—ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</span>
                                        </button>
                                        <button onClick={() => handleCloudSync('push')} className="col-span-2 bg-white text-indigo-900 py-3 rounded-lg font-bold hover:bg-sky-50 transition text-sm border border-indigo-200 flex items-center justify-center gap-2 mb-2">
                                            <span className="text-xl">â˜ï¸</span>
                                            <span>ì‘ì—… ê²°ê³¼ ì„œë²„ì— ì €ì¥</span>
                                        </button>

                                        <button onClick={() => {
                                            const blob = new Blob([JSON.stringify(deliveries)], {type: "application/json"});
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `driver_data_${new Date().toISOString().slice(0,10)}.json`;
                                            a.click();
                                        }} className="bg-white text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition text-sm border border-slate-200 shadow-sm flex flex-col items-center justify-center gap-1">
                                            <span className="text-xl">ğŸ“¤</span>
                                            <span>íŒŒì¼ë¡œ ì €ì¥</span>
                                        </button>
                                        <label className="bg-white text-slate-600 py-3 rounded-lg font-bold hover:bg-slate-50 transition text-sm border border-slate-200 shadow-sm flex flex-col items-center justify-center gap-1 cursor-pointer">
                                            <span className="text-xl">ğŸ“¥</span>
                                            <span>íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</span>
                                            <input type="file" hidden accept=".json" onChange={(e) => {
                                                const file = e.target.files[0];
                                                if(!file) return;
                                                readJsonFileWithEncoding(file, (data) => {
                                                    if(Array.isArray(data)) {
                                                        if(confirm(`ì´ ${data.length}ê±´ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.`)) {
                                                            setDeliveries(data);
                                                            StorageManager.saveDeliveries(data);
                                                            alert("ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                                                        }
                                                    } else {
                                                        alert("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.");
                                                    }
                                                });
                                            }} />
                                        </label>
                                    </div>
                                    <p className="text-xs text-slate-400 mt-2 text-center">
                                        * ê´€ë¦¬ìê°€ ë³´ë‚¸ íŒŒì¼ì„ 'ë¶ˆëŸ¬ì˜¤ê¸°' í•˜ê³ , ì‘ì—… í›„ 'ì €ì¥'í•˜ì—¬ ê´€ë¦¬ìì—ê²Œ ë³´ë‚´ì„¸ìš”.
                                    </p>
                                </div>
                                
                                {/* Undo Button (Floating) */}
                                {history.length > 0 && (
                                    <div className="fixed bottom-6 right-6 z-50 animate-slide-up">
                                        <button 
                                            onClick={handleUndo}
                                            className="bg-slate-800 text-white px-5 py-3 rounded-full shadow-2xl font-bold flex items-center gap-2 hover:bg-slate-900 transition active:scale-95 border border-slate-700"
                                        >
                                            <span className="text-xl">â†©ï¸</span>
                                            <span className="text-sm">ë˜ëŒë¦¬ê¸° ({history.length})</span>
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                    
                    {/* [Admin Only Area] */} 
                    <div id="admin-only" style={{display:'none', border:'1px dashed #e5e7eb', padding:'12px', margin:'12px', borderRadius:'12px'}}> 
                        <strong>ê´€ë¦¬ì ì˜ì—­</strong> 
                        <div style={{fontSize:'12px', color:'#64748b', marginTop:'4px'}}> ê´€ë¦¬ì ì „ìš© ì½˜í…ì¸  </div> 
                    </div>

                    {/* [New] Guide Modal */}
                    <GuideModal isOpen={showGuideModal} onClose={() => setShowGuideModal(false)} />

                    {/* [New] Cloud Settings Modal */}
                    <CloudSettingsModal 
                        isOpen={isCloudModalOpen} 
                        onClose={() => {
                            setCloudModalOpen(false);
                            // Re-check connection status on close
                            const config = StorageManager.get('mvp_supabase_config');
                            setCloudConnected(!!(config && config.url && config.key && CloudManager.isConnected));
                        }}
                        onReset={() => {
                            setDeliveries([]);
                            StorageManager.saveDeliveries([]);
                        }} 
                    />

                    {/* [New] Floating Undo Button */}
                    {history.length > 0 && (
                        <button 
                            onClick={handleUndo}
                            className="fixed bottom-32 left-4 z-[70] bg-gray-800 text-white p-3 rounded-full shadow-2xl hover:bg-gray-700 active:scale-95 transition-all flex items-center gap-2 pr-4 border border-gray-600"
                            aria-label="ì‹¤í–‰ ì·¨ì†Œ"
                        >
                            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path></svg>
                            <span className="text-xs font-bold">ë˜ëŒë¦¬ê¸°</span>
                        </button>
                    )}

                    {/* ì™„ë£Œ ì¶•í•˜ ëª¨ë‹¬ (ì ‘ê·¼ì„± ì ìš©) */}
                    {showCompletionModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" 
                             style={{animation: 'fadeIn 0.5s'}}
                             role="dialog"
                             aria-modal="true"
                             aria-labelledby="modal-title"
                             aria-describedby="modal-desc">
                            <style>{`
                                @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                                @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                            `}</style>
                            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center relative overflow-hidden" 
                                 style={{animation: 'slideUp 0.5s 0.1s both'}}>
                                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-400 to-purple-500"></div>
                                <button 
                                    onClick={() => setShowCompletionModal(false)}
                                    className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
                                    aria-label="ë‹«ê¸°"
                                >
                                    âœ•
                                </button>
                                <div className="text-6xl mb-6 animate-bounce" aria-hidden="true">â˜ï¸</div>
                                <h2 id="modal-title" className="text-2xl font-bold text-gray-800 mb-2">ì‘ì—… ì™„ë£Œ</h2>
                                <p id="modal-desc" className="text-gray-600 mb-8 font-medium">
                                    ëª¨ë“  ë°°ì†¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.<br/>
                                    <span className="text-indigo-900 font-bold text-lg block mt-2">ì‘ì—… ê²°ê³¼ê°€ ì„œë²„ì—<br/>ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</span>
                                </p>
                                <div className="flex flex-col gap-3">
                                    <button 
                                        onClick={() => setShowCompletionModal(false)}
                                        className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg transform active:scale-95 transition w-full"
                                        autoFocus
                                    >
                                        í™•ì¸
                                    </button>
                                    <button 
                                        onClick={() => {
                                            setEnableCompletionMessage(false);
                                            StorageManager.set('mvp_enable_completion_msg', false);
                                            setShowCompletionModal(false);
                                        }}
                                        className="text-xs text-gray-400 hover:text-gray-600 underline"
                                    >
                                        ì´ ë©”ì‹œì§€ ë‹¤ì‹œ ë³´ì§€ ì•Šê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* [ìˆ˜ì •] ìƒì„¸ ì •ë³´ í¸ì§‘ ëª¨ë‹¬ */}
                    {showEditModal && editTarget && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={() => setShowEditModal(false)}>
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]" onClick={e => e.stopPropagation()}>
                                {/* Header */}
                                <div className="bg-slate-50 px-6 py-4 border-b flex justify-between items-center">
                                    <h3 className="text-lg font-bold text-slate-800">ë°°ì†¡ ìƒì„¸ ì •ë³´ ìˆ˜ì •</h3>
                                    <button onClick={() => setShowEditModal(false)} className="text-slate-400 hover:text-slate-600">
                                        <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                                    </button>
                                </div>
                                
                                {/* Tabs */}
                                <div className="flex border-b">
                                    <button className={`flex-1 py-3 text-sm font-bold ${editTab === 'basic' ? 'text-indigo-900 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setEditTab('basic')}>ê¸°ë³¸ ì •ë³´</button>
                                    <button className={`flex-1 py-3 text-sm font-bold ${editTab === 'cost' ? 'text-indigo-900 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setEditTab('cost')}>ë¹„ìš©/ì •ì‚°</button>
                                    <button className={`flex-1 py-3 text-sm font-bold ${editTab === 'attach' ? 'text-indigo-900 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setEditTab('attach')}>ì²¨ë¶€íŒŒì¼</button>
                                    <button className={`flex-1 py-3 text-sm font-bold ${editTab === 'history' ? 'text-indigo-900 border-b-2 border-indigo-600' : 'text-slate-500 hover:text-slate-700'}`} onClick={() => setEditTab('history')}>ìˆ˜ì • ì´ë ¥</button>
                                </div>

                                {/* Content */}
                                <div className="p-6 overflow-y-auto flex-1">
                                    {editTab === 'basic' && (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">ìƒí’ˆëª… <span className="text-red-500">*</span></label>
                                                <input type="text" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                    value={editTarget.item} 
                                                    onChange={e => setEditTarget({...editTarget, item: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">ì „í™”ë²ˆí˜¸ <span className="text-red-500">*</span></label>
                                                <input type="tel" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                    value={editTarget.phone} 
                                                    onChange={e => setEditTarget({...editTarget, phone: e.target.value})} />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">ì£¼ì†Œ <span className="text-red-500">*</span></label>
                                                <input type="text" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                    value={editTarget.address} 
                                                    onChange={e => setEditTarget({...editTarget, address: e.target.value})} />
                                                <p className="text-xs text-orange-500 mt-1">âš ï¸ ì£¼ì†Œ ë³€ê²½ ì‹œ ì¢Œí‘œê°€ ìë™ìœ¼ë¡œ ì¬ê²€ìƒ‰ë©ë‹ˆë‹¤.</p>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">ë©”ëª¨</label>
                                                <textarea className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none h-24 resize-none" 
                                                    value={editTarget.memo || ''} 
                                                    onChange={e => setEditTarget({...editTarget, memo: e.target.value})}></textarea>
                                            </div>
                                        </div>
                                    )}

                                    {editTab === 'cost' && (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-1">ì„¤ì¹˜ë¹„</label>
                                                <input type="number" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                    value={editTarget.install_fee || 0} 
                                                    onChange={e => setEditTarget({...editTarget, install_fee: Number(e.target.value)})} />
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-600 mb-1">ì–‘ì¤‘ë¹„</label>
                                                    <input type="number" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                        value={editTarget.yangjung || 0} 
                                                        onChange={e => setEditTarget({...editTarget, yangjung: Number(e.target.value)})} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-600 mb-1">ë‚´ë¦¼ë¹„</label>
                                                    <input type="number" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                        value={editTarget.naerim || 0} 
                                                        onChange={e => setEditTarget({...editTarget, naerim: Number(e.target.value)})} />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-600 mb-1">ê¸°íƒ€ë¹„ìš©</label>
                                                    <input type="number" className="w-full border rounded p-2 focus:ring-2 focus:ring-indigo-500 outline-none" 
                                                        value={editTarget.etc_fee || 0} 
                                                        onChange={e => setEditTarget({...editTarget, etc_fee: Number(e.target.value)})} />
                                                </div>
                                            </div>
                                            <div className="bg-slate-50 p-3 rounded text-right">
                                                <span className="text-sm font-bold text-slate-500 mr-2">ì´ í•©ê³„:</span>
                                                <span className="text-lg font-extrabold text-indigo-900">
                                                    {((editTarget.install_fee||0) + (editTarget.yangjung||0) + (editTarget.naerim||0) + (editTarget.etc_fee||0)).toLocaleString()}ì›
                                                </span>
                                            </div>
                                        </div>
                                    )}

                                    {editTab === 'attach' && (
                                        <div className="space-y-6">
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-2">ì´ë¯¸ì§€ (ìµœëŒ€ 3ì¥)</label>
                                                <div className="grid grid-cols-3 gap-2 mb-2">
                                                    {(editTarget.images || []).map((img, idx) => (
                                                        <div key={idx} className="relative aspect-square bg-slate-100 rounded overflow-hidden group">
                                                            <img src={img} alt="preview" className="w-full h-full object-cover" />
                                                            <button onClick={() => {
                                                                const newImages = [...editTarget.images];
                                                                newImages.splice(idx, 1);
                                                                setEditTarget({...editTarget, images: newImages});
                                                            }} className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition">âœ•</button>
                                                        </div>
                                                    ))}
                                                    {(editTarget.images || []).length < 3 && (
                                                        <label className="border-2 border-dashed border-slate-300 rounded flex items-center justify-center cursor-pointer hover:border-indigo-500 aspect-square">
                                                            <span className="text-2xl text-slate-400">+</span>
                                                            <input type="file" className="hidden" accept="image/*" onChange={e => {
                                                                const file = e.target.files[0];
                                                                if(file) {
                                                                    if(file.size > 500 * 1024) { alert("ì´ë¯¸ì§€ëŠ” 500KB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
                                                                    const reader = new FileReader();
                                                                    reader.onload = (ev) => {
                                                                        setEditTarget({...editTarget, images: [...(editTarget.images || []), ev.target.result]});
                                                                    };
                                                                    reader.readAsDataURL(file);
                                                                }
                                                            }} />
                                                        </label>
                                                    )}
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-slate-600 mb-2">ê¸°íƒ€ ì²¨ë¶€íŒŒì¼</label>
                                                <div className="flex gap-2 mb-2">
                                                    <input type="file" id="attachFile" className="hidden" onChange={e => {
                                                        const file = e.target.files[0];
                                                        if(file) {
                                                            setEditTarget({...editTarget, attachments: [...(editTarget.attachments || []), file.name]});
                                                        }
                                                    }} />
                                                    <label htmlFor="attachFile" className="bg-slate-100 px-3 py-2 rounded text-sm cursor-pointer hover:bg-slate-200 border">íŒŒì¼ ì„ íƒ</label>
                                                </div>
                                                <ul className="space-y-1">
                                                    {(editTarget.attachments || []).map((file, idx) => (
                                                        <li key={idx} className="flex justify-between items-center text-sm bg-slate-50 p-2 rounded">
                                                            <span className="truncate max-w-[200px]">ğŸ“ {file}</span>
                                                            <button onClick={() => {
                                                                const newAttach = [...editTarget.attachments];
                                                                newAttach.splice(idx, 1);
                                                                setEditTarget({...editTarget, attachments: newAttach});
                                                            }} className="text-red-500 hover:text-red-700 text-xs">ì‚­ì œ</button>
                                                        </li>
                                                    ))}
                                                    {(editTarget.attachments || []).length === 0 && <li className="text-xs text-gray-400">ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>}
                                                </ul>
                                                <p className="text-xs text-orange-500 mt-2">â€» ë¡œì»¬ ëª¨ë“œì—ì„œëŠ” íŒŒì¼ëª…ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</p>
                                            </div>
                                        </div>
                                    )}

                                    {editTab === 'history' && (
                                        <div className="space-y-3 h-full">
                                            {(!deliveries.find(d => d.id === editTarget.id)?.history || deliveries.find(d => d.id === editTarget.id)?.history.length === 0) ? (
                                                <div className="text-center text-gray-400 py-10">ìˆ˜ì • ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                            ) : (
                                                deliveries.find(d => d.id === editTarget.id).history.slice().reverse().map((log, idx) => (
                                                    <div key={idx} className="border-l-2 border-indigo-200 pl-3 py-1">
                                                        <div className="text-xs text-gray-400 mb-1">{new Date(log.date).toLocaleString()}</div>
                                                        <div className="space-y-1">
                                                            {log.changes.map((c, cIdx) => (
                                                                <div key={cIdx} className="text-xs">
                                                                    <span className="font-bold text-slate-600">{c.field}</span>: 
                                                                    <span className="text-red-400 line-through mx-1">{c.old}</span>
                                                                    â†’ 
                                                                    <span className="text-blue-600 font-bold mx-1">{c.new}</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="p-4 border-t bg-slate-50 flex justify-end gap-2">
                                    <button onClick={() => setShowEditModal(false)} className="px-4 py-2 text-slate-600 font-bold hover:bg-slate-200 rounded-lg">ì·¨ì†Œ</button>
                                    <button onClick={handleEditSave} className="px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-200">ì €ì¥í•˜ê¸°</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ì‚­ì œ í™•ì¸ ëª¨ë‹¬ */}
                    {showDeleteModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" 
                             style={{animation: 'fadeIn 0.5s'}}
                             role="dialog"
                             aria-modal="true">
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center relative overflow-hidden" style={{animation: 'slideUp 0.3s'}}>
                                <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                        <path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                    </svg>
                                </div>
                                <h3 className="text-lg font-bold text-gray-900 mb-2">í•­ëª© ì‚­ì œ</h3>
                                <p className="text-sm text-gray-500 mb-6 leading-relaxed">
                                    ì„ íƒí•œ ë°°ì†¡ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br/>
                                    <span className="text-xs text-red-500 font-bold">âš ï¸ ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
                                </p>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setShowDeleteModal(false)}
                                        className="flex-1 px-4 py-3 rounded-lg border border-gray-200 font-bold text-gray-600 hover:bg-gray-50 transition"
                                    >
                                        ì·¨ì†Œ
                                    </button>
                                    <button 
                                        onClick={executeDelete}
                                        className="flex-1 px-4 py-3 rounded-lg bg-red-500 font-bold text-white hover:bg-red-600 transition shadow-lg shadow-red-200"
                                    >
                                        ì‚­ì œí•˜ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ê¸°ì‚¬ ì´ë™ ëª¨ë‹¬ */}
                    {moveDriverModal.isOpen && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={() => setMoveDriverModal({ ...moveDriverModal, isOpen: false })}>
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full relative" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                    <span>ğŸšš</span> ê¸°ì‚¬ ë³€ê²½
                                </h3>
                                <p className="text-sm text-slate-500 mb-4">
                                    ì´ ë°°ì†¡ ê±´ì„ ì „ë‹¬í•  ê¸°ì‚¬ë‹˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
                                </p>
                                <div className="space-y-2 mb-6 max-h-60 overflow-y-auto">
                                    {Array.from(new Set(deliveries.map(d => d.driver).filter(Boolean))).sort().filter(d => d !== moveDriverModal.currentDriver).map(driver => (
                                        <button 
                                            key={String(driver)}
                                            onClick={() => setMoveDriverTarget(String(driver))}
                                            className={`w-full text-left px-4 py-3 rounded-lg font-bold border transition-all ${moveDriverTarget === String(driver) ? 'border-indigo-500 bg-sky-50 text-indigo-700 ring-2 ring-indigo-200' : 'border-slate-200 hover:bg-slate-50 text-slate-700'}`}
                                        >
                                            {String(driver)} ê¸°ì‚¬ë‹˜
                                        </button>
                                    ))}
                                    {Array.from(new Set(deliveries.map(d => d.driver).filter(Boolean))).filter(d => d !== moveDriverModal.currentDriver).length === 0 && (
                                        <div className="text-center py-4 text-slate-400 text-sm">
                                            ì´ë™í•  ë‹¤ë¥¸ ê¸°ì‚¬ë‹˜ì´ ì—†ìŠµë‹ˆë‹¤.
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setMoveDriverModal({ ...moveDriverModal, isOpen: false })}
                                        className="flex-1 px-4 py-3 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition"
                                    >
                                        ì·¨ì†Œ
                                    </button>
                                    <button 
                                        onClick={handleMoveDriverConfirm}
                                        disabled={!moveDriverTarget}
                                        className="flex-1 px-4 py-3 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-indigo-200"
                                    >
                                        ì´ë™í•˜ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showAddItemModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={() => setShowAddItemModal(false)}>
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full relative" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                    <span>ğŸ“¦</span> ê°œë³„ ìƒí’ˆ ì¶”ê°€
                                </h3>
                                <div className="space-y-3 mb-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">ë°°ì†¡ë‚ ì§œ</label>
                                        <input type="date" className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            value={addForm.date}
                                            onChange={e => setAddForm({ ...addForm, date: e.target.value })}
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">ì „í™”ë²ˆí˜¸</label>
                                        <input type="tel" className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            value={addForm.phone}
                                            onChange={e => setAddForm({ ...addForm, phone: e.target.value })}
                                            placeholder="ìˆ«ìë§Œ ì…ë ¥"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">ì£¼ì†Œ</label>
                                        <input type="text" className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            value={addForm.address}
                                            onChange={e => setAddForm({ ...addForm, address: e.target.value })}
                                            placeholder="ì£¼ì†Œ ì…ë ¥"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 mb-1 block">í’ˆëª©</label>
                                        <input type="text" className="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm"
                                            value={addForm.item}
                                            onChange={e => setAddForm({ ...addForm, item: e.target.value })}
                                            placeholder="ì˜ˆ: ì¹¨ëŒ€ í”„ë ˆì„"
                                        />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <button 
                                        onClick={() => setShowAddItemModal(false)}
                                        className="flex-1 px-4 py-3 rounded-xl font-bold text-slate-600 bg-slate-100 hover:bg-slate-200 transition"
                                    >
                                        ì·¨ì†Œ
                                    </button>
                                    <button 
                                        onClick={handleAddItemSubmit}
                                        className="flex-1 px-4 py-3 rounded-xl font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition shadow-lg shadow-indigo-200"
                                    >
                                        ì¶”ê°€í•˜ê¸°
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* ì›”ë³„ ë¹„ìš© í•©ê³„ ëª¨ë‹¬ */}
                    {showMonthlyCostModal && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm animate-fade-in" onClick={() => setShowMonthlyCostModal(false)}>
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full relative max-h-[90vh] overflow-hidden flex flex-col" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-xl font-bold text-slate-900 flex items-center gap-2">
                                        <span>ğŸ“Š</span> ì›”ë³„ ë¹„ìš© í•©ê³„
                                    </h3>
                                    <button onClick={() => setShowMonthlyCostModal(false)} className="text-slate-400 hover:text-slate-600">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-6 h-6">
                                            <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                                
                                <div className="flex items-center gap-4 mb-6 bg-slate-50 p-3 rounded-xl border border-slate-100">
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={() => setMonthlyViewMode('month')}
                                            className={`px-3 py-1 rounded-full text-xs font-bold ${monthlyViewMode === 'month' ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 border border-slate-300'}`}
                                        >
                                            ì›”
                                        </button>
                                        <button 
                                            onClick={() => setMonthlyViewMode('day')}
                                            className={`px-3 py-1 rounded-full text-xs font-bold ${monthlyViewMode === 'day' ? 'bg-indigo-600 text-white' : 'bg-white text-slate-600 border border-slate-300'}`}
                                        >
                                            ì¼
                                        </button>
                                    </div>
                                    {monthlyViewMode === 'month' ? (
                                        <input 
                                            type="month" 
                                            value={monthlyCostTargetMonth} 
                                            onChange={(e) => setMonthlyCostTargetMonth(e.target.value)}
                                            className="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 text-base font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        />
                                    ) : (
                                        <input 
                                            type="date" 
                                            value={monthlyCostTargetDay} 
                                            onChange={(e) => setMonthlyCostTargetDay(e.target.value)}
                                            className="w-full bg-white border border-slate-300 rounded-lg px-3 py-2 text-base font-bold text-slate-800 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                        />
                                    )}
                                </div>

                                <div className="flex-1 overflow-y-auto custom-scrollbar pb-2">
                                    {(() => {
                                        const targetMonth = monthlyCostTargetMonth;
                                        let filtered = deliveries.filter(d => {
                                            if (!d.date || d.canceled) return false;
                                            if (monthlyViewMode === 'month') {
                                                return d.date.startsWith(targetMonth);
                                            } else {
                                                return d.date === monthlyCostTargetDay;
                                            }
                                        });
                                        
                                        // 2. ê¶Œí•œ í•„í„°: ê¸°ì‚¬ëŠ” ë³¸ì¸ ê²ƒë§Œ, ê´€ë¦¬ìëŠ” ì „ì²´(ë˜ëŠ” í•„í„°ë§ ê°€ëŠ¥í•˜ì§€ë§Œ ì—¬ê¸°ì„  ì „ì²´ í•©ê³„ ë³´ì—¬ì¤Œ)
                                        // "ì´ ë‚´ìš©ì€ ë¡œê·¸ì¸í•œ ê¸°ì‚¬ë§Œ í™•ì¸ ê°€ëŠ¥" -> ê¸°ì‚¬ ëª¨ë“œì¼ ë• ë³¸ì¸ ë°ì´í„°ë§Œ.
                                        if (view === 'driver') {
                                            if (!currentUser) return <div className="text-center text-gray-400 py-8">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>;
                                            filtered = filtered.filter(d => d.driver === currentUser);
                                        }

                                        // 3. í†µê³„ ê³„ì‚°
                                        const stats = filtered.reduce((acc, d) => ({
                                            install: acc.install + (d.install_fee||0),
                                            yangjung: acc.yangjung + (d.yangjung||0),
                                            naerim: acc.naerim + (d.naerim||0),
                                            etc: acc.etc + (d.etc_fee||0),
                                            total: acc.total + ((d.install_fee||0)+(d.yangjung||0)+(d.naerim||0)+(d.etc_fee||0))
                                        }), { install: 0, yangjung: 0, naerim: 0, etc: 0, total: 0 });

                                        // Today summary (same month)
                                        const refDay = monthlyViewMode === 'day' ? monthlyCostTargetDay : new Date().toISOString().slice(0,10);
                                        const dayItems = filtered.filter(d => d.date === refDay);
                                        const dayInstall = dayItems.reduce((s, d) => s + (d.install_fee || 0), 0);
                                        const dayExtra = dayItems.reduce((s, d) => s + ((d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0)), 0);
                                        const dayTotal = dayInstall + dayExtra;

                                        return (
                                            <div className="space-y-4 animate-slide-up">
                                                {/* Today Summary Card - placed above monthly total */}
                                                <div className="bg-sky-50 p-3 rounded-xl border border-slate-100">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-xs font-bold text-slate-700">ì˜¤ëŠ˜ ë¹„ìš© í•©ê³„</span>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                                        <div className="bg-white rounded-lg px-3 py-2 border border-slate-200 text-center">
                                                            <span className="block text-[11px] font-bold text-indigo-700 mb-0.5">ì˜ˆìƒ ì„¤ì¹˜ë¹„</span>
                                                            <span className="block text-sm font-black text-indigo-900">{dayInstall.toLocaleString()}ì›</span>
                                                        </div>
                                                        <div className="bg-white rounded-lg px-3 py-2 border border-slate-200 text-center">
                                                            <span className="block text-[11px] font-bold text-orange-600 mb-0.5">ì¶”ê°€ë¹„ìš©</span>
                                                            <span className="block text-sm font-black text-orange-900">{dayExtra.toLocaleString()}ì›</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                {/* Total Card */}
                                                <div className="bg-gradient-to-br from-indigo-600 to-indigo-700 text-white p-6 rounded-2xl shadow-lg shadow-indigo-200 text-center relative overflow-hidden">
                                                    <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-16 -mt-16 blur-xl"></div>
                                                    <div className="absolute bottom-0 left-0 w-24 h-24 bg-black/10 rounded-full -ml-12 -mb-12 blur-xl"></div>
                                                    
                                                    <p className="text-indigo-100 font-medium mb-2 relative z-10">
                                                        <span className="block opacity-90 text-sm mb-1">{view === 'driver' ? `${currentUser} ê¸°ì‚¬ë‹˜` : 'ì „ì²´ ê¸°ì‚¬'}</span>
                                                        <span className="block text-xl font-bold">{parseInt(targetMonth.split('-')[1])}ì›” ì´ ìˆ˜ìµ</span>
                                                    </p>
                                                    <h2 className="text-4xl font-black relative z-10 tracking-tight">
                                                        {stats.total.toLocaleString()}
                                                        <span className="text-2xl font-bold opacity-80 ml-1">ì›</span>
                                                    </h2>
                                                </div>

                                                {/* Breakdown Grid */}
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">ì„¤ì¹˜ë¹„</span>
                                                        <span className="text-lg font-black text-slate-800">{stats.install.toLocaleString()}ì›</span>
                                                    </div>
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">ì–‘ì¤‘ë¹„</span>
                                                        <span className="text-lg font-black text-slate-800">{stats.yangjung.toLocaleString()}ì›</span>
                                                    </div>
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">ë‚´ë¦¼ë¹„</span>
                                                        <span className="text-lg font-black text-slate-800">{stats.naerim.toLocaleString()}ì›</span>
                                                    </div>
                                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex flex-col items-center justify-center gap-1">
                                                        <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">ê¸°íƒ€ë¹„ìš©</span>
                                                        <span className="text-lg font-black text-slate-800">{stats.etc.toLocaleString()}ì›</span>
                                                    </div>
                                                </div>
                                                
                                                {/* Daily Breakdown */}
                                                <div className="mt-4">
                                                    {(() => {
                                                        const selectedStr = monthlyViewMode === 'day' ? monthlyCostTargetDay : new Date().toISOString().slice(0,10);
                                                        const selectedItems = filtered.filter(d => d.date === selectedStr);
                                                        const selInstall = selectedItems.reduce((s, d) => s + (d.install_fee || 0), 0);
                                                        const selExtra = selectedItems.reduce((s, d) => s + ((d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0)), 0);
                                                        const selTotal = selInstall + selExtra;
                                                        const Header = (
                                                            <>
                                                                <h4 className="text-sm font-bold text-slate-800 mb-2 flex items-center gap-2">
                                                                    <span>ğŸ“…</span> ì¼ë³„ ë¹„ìš© í•©ê³„
                                                                </h4>
                                                                {monthlyViewMode === 'day' && (
                                                                    <div className="flex items-center gap-3 mb-2">
                                                                        <span className="block text-sm font-black text-indigo-900">{selInstall.toLocaleString()}ì›</span>
                                                                        <span className="block text-sm font-black text-orange-900">{selExtra.toLocaleString()}ì›</span>
                                                                        <span className="block text-sm font-black text-slate-900">{selTotal.toLocaleString()}ì›</span>
                                                                    </div>
                                                                )}
                                                            </>
                                                        );
                                                        const dailyMap = {};
                                                        filtered.forEach(d => {
                                                            const day = d.date;
                                                            if (!dailyMap[day]) dailyMap[day] = { install: 0, extra: 0, total: 0 };
                                                            dailyMap[day].install += (d.install_fee || 0);
                                                            dailyMap[day].extra += (d.yangjung || 0) + (d.naerim || 0) + (d.etc_fee || 0);
                                                            dailyMap[day].total = dailyMap[day].install + dailyMap[day].extra;
                                                        });
                                                        const entries = Object.entries(dailyMap).sort((a, b) => a[0].localeCompare(b[0]));
                                                        if (entries.length === 0) {
                                                            return (
                                                                <>
                                                                    {Header}
                                                                    <div className="text-center text-slate-400 text-sm py-3">í•´ë‹¹ ì›”ì˜ ì¼ë³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                                                                </>
                                                            );
                                                        }
                                                        return (
                                                            <>
                                                                {Header}
                                                                <div className="space-y-2">
                                                                {entries.map(([day, v]) => (
                                                                    <div key={day} className="bg-white p-3 rounded-xl border border-slate-100 flex items-center justify-between">
                                                                        <div className="text-sm font-bold text-slate-800">{day}</div>
                                                                        <div className="flex items-center gap-3">
                                                                            <div className="text-xs font-bold text-indigo-700">
                                                                                ì„¤ì¹˜ë¹„ <span className="font-black text-slate-900 ml-1">{v.install.toLocaleString()}ì›</span>
                                                                            </div>
                                                                            <div className="text-xs font-bold text-orange-600">
                                                                                ì¶”ê°€ë¹„ìš© <span className="font-black text-slate-900 ml-1">{v.extra.toLocaleString()}ì›</span>
                                                                            </div>
                                                                            <div className="text-xs font-bold text-slate-600">
                                                                                í•©ê³„ <span className="font-black text-slate-900 ml-1">{v.total.toLocaleString()}ì›</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                ))}
                                                                </div>
                                                            </>
                                                        );
                                                    })()}
                                                </div>

                                                {filtered.length === 0 && (
                                                    <div className="text-center text-slate-400 text-sm py-4">
                                                        í•´ë‹¹ ì›”ì˜ ì •ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */}
                    {toastMsg && (
                        <div className="fixed bottom-20 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-[60] animate-fade-in text-sm font-bold flex items-center gap-2">
                            <span>âš ï¸</span>
                            {toastMsg}
                        </div>
                    )}

                    {loading && (
                        <div className="absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center z-50">
                            <div className="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center animate-bounce">
                                <div className="text-4xl mb-2">ğŸšš</div>
                                <div className="font-bold text-gray-700">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(
                <ErrorBoundary>
                    <App />
                </ErrorBoundary>
            );

            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => console.log('SW registered'))
                        .catch(err => console.log('SW registration failed', err));
                });
            }
    </script>

    <!-- [AdSense] Initialization Guard -->
    <script>
        window.adsbygoogle = window.adsbygoogle || [];
        if (!window.__adsInitialized) {
            try {
                window.adsbygoogle.push({});
                window.__adsInitialized = true;
                console.log("AdSense initialized");
            } catch (e) {
                console.warn("AdSense init skipped", e);
            }
        }
    </script>
</body>
</html>


